################################################################################
#                                                                              #
#                        FRONTEND CODE EXPORT                                  #
#                  Vue.js 3 + Vite + Tailwind + TypeScript                     #
#                                                                              #
#  Export Date: 2026-02-28 08:00:08                                          #
#  Timestamp: 2026-02-28_08-00-08                                                   #
#                                                                              #
################################################################################

=================================================================================
FILE: package.json
LOCATION: .//package.json
=================================================================================

{
  "name": "cserp-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@mdi/font": "^7.4.47",
    "axios": "^1.13.4",
    "date-fns": "^4.1.0",
    "lodash": "^4.17.23",
    "lucide-vue-next": "^0.563.0",
    "pinia": "^3.0.4",
    "vite-plugin-vuetify": "^2.1.3",
    "vue": "^3.5.24",
    "vue-router": "^4.6.4",
    "vuetify": "^3.11.8"
  },
  "devDependencies": {
    "@tsconfig/node20": "^20.1.9",
    "@types/lodash": "^4.17.23",
    "@types/node": "^25.2.2",
    "@vitejs/plugin-vue": "^6.0.1",
    "@vue/tsconfig": "^0.8.1",
    "typescript": "^5.9.3",
    "vite": "^7.2.4",
    "vue-tsc": "^3.2.4"
  }
}


=================================================================================
FILE: tsconfig.json
LOCATION: .//tsconfig.json
=================================================================================

{
  "files": [],
  "references": [
    {
      "path": "./tsconfig.node.json"
    },
    {
      "path": "./tsconfig.app.json"
    }
  ],
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}

=================================================================================
FILE: tsconfig.app.json
LOCATION: .//tsconfig.app.json
=================================================================================

{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "include": ["src/**/*", "src/**/*.vue"],
  "exclude": ["src/**/__tests__/*"],
  "compilerOptions": {
    "composite": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    "noImplicitAny": true, 
    "strict": true,
    "jsx": "preserve",
    "moduleResolution": "bundler"
  }
}

=================================================================================
FILE: tsconfig.node.json
LOCATION: .//tsconfig.node.json
=================================================================================

{
  "extends": "@tsconfig/node20/tsconfig.json",
  "include": [
    "vite.config.*",
    "vitest.config.*",
    "cypress.config.*",
    "nightwatch.conf.*",
    "playwright.config.*"
  ],
  "compilerOptions": {
    "composite": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo"
  }
}

=================================================================================
FILE: vite.config.ts
LOCATION: .//vite.config.ts
=================================================================================

import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vuetify from 'vite-plugin-vuetify'

export default defineConfig({
  plugins: [
    vue(),
    vuetify({ autoImport: true }),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      }
    }
  }
})

=================================================================================
FILE: index.html
LOCATION: .//index.html
=================================================================================

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSERP - Custom Solutions ERP</title>
    <!-- Roboto Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>


=================================================================================
FILE: src/env.d.ts
LOCATION: .//src/env.d.ts
=================================================================================

/// <reference types="vite/client" />
/// <reference types="vite-plugin-vuetify/client" />

declare module '*.vue' {
    import type { DefineComponent } from 'vue'
    const component: DefineComponent<{}, {}, any>
    export default component
}

=================================================================================
FILE: src/main.ts
LOCATION: .//src/main.ts
=================================================================================

import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'
import router from './router'
import vuetify from './plugins/vuetify'
import { useMetadataStore } from './stores/metadata'
import { useAuthStore } from './stores/auth'
import './assets/main.css'

const app = createApp(App)
const pinia = createPinia()

app.use(pinia)

const authStore = useAuthStore()

// TypeScript wymaga obsłużenia Promise
authStore.initialize().then(async () => {
  app.use(router)
  app.use(vuetify)
  app.mount('#app')

  const metadataStore = useMetadataStore()
  await metadataStore.fetchMetadata()
})

=================================================================================
FILE: src/App.vue
LOCATION: .//src/App.vue
=================================================================================

<template>
  <!-- Jeśli użytkownik zalogowany i nie na stronie logowania -> Użyj MainLayout -->
  <main-layout v-if="showLayout">
    <router-view />
  </main-layout>

  <!-- W przeciwnym razie (Logowanie) -> Sama treść (v-app potrzebne dla Vuetify) -->
  <v-app v-else>
    <router-view />
  </v-app>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { useRoute } from "vue-router";
import { useAuthStore } from "@/stores/auth";
import MainLayout from "@/layouts/MainLayout.vue";

const route = useRoute();
const authStore = useAuthStore();

const showLayout = computed(() => {
  return authStore.isAuthenticated && route.name !== "Login" && route.name !== "LoginPin";
});
</script>


=================================================================================
FILE: src/router/index.ts
LOCATION: .//src/router/index.ts
=================================================================================

// src/router/index.ts
import { createRouter, createWebHistory, type RouteRecordRaw } from 'vue-router'
import { useAuthStore } from '@/stores/auth'

const routes: Array<RouteRecordRaw> = [
  // ============================================================================
  // PRZEKIEROWANIE GŁÓWNE
  // ============================================================================
  {
    path: '/',
    redirect: () => {
      const mode = localStorage.getItem('login_mode')
      if (!mode || mode === 'pin') {
        return '/login-pin'
      }
      return '/login'
    }
  },

  // ============================================================================
  // AUTENTYKACJA
  // ============================================================================
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/auth/Login.vue'),
    meta: {
      guestOnly: true,
      title: 'Logowanie'
    }
  },
  {
    path: '/login-pin',
    name: 'LoginPin',
    component: () => import('@/views/auth/LoginPin.vue'),
    meta: {
      guestOnly: true,
      title: 'Logowanie PIN'
    }
  },

  // ============================================================================
  // DASHBOARD
  // ============================================================================
  {
    path: '/dashboard',
    name: 'Dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: {
      requiresAuth: true,
      title: 'Dashboard'
    }
  },

  // ============================================================================
  // ZAMÓWIENIA (tylko dla zarządzających)
  // ============================================================================
  {
    path: '/orders',
    name: 'OrderList',
    component: () => import('@/views/orders/OrderList.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true, // Flaga: wymaga uprawnień zarządczych
      title: 'Zamówienia'
    }
  },
  {
    path: '/orders/:id',
    name: 'OrderDetail',
    component: () => import('@/views/orders/OrderDetail.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Szczegóły zamówienia'
    }
  },
  {
    path: '/orders/:orderId/variants/:id',
    name: 'VariantDetail',
    component: () => import('@/views/orders/VariantDetail.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Szczegóły Wariantu Produktowej'
    }
  },

  // ============================================================================
  // KLIENCI (tylko dla zarządzających)
  // ============================================================================
  {
    path: '/customers',
    name: 'CustomerList',
    component: () => import('@/views/customers/CustomerList.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Klienci'
    }
  },
  {
    path: '/customers/:id',
    name: 'CustomerDetail',
    component: () => import('@/views/customers/CustomerDetail.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Szczegóły klienta'
    }
  },

  // ============================================================================
  // ASORTYMENT (tylko dla zarządzających)
  // ============================================================================
  {
    path: '/assortment',
    name: 'AssortmentList',
    component: () => import('@/views/assortment/AssortmentList.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Asortyment'
    }
  },

  // ============================================================================
  // PRODUKCJA - PANEL ZARZĄDCZY (tylko dla zarządzających)
  // ============================================================================


  {
    path: '/admin/rcp',
    name: 'RcpManagement',
    component: () => import('@/views/production/RcpManagement.vue'),
    meta: {
      requiresAuth: true,
      title: 'Zarządzanie RCP'
    }
  },

  // ============================================================================
  // STANOWISKA (tylko dla zarządzających)
  // ============================================================================
  {
    path: '/workstations',
    name: 'WorkstationList',
    component: () => import('@/views/workstations/WorkstationList.vue'),
    meta: {
      requiresAuth: true,
      requiresManager: true,
      title: 'Stanowiska Robocze'
    }
  },

  // ============================================================================
  // RCP - PANEL PRACOWNIKA (dostępny dla wszystkich zalogowanych)
  // ============================================================================
  {
    path: '/rcp/workstation',
    name: 'WorkstationSelect',
    component: () => import('@/views/rcp/WorkstationSelect.vue'),
    meta: {
      requiresAuth: true,
      title: 'Wybór stanowiska'
    }
  },
  {
    path: '/rcp/timer/:taskId',
    name: 'Timer',
    component: () => import('@/views/rcp/Timer.vue'),
    meta: {
      requiresAuth: true,
      title: 'Timer zadania'
    }
  },

  {
    path: '/users',
    name: 'UserList',
    component: () => import('@/views/users/UserList.vue'),
    meta: {
      title: 'Użytkownicy',
      requiresAuth: true
    }
  },

  // ============================================================================
  // STRONA 404 (opcjonalnie)
  // ============================================================================
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    redirect: () => {
      const authStore = useAuthStore()
      if (authStore.isAuthenticated) {
        if (authStore.isWorker) {
          return '/rcp/workstation'
        }
        return '/dashboard'
      }
      return '/login'
    }
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// ============================================================================
// NAVIGATION GUARD - Kontrola dostępu
// ============================================================================
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  // Pobierz flagi z meta
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
  const guestOnly = to.matched.some(record => record.meta.guestOnly)
  const requiresManager = to.matched.some(record => record.meta.requiresManager)

  // ---------------------------------------------------------------------------
  // 1. Przekierowanie z Login na LoginPin jeśli tryb PIN
  // ---------------------------------------------------------------------------
  if (!authStore.token && to.name === 'Login') {
    const mode = localStorage.getItem('login_mode')
    if (mode && mode === 'pin') {
      return next({ name: 'LoginPin' })
    }
  }

  // ---------------------------------------------------------------------------
  // 2. Strona wymaga autoryzacji, ale użytkownik nie jest zalogowany
  // ---------------------------------------------------------------------------
  if (requiresAuth && !authStore.token) {
    const mode = localStorage.getItem('login_mode')
    const loginRoute = (mode === 'standard') ? 'Login' : 'LoginPin'

    return next({
      name: loginRoute,
      query: { redirect: to.fullPath }
    })
  }

  // ---------------------------------------------------------------------------
  // 3. Użytkownik ma token ale nie ma danych usera - pobierz je
  // ---------------------------------------------------------------------------
  if (requiresAuth && authStore.token && !authStore.user) {
    try {
      await authStore.fetchUser()
    } catch (err) {
      console.error('Błąd pobierania danych użytkownika:', err)
      await authStore.logout()
      return next({ path: '/' })
    }
  }

  // Zabezpieczenie tras admina
  if (to.path.startsWith('/admin') && !authStore.canManageSystem) {
    return next({ name: 'WorkstationSelect' }) // Przekieruj workera
  }

  // ---------------------------------------------------------------------------
  // 4. Strona tylko dla gości, ale użytkownik jest zalogowany
  // ---------------------------------------------------------------------------
  if (guestOnly && authStore.isAuthenticated) {
    // Pracownicy produkcyjni → Panel RCP
    if (authStore.isWorker) {
      return next({ name: 'WorkstationSelect' })
    }
    // Pozostali (Admin, Manager, Trader, etc.) → Dashboard
    return next({ name: 'Dashboard' })
  }

  // ---------------------------------------------------------------------------
  // 5. Strona wymaga uprawnień zarządczych (requiresManager)
  // ---------------------------------------------------------------------------
  if (requiresManager && authStore.isAuthenticated) {
    // Sprawdź czy użytkownik ma uprawnienia zarządcze
    if (!authStore.canManageSystem) {
      console.warn(`Użytkownik ${authStore.user?.name} nie ma uprawnień do: ${to.path}`)

      // Pracownik produkcyjny → przekieruj do RCP
      if (authStore.isWorker) {
        return next({ name: 'WorkstationSelect' })
      }

      // Inny użytkownik bez uprawnień → Dashboard
      return next({ name: 'Dashboard' })
    }
  }

  // ---------------------------------------------------------------------------
  // 6. Dodatkowa walidacja dla pracowników produkcyjnych
  //    (zabezpieczenie przed ręcznym wpisaniem URL)
  // ---------------------------------------------------------------------------
  if (requiresAuth && authStore.isAuthenticated && authStore.isWorker) {
    // Lista dozwolonych ścieżek dla pracowników produkcyjnych
    const allowedPathsForWorker = [
      '/dashboard',
      '/rcp/workstation',
      '/rcp/timer'
    ]

    // Sprawdź czy ścieżka jest dozwolona
    const isAllowedPath = allowedPathsForWorker.some(path =>
      to.path === path || to.path.startsWith(path + '/')
    )

    if (!isAllowedPath) {
      console.warn(`Pracownik ${authStore.user?.name} próbował wejść na: ${to.path}`)
      return next({ name: 'WorkstationSelect' })
    }
  }

  // ---------------------------------------------------------------------------
  // 7. Aktualizacja tytułu strony (opcjonalnie)
  // ---------------------------------------------------------------------------
  if (to.meta.title) {
    document.title = `${to.meta.title} | CSERP`
  } else {
    document.title = 'CSERP'
  }

  // ---------------------------------------------------------------------------
  // 8. Wszystko OK - kontynuuj nawigację
  // ---------------------------------------------------------------------------
  next()
})

// ============================================================================
// AFTER EACH - Dodatkowe akcje po nawigacji (opcjonalnie)
// ============================================================================
router.afterEach((to, from) => {
  // Można tutaj dodać logowanie, analytics, etc.
  // console.log(`Nawigacja: ${from.path} → ${to.path}`)
})

export default router

=================================================================================
FILE: src/stores/assortment.ts
LOCATION: .//src/stores/assortment.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref } from 'vue'
import { assortmentService } from '@/services/assortmentService'
import type { AssortmentItem } from '@/types'

export const useAssortmentStore = defineStore('assortment', () => {
  const items = ref<AssortmentItem[]>([])
  const currentItem = ref<AssortmentItem | null>(null)
  const categories = ref<string[]>([])
  const history = ref<any[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)

  const fetchItems = async (filters: any = {}) => {
    loading.value = true
    try {
      items.value = await assortmentService.getAll(filters)
    } catch (err) {
      console.error(err)
    } finally {
      loading.value = false
    }
  }

  const fetchCategories = async (type: string | null = null) => {
    try {
      categories.value = await assortmentService.getCategories(type) || []
    } catch (err) {
      console.error(err)
    }
  }

  const createItem = async (data: Partial<AssortmentItem>) => {
    try {
      await assortmentService.create(data)
      await fetchItems()
      // Pobieramy kategorie, bo mogła dojść nowa
      await fetchCategories(data.type || null)
    } catch (err) {
      throw err
    }
  }

  const updateItem = async (id: number, data: Partial<AssortmentItem>) => {
    try {
      await assortmentService.update(id, data)
      await fetchItems()
      await fetchCategories(data.type || null)
    } catch (err) {
      throw err
    }
  }

  const deleteItem = async (id: number) => {
    try {
      await assortmentService.delete(id)
      await fetchItems()
    } catch (err) {
      throw err
    }
  }

  const toggleActive = async (id: number) => {
    try {
      await assortmentService.toggleActive(id)
      await fetchItems()
    } catch (err) {
      throw err
    }
  }

  const fetchHistory = async (id: number) => {
    loading.value = true
    try {
      history.value = await assortmentService.getHistory(id) || []
    } catch (err) {
      console.error('Fetch history error:', err)
      history.value = []
    } finally {
      loading.value = false
    }
  }

  return {
    items,
    currentItem,
    categories,
    history,
    loading,
    error,
    fetchItems,
    fetchCategories,
    createItem,
    updateItem,
    deleteItem,
    toggleActive,
    fetchHistory
  }
})

=================================================================================
FILE: src/stores/auth.ts
LOCATION: .//src/stores/auth.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { authService } from '@/services/authService'
import { UserRole } from '@/enums/UserRole' // Upewnij się, że masz ten enum
import router from '@/router'
import type { User } from '@/types'

export const useAuthStore = defineStore('auth', () => {
  const user = ref<User | null>(null)
  const token = ref<string | null>(localStorage.getItem('auth_token'))
  const loading = ref(false)
  const error = ref<string | null>(null)

  const isAuthenticated = computed(() => !!token.value && !!user.value)

  const canManageSystem = computed(() => {
    if (!user.value?.role) return false
    const role = user.value.role.toUpperCase()
    return [
      UserRole.ADMIN,
      UserRole.PROJECT_MANAGER,
      UserRole.TRADER,
      UserRole.LOGISTICS_SPECIALIST
    ].includes(role)
  })

  const isWorker = computed(() => {
    if (!user.value?.role) return false
    return user.value.role.toUpperCase() === UserRole.PRODUCTION_EMPLOYEE
  })

  const isAdmin = computed(() => {
    if (!user.value?.role) return false
    return user.value.role.toUpperCase() === UserRole.ADMIN
  })

  const initialize = async (): Promise<boolean> => {
    if (!token.value) return false
    try {
      await fetchUser()
      return true
    } catch (err) {
      await logout()
      return false
    }
  }

  const login = async (email: string, password: string): Promise<boolean> => {
    loading.value = true
    error.value = null
    try {
      const data = await authService.login(email, password)
      if (!data.token || !data.user) throw new Error('Błąd odpowiedzi')

      token.value = data.token
      user.value = data.user

      localStorage.setItem('auth_token', data.token)
      localStorage.setItem('login_mode', 'standard')

      return true
    } catch (err: any) {
      error.value = err.response?.data?.message || 'Błąd logowania'
      return false
    } finally {
      loading.value = false
    }
  }

  const loginWithPin = async (pin: string): Promise<boolean> => {
    loading.value = true
    error.value = null
    try {
      const data = await authService.loginPin(pin)

      if (!data.token || !data.user) throw new Error('Błąd odpowiedzi')

      token.value = data.token
      user.value = data.user

      localStorage.setItem('auth_token', data.token)
      localStorage.setItem('login_mode', 'pin')

      return true
    } catch (err: any) {
      console.error(err)
      error.value = err.response?.data?.message || 'Nieprawidłowy kod PIN'
      return false
    } finally {
      loading.value = false
    }
  }

  const logout = async () => {
    try {
      const targetRoute = 'Login'
      // const currentMode = localStorage.getItem('login_mode')

      // if (!currentMode || currentMode === 'pin') {
      //   targetRoute = 'LoginPin'
      // } else {
      //   targetRoute = 'Login'
      // }

      if (token.value) await authService.logout()

      router.push({ name: targetRoute })

    } catch (err) {
      console.error('Logout error', err)
    } finally {
      token.value = null
      user.value = null
      error.value = null
      localStorage.removeItem('auth_token')
    }
  }

  const fetchUser = async () => {
    if (!token.value) throw new Error('Brak tokena')
    const userData = await authService.getUser()
    user.value = userData
    return userData
  }

  return {
    user,
    token,
    loading,
    error,
    isAuthenticated,
    isAdmin,
    canManageSystem,
    isWorker,
    initialize,
    login,
    loginWithPin,
    logout,
    fetchUser
  }
})

=================================================================================
FILE: src/stores/layout.ts
LOCATION: .//src/stores/layout.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref } from 'vue'

interface PageInfo {
  title?: string;
  subtitle?: string;
  icon?: string;
  iconColor?: string;
  breadcrumbs?: any[];
}

export const useLayoutStore = defineStore('layout', () => {
  // Page info
  const pageTitle = ref('Dashboard')
  const pageSubtitle = ref('')
  const pageIcon = ref('mdi-view-dashboard')
  const pageIconColor = ref('primary')
  const breadcrumbs = ref<any[]>([])

  // Actions
  const setPageInfo = (info: PageInfo) => {
    if (info.title) pageTitle.value = info.title
    if (info.subtitle !== undefined) pageSubtitle.value = info.subtitle
    if (info.icon) pageIcon.value = info.icon
    if (info.iconColor) pageIconColor.value = info.iconColor
    if (info.breadcrumbs) breadcrumbs.value = info.breadcrumbs
  }

  const resetPageInfo = () => {
    pageTitle.value = 'Dashboard'
    pageSubtitle.value = ''
    pageIcon.value = 'mdi-view-dashboard'
    pageIconColor.value = 'primary'
    breadcrumbs.value = []
  }

  return {
    pageTitle,
    pageSubtitle,
    pageIcon,
    pageIconColor,
    breadcrumbs,
    setPageInfo,
    resetPageInfo
  }
})

=================================================================================
FILE: src/stores/metadata.ts
LOCATION: .//src/stores/metadata.ts
=================================================================================

import { defineStore } from 'pinia'
import api from '@/services/api'
import {
    ORDER_STATUSES,
    PAYMENT_STATUSES,
    ORDER_PRIORITIES,
    ASSORTMENT_TYPES,
    WORKSTATION_TYPES,
    WORKSTATION_STATUSES,
    PRODUCTION_STATUSES,
    TEST_RESULTS,
    EVENT_TYPES,
    DELIVERY_STATUSES,
    INVOICE_STATUSES,
    PAYMENT_METHODS,
    ASSORTMENT_HISTORY_ACTIONS,
    USER_ROLES,
    CUSTOMER_TYPES,
    MATERIAL_STATUSES,
    VARIANT_STATUSES, // NOWY IMPORT
    VARIANT_TYPES, // NOWY IMPORT
} from '@/config/statusMappings'

interface MetadataItem {
    value: string;
    label: string;
    color?: string;
    icon?: string;
}

interface MetadataState {
    userRoles: MetadataItem[];
    customerTypes: MetadataItem[];
    assortmentTypes: MetadataItem[];
    units: any[];
    orderStatuses: MetadataItem[];
    paymentStatuses: MetadataItem[];
    orderPriorities: MetadataItem[];
    workstationTypes: MetadataItem[];
    workstationStatuses: MetadataItem[];
    productionStatuses: MetadataItem[];
    testResults: MetadataItem[];
    eventTypes: MetadataItem[];
    deliveryStatuses: MetadataItem[];
    invoiceStatuses: MetadataItem[];
    paymentMethods: MetadataItem[];
    assortmentHistoryActions: MetadataItem[];
    materialStatuses: MetadataItem[];
    categories: any[];

    // NOWE
    variantTypes: MetadataItem[];
    variantStatuses: MetadataItem[];

    loaded: boolean;
}

export const useMetadataStore = defineStore('metadata', {
    state: (): MetadataState => ({
        userRoles: [],
        customerTypes: [],
        assortmentTypes: [],
        units: [],
        orderStatuses: [],
        paymentStatuses: [],
        orderPriorities: [],
        workstationTypes: [],
        workstationStatuses: [],
        productionStatuses: [],
        testResults: [],
        eventTypes: [],
        deliveryStatuses: [],
        invoiceStatuses: [],
        paymentMethods: [],
        assortmentHistoryActions: [],
        materialStatuses: [],
        categories: [],

        variantTypes: [],
        variantStatuses: [],

        loaded: false
    }),

    actions: {
        async fetchMetadata() {
            if (this.loaded) return

            try {
                const { data } = await api.get('/metadata')

                const merge = (apiData: any[], uiConfig: any) => {
                    return apiData.map(item => ({
                        value: item.value,
                        label: item.label,
                        // Fix: sprawdź czy uiConfig[item.value] istnieje
                        color: uiConfig[item.value]?.color || item.color || 'grey',
                        icon: uiConfig[item.value]?.icon || item.icon || 'mdi-circle-small'
                    }))
                }

                // ... mapowania ...
                this.userRoles = merge(data.user_roles || [], USER_ROLES)
                this.customerTypes = merge(data.customer_types || [], CUSTOMER_TYPES)
                this.assortmentTypes = merge(data.assortment_types || [], ASSORTMENT_TYPES)
                this.units = data.units || []

                this.orderStatuses = merge(data.order_statuses || [], ORDER_STATUSES)
                this.paymentStatuses = merge(data.payment_statuses || [], PAYMENT_STATUSES)
                this.orderPriorities = merge(data.order_priorities || [], ORDER_PRIORITIES)

                this.workstationTypes = merge(data.workstation_types || [], WORKSTATION_TYPES)
                this.workstationStatuses = merge(data.workstation_statuses || [], WORKSTATION_STATUSES)

                this.productionStatuses = merge(data.production_statuses || [], PRODUCTION_STATUSES)
                this.testResults = merge(data.test_results || [], TEST_RESULTS)
                this.eventTypes = merge(data.event_types || [], EVENT_TYPES)

                this.deliveryStatuses = merge(data.delivery_statuses || [], DELIVERY_STATUSES)
                this.invoiceStatuses = merge(data.invoice_statuses || [], INVOICE_STATUSES)
                this.paymentMethods = merge(data.payment_methods || [], PAYMENT_METHODS)

                this.assortmentHistoryActions = merge(data.assortment_history_actions || [], ASSORTMENT_HISTORY_ACTIONS)
                this.materialStatuses = merge(data.material_statuses || [], MATERIAL_STATUSES)

                this.categories = data.assortment_categories || []

                // NOWE: Variant Metadata
                this.variantTypes = merge(data.variant_types || [], VARIANT_TYPES);
                this.variantStatuses = merge(data.variant_statuses || [], VARIANT_STATUSES);

                this.loaded = true
            } catch (e) {
                console.error('Błąd pobierania metadanych:', e)
            }
        },

        getConfig(groupName: keyof MetadataState, value: string) {
            if (!value || !this[groupName]) return null
            const group = this[groupName] as any[]
            const normalizedValue = String(value).toLowerCase()
            const found = group.find(item =>
                String(item.value).toLowerCase() === normalizedValue
            )
            return found || null
        },

        getLabel(groupName: keyof MetadataState, value: string) {
            const config = this.getConfig(groupName, value)
            return config ? config.label : (value || '-')
        },

        getColor(groupName: keyof MetadataState, value: string, defaultColor = 'grey') {
            const config = this.getConfig(groupName, value)
            return config ? config.color : defaultColor
        },

        getIcon(groupName: keyof MetadataState, value: string, defaultIcon = 'mdi-circle-small') {
            const config = this.getConfig(groupName, value)
            return config ? config.icon : defaultIcon
        }
    }
})

=================================================================================
FILE: src/stores/orders.ts
LOCATION: .//src/stores/orders.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { orderService } from '@/services/orderService'
import { useSharedApiState } from '@/composables/useApiAction'
import type { Order } from '@/types'

export const useOrdersStore = defineStore('orders', () => {
  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------

  const orders = ref<Order[]>([])
  const currentOrder = ref<Order | null>(null)

  // Wspólny stan loading/error dla wszystkich akcji tego store
  // PRZED: loading i error były ref(false)/ref(null) definiowane osobno,
  //        a każda z 5 akcji miała identyczny try/catch/finally
  const { loading, error, wrapAction } = useSharedApiState()

  // ---------------------------------------------------------------------------
  // COMPUTED
  // ---------------------------------------------------------------------------

  const activeOrders = computed(() =>
    orders.value.filter(o => !['completed', 'cancelled'].includes(o.overall_status))
  )

  const completedOrders = computed(() =>
    orders.value.filter(o => o.overall_status === 'completed')
  )

  // ---------------------------------------------------------------------------
  // ACTIONS (przez wrapAction — automatyczny loading/error handling)
  // ---------------------------------------------------------------------------

  /** Pobierz listę zamówień z opcjonalnymi filtrami */
  const fetchOrders = wrapAction(
    async (params: Record<string, any> = {}) => {
      const response = await orderService.getAll(params)
      orders.value = Array.isArray(response.data) ? response.data : []
      return orders.value
    },
    'Błąd pobierania zamówień'
  )

  /** Pobierz szczegóły jednego zamówienia */
  const fetchOrder = wrapAction(
    async (id: number | string) => {
      const response = await orderService.getById(id)
      currentOrder.value = response
      return currentOrder.value
    },
    'Błąd pobierania zamówienia'
  )

  /** Utwórz nowe zamówienie */
  const createOrder = wrapAction(
    async (orderData: Partial<Order>) => {
      const newOrder = await orderService.create(orderData)
      orders.value.unshift(newOrder)
      return newOrder
    },
    'Błąd tworzenia zamówienia'
  )

  /** Zaktualizuj istniejące zamówienie */
  const updateOrder = wrapAction(
    async (id: number | string, data: Partial<Order>) => {
      const updated = await orderService.update(id, data)

      // Aktualizuj w liście
      const index = orders.value.findIndex(o => o.id === Number(id))
      if (index !== -1) orders.value[index] = updated

      // Aktualizuj bieżące (jeśli to ono)
      if (currentOrder.value?.id === Number(id)) currentOrder.value = updated

      return updated
    },
    'Błąd aktualizacji zamówienia'
  )

  /** Usuń zamówienie */
  const deleteOrder = wrapAction(
    async (id: number | string) => {
      await orderService.delete(id)
      orders.value = orders.value.filter(o => o.id !== Number(id))
    },
    'Błąd usuwania zamówienia'
  )

  return {
    // State
    orders,
    currentOrder,
    loading,
    error,

    // Computed
    activeOrders,
    completedOrders,

    // Actions
    fetchOrders,
    fetchOrder,
    createOrder,
    updateOrder,
    deleteOrder,
  }
})

=================================================================================
FILE: src/stores/quotations.ts
LOCATION: .//src/stores/quotations.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { quotationService } from '@/services/quotationService'
import type { AssortmentItem } from '@/types'

export const useQuotationsStore = defineStore('quotations', () => {
  // =========================================================================
  // STATE
  // =========================================================================

  const quotations = ref<any[]>([])
  const currentQuotation = ref<any>(null)
  const materials = ref<AssortmentItem[]>([])
  const services = ref<AssortmentItem[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)

  // =========================================================================
  // COMPUTED
  // =========================================================================

  /** Zatwierdzona wycena (jeśli istnieje) */
  const approvedQuotation = computed(() => {
    if (!Array.isArray(quotations.value)) return null
    return quotations.value.find(q => q.is_approved) ?? null
  })

  /** Najwyższy numer wersji na liście */
  const latestVersion = computed(() => {
    if (!Array.isArray(quotations.value) || quotations.value.length === 0) return 0
    return Math.max(...quotations.value.map(q => q.version_number))
  })

  // =========================================================================
  // ACTIONS — POBIERANIE
  // =========================================================================

  /** Pobierz wszystkie wyceny wariantu */
  const fetchQuotations = async (variantId: number | string) => {
    loading.value = true
    error.value = null
    try {
      const response = await quotationService.getAll(variantId)
      quotations.value = response
    } catch (err: any) {
      console.error('Fetch quotations error:', err)
      error.value = err.response?.data?.message || 'Błąd pobierania wycen'
      quotations.value = []
    } finally {
      loading.value = false
    }
  }

  /** Pobierz szczegóły pojedynczej wyceny */
  const fetchQuotation = async (id: number | string) => {
    loading.value = true
    error.value = null
    try {
      const response = await quotationService.getById(id)
      currentQuotation.value = response
      return currentQuotation.value
    } catch (err: any) {
      console.error('Fetch quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd pobierania wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // ACTIONS — ZAPIS / EDYCJA
  // =========================================================================

  /** Utwórz nową wycenę dla wariantu */
  const createQuotation = async (variantId: number | string, data: any) => {
    loading.value = true
    error.value = null
    try {
      const newQuotation = await quotationService.create(variantId, data)
      if (Array.isArray(quotations.value)) {
        quotations.value.push(newQuotation)
      } else {
        quotations.value = [newQuotation]
      }
      return newQuotation
    } catch (err: any) {
      console.error('Create quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd tworzenia wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  /** Zaktualizuj istniejącą wycenę */
  const updateQuotation = async (id: number | string, data: any) => {
    loading.value = true
    error.value = null
    try {
      const updatedQuotation = await quotationService.update(id, data)

      // Aktualizuj lokalną listę
      if (Array.isArray(quotations.value)) {
        const index = quotations.value.findIndex(q => q.id === id)
        if (index !== -1) {
          quotations.value[index] = updatedQuotation
        }
      }

      // Jeśli edytujemy aktualnie otwartą wycenę, zaktualizuj ją też
      if (currentQuotation.value?.id === id) {
        currentQuotation.value = updatedQuotation
      }

      return updatedQuotation
    } catch (err: any) {
      console.error('Update quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd aktualizacji wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  /** Zatwierdź wycenę */
  const approveQuotation = async (id: number | string) => {
    loading.value = true
    error.value = null
    try {
      const approved = await quotationService.approve(id)

      // Odznacz wszystkie, zatwierdź tę jedną
      if (Array.isArray(quotations.value)) {
        quotations.value = quotations.value.map(q => ({
          ...q,
          is_approved: q.id === id
        }))
      }

      return approved
    } catch (err: any) {
      console.error('Approve quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd zatwierdzania wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  /** Usuń wycenę */
  const deleteQuotation = async (id: number | string) => {
    loading.value = true
    error.value = null
    try {
      await quotationService.delete(id)

      if (Array.isArray(quotations.value)) {
        const numId = Number(id)
        quotations.value = quotations.value.filter(q => q.id !== numId)
      }
    } catch (err: any) {
      console.error('Delete quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd usuwania wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // ACTIONS — DUPLIKOWANIE
  // =========================================================================

  /**
   * Duplikuj wycenę — tworzy nową wersję z tymi samymi pozycjami.
   * Nowa wersja jest zawsze niezatwierdzona.
   */
  const duplicateQuotation = async (quotationId: number | string) => {
    loading.value = true
    error.value = null
    try {
      const result = await quotationService.duplicate(quotationId)

      // Dodaj nową wersję do lokalnej listy
      if (Array.isArray(quotations.value)) {
        quotations.value.push(result.quotation)
      }

      return result.quotation
    } catch (err: any) {
      console.error('Duplicate quotation error:', err)
      error.value = err.response?.data?.message || 'Błąd duplikowania wyceny'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // ACTIONS — EKSPORT MATERIAŁÓW
  // =========================================================================

  /**
   * Eksportuj materiały z zatwierdzonej wyceny do listy materiałów wariantu.
   *
   * @param quotationId  - ID wyceny (musi być zatwierdzona)
   * @param mode         - Tryb obsługi duplikatów:
   *                        'skip'    – pomija istniejące (domyślny)
   *                        'merge'   – sumuje ilości z istniejącymi
   *                        'replace' – nadpisuje istniejące
   */
  const exportMaterials = async (
    quotationId: number | string,
    mode: 'skip' | 'merge' | 'replace' = 'skip'
  ) => {
    loading.value = true
    error.value = null
    try {
      const result = await quotationService.exportMaterials(quotationId, mode)
      return result
    } catch (err: any) {
      console.error('Export materials error:', err)
      error.value = err.response?.data?.message || 'Błąd eksportu materiałów'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // ACTIONS — KATALOG (ASORTYMENT)
  // =========================================================================

  /** Pobierz listę materiałów z katalogu */
  const fetchMaterials = async () => {
    try {
      materials.value = await quotationService.getMaterials()
    } catch (err) {
      console.error('Fetch materials error:', err)
      materials.value = []
    }
  }

  /** Pobierz listę usług z katalogu */
  const fetchServices = async () => {
    try {
      services.value = await quotationService.getServices()
    } catch (err) {
      console.error('Fetch services error:', err)
      services.value = []
    }
  }

  // =========================================================================
  // ACTIONS — PDF
  // =========================================================================

  /** Pobierz PDF wyceny jako blob */
  const downloadPdf = async (id: number | string) => {
    try {
      return await quotationService.downloadPDF(id)
    } catch (err) {
      console.error('Download PDF error:', err)
      throw err
    }
  }

  // =========================================================================
  // RETURN
  // =========================================================================

  return {
    // State
    quotations,
    currentQuotation,
    materials,
    services,
    loading,
    error,

    // Computed
    approvedQuotation,
    latestVersion,

    // Actions
    fetchQuotations,
    fetchQuotation,
    createQuotation,
    updateQuotation,
    approveQuotation,
    deleteQuotation,
    duplicateQuotation,
    exportMaterials,
    fetchMaterials,
    fetchServices,
    downloadPdf,
  }
})

=================================================================================
FILE: src/stores/rcpAdmin.ts
LOCATION: .//src/stores/rcpAdmin.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref } from 'vue'
import rcpAdminService from '@/services/rcpAdminService'
export const useRcpAdminStore = defineStore('rcpAdmin', () => {
    const tasks = ref<any[]>([])
    const totalTasks = ref(0)
    const loading = ref(false)
    const currentPage = ref(1)
    const lastPage = ref(1)
    // Filtry (zaktualizowane o zakres dat)
    const filters = ref({
        status: 'all',
        search: '',
        worker_id: null,
        workstation_id: null,
        date_from: null,
        date_to: null
    })
    const fetchTasks = async (page = 1) => {
        loading.value = true
        try {
            const params = {
                page,
                ...filters.value
            }
            // Usuń puste filtry
            if (!params.search) delete params.search
            if (params.status === 'all') delete params.status
            if (!params.worker_id) delete params.worker_id
            if (!params.workstation_id) delete params.workstation_id
            if (!params.date_from) delete params.date_from
            if (!params.date_to) delete params.date_to

            const response = await rcpAdminService.getTasks(params)

            tasks.value = response.data
            totalTasks.value = response.total
            currentPage.value = response.current_page
            lastPage.value = response.last_page
        } catch (error) {
            console.error('Błąd pobierania zadań RCP:', error)
        } finally {
            loading.value = false
        }
    }
    const updateFilters = (newFilters: any) => {
        filters.value = { ...filters.value, ...newFilters }
        fetchTasks(1) // Reset do strony 1 przy zmianie filtrów
    }
    return {
        tasks,
        totalTasks,
        loading,
        currentPage,
        lastPage,
        filters,
        fetchTasks,
        updateFilters
    }
})

=================================================================================
FILE: src/stores/timer.ts
LOCATION: .//src/stores/timer.ts
=================================================================================

// src/stores/timer.ts
// =============================================================================
// STORE: timer
// =============================================================================
// Zmiany względem oryginału:
// - formattedTime computed → formatDuration z useFormatters
//   (eliminuje trzecią kopię logiki padStart: była tu, w useTimer.ts i VariantDetail.vue)
// - Dodana metoda setElapsed() do resync z backendem (np. po refresh strony)
// =============================================================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { formatDuration } from '@/composables/useFormatters'

export const useTimerStore = defineStore('timer', () => {
  // ---------------------------------------------------------------------------
  // STATE
  // ---------------------------------------------------------------------------

  const activeTask = ref<any>(null)
  const elapsedSeconds = ref(0)
  const isRunning = ref(false)
  const isPaused = ref(false)

  let intervalId: ReturnType<typeof setInterval> | null = null

  // ---------------------------------------------------------------------------
  // COMPUTED
  // ---------------------------------------------------------------------------

  // PRZED: ręczna logika padStart (identyczna kopia jak w useTimer.ts i VariantDetail.vue)
  // PO: jedna funkcja z useFormatters
  const formattedTime = computed(() => formatDuration(elapsedSeconds.value))

  // ---------------------------------------------------------------------------
  // ACTIONS
  // ---------------------------------------------------------------------------

  // Wewnętrzna funkcja uruchamiająca interval (DRY względem startTimer/resumeTimer)
  const _startInterval = () => {
    if (intervalId) clearInterval(intervalId)
    intervalId = setInterval(() => {
      elapsedSeconds.value++
    }, 1000)
  }

  /** Rozpocznij timer dla zadania */
  function startTimer(task: any): void {
    activeTask.value = task
    isRunning.value = true
    isPaused.value = false
    elapsedSeconds.value = 0

    _startInterval()
  }

  /** Wstrzymaj timer */
  function pauseTimer(): void {
    isPaused.value = true

    if (intervalId) {
      clearInterval(intervalId)
      intervalId = null
    }
  }

  /** Wznów timer po przerwie */
  function resumeTimer(): void {
    isPaused.value = false
    _startInterval()
  }

  /** Zatrzymaj timer i wyczyść stan */
  function stopTimer(): void {
    isRunning.value = false
    isPaused.value = false
    activeTask.value = null
    elapsedSeconds.value = 0

    if (intervalId) {
      clearInterval(intervalId)
      intervalId = null
    }
  }

  /**
   * Ustaw czas z zewnątrz (np. po powrocie na stronę po refresh).
   * Backend może zwrócić aktualny elapsed_seconds — użyj tej metody
   * żeby zsynchronizować wyświetlany czas.
   */
  function setElapsed(seconds: number): void {
    elapsedSeconds.value = seconds
  }

  return {
    // State
    activeTask,
    elapsedSeconds,
    isRunning,
    isPaused,

    // Computed
    formattedTime,

    // Actions
    startTimer,
    pauseTimer,
    resumeTimer,
    stopTimer,
    setElapsed,
  }
})

=================================================================================
FILE: src/stores/users.ts
LOCATION: .//src/stores/users.ts
=================================================================================


import { defineStore } from 'pinia'
import { ref } from 'vue'
import { userService } from '@/services/userService'
import type { User } from '@/types'

export const useUsersStore = defineStore('users', () => {
    const items = ref<User[]>([])
    const loading = ref(false)
    const error = ref<string | null>(null)

    const fetchUsers = async (params: any = {}) => {
        loading.value = true
        error.value = null
        try {
            // Service teraz bezpiecznie zwraca tablicę, nawet przy paginacji
            const data = await userService.getAll(params)
            items.value = data
        } catch (err: any) {
            console.error(err)
            error.value = err.response?.data?.message || 'Błąd pobierania użytkowników'
            items.value = [] // Resetuj do pustej tablicy w przypadku błędu
        } finally {
            loading.value = false
        }
    }

    const createUser = async (data: Partial<User>) => {
        loading.value = true
        try {
            await userService.create(data)
            await fetchUsers()
        } catch (err: any) {
            throw err
        } finally {
            loading.value = false
        }
    }

    const updateUser = async (id: number | string, data: Partial<User>) => {
        loading.value = true
        try {
            await userService.update(id, data)
            await fetchUsers()
        } catch (err: any) {
            throw err
        } finally {
            loading.value = false
        }
    }

    const toggleActive = async (user: User) => {
        try {
            await userService.toggleActive(user.id)
            await fetchUsers()
        } catch (err: any) {
            throw err
        }
    }

    const deleteUser = async (id: number | string) => {
        loading.value = true
        try {
            await userService.delete(id)
            await fetchUsers()
        } catch (err: any) {
            throw err
        } finally {
            loading.value = false
        }
    }

    return {
        items,
        loading,
        error,
        fetchUsers,
        createUser,
        updateUser,
        toggleActive,
        deleteUser
    }
})


=================================================================================
FILE: src/stores/variants.ts
LOCATION: .//src/stores/variants.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { variantService } from '@/services/variantService'
import type { Variant } from '@/types'

export const useVariantsStore = defineStore('variants', () => {
  // =========================================================================
  // STATE
  // =========================================================================

  /** Płaska lista wszystkich elementów (grupy + warianty) dla zamówienia */
  const variants = ref<Variant[]>([])
  const currentVariant = ref<Variant | null>(null)
  const prototypes = ref<any[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)

  // =========================================================================
  // COMPUTED — PODZIAŁ NA GRUPY I WARIANTY
  // =========================================================================

  /**
   * Tylko elementy będące grupami (quantity === 0, is_group === true).
   * Grupy to kontenery — nie są produkowane.
   */
  const groups = computed(() =>
    variants.value.filter(v => v.is_group || v.quantity === 0)
  )

  /**
   * Tylko elementy będące wariantami (quantity >= 1).
   * Warianty mają lifecycle produkcji.
   */
  const onlyVariants = computed(() =>
    variants.value.filter(v => !v.is_group && v.quantity > 0)
  )

  // =========================================================================
  // POBIERANIE
  // =========================================================================

  /** Pobierz wszystkie elementy (grupy + warianty) dla zamówienia */
  const fetchVariants = async (orderId: number | string) => {
    loading.value = true
    error.value = null
    try {
      const response = await variantService.getAll(orderId)
      variants.value = response
    } catch (err: any) {
      console.error('Fetch variants error:', err)
      error.value = err.response?.data?.message || 'Błąd pobierania wariantów'
      variants.value = []
    } finally {
      loading.value = false
    }
  }

  /** Pobierz szczegóły pojedynczego elementu (grupy lub wariantu) */
  const fetchVariant = async (id: number | string) => {
    loading.value = true
    error.value = null
    try {
      const response = await variantService.getById(id)
      currentVariant.value = response
      return currentVariant.value
    } catch (err: any) {
      console.error('Fetch variant error:', err)
      error.value = err.response?.data?.message || 'Błąd pobierania wariantu'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // TWORZENIE
  // =========================================================================

  /**
   * Utwórz nową GRUPĘ dla zamówienia.
   * Backend automatycznie nadaje kolejną literę (A, B, C...) i ustawia quantity=0.
   */
  const createGroup = async (
    orderId: number | string,
    data: { name: string; description?: string }
  ) => {
    loading.value = true
    error.value = null
    try {
      const newGroup = await variantService.createGroup(orderId, data)
      variants.value.push(newGroup)
      return newGroup
    } catch (err: any) {
      console.error('Create group error:', err)
      error.value = err.response?.data?.message || 'Błąd tworzenia grupy'
      throw err
    } finally {
      loading.value = false
    }
  }

  /**
   * Utwórz WARIANT jako dziecko grupy lub wariantu.
   * Backend nadaje numer: A → A1, A2; A1 → A1_1, A1_2.
   */
  const createChildVariant = async (
    orderId: number | string,
    parentId: number | string,
    data: {
      name: string
      quantity: number
      type: 'SERIAL' | 'PROTOTYPE'
      description?: string
    }
  ) => {
    loading.value = true
    error.value = null
    try {
      const newVariant = await variantService.createChild(orderId, parentId, data)
      variants.value.push(newVariant)
      return newVariant
    } catch (err: any) {
      console.error('Create child variant error:', err)
      error.value = err.response?.data?.message || 'Błąd tworzenia wariantu'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // EDYCJA
  // =========================================================================

  /** Zaktualizuj grupę lub wariant */
  const updateVariant = async (id: number | string, data: Partial<Variant>) => {
    loading.value = true
    error.value = null
    try {
      const updated = await variantService.update(id, data)

      // Aktualizuj w liście
      if (Array.isArray(variants.value)) {
        const index = variants.value.findIndex(l => l.id === Number(id))
        if (index !== -1) variants.value[index] = updated
      }

      // Aktualizuj bieżący jeśli to on
      if (currentVariant.value?.id === Number(id)) {
        currentVariant.value = updated
      }

      return updated
    } catch (err: any) {
      console.error('Update variant error:', err)
      error.value = err.response?.data?.message || 'Błąd aktualizacji'
      throw err
    } finally {
      loading.value = false
    }
  }

  /** Zmień status wariantu (nie dot. grup) */
  const updateStatus = async (id: number | string, status: string) => {
    loading.value = true
    error.value = null
    try {
      const updated = await variantService.updateStatus(id, status)

      if (Array.isArray(variants.value)) {
        const numId = Number(id)
        const index = variants.value.findIndex(l => l.id === numId)
        if (index !== -1) variants.value[index] = updated
      }
      if (currentVariant.value?.id === Number(id)) {
        currentVariant.value = updated
      }

      return updated
    } catch (err: any) {
      console.error('Update status error:', err)
      error.value = err.response?.data?.message || 'Błąd zmiany statusu'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // USUWANIE
  // =========================================================================

  /**
   * Usuń wariant lub grupę.
   *
   * @param id     - ID elementu
   * @param force  - Wymagane dla grup z dziećmi (kasuje całe drzewo rekurencyjnie)
   */
  const deleteVariant = async (id: number | string, force = false) => {
    loading.value = true
    error.value = null
    try {
      await variantService.delete(id, force)

      // Usuń z listy — przy force=true usuń też wszystkich potomków
      if (force) {
        // Rekurencyjnie wyznacz ID wszystkich potomków
        const toRemove = new Set<number>()
        const collectDescendants = (parentId: number) => {
          toRemove.add(parentId)
          variants.value
            .filter(v => v.parent_variant_id === parentId)
            .forEach(child => collectDescendants(child.id))
        }
        collectDescendants(Number(id))
        variants.value = variants.value.filter(v => !toRemove.has(v.id))
      } else {
        const numId = Number(id)
        variants.value = variants.value.filter(l => l.id !== numId)
      }
    } catch (err: any) {
      console.error('Delete variant error:', err)
      error.value = err.response?.data?.message || 'Błąd usuwania'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // RECENZJA PROTOTYPU
  // =========================================================================

  /** Zatwierdź lub odrzuć prototyp z opcjonalnym feedbackiem */
  const reviewPrototype = async (
    id: number | string,
    action: 'approve' | 'reject',
    feedback: string
  ) => {
    loading.value = true
    try {
      const updated = await variantService.reviewPrototype(id, action, feedback)
      if (currentVariant.value?.id === Number(id)) {
        currentVariant.value = updated
      }
      return updated
    } catch (err: any) {
      error.value = err.response?.data?.message || 'Błąd recenzji prototypu'
      throw err
    } finally {
      loading.value = false
    }
  }

  // =========================================================================
  // POMOCNICZE
  // =========================================================================

  /**
   * Zwróć dzieci (warianty) należące do danej grupy/wariantu.
   */
  const getChildren = (parentId: number): Variant[] =>
    variants.value.filter(v => v.parent_variant_id === parentId)

  return {
    // Stan
    variants,
    currentVariant,
    prototypes,
    loading,
    error,

    // Computed
    groups,
    onlyVariants,

    // Pobieranie
    fetchVariants,
    fetchVariant,

    // Tworzenie
    createGroup,
    createChildVariant,

    // Edycja
    updateVariant,
    updateStatus,

    // Usuwanie
    deleteVariant,

    // Recenzja
    reviewPrototype,

    // Pomocnicze
    getChildren,
  }
})

=================================================================================
FILE: src/stores/workstations.ts
LOCATION: .//src/stores/workstations.ts
=================================================================================

import { defineStore } from 'pinia'
import { ref } from 'vue'
import { workstationService } from '@/services/workstationService'
import api from '@/services/api'
import type { Workstation, User } from '@/types'

export const useWorkstationStore = defineStore('workstations', () => {
    const items = ref < Workstation[] > ([])
    const myItems = ref < Workstation[] > ([])
    const workers = ref < User[] > ([])
    const currentWorkstationServices = ref < any[] > ([])
    const loading = ref(false)
    const error = ref < string | null > (null)

    const fetchWorkstations = async () => {
        loading.value = true
        try {
            const data = await workstationService.getAll()
            items.value = data
        } catch (err: any) {
            console.error(err)
            error.value = 'Błąd pobierania stanowisk'
        } finally {
            loading.value = false
        }
    }

    const fetchMyWorkstations = async () => {
        loading.value = true
        try {
            const response = await api.get('/workstations-my-list')
            const data = response.data
            myItems.value = Array.isArray(data) ? data : (data as any).data || []
        } catch (err) {
            console.error(err)
        } finally {
            loading.value = false
        }
    }

    const fetchWorkers = async () => {
        try {
            const response = await api.get('/workers-list')
            const data = response.data
            workers.value = Array.isArray(data) ? data : (data as any).data || []
        } catch (err) {
            console.error('Błąd pobierania pracowników:', err)
        }
    }

    const createWorkstation = async (data: Partial<Workstation>) => {
        loading.value = true
        try {
            await workstationService.create(data)
            await fetchWorkstations()
        } finally {
            loading.value = false
        }
    }

    const updateWorkstation = async (id: number | string, data: Partial<Workstation>) => {
        loading.value = true
        try {
            await workstationService.update(id, data)
            await fetchWorkstations()
        } finally {
            loading.value = false
        }
    }

    const deleteWorkstation = async (id: number | string) => {
        loading.value = true
        try {
            await workstationService.delete(id)
            // Rzutowanie na number dla filtra
            const numId = Number(id)
            items.value = items.value.filter(i => i.id !== numId)
        } finally {
            loading.value = false
        }
    }

    // --- USŁUGI ---
    const fetchWorkstationServices = async (workstationId: number | string) => {
        try {
            const services = await workstationService.getAssignedServices(workstationId)
            currentWorkstationServices.value = services
        } catch (err) {
            console.error('Błąd pobierania usług stanowiska:', err)
            currentWorkstationServices.value = []
        }
    }

    const attachService = async (workstationId: number | string, assortmentId: number | string) => {
        try {
            await workstationService.attachService(workstationId, assortmentId)
            await fetchWorkstationServices(workstationId)
        } catch (err) {
            throw err
        }
    }

    const detachService = async (workstationId: number | string, assortmentId: number | string) => {
        try {
            await workstationService.detachService(workstationId, assortmentId)
            await fetchWorkstationServices(workstationId)
        } catch (err) {
            throw err
        }
    }

    return {
        items,
        myItems,
        workers,
        currentWorkstationServices,
        loading,
        error,
        fetchWorkstations,
        fetchMyWorkstations,
        fetchWorkers,
        createWorkstation,
        updateWorkstation,
        deleteWorkstation,
        fetchWorkstationServices,
        attachService,
        detachService
    }
})

=================================================================================
FILE: src/services/api.ts
LOCATION: .//src/services/api.ts
=================================================================================

import axios, { type AxiosInstance, type InternalAxiosRequestConfig, type AxiosError } from 'axios'
import { useAuthStore } from '@/stores/auth'
import router from '@/router'

const api: AxiosInstance = axios.create({
  baseURL: '/api', // Zmienione na relatywne dla Proxy
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
  },
  timeout: 10000
})

// Request interceptor
api.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    const token = localStorage.getItem('auth_token')

    if (token && config.headers) {
      config.headers.Authorization = `Bearer ${token}`
    }

    return config
  },
  (error: AxiosError) => {
    return Promise.reject(error)
  }
)

// Response interceptor
api.interceptors.response.use(
  (response) => {
    return response
  },
  async (error: AxiosError) => {
    const originalRequest = error.config

    if (error.response?.status === 401 && originalRequest && !(originalRequest as any)._retry) {
      (originalRequest as any)._retry = true

      localStorage.removeItem('auth_token')

      const authStore = useAuthStore()
      authStore.token = null
      authStore.user = null

      if (router.currentRoute.value.name !== 'Login') {
        router.push({
          name: 'Login',
          query: { redirect: router.currentRoute.value.fullPath }
        })
      }

      return Promise.reject(error)
    }

    // Inne błędy
    if (error.response?.status === 403) {
      console.error('Brak uprawnień do tego zasobu')
    }
    if (error.response?.status === 419) {
      console.error('Token CSRF wygasł - odśwież stronę')
    }
    if (error.response?.status === 500) {
      console.error('Błąd serwera:', error.response.data)
    }

    return Promise.reject(error)
  }
)

export default api

=================================================================================
FILE: src/services/assortmentService.ts
LOCATION: .//src/services/assortmentService.ts
=================================================================================

import api from './api'
import type { AssortmentItem } from '@/types'

export const assortmentService = {
  async getAll(params: any = {}): Promise<AssortmentItem[]> {
    const response = await api.get('/assortment', { params })
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  async getById(id: number | string): Promise<AssortmentItem> {
    const response = await api.get(`/assortment/${id}`)
    const data = response.data
    return (data as any).data || data
  },

  async create(data: Partial<AssortmentItem>): Promise<AssortmentItem> {
    const response = await api.post('/assortment', data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async update(id: number | string, data: Partial<AssortmentItem>): Promise<AssortmentItem> {
    const response = await api.put(`/assortment/${id}`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async delete(id: number | string): Promise<void> {
    await api.delete(`/assortment/${id}`)
  },

  async getCategories(type: string | null = null): Promise<string[]> {
    const response = await api.get('/assortment-categories', {
      params: type ? { type } : {}
    })
    return response.data
  },

  async toggleActive(id: number | string): Promise<AssortmentItem> {
    const response = await api.patch(`/assortment/${id}/toggle-active`)
    return response.data
  },

  async getHistory(id: number | string): Promise<any[]> {
    const response = await api.get(`/assortment/${id}/history`)
    return response.data
  },

  async batchCheckOrCreate(items: any[], type: 'MATERIAL' | 'SERVICE' = 'MATERIAL'): Promise<any[]> {
    const response = await api.post('/assortment/batch-check', {
      items,
      type
    })
    return response.data
  }
}

=================================================================================
FILE: src/services/authService.ts
LOCATION: .//src/services/authService.ts
=================================================================================

import api from './api'
import type { User } from '@/types'

interface LoginResponse {
  token: string;
  user: User;
}

export const authService = {
  async login(email: string, password: string): Promise<LoginResponse> {
    const response = await api.post<LoginResponse>('/login', { email, password })
    return response.data
  },

  async logout(): Promise<void> {
    await api.post('/logout')
  },

  async getUser(): Promise<User> {
    const response = await api.get<User>('/user')
    return response.data
  },

  async loginPin(pin: string): Promise<LoginResponse> {
    const response = await api.post<LoginResponse>('/auth/login-pin', { pin })
    return response.data
  }
}

=================================================================================
FILE: src/services/customerService.ts
LOCATION: .//src/services/customerService.ts
=================================================================================

import api from './api'
import type { Customer, ApiResponse } from '@/types'

export const customerService = {
  async getAll(params: any = {}): Promise<Customer[]> {
    const response = await api.get < ApiResponse < Customer[] >> ('/customers', { params })
    const data = response.data
    // Obsługa różnych formatów odpowiedzi (wrapper 'data' lub bezpośrednia tablica)
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  async getForSelect(): Promise<Customer[]> {
    const response = await api.get < ApiResponse < Customer[] >> ('/customers/for-select')
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  async getById(id: number | string): Promise<Customer> {
    const response = await api.get < ApiResponse < Customer >> (`/customers/${id}`)
    const data = response.data
    return (data as any).data || data
  },

  async create(data: Partial<Customer>): Promise<Customer> {
    const response = await api.post < ApiResponse < Customer >> ('/customers', data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async update(id: number | string, data: Partial<Customer>): Promise<Customer> {
    const response = await api.put < ApiResponse < Customer >> (`/customers/${id}`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async delete(id: number | string): Promise<void> {
    await api.delete(`/customers/${id}`)
  },

  async toggleActive(id: number | string): Promise<Customer> {
    const response = await api.patch < ApiResponse < Customer >> (`/customers/${id}/toggle-active`)
    const resData = response.data
    return (resData as any).data || resData
  },

  async getStatistics(id: number | string): Promise<any> {
    const response = await api.get(`/customers/${id}/statistics`)
    return response.data
  }
}

export default customerService

=================================================================================
FILE: src/services/orderService.ts
LOCATION: .//src/services/orderService.ts
=================================================================================

import api from './api'
import type { Order, ApiResponse, Customer } from '@/types'

export const orderService = {
  // Orders
  async getAll(params: any = {}): Promise<Order[]> {
    const response = await api.get<ApiResponse<Order[]>>('/orders', { params })
    // Obsługa różnych formatów odpowiedzi API (z wrapperem data lub bez)
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  async getById(id: number | string): Promise<Order> {
    const response = await api.get<ApiResponse<Order>>(`/orders/${id}`)
    const data = response.data
    // Jeśli API zwraca obiekt { data: Order }, wyciągnij go
    return (data as any).data || data
  },

  // NOWA METODA: Pobierz następny wolny numer
  async getNextNumber(): Promise<string> {
    const response = await api.get<{ next_number: string }>('/orders/next-number')
    return response.data.next_number
  },

  async create(data: Partial<Order>): Promise<Order> {
    const response = await api.post<ApiResponse<Order>>('/orders', data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async update(id: number | string, data: Partial<Order>): Promise<Order> {
    const response = await api.put<ApiResponse<Order>>(`/orders/${id}`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  async delete(id: number | string): Promise<void> {
    await api.delete(`/orders/${id}`)
  },

  // Customers
  async getCustomers(): Promise<Customer[]> {
    const response = await api.get<ApiResponse<Customer[]>>('/customers')
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  // Product Lines
  async getVariants(orderId: number | string): Promise<any[]> {
    const response = await api.get(`/orders/${orderId}/variants`)
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  // Quotations
  async getQuotations(orderId: number | string): Promise<any[]> {
    const response = await api.get(`/orders/${orderId}/quotations`)
    const data = response.data
    return Array.isArray(data) ? data : (data as any).data || []
  },

  async createQuotation(orderId: number | string, data: any): Promise<any> {
    const response = await api.post(`/orders/${orderId}/quotations`, data)
    return response.data
  },

  async approveQuotation(quotationId: number | string): Promise<any> {
    const response = await api.patch(`/quotations/${quotationId}/approve`)
    return response.data
  }
}

=================================================================================
FILE: src/services/prototypeServiceService.ts
LOCATION: .//src/services/prototypeServiceService.ts
=================================================================================

import api from './api'

export interface PrototypeServiceItem {
    id: number
    prototype_id: number
    step_number: number
    service_name: string
    workstation_id: number | null
    assigned_to_user_id: number | null
    estimated_quantity: number
    estimated_time_hours: number
    estimated_cost: number
    actual_quantity: number | null
    actual_time_hours: number | null
    actual_cost: number | null
    status: string
    actual_start_date: string | null
    actual_end_date: string | null
    total_pause_duration_seconds: number
    worker_notes: string | null
    workstation?: {
        id: number
        name: string
        type: string
    }
    assigned_worker?: {
        id: number
        name: string
    }
    created_at: string
    updated_at: string
}

export const prototypeServiceService = {
    async getAll(prototypeId: number | string): Promise<PrototypeServiceItem[]> {
        const response = await api.get(`/prototypes/${prototypeId}/services`)
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    async create(prototypeId: number | string, payload: Partial<PrototypeServiceItem>): Promise<PrototypeServiceItem> {
        const response = await api.post(`/prototypes/${prototypeId}/services`, payload)
        const data = response.data
        return (data as any).data || data
    },

    async update(serviceId: number | string, payload: Partial<PrototypeServiceItem>): Promise<PrototypeServiceItem> {
        const response = await api.put(`/prototype-services/${serviceId}`, payload)
        const data = response.data
        return (data as any).data || data
    },

    async delete(serviceId: number | string): Promise<void> {
        await api.delete(`/prototype-services/${serviceId}`)
    }
}

=================================================================================
FILE: src/services/quotationService.ts
LOCATION: .//src/services/quotationService.ts
=================================================================================

import api from './api'

export interface AssortmentItem {
  id: number
  name: string
  type: string
  unit: string
  default_price: number
}

export type ExportMaterialsMode = 'skip' | 'merge' | 'replace'

export interface ExportMaterialsResult {
  message: string
  stats: {
    exported: number
    skipped: number
    merged: number
    replaced: number
  }
}

export const quotationService = {
  /**
   * Pobierz wszystkie wyceny dla wariantu
   */
  async getAll(variantId: number | string): Promise<any[]> {
    const response = await api.get(`/variants/${variantId}/quotations`)
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  /**
   * Pobierz szczegóły wyceny
   */
  async getById(id: number | string): Promise<any> {
    const response = await api.get(`/quotations/${id}`)
    const data = response.data
    return (data as any).data || data
  },

  /**
   * Utwórz nową wycenę dla wariantu
   */
  async create(variantId: number | string, data: any): Promise<any> {
    const response = await api.post(`/variants/${variantId}/quotations`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Zaktualizuj wycenę (tylko niezatwierdzone)
   */
  async update(id: number | string, data: any): Promise<any> {
    const response = await api.put(`/quotations/${id}`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Zatwierdź wycenę
   */
  async approve(id: number | string): Promise<any> {
    const response = await api.patch(`/quotations/${id}/approve`)
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Usuń wycenę
   */
  async delete(id: number | string): Promise<void> {
    await api.delete(`/quotations/${id}`)
  },

  /**
   * Pobierz PDF wyceny jako blob
   */
  async downloadPDF(id: number | string): Promise<any> {
    const response = await api.get(`/quotations/${id}/pdf`, {
      responseType: 'blob'
    })
    return response.data
  },

  /**
   * Duplikuj wycenę jako nową wersję w tym samym wariancie
   */
  async duplicate(quotationId: number | string): Promise<any> {
    const response = await api.post(`/quotations/${quotationId}/duplicate`)
    return response.data
  },

  /**
   * Eksportuj materiały z zatwierdzonej wyceny do listy materiałów wariantu.
   *
   * @param quotationId - ID wyceny (musi być zatwierdzona)
   * @param mode        - Tryb obsługi duplikatów:
   *                       'skip'    – pomija istniejące (domyślny)
   *                       'merge'   – sumuje ilości z istniejącymi
   *                       'replace' – nadpisuje istniejące
   */
  async exportMaterials(
    quotationId: number | string,
    mode: 'skip' | 'merge' | 'replace' = 'skip'
  ): Promise<ExportMaterialsResult> {
    const response = await api.post(
      `/quotations/${quotationId}/export-materials?mode=${mode}`
    )
    return response.data
  },

  /**
   * Pobierz listę materiałów z katalogu (do formularzy wycen)
   */
  async getMaterials(): Promise<AssortmentItem[]> {
    const response = await api.get('/assortment-materials')
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  /**
   * Pobierz listę usług z katalogu (do formularzy wycen)
   */
  async getServices(): Promise<AssortmentItem[]> {
    const response = await api.get('/assortment-services')
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  }
}

=================================================================================
FILE: src/services/rcpAdminService.ts
LOCATION: .//src/services/rcpAdminService.ts
=================================================================================

import api from './api'
export const rcpAdminService = {
    // Pobierz listę zadań (z paginacją i filtrami)
    async getTasks(params: any = {}): Promise<any> {
        const response = await api.get('/admin/rcp/tasks', { params })
        return response.data
    },
    // Aktualizuj zadanie (status, przypisanie, notatki, daty)
    async updateTask(taskId: number | string, data: any): Promise<any> {
        const response = await api.put(`/admin/rcp/tasks/${taskId}`, data)
        return response.data
    },
    // Pobierz logi czasu dla konkretnego zadania
    async getTimeLogs(taskId: number | string): Promise<any[]> {
        const response = await api.get(`/admin/rcp/tasks/${taskId}/logs`)
        return response.data
    },
    // Dodaj nowy wpis do logu (korekta ręczna)
    async addTimeLog(taskId: number | string, data: any): Promise<any> {
        const response = await api.post(`/admin/rcp/tasks/${taskId}/logs`, data)
        return response.data
    },
    // Edytuj wpis w logu
    async updateTimeLog(logId: number | string, data: any): Promise<any> {
        const response = await api.put(`/admin/rcp/logs/${logId}`, data)
        return response.data
    },
    // Usuń wpis z logu
    async deleteTimeLog(logId: number | string): Promise<any> {
        const response = await api.delete(`/admin/rcp/logs/${logId}`)
        return response.data
    }
}

export default rcpAdminService;

=================================================================================
FILE: src/services/seriesService.ts
LOCATION: .//src/services/seriesService.ts
=================================================================================

// src/services/seriesService.ts
// Serwis API do zarządzania seriami zamówień
import api from './api'

// ─── Typy odpowiedzi API ───────────────────────────────────────────────────────

/** Pojedyncza seria na liście */
export interface SeriesListItem {
    id: number
    full_order_number: string
    order_number: string
    series: string
    description: string | null
    overall_status: string
    payment_status: string
    priority: string
    created_at: string
    planned_delivery_date: string | null
    variants_count: number
    customer: {
        id: number
        name: string
    }
}

/** Wariant dostępny do kopiowania (dla selektora) */
export interface VariantForCopy {
    id: number
    variant_number: string
    name: string
    type: string
    status: string
    quantity: number
    has_quotation: boolean
    has_approved_quotation: boolean
    has_materials: boolean
    materials_count: number
    quotation_info: {
        version_number: number
        is_approved: boolean
        total_gross: number
    } | null
}

/** Konfiguracja kopiowania pojedynczego wariantu */
export interface VariantCopyConfig {
    source_variant_id: number
    copy_quotation: boolean
    copy_materials: boolean
}

/** Payload do tworzenia nowej serii */
export interface CreateSeriesPayload {
    description?: string
    planned_delivery_date?: string | null
    priority?: string
    copy_from_order_id?: number | null
    variants?: VariantCopyConfig[]
}

/** Odpowiedź z API po utworzeniu serii */
export interface CreateSeriesResponse {
    message: string
    data: any
    summary: {
        new_order_id: number
        new_full_order_number: string
        variants_created: number
        copied_from: string | null
        copy_details: {
            variants_requested: number
            with_quotation_copy: number
            with_materials_copy: number
        } | null
    }
}

// ─── Serwis ───────────────────────────────────────────────────────────────────

export const seriesService = {
    /**
     * Pobierz wszystkie serie dla numeru zamówienia (np. Z/0001)
     * Używa ID dowolnej serii z tej grupy
     */
    async getAllSeries(orderId: number | string): Promise<SeriesListItem[]> {
        const response = await api.get(`/orders/${orderId}/series`)
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    /**
     * Pobierz warianty z danej serii do selektora kopiowania
     */
    async getVariantsForSelector(orderId: number | string): Promise<VariantForCopy[]> {
        const response = await api.get(`/orders/${orderId}/series/variants`)
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    /**
     * Utwórz nową serię - opcjonalnie z kopiowaniem wariantów
     */
    async createSeries(
        orderId: number | string,
        payload: CreateSeriesPayload
    ): Promise<CreateSeriesResponse> {
        const response = await api.post(`/orders/${orderId}/series/create`, payload)
        return response.data
    }
}

export default seriesService

=================================================================================
FILE: src/services/timerService.ts
LOCATION: .//src/services/timerService.ts
=================================================================================

import api from './api'

export const timerService = {

  /**
   * Rozpocznij pracę — tworzy lub wznawia zadanie (firstOrCreate po stronie backendu).
   *
   * POST /api/rcp/start
   *
   * @returns { current_task_id, task, message }
   */
  async startWork(variantId: number, workstationId: number, serviceId: number): Promise<any> {
    const response = await api.post('/rcp/start', {
      variant_id: variantId,
      workstation_id: workstationId,
      service_id: serviceId,
    })
    return response.data
  },

  /**
   * Sprawdź czy zalogowany pracownik ma aktywne lub wstrzymane zadanie.
   * Używane przy montowaniu WorkstationSelect.vue — przekierowanie jeśli trwa zadanie.
   *
   * GET /api/rcp/active-task
   *
   * @returns { has_active_task: boolean, task_id?: number }
   */
  async checkActiveTask(): Promise<{ has_active_task: boolean; task_id?: number }> {
    const response = await api.get('/rcp/active-task')
    return response.data
  },

  /**
   * Pobierz szczegóły zadania z obliczonym bieżącym czasem trwania.
   * Używane przy montowaniu Timer.vue (sync stanu po odświeżeniu strony).
   *
   * GET /api/rcp/tasks/{taskId}
   *
   * @returns task + current_duration_seconds (czas netto od START minus pauzy)
   */
  async getTaskDetails(taskId: number | string): Promise<any> {
    const response = await api.get(`/rcp/tasks/${taskId}`)
    return response.data
  },

  /**
   * Wstrzymaj pracę (przerwa).
   *
   * POST /api/rcp/pause/{taskId}
   */
  async pause(taskId: number | string): Promise<any> {
    const response = await api.post(`/rcp/pause/${taskId}`)
    return response.data
  },

  /**
   * Wznów pracę po przerwie.
   *
   * POST /api/rcp/resume/{taskId}
   */
  async resume(taskId: number | string): Promise<any> {
    const response = await api.post(`/rcp/resume/${taskId}`)
    return response.data
  },

  /**
   * Zakończ pracę i odbierz dane o wariancji czasu.
   *
   * POST /api/rcp/stop/{taskId}
   *
   * @returns { actual_hours, estimated_hours, variance_percent, time_variance,
   *            actual_cost, cost_variance, task, message }
   */
  async stop(taskId: number | string): Promise<any> {
    const response = await api.post(`/rcp/stop/${taskId}`)
    return response.data
  },
}

=================================================================================
FILE: src/services/userService.ts
LOCATION: .//src/services/userService.ts
=================================================================================

import api from './api'
import type { User } from '@/types'

export const userService = {
    async getAll(params: any = {}): Promise<User[]> {
        const response = await api.get('/users', { params })
        const data = response.data

        // FIX: Obsługa paginacji Laravel. Jeśli przychodzi obiekt z polem 'data', wyciągnij tablicę.
        if (Array.isArray(data)) {
            return data
        } else if (data && Array.isArray(data.data)) {
            return data.data
        }

        return []
    },

    async getById(id: number | string): Promise<User> {
        const response = await api.get(`/users/${id}`)
        return response.data
    },

    async create(data: Partial<User>): Promise<User> {
        const response = await api.post('/users', data)
        return response.data
    },

    async update(id: number | string, data: Partial<User>): Promise<User> {
        const response = await api.put(`/users/${id}`, data)
        return response.data
    },

    async delete(id: number | string): Promise<void> {
        await api.delete(`/users/${id}`)
    },

    async toggleActive(id: number | string): Promise<User> {
        const response = await api.patch(`/users/${id}/toggle-active`)
        return response.data.user
    }
}


=================================================================================
FILE: src/services/variantMaterialService.ts
LOCATION: .//src/services/variantMaterialService.ts
=================================================================================

import api from './api'

export interface VariantMaterial {
    id: number
    variant_id: number
    assortment_id: number
    quantity: number
    unit: string
    unit_price: number
    total_cost: number
    status: string
    expected_delivery_date: string | null
    ordered_at: string | null
    received_at: string | null
    quantity_in_stock: number
    quantity_ordered: number
    supplier: string | null
    notes: string | null
    assortment?: {
        id: number
        name: string
        type: string
        unit: string
        unit_price: number
    }
    created_at: string
    updated_at: string
}

export interface MaterialsSummary {
    total: number
    not_ordered: number
    ordered: number
    partially_in_stock: number
    in_stock: number
    all_ready: boolean
}

export interface VariantMaterialsResponse {
    materials: VariantMaterial[]
    summary: MaterialsSummary
    total_cost: number
}

export const variantMaterialService = {
    async getAll(variantId: number | string): Promise<VariantMaterialsResponse> {
        const response = await api.get(`/variants/${variantId}/materials`)
        const data = response.data
        return (data as any).data || data
    },

    async create(variantId: number | string, payload: Partial<VariantMaterial>): Promise<VariantMaterial> {
        const response = await api.post(`/variants/${variantId}/materials`, payload)
        const data = response.data
        return (data as any).data || data
    },

    async getById(materialId: number | string): Promise<VariantMaterial> {
        const response = await api.get(`/variant-materials/${materialId}`)
        const data = response.data
        return (data as any).data || data
    },

    async update(materialId: number | string, payload: Partial<VariantMaterial>): Promise<VariantMaterial> {
        const response = await api.put(`/variant-materials/${materialId}`, payload)
        const data = response.data
        return (data as any).data || data
    },

    async delete(materialId: number | string): Promise<void> {
        await api.delete(`/variant-materials/${materialId}`)
    },

    async updateStatus(materialId: number | string, status: string, extra: Record<string, any> = {}): Promise<VariantMaterial> {
        const response = await api.patch(`/variant-materials/${materialId}/status`, { status, ...extra })
        const data = response.data
        return (data as any).data || data
    },

    async markAllOrdered(variantId: number | string, payload: Record<string, any> = {}): Promise<any> {
        const response = await api.post(`/variants/${variantId}/materials/mark-all-ordered`, payload)
        return response.data
    },

    async batchCreate(variantId: number | string, items: any[]): Promise<any> {
        const response = await api.post(`/variants/${variantId}/materials/batch`, { items })
        return response.data
    }
}

=================================================================================
FILE: src/services/variantService.ts
LOCATION: .//src/services/variantService.ts
=================================================================================

import api from './api'
import type { Variant } from '@/types'

export const variantService = {
  // =========================================================================
  // POBIERANIE
  // =========================================================================

  /**
   * Pobierz wszystkie warianty (grupy i warianty) dla zamówienia.
   * Backend zwraca płaską listę — grupy mają is_group=true, quantity=0.
   */
  async getAll(orderId: number | string): Promise<Variant[]> {
    const response = await api.get(`/orders/${orderId}/variants`)
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  /**
   * Pobierz szczegóły wariantu lub grupy po ID.
   */
  async getById(id: number | string): Promise<Variant> {
    const response = await api.get(`/variants/${id}`)
    const data = response.data
    return (data as any).data || data
  },

  // =========================================================================
  // TWORZENIE
  // =========================================================================

  /**
   * Utwórz nową GRUPĘ dla zamówienia.
   * Backend automatycznie nadaje kolejną literę (A, B, C…) i ustawia quantity=0.
   *
   * Payload: { name, description? }
   */
  async createGroup(orderId: number | string, data: { name: string; description?: string }): Promise<Variant> {
    const response = await api.post(`/orders/${orderId}/variants`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Utwórz WARIANT w istniejącej grupie (parent = grupa lub wariant).
   * Backend nadaje kolejny numer wg reguły: A → A1, A2; A1 → A1_1, A1_2.
   *
   * Payload: { name, quantity (≥1), type (SERIAL|PROTOTYPE), description? }
   */
  async createChild(
    orderId: number | string,
    parentId: number | string,
    data: {
      name: string
      quantity: number
      type: 'SERIAL' | 'PROTOTYPE'
      description?: string
    }
  ): Promise<Variant> {
    const response = await api.post(`/orders/${orderId}/variants/${parentId}/children`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  // =========================================================================
  // EDYCJA
  // =========================================================================

  /**
   * Aktualizuj grupę lub wariant.
   * Backend blokuje konwersję typu (grupa ↔ wariant) — quantity musi być spójne.
   */
  async update(id: number | string, data: Partial<Variant>): Promise<Variant> {
    const response = await api.put(`/variants/${id}`, data)
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Zmień status wariantu (tylko dla wariantów — grup nie dotyczą statusy).
   */
  async updateStatus(id: number | string, status: string): Promise<Variant> {
    const response = await api.patch(`/variants/${id}/status`, { status })
    const resData = response.data
    return (resData as any).data || resData
  },

  // =========================================================================
  // USUWANIE
  // =========================================================================

  /**
   * Usuń wariant lub grupę.
   *
   * Grupy z dziećmi wymagają force=true — bez tego backend zwraca 422.
   * Z force=true kasuje grupę rekurencyjnie wraz z całym drzewem.
   */
  async delete(id: number | string, force = false): Promise<void> {
    await api.delete(`/variants/${id}`, {
      params: force ? { force: true } : undefined,
    })
  },

  // =========================================================================
  // DUPLIKOWANIE
  // =========================================================================

  /**
   * Duplikuj wariant lub grupę.
   *
   * Dla WARIANTU:
   *   relation: 'sibling' | 'child'
   *   name, quantity, type, copy_quotation, copy_materials, description?
   *
   * Dla GRUPY (is_group=true):
   *   relation: 'sibling' (jedyna opcja — nie można tworzyć sub-grup)
   *   name, copy_children (kopiuje całe drzewo wariantów grupy)
   *
   * Backend zwraca { variant: Variant, ... }
   */
  async duplicate(
    id: number | string,
    payload: {
      relation: 'sibling' | 'child'
      name?: string
      quantity?: number
      type?: string
      description?: string
      copy_quotation?: boolean
      copy_materials?: boolean
      copy_children?: boolean
    }
  ): Promise<any> {
    const response = await api.post(`/variants/${id}/duplicate`, payload)
    return response.data
  },

  // =========================================================================
  // PROTOTYPY
  // =========================================================================

  /**
   * Prześlij recenzję prototypu (zatwierdzenie/odrzucenie).
   */
  async reviewPrototype(
    id: number | string,
    action: 'approve' | 'reject',
    feedback: string
  ): Promise<Variant> {
    const response = await api.post(`/variants/${id}/review`, {
      action,
      feedback_notes: feedback,
    })
    const resData = response.data
    return (resData as any).data || resData
  },

  /**
   * Pobierz historię prototypów wariantu.
   */
  async getPrototypes(variantId: number | string): Promise<any[]> {
    const response = await api.get(`/variants/${variantId}/prototypes`)
    const data = response.data
    if (Array.isArray(data)) return data
    return (data as any).data || []
  },

  /**
   * Utwórz nowy prototyp.
   */
  async createPrototype(variantId: number | string, data: any): Promise<any> {
    const response = await api.post(`/variants/${variantId}/prototypes`, data)
    return response.data
  },
}

export default variantService

=================================================================================
FILE: src/services/workstationService.ts
LOCATION: .//src/services/workstationService.ts
=================================================================================

import api from './api'
import type { Workstation, User } from '@/types'

export const workstationService = {
    async getAll(): Promise<Workstation[]> {
        const response = await api.get('/workstations')
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    async getById(id: number | string): Promise<Workstation> {
        const response = await api.get(`/workstations/${id}`)
        const data = response.data
        return (data as any).data || data
    },

    async create(data: Partial<Workstation>): Promise<Workstation> {
        const response = await api.post('/workstations', data)
        const resData = response.data
        return (resData as any).data || resData
    },

    async update(id: number | string, data: Partial<Workstation>): Promise<Workstation> {
        const response = await api.put(`/workstations/${id}`, data)
        const resData = response.data
        return (resData as any).data || resData
    },

    async delete(id: number | string): Promise<void> {
        await api.delete(`/workstations/${id}`)
    },

    async getWorkers(): Promise<User[]> {
        const response = await api.get('/workers-list')
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    // --- USŁUGI ---

    async getAssignedServices(workstationId: number | string): Promise<any[]> {
        const response = await api.get(`/workstations/${workstationId}/services`)
        const data = response.data
        if (Array.isArray(data)) return data
        return (data as any).data || []
    },

    async attachService(workstationId: number | string, assortmentId: number | string): Promise<any> {
        const response = await api.post(`/workstations/${workstationId}/services`, {
            assortment_id: assortmentId
        })
        return response.data
    },

    async detachService(workstationId: number | string, assortmentId: number | string): Promise<any> {
        const response = await api.delete(`/workstations/${workstationId}/services/${assortmentId}`)
        return response.data
    }
}

=================================================================================
FILE: src/composables/useApiAction.ts
LOCATION: .//src/composables/useApiAction.ts
=================================================================================

import { ref } from 'vue'

// -----------------------------------------------------------------------------
// TYPY
// -----------------------------------------------------------------------------

export interface ApiActionReturn {
    loading: ReturnType<typeof ref<boolean>>
    error: ReturnType<typeof ref<string | null>>
    /** Uruchom akcję z automatyczną obsługą loading/error */
    run: <T>(action: () => Promise<T>, options?: RunOptions) => Promise<T | undefined>
    /** Wersja skrócona: opakowuje funkcję i zwraca nową, gotową do użycia */
    withLoading: <T>(action: () => Promise<T>, options?: RunOptions) => () => Promise<T | undefined>
}

export interface RunOptions {
    /** Domyślna wiadomość błędu gdy API nie zwróci message */
    fallbackError?: string
    /** Czy nie logować błędu do konsoli */
    silent?: boolean
    /** Callback wywoływany po błędzie (np. do pokazania snackbar) */
    onError?: (message: string) => void
}

// -----------------------------------------------------------------------------
// IMPLEMENTACJA
// -----------------------------------------------------------------------------

/**
 * Zarządza stanem loading/error dla jednej operacji API.
 * Używaj jednego `useApiAction()` per "typ operacji" w store,
 * lub jednego dla wielu podobnych akcji.
 *
 * @example
 * // W store Pinia:
 * const listAction = useApiAction()
 * const saveAction = useApiAction()
 *
 * const fetchItems = listAction.withLoading(async () => {
 *   items.value = await itemService.getAll()
 * }, { fallbackError: 'Błąd pobierania listy' })
 *
 * const saveItem = saveAction.withLoading(async (data) => {
 *   const created = await itemService.create(data)
 *   items.value.push(created)
 *   return created
 * }, { fallbackError: 'Błąd zapisu' })
 */
export function useApiAction(): ApiActionReturn {
    const loading = ref(false)
    const error = ref<string | null>(null)

    const run = async <T>(
        action: () => Promise<T>,
        options: RunOptions = {}
    ): Promise<T | undefined> => {
        const {
            fallbackError = 'Wystąpił błąd',
            silent = false,
            onError,
        } = options

        loading.value = true
        error.value = null

        try {
            return await action()
        } catch (err: any) {
            const message = err?.response?.data?.message
                || err?.message
                || fallbackError

            error.value = message

            if (!silent) {
                console.error('[useApiAction]', message, err)
            }

            if (onError) {
                onError(message)
            }

            // Re-throw żeby wywołujący mógł obsłużyć błąd (np. w komponencie)
            throw err
        } finally {
            loading.value = false
        }
    }

    const withLoading = <T>(
        action: () => Promise<T>,
        options: RunOptions = {}
    ) => {
        return () => run(action, options)
    }

    return { loading, error, run, withLoading }
}

// =============================================================================
// useSharedApiState — dla stores z jednym wspólnym loading/error
// =============================================================================
// Gdy store potrzebuje JEDNEGO globalnego loading (jak orders.ts, quotations.ts),
// to narzędzie upraszcza zapis akcji przez wrapping.
//
// @example
// export const useOrdersStore = defineStore('orders', () => {
//   const orders = ref([])
//   const { loading, error, wrapAction } = useSharedApiState()
//
//   const fetchOrders = wrapAction(async () => {
//     orders.value = await orderService.getAll()
//   }, 'Błąd pobierania zamówień')
//
//   const createOrder = wrapAction(async (data) => {
//     const order = await orderService.create(data)
//     orders.value.unshift(order)
//     return order
//   }, 'Błąd tworzenia zamówienia')
//
//   return { orders, loading, error, fetchOrders, createOrder }
// })
// =============================================================================

export function useSharedApiState() {
    const loading = ref(false)
    const error = ref<string | null>(null)

    /**
     * Opakowuje akcję async w loading/error handling
     * Zwraca nową funkcję gotową do użycia w store
     */
    function wrapAction<TArgs extends any[], TReturn>(
        action: (...args: TArgs) => Promise<TReturn>,
        fallbackError = 'Wystąpił błąd'
    ): (...args: TArgs) => Promise<TReturn> {
        return async (...args: TArgs): Promise<TReturn> => {
            loading.value = true
            error.value = null

            try {
                return await action(...args)
            } catch (err: any) {
                const message = err?.response?.data?.message || err?.message || fallbackError
                error.value = message
                console.error(`[Store Action] ${fallbackError}:`, err)
                throw err
            } finally {
                loading.value = false
            }
        }
    }

    return { loading, error, wrapAction }
}

=================================================================================
FILE: src/composables/useFormatters.ts
LOCATION: .//src/composables/useFormatters.ts
=================================================================================

import {
    format,
    formatDistanceToNow,
    parseISO,
    isValid,
} from 'date-fns'
import { pl } from 'date-fns/locale'

// -----------------------------------------------------------------------------
// TYPY
// -----------------------------------------------------------------------------

export interface FormattersReturn {
    /** Formatuje liczbę jako PLN: 1234.5 → "1 234,50 PLN" */
    formatCurrency: (value: number | string | null | undefined) => string

    /** Formatuje datę: "2024-01-15T10:30:00Z" → "15.01.2024 10:30" */
    formatDate: (dateStr: string | null | undefined) => string

    /** Formatuje datę bez godziny: "2024-01-15T10:30:00Z" → "15.01.2024" */
    formatDateOnly: (dateStr: string | null | undefined) => string

    /** Formatuje sekundy jako HH:MM:SS: 3665 → "01:01:05" */
    formatDuration: (totalSeconds: number) => string

    /** Formatuje godziny jako HH:MM:SS: 1.0167 → "01:01:05" */
    formatHours: (hours: number) => string

    /** Konwertuje ISO na format datetime-local dla inputa HTML: "2024-01-15T10:30:00Z" → "2024-01-15T10:30" */
    toInputDate: (isoString: string | null | undefined) => string

    /** Formatuje względny czas: "2 godziny temu", "za 3 dni" */
    formatRelative: (dateStr: string | null | undefined) => string

    /** Formatuje wartość procentową z znakiem: -3.1 → "-3.1%", 5.2 → "+5.2%" */
    formatVariancePercent: (percent: number | null | undefined) => string

    /** Zwraca kolor Vuetify dla wariancji: green/red/warning */
    varianceColor: (percent: number | null | undefined) => string
}

// -----------------------------------------------------------------------------
// IMPLEMENTACJA
// -----------------------------------------------------------------------------

export function useFormatters(): FormattersReturn {

    // ---
    // formatCurrency
    // ---
    // Przed refaktorem: każdy komponent miał własną kopię:
    //   const formatCurrency = (value) => new Intl.NumberFormat('pl-PL', {...}).format(value)
    // ---
    const formatCurrency = (value: number | string | null | undefined): string => {
        const num = Number(value)
        if (isNaN(num)) return '0,00 PLN'

        return new Intl.NumberFormat('pl-PL', {
            style: 'currency',
            currency: 'PLN',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(num)
    }

    // ---
    // formatDate
    // ---
    // Przed refaktorem: 3 różne implementacje używając new Date().toLocaleString()
    // Teraz używamy date-fns (już zainstalowane w projekcie!) dla spójności
    // ---
    const formatDate = (dateStr: string | null | undefined): string => {
        if (!dateStr) return '-'

        try {
            // Obsługujemy zarówno ISO string jak i inne formaty
            const date = typeof dateStr === 'string' ? parseISO(dateStr) : new Date(dateStr)
            if (!isValid(date)) return '-'

            return format(date, 'dd.MM.yyyy HH:mm', { locale: pl })
        } catch {
            return '-'
        }
    }

    // ---
    // formatDateOnly
    // ---
    const formatDateOnly = (dateStr: string | null | undefined): string => {
        if (!dateStr) return '-'

        try {
            const date = typeof dateStr === 'string' ? parseISO(dateStr) : new Date(dateStr)
            if (!isValid(date)) return '-'

            return format(date, 'dd.MM.yyyy', { locale: pl })
        } catch {
            return '-'
        }
    }

    // ---
    // formatDuration
    // ---
    // Przed refaktorem: identyczna logika padStart była w:
    //   - useTimer.ts (formattedTime computed)
    //   - stores/timer.ts (formattedTime computed)
    //   - VariantDetail.vue (liveTimerDisplay computed)
    //   - TimeLogsDialog.vue (formatDuration)
    // ---
    const formatDuration = (totalSeconds: number): string => {
        if (!totalSeconds || totalSeconds < 0) return '00:00:00'

        const h = Math.floor(totalSeconds / 3600)
        const m = Math.floor((totalSeconds % 3600) / 60)
        const s = Math.floor(totalSeconds % 60)

        return [h, m, s].map(v => String(v).padStart(2, '0')).join(':')
    }

    // ---
    // formatHours
    // ---
    // Konwertuje godziny (np. 1.5) na HH:MM:SS
    // Używane w liveTimerDisplay w VariantDetail zamiast ręcznych obliczeń
    // ---
    const formatHours = (hours: number): string => {
        if (!hours || hours < 0) return '00:00:00'
        return formatDuration(Math.floor(hours * 3600))
    }

    // ---
    // toInputDate
    // ---
    // Przed refaktorem: identyczna funkcja w TaskEditDialog.vue i TimeLogsDialog.vue:
    //   const toInputDate = (isoString) => {
    //     if (!isoString) return ''
    //     const date = new Date(isoString)
    //     const tzOffset = date.getTimezoneOffset() * 60000
    //     return new Date(date.getTime() - tzOffset).toISOString().slice(0, 16)
    //   }
    // Teraz używamy date-fns
    // ---
    const toInputDate = (isoString: string | null | undefined): string => {
        if (!isoString) return ''

        try {
            const date = parseISO(isoString)
            if (!isValid(date)) return ''

            // Format dla datetime-local: "yyyy-MM-ddTHH:mm"
            return format(date, "yyyy-MM-dd'T'HH:mm")
        } catch {
            return ''
        }
    }

    // ---
    // formatRelative
    // ---
    const formatRelative = (dateStr: string | null | undefined): string => {
        if (!dateStr) return '-'

        try {
            const date = parseISO(dateStr)
            if (!isValid(date)) return '-'

            return formatDistanceToNow(date, { locale: pl, addSuffix: true })
        } catch {
            return '-'
        }
    }

    // ---
    // formatVariancePercent
    // ---
    const formatVariancePercent = (percent: number | null | undefined): string => {
        if (percent == null) return '-'
        const sign = percent > 0 ? '+' : ''
        return `${sign}${Number(percent).toFixed(1)}%`
    }

    // ---
    // varianceColor
    // ---
    // Przed refaktorem: logika kolorów wariancji była w useTimer.ts
    // Tutaj jest centralne miejsce, używane też w RCP admin tabeli
    // ---
    const varianceColor = (percent: number | null | undefined): string => {
        if (percent == null) return 'grey'
        if (percent < -10) return 'success'  // szybciej niż plan — zielony
        if (percent > 10) return 'error'      // wolniej o >10% — czerwony
        if (percent < 0) return 'success'     // trochę szybciej
        if (percent > 0) return 'warning'     // trochę wolniej
        return 'success'                      // dokładnie na czas
    }

    return {
        formatCurrency,
        formatDate,
        formatDateOnly,
        formatDuration,
        formatHours,
        toInputDate,
        formatRelative,
        formatVariancePercent,
        varianceColor,
    }
}

// =============================================================================
// EKSPORT FUNKCJI STANDALONE (bez composable, dla store/service)
// =============================================================================
// Używaj gdy potrzebujesz formatowania poza komponentem Vue (np. w store)

export const formatCurrency = (value: number | string | null | undefined): string => {
    const num = Number(value)
    if (isNaN(num)) return '0,00 PLN'
    return new Intl.NumberFormat('pl-PL', {
        style: 'currency',
        currency: 'PLN',
    }).format(num)
}

export const formatDuration = (totalSeconds: number): string => {
    if (!totalSeconds || totalSeconds < 0) return '00:00:00'
    const h = Math.floor(totalSeconds / 3600)
    const m = Math.floor((totalSeconds % 3600) / 60)
    const s = Math.floor(totalSeconds % 60)
    return [h, m, s].map(v => String(v).padStart(2, '0')).join(':')
}

export const formatDate = (dateStr: string | null | undefined): string => {
    if (!dateStr) return '-'
    try {
        const date = parseISO(dateStr)
        if (!isValid(date)) return '-'
        return format(date, 'dd.MM.yyyy HH:mm', { locale: pl })
    } catch {
        return '-'
    }
}

=================================================================================
FILE: src/composables/useServerTable.ts
LOCATION: .//src/composables/useServerTable.ts
=================================================================================

/**
 * useServerTable — Composable do obsługi v-data-table-server.
 *
 * Zarządza stanem paginacji, sortowaniem, wyszukiwaniem i pobieraniem danych.
 * Współpracuje z backendowym traitem Paginatable.
 *
 * Użycie:
 *   const { items, totalItems, loading, options, search, fetchData, updateOptions } =
 *     useServerTable('/orders', { quick_filter: quickFilter });
 */
import { ref, watch, type Ref } from "vue";
import { debounce } from "lodash";
import api from "@/services/api";

interface ServerTableOptions {
    page: number;
    itemsPerPage: number;
    sortBy: Array<{ key: string; order: "asc" | "desc" }>;
}

interface UseServerTableConfig {
    defaultPerPage?: number;
    defaultSortBy?: string;
    defaultSortDir?: "asc" | "desc";
    /** Dodatkowe reaktywne filtry — obiekt ref, którego wartości zostaną dołączone do query params */
    extraFilters?: Ref<Record<string, any>>;
    /** Callback po udanym pobraniu — np. do aktualizacji statystyk */
    onSuccess?: (response: any) => void;
}

export function useServerTable(endpoint: string, config: UseServerTableConfig = {}) {
    const {
        defaultPerPage = 15,
        defaultSortBy = "created_at",
        defaultSortDir = "desc",
        extraFilters,
        onSuccess,
    } = config;

    const items: Ref<any[]> = ref([]);
    const totalItems = ref(0);
    const loading = ref(false);
    const error: Ref<string | null> = ref(null);
    const search = ref("");

    const options = ref<ServerTableOptions>({
        page: 1,
        itemsPerPage: defaultPerPage,
        sortBy: [{ key: defaultSortBy, order: defaultSortDir }],
    });

    /**
     * Pobierz dane z API na podstawie aktualnych opcji tabeli i filtrów.
     */
    const fetchData = async () => {
        try {
            loading.value = true;
            error.value = null;

            const sort = options.value.sortBy[0];
            const params: Record<string, any> = {
                page: options.value.page,
                per_page: options.value.itemsPerPage,
                sort_by: sort?.key || defaultSortBy,
                sort_dir: sort?.order || defaultSortDir,
            };

            // Dodaj search jeśli niepusty
            if (search.value) {
                params.search = search.value;
            }

            // Dołącz dodatkowe filtry (reactive)
            if (extraFilters?.value) {
                for (const [key, value] of Object.entries(extraFilters.value)) {
                    if (value !== null && value !== undefined && value !== "" && value !== "all") {
                        params[key] = value;
                    }
                }
            }

            const response = await api.get(endpoint, { params });

            // Laravel paginator zwraca: { data: [...], total: N, current_page: N, ... }
            const payload = response.data;

            if (payload.data && typeof payload.total === "number") {
                // Standardowa odpowiedź paginatora Laravela
                items.value = payload.data;
                totalItems.value = payload.total;
            } else if (Array.isArray(payload)) {
                // Fallback — odpowiedź bez paginacji (backward compatibility)
                items.value = payload;
                totalItems.value = payload.length;
            } else if (Array.isArray(payload.data)) {
                // Odpowiedź owinięta w { data: [...] } bez paginacji
                items.value = payload.data;
                totalItems.value = payload.data.length;
            }

            onSuccess?.(payload);
        } catch (err: any) {
            console.error(`Błąd pobierania ${endpoint}:`, err);
            error.value = err.response?.data?.message || "Nie udało się pobrać danych";
            items.value = [];
            totalItems.value = 0;
        } finally {
            loading.value = false;
        }
    };

    /**
     * Handler dla @update:options z v-data-table-server.
     */
    const updateOptions = (newOptions: ServerTableOptions) => {
        options.value = newOptions;
        fetchData();
    };

    /**
     * Debounced search — resetuje na stronę 1.
     */
    const debouncedSearch = debounce(() => {
        options.value.page = 1;
        fetchData();
    }, 400);

    // Watch na search → debounced fetch
    watch(search, () => {
        debouncedSearch();
    });

    // Watch na extra filters → natychmiastowe przeładowanie (reset strony)
    if (extraFilters) {
        watch(
            extraFilters,
            () => {
                options.value.page = 1;
                fetchData();
            },
            { deep: true }
        );
    }

    return {
        items,
        totalItems,
        loading,
        error,
        search,
        options,
        fetchData,
        updateOptions,
    };
}

=================================================================================
FILE: src/composables/useStatusFormatter.ts
LOCATION: .//src/composables/useStatusFormatter.ts
=================================================================================

import { useMetadataStore } from '@/stores/metadata'

interface FormattedStatus {
    label: string;
    color: string;
    icon: string;
}

export function useStatusFormatter() {
    const metadataStore = useMetadataStore()

    const format = (groupName: string, value: string): FormattedStatus => {
        return {
            label: metadataStore.getLabel(groupName, value),
            color: metadataStore.getColor(groupName, value),
            icon: metadataStore.getIcon(groupName, value)
        }
    }

    return {
        // Zamówienia
        formatOrderStatus: (status: string) => format('orderStatuses', status),
        formatPaymentStatus: (status: string) => format('paymentStatuses', status),
        formatPriority: (priority: string) => format('orderPriorities', priority),

        // WARIANTY (NOWE)
        formatVariantStatus: (status: string) => format('variantStatuses', status),
        formatVariantType: (type: string) => format('variantTypes', type),

        // Asortyment
        formatAssortmentType: (type: string) => format('assortmentTypes', type),

        // Stanowiska
        formatWorkstationType: (type: string) => format('workstationTypes', type),
        formatWorkstationStatus: (status: string) => format('workstationStatuses', status),

        // Produkcja
        formatProductionStatus: (status: string) => format('productionStatuses', status),
        formatTestResult: (result: string) => format('testResults', result),
        formatEventType: (type: string) => format('eventTypes', type),

        // Dostawy i faktury
        formatDeliveryStatus: (status: string) => format('deliveryStatuses', status),
        formatInvoiceStatus: (status: string) => format('invoiceStatuses', status),
        formatPaymentMethod: (method: string) => format('paymentMethods', method),

        // Historia
        formatHistoryAction: (action: string) => format('assortmentHistoryActions', action),

        // Role i typy
        formatUserRole: (role: string) => format('userRoles', role),
        formatCustomerType: (type: string) => format('customerTypes', type),

        // Materiały
        formatMaterialStatus: (status: string) => format('materialStatuses', status),

        // Uniwersalne
        format
    }
}


=================================================================================
FILE: src/composables/useTimer.ts
LOCATION: .//src/composables/useTimer.ts
=================================================================================

import { ref, computed, onUnmounted } from 'vue'
import { timerService } from '@/services/timerService'
import { formatDuration, useFormatters } from '@/composables/useFormatters'

// -----------------------------------------------------------------------------
// TYPY
// -----------------------------------------------------------------------------

export interface TimerVarianceResult {
  actual_hours: number
  estimated_hours: number
  variance_percent: number
  time_variance: number
  actual_cost: number
  cost_variance: number
}

export interface TimerTask {
  estimated_time_hours: number
  [key: string]: any
}

// -----------------------------------------------------------------------------
// IMPLEMENTACJA
// -----------------------------------------------------------------------------

/**
 * Composable do sterowania timerem dla już uruchomionego zadania.
 *
 * Obsługuje: pause / resume / stop + lokalny interval (co 1 sekundę).
 *
 * START nowego zadania jest poza tym composable — realizuje go WorkstationSelect.vue
 * przez timerService.startWork(variantId, workstationId, serviceId).
 *
 * Typowy przepływ Timer.vue:
 *   onMounted → timerService.getTaskDetails(taskId)
 *             → initFromTaskData(task, current_duration_seconds)
 *             → startInterval()
 *
 *   Kliknięcie STOP → stop() → timerService.stop(taskId) → wyniki wariancji
 */
export function useTimer(taskId: number | { value: number }) {

  // Stan
  const isRunning = ref(false)
  const isPaused = ref(false)
  const elapsedSeconds = ref(0)
  const estimatedSeconds = ref(0)
  const taskData = ref<TimerTask | null>(null)
  const variance = ref<TimerVarianceResult | null>(null)

  let intervalId: ReturnType<typeof setInterval> | null = null

  const { varianceColor } = useFormatters()

  // ---
  // Pomocniki
  // ---

  const getTaskId = (): number => {
    return typeof taskId === 'object' && 'value' in taskId ? taskId.value : taskId
  }

  const startInterval = () => {
    if (intervalId) clearInterval(intervalId)
    intervalId = setInterval(() => {
      elapsedSeconds.value++
    }, 1000)
  }

  // ---
  // Computed
  // ---

  // Czas sformatowany HH:MM:SS
  const formattedTime = computed(() => formatDuration(elapsedSeconds.value))

  // Szacowany czas sformatowany HH:MM:SS
  const formattedEstimatedTime = computed(() => formatDuration(estimatedSeconds.value))

  // Procent postępu względem szacowanego czasu (max 100%)
  const progressPercent = computed(() => {
    if (estimatedSeconds.value === 0) return 0
    const percent = (elapsedSeconds.value / estimatedSeconds.value) * 100
    return Math.min(Math.round(percent), 100)
  })

  // Kolor paska postępu (zmienia się gdy zbliżamy się do limitu i przekraczamy)
  const progressColor = computed(() => {
    if (progressPercent.value < 50) return 'success'
    if (progressPercent.value < 90) return 'warning'
    if (progressPercent.value < 100) return 'orange'
    return 'error'
  })

  // Kolor wariancji po zakończeniu (delegacja do useFormatters)
  const varianceColorComputed = computed(() => {
    return varianceColor(variance.value?.variance_percent ?? null)
  })

  // ---
  // Akcje
  // ---

  /**
   * Wstrzymaj zadanie (przerwa).
   * Zatrzymuje lokalny interval.
   */
  const pause = async (): Promise<void> => {
    try {
      await timerService.pause(getTaskId())
      isPaused.value = true
      if (intervalId) {
        clearInterval(intervalId)
        intervalId = null
      }
    } catch (error) {
      console.error('Błąd podczas pauzy timera:', error)
      throw error
    }
  }

  /**
   * Wznów zadanie po przerwie.
   * Wznawia lokalny interval.
   */
  const resume = async (): Promise<void> => {
    try {
      await timerService.resume(getTaskId())
      isPaused.value = false
      startInterval()
    } catch (error) {
      console.error('Błąd podczas wznowienia timera:', error)
      throw error
    }
  }

  /**
   * Zakończ zadanie i pobierz wyniki wariancji.
   * Zatrzymuje lokalny interval.
   */
  const stop = async (): Promise<TimerVarianceResult> => {
    try {
      const result = await timerService.stop(getTaskId())
      isRunning.value = false
      isPaused.value = false
      variance.value = result
      if (intervalId) {
        clearInterval(intervalId)
        intervalId = null
      }
      return result
    } catch (error) {
      console.error('Błąd podczas stop timera:', error)
      throw error
    }
  }

  /**
   * Zainicjalizuj composable danymi z backendu po timerService.getTaskDetails().
   *
   * Ustawia elapsed zsynchronizowany z backendem i startuje lokalny interval.
   * Wywołuj z onMounted Timer.vue.
   */
  const initFromTaskData = (task: TimerTask, currentDurationSeconds: number) => {
    taskData.value = task
    estimatedSeconds.value = Math.floor(task.estimated_time_hours * 3600)
    elapsedSeconds.value = currentDurationSeconds
    isRunning.value = true
    isPaused.value = false
    startInterval()
  }

  // Cleanup przy odmontowaniu komponentu
  onUnmounted(() => {
    if (intervalId) {
      clearInterval(intervalId)
    }
  })

  return {
    // Stan
    isRunning,
    isPaused,
    elapsedSeconds,
    estimatedSeconds,
    taskData,
    variance,

    // Computed
    formattedTime,
    formattedEstimatedTime,
    progressPercent,
    progressColor,
    varianceColorComputed,

    // Akcje
    pause,
    resume,
    stop,
    initFromTaskData,
  }
}

=================================================================================
FILE: src/config/statusMappings.ts
LOCATION: .//src/config/statusMappings.ts
=================================================================================

// src/config/statusMappings.ts

interface StatusConfig {
    color: string;
    icon: string;
}

interface StatusMap {
    [key: string]: StatusConfig;
}

// ============================================================================
// ZAMÓWIENIA
// ============================================================================

export const ORDER_STATUSES: StatusMap = {
    draft: {
        color: 'grey',
        icon: 'mdi-file-document-outline'
    },
    quotation: {
        color: 'blue',
        icon: 'mdi-calculator'
    },
    prototype: {
        color: 'purple',
        icon: 'mdi-test-tube'
    },
    production: {
        color: 'orange',
        icon: 'mdi-cog'
    },
    delivery: {
        color: 'cyan',
        icon: 'mdi-truck-delivery'
    },
    completed: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    cancelled: {
        color: 'red',
        icon: 'mdi-cancel'
    }
}

export const PAYMENT_STATUSES: StatusMap = {
    unpaid: {
        color: 'grey',
        icon: 'mdi-clock-outline'
    },
    partial: {
        color: 'orange',
        icon: 'mdi-clock-alert'
    },
    paid: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    overdue: {
        color: 'red',
        icon: 'mdi-alert-circle'
    }
}

export const ORDER_PRIORITIES: StatusMap = {
    low: {
        color: 'grey',
        icon: 'mdi-flag-outline'
    },
    normal: {
        color: 'blue',
        icon: 'mdi-flag'
    },
    high: {
        color: 'orange',
        icon: 'mdi-flag'
    },
    urgent: {
        color: 'red',
        icon: 'mdi-fire'
    }
}

// ============================================================================
// ASORTYMENT
// ============================================================================

export const ASSORTMENT_TYPES: StatusMap = {
    material: {
        color: 'blue',
        icon: 'mdi-package-variant'
    },
    service: {
        color: 'orange',
        icon: 'mdi-wrench'
    }
}

// ============================================================================
// STANOWISKA
// ============================================================================

export const WORKSTATION_TYPES: StatusMap = {
    cnc: {
        color: 'blue',
        icon: 'mdi-laser-pointer'
    },
    laser: {
        color: 'red',
        icon: 'mdi-laser-pointer'
    },
    assembly: {
        color: 'green',
        icon: 'mdi-puzzle'
    },
    welding: {
        color: 'orange',
        icon: 'mdi-fire'
    },
    painting: {
        color: 'purple',
        icon: 'mdi-spray'
    },
    packaging: {
        color: 'brown',
        icon: 'mdi-package-variant'
    },
    quality_control: {
        color: 'teal',
        icon: 'mdi-magnify'
    },
    other: {
        color: 'grey',
        icon: 'mdi-wrench'
    }
}

export const WORKSTATION_STATUSES: StatusMap = {
    idle: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    active: {
        color: 'blue',
        icon: 'mdi-cog'
    },
    maintenance: {
        color: 'orange',
        icon: 'mdi-wrench'
    },
    offline: {
        color: 'red',
        icon: 'mdi-power-off'
    }
}

// ============================================================================
// PRODUKCJA
// ============================================================================

export const PRODUCTION_STATUSES: StatusMap = {
    planned: {
        color: 'grey',
        icon: 'mdi-clock-outline'
    },
    in_progress: {
        color: 'orange',
        icon: 'mdi-cog'
    },
    paused: {
        color: 'yellow',
        icon: 'mdi-pause'
    },
    completed: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    cancelled: {
        color: 'red',
        icon: 'mdi-cancel'
    }
}

export const TEST_RESULTS: StatusMap = {
    pending: {
        color: 'yellow',
        icon: 'mdi-clock-outline'
    },
    passed: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    failed: {
        color: 'red',
        icon: 'mdi-close-circle'
    }
}

export const EVENT_TYPES: StatusMap = {
    start: {
        color: 'green',
        icon: 'mdi-play'
    },
    pause: {
        color: 'orange',
        icon: 'mdi-pause'
    },
    resume: {
        color: 'blue',
        icon: 'mdi-play-circle'
    },
    stop: {
        color: 'red',
        icon: 'mdi-stop'
    }
}

// ============================================================================
// DOSTAWY I FAKTURY
// ============================================================================

export const DELIVERY_STATUSES: StatusMap = {
    scheduled: {
        color: 'blue',
        icon: 'mdi-calendar-clock'
    },
    in_transit: {
        color: 'orange',
        icon: 'mdi-truck'
    },
    delivered: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    cancelled: {
        color: 'red',
        icon: 'mdi-cancel'
    }
}

export const INVOICE_STATUSES: StatusMap = {
    issued: {
        color: 'blue',
        icon: 'mdi-file-document'
    },
    paid: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    overdue: {
        color: 'red',
        icon: 'mdi-alert'
    },
    cancelled: {
        color: 'grey',
        icon: 'mdi-cancel'
    }
}

export const PAYMENT_METHODS: StatusMap = {
    transfer: {
        color: 'blue',
        icon: 'mdi-bank-transfer'
    },
    cash: {
        color: 'green',
        icon: 'mdi-cash'
    },
    card: {
        color: 'purple',
        icon: 'mdi-credit-card'
    },
    other: {
        color: 'grey',
        icon: 'mdi-dots-horizontal'
    }
}

// ============================================================================
// HISTORIA
// ============================================================================

export const ASSORTMENT_HISTORY_ACTIONS: StatusMap = {
    created: {
        color: 'green',
        icon: 'mdi-plus-circle'
    },
    updated: {
        color: 'blue',
        icon: 'mdi-pencil'
    },
    deleted: {
        color: 'red',
        icon: 'mdi-delete'
    },
    activated: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    deactivated: {
        color: 'orange',
        icon: 'mdi-pause-circle'
    }
}

// ============================================================================
// ROLE I TYPY
// ============================================================================

export const USER_ROLES: StatusMap = {
    admin: {
        color: 'red',
        icon: 'mdi-shield-crown'
    },
    project_manager: {
        color: 'purple',
        icon: 'mdi-account-tie'
    },
    production_manager: {
        color: 'orange',
        icon: 'mdi-account-hard-hat'
    },
    trader: {
        color: 'blue',
        icon: 'mdi-handshake'
    },
    logistics_specialist: {
        color: 'cyan',
        icon: 'mdi-truck-delivery'
    },
    production_employee: {
        color: 'green',
        icon: 'mdi-account-wrench'
    }
}

export const CUSTOMER_TYPES: StatusMap = {
    b2b: {
        color: 'blue',
        icon: 'mdi-domain'
    },
    b2c: {
        color: 'purple',
        icon: 'mdi-account'
    }
}

// ============================================================================
// MATERIAŁY (NOWE)
// ============================================================================

export const MATERIAL_STATUSES: StatusMap = {
    NOT_ORDERED: {
        color: 'red',
        icon: 'mdi-cart-outline'
    },
    ORDERED: {
        color: 'orange',
        icon: 'mdi-truck-fast-outline'
    },
    PARTIALLY_IN_STOCK: {
        color: 'blue',
        icon: 'mdi-package-variant'
    },
    IN_STOCK: {
        color: 'green',
        icon: 'mdi-package-variant-closed-check'
    }
}

export const VARIANT_STATUSES: StatusMap = {
    DRAFT: {
        color: 'grey-lighten-1',
        icon: 'mdi-pencil-outline'
    },
    QUOTATION: {
        color: 'blue',
        icon: 'mdi-calculator'
    },
    PRODUCTION: {
        color: 'orange',
        icon: 'mdi-cog'
    },
    DELIVERY: {
        color: 'cyan',
        icon: 'mdi-truck-delivery'
    },
    COMPLETED: {
        color: 'green',
        icon: 'mdi-check-circle'
    },
    CANCELLED: {
        color: 'red-darken-4',
        icon: 'mdi-cancel'
    }
}

export const VARIANT_TYPES: StatusMap = {
    PROTOTYPE: {
        color: 'purple',
        icon: 'mdi-flask'
    },
    SERIAL: {
        color: 'blue',
        icon: 'mdi-factory'
    }
}



export const PRIORITIES = ORDER_PRIORITIES

=================================================================================
FILE: src/enums/UserRole.ts
LOCATION: .//src/enums/UserRole.ts
=================================================================================

export enum UserRole {
    ADMIN = 'ADMIN',
    PROJECT_MANAGER = 'PROJECT_MANAGER',
    TRADER = 'TRADER',
    PRODUCTION_EMPLOYEE = 'PRODUCTION_EMPLOYEE',
    ADMINISTRATIVE_EMPLOYEE = 'ADMINISTRATIVE_EMPLOYEE',
    LOGISTICS_SPECIALIST = 'LOGISTICS_SPECIALIST'
}

=================================================================================
FILE: src/layouts/MainLayout.vue
LOCATION: .//src/layouts/MainLayout.vue
=================================================================================

<template>
  <v-app>
    <!-- Header dynamiczny na podstawie roli -->
    <!-- Dla pracowników produkcyjnych (PRODUCTION_EMPLOYEE) pokazujemy RcpHeader -->
    <rcp-header
      v-if="authStore.isWorker"
      :show-back="showBackButton"
      @back="handleBack"
    />

    <!-- Dla pozostałych ról (Admin, Manager, Trader, etc.) pokazujemy pełny AppHeader -->
    <app-header v-else @toggle-drawer="mobileDrawer = !mobileDrawer" />

    <!-- Mobile Drawer - tylko dla użytkowników z pełnym dostępem -->
    <v-navigation-drawer
      v-if="!authStore.isWorker"
      v-model="mobileDrawer"
      temporary
      location="left"
      class="d-md-none"
    >
      <v-list>
        <v-list-item
          prepend-icon="mdi-factory"
          title="CSERP"
          subtitle="Custom Solutions ERP"
          class="mb-2"
        />
        <v-divider />
        <v-list-item
          v-for="item in mobileNavItems"
          :key="item.to"
          :to="item.to"
          :prepend-icon="item.icon"
          :title="item.title"
        />
      </v-list>
    </v-navigation-drawer>

    <!-- Główna zawartość -->
    <v-main class="flex-grow-1">
      <slot />
    </v-main>

    <!-- Footer - ukryty dla pracowników produkcyjnych (opcjonalnie) -->
    <app-footer />
  </v-app>
</template>

<script setup lang="ts">
import { ref, computed } from "vue";
import { useRouter, useRoute } from "vue-router";
import { useAuthStore } from "@/stores/auth";
import AppHeader from "@/components/layout/AppHeader.vue";
import AppFooter from "@/components/layout/AppFooter.vue";
import RcpHeader from "@/components/layout/RcpHeader.vue";

const router = useRouter();
const route = useRoute();
const authStore = useAuthStore();
const mobileDrawer = ref(false);

// Określanie czy pokazać przycisk wstecz w RcpHeader
// Pokazujemy go gdy jesteśmy na stronie Timer (nie na głównej stronie wyboru stanowiska)
const showBackButton = computed(() => {
  // Lista ścieżek gdzie NIE pokazujemy przycisku wstecz
  const noBackRoutes = ["/rcp/workstation", "/dashboard"];
  return !noBackRoutes.includes(route.path);
});

// Obsługa przycisku wstecz
const handleBack = () => {
  // Jeśli jesteśmy na timerze, wracamy do wyboru stanowiska
  if (route.path.startsWith("/rcp/timer")) {
    router.push("/rcp/workstation");
  } else {
    router.back();
  }
};

// Menu mobilne dla pełnego dostępu
const mobileNavItems = computed(() => {
  const items = [{ title: "Dashboard", icon: "mdi-view-dashboard", to: "/dashboard" }];

  if (authStore.canManageSystem) {
    items.push(
      { title: "Zamówienia", icon: "mdi-clipboard-text", to: "/orders" },
      { title: "Klienci", icon: "mdi-account-group", to: "/customers" },
      { title: "Asortyment", icon: "mdi-package-variant-closed", to: "/assortment" },
      { title: "Stanowiska", icon: "mdi-factory", to: "/workstations" }
    );
  }

  items.push({ title: "Panel Pracownika", icon: "mdi-timer", to: "/rcp/workstation" });
  return items;
});
</script>


=================================================================================
FILE: src/types/index.ts
LOCATION: .//src/types/index.ts
=================================================================================

export interface User {
    id: number;
    name: string;
    email: string;
    role: string;
}

export interface Customer {
    id: number;
    name: string;
    type: 'B2B' | 'B2C';
    nip?: string;
    email?: string;
    phone?: string;
    address?: string;
    is_active: boolean;
    stats?: {
        total_orders: number;
        active_orders: number;
        completed_orders: number;
        total_budget: number;
        paid_orders: number;
        unpaid_orders: number;
    };
}

export interface Order {
    id: number;
    order_number: string;
    series: string;
    full_order_number: string;
    customer_id: number;
    customer?: Customer;
    description: string;
    planned_delivery_date?: string;
    overall_status: string;
    payment_status: string;
    priority: string;
    created_at: string;
    updated_at: string;
    variants?: Variant[];
    materials_cost?: number;
    services_cost?: number;
    total_price?: number;
}

// ZMIANY W VARIANT:
export interface Variant {
    id: number;
    order_id: number;
    variant_number: string;
    name: string;
    description?: string; // NOWE
    quantity: number;
    type: 'PROTOTYPE' | 'SERIAL'; // NOWE
    status: string; // ZAMIAST status
    is_approved: boolean; // NOWE (dla prototypu)
    feedback_notes?: string; // NOWE

    created_at: string;
    updated_at: string; // WAŻNE: data ostatniej aktualizacji

    production_order?: any;
    prototypes?: any[];
}

export interface AssortmentItem {
    id: number;
    name: string;
    type: 'material' | 'service';
    category: string;
    unit: string;
    default_price: number;
    description?: string;
    is_active: boolean;
}

export interface Workstation {
    id: number;
    name: string;
    type: string;
    status: string;
    location?: string;
    operators?: User[];
}

export interface ApiResponse<T> {
    data: T;
    message?: string;
    success?: boolean;
    meta?: {
        current_page: number;
        last_page: number;
        total: number;
    };
}

=================================================================================
FILE: src/assets/main.css
LOCATION: .//src/assets/main.css
=================================================================================

/* Global styles */
body {
  font-family: 'Roboto', sans-serif;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #555;
}


=================================================================================
FILE: src/style.css
LOCATION: .//src/style.css
=================================================================================

:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.card {
  padding: 2em;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}


=================================================================================
FILE: src/views/Dashboard.vue
LOCATION: .//src/views/Dashboard.vue
=================================================================================

<template>
  <v-container fluid>
    <!-- Page Header -->
    <page-header
      title="Dashboard"
      subtitle="Przegląd systemu CSERP"
      icon="mdi-view-dashboard"
      icon-color="primary"
      :breadcrumbs="[]"
    />

    <!-- Quick Actions -->
    <v-card class="mt-6" elevation="2">
      <v-card-title class="d-flex align-center">
        <v-icon class="mr-2">mdi-lightning-bolt</v-icon>
        Szybkie akcje
      </v-card-title>
      <v-divider />
      <v-card-text>
        <v-row>
          <!-- Sekcja Zarządcza (Admin/Manager) -->
          <template v-if="authStore.canManageSystem">
            <v-col cols="12" sm="6" md="3">
              <v-card
                variant="outlined"
                hover
                @click="$router.push('/orders')"
                class="cursor-pointer text-center pa-4"
              >
                <v-avatar color="blue" size="64" class="mb-3">
                  <v-icon color="white" size="36">mdi-clipboard-text</v-icon>
                </v-avatar>
                <div class="text-h6 font-weight-bold">Zamówienia</div>
                <div class="text-caption text-medium-emphasis mt-1">
                  Zarządzaj zamówieniami
                </div>
              </v-card>
            </v-col>

            <v-col cols="12" sm="6" md="3">
              <v-card
                variant="outlined"
                hover
                @click="$router.push('/assortment')"
                class="cursor-pointer text-center pa-4"
              >
                <v-avatar color="orange" size="64" class="mb-3">
                  <v-icon color="white" size="36">mdi-package-variant</v-icon>
                </v-avatar>
                <div class="text-h6 font-weight-bold">Asortyment</div>
                <div class="text-caption text-medium-emphasis mt-1">
                  Materiały i usługi
                </div>
              </v-card>
            </v-col>
          </template>

          <!-- Sekcja Pracownika (Dostępna dla wszystkich lub można ograniczyć) -->
          <!-- Dynamiczna szerokość kolumny: jeśli zarządzający, to 3 kolumny, jeśli worker, to 6 lub 12 -->
          <v-col
            cols="12"
            :sm="authStore.canManageSystem ? 6 : 12"
            :md="authStore.canManageSystem ? 3 : 6"
          >
            <v-card
              variant="outlined"
              hover
              @click="$router.push('/rcp/workstation')"
              class="cursor-pointer text-center pa-4"
              color="success"
            >
              <v-avatar color="success" size="64" class="mb-3">
                <v-icon color="white" size="36">mdi-timer</v-icon>
              </v-avatar>
              <div class="text-h6 font-weight-bold">Panel Pracownika</div>
              <div class="text-caption text-medium-emphasis mt-1">Timer produkcyjny</div>
            </v-card>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>
  </v-container>
</template>

<script setup lang="ts">
import { onMounted } from "vue";
import { useAuthStore } from "@/stores/auth";
import PageHeader from "@/components/layout/PageHeader.vue";

const authStore = useAuthStore();

onMounted(async () => {
  if (!authStore.user) {
    await authStore.fetchUser();
  }
});
</script>

<style scoped>
.cursor-pointer {
  cursor: pointer;
}
</style>


=================================================================================
FILE: src/views/assortment/AssortmentList.vue
LOCATION: .//src/views/assortment/AssortmentList.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Asortyment"
      subtitle="Zarządzaj bazą materiałów i usług"
      icon="mdi-package-variant-closed"
      icon-color="orange"
      :breadcrumbs="[{ title: 'Asortyment', disabled: true }]"
    >
      <template #actions>
        <v-btn
          color="primary"
          variant="elevated"
          prepend-icon="mdi-plus"
          size="large"
          @click="openCreateDialog"
        >
          DODAJ POZYCJĘ
        </v-btn>
      </template>
    </page-header>

    <!-- Filtry -->
    <v-card elevation="2" class="mb-4">
      <v-card-text>
        <v-row align="center">
          <v-col cols="12" md="4">
            <v-text-field
              v-model="search"
              label="Szukaj po nazwie lub opisie"
              prepend-inner-icon="mdi-magnify"
              variant="outlined"
              density="compact"
              hide-details
              clearable
            />
          </v-col>

          <v-col cols="12" md="3">
            <v-select
              v-model="filters.type"
              label="Typ"
              :items="typeOptions"
              item-title="label"
              item-value="value"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              prepend-inner-icon="mdi-filter-variant"
            />
          </v-col>

          <v-col cols="12" md="3">
            <v-autocomplete
              v-model="filters.category"
              label="Kategoria"
              :items="categories"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              prepend-inner-icon="mdi-shape"
              placeholder="Wybierz kategorię"
              no-data-text="Brak kategorii dla wybranego typu"
            />
          </v-col>

          <v-col cols="12" md="2">
            <v-switch
              v-model="showInactive"
              label="Pokaż nieaktywne"
              color="error"
              hide-details
              density="compact"
              @update:model-value="onInactiveToggle"
            />
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>

    <!-- Tabela z paginacją server-side -->
    <v-card elevation="2">
      <v-data-table-server
        :headers="headers"
        :items="items"
        :items-length="totalItems"
        :loading="loading"
        :items-per-page="options.itemsPerPage"
        :page="options.page"
        :sort-by="options.sortBy"
        hover
        @update:options="updateOptions"
      >
        <!-- Kolumna: Nazwa -->
        <template v-slot:item.name="{ item }">
          <div class="font-weight-bold">{{ item.name }}</div>
          <div
            class="text-caption text-medium-emphasis text-truncate"
            style="max-width: 300px"
          >
            {{ item.description }}
          </div>
        </template>

        <!-- Kolumna: Typ -->
        <template v-slot:item.type="{ item }">
          <v-chip
            size="small"
            :color="formatAssortmentType(item.type).color"
            variant="tonal"
          >
            <v-icon start size="small">
              {{ formatAssortmentType(item.type).icon }}
            </v-icon>
            {{ formatAssortmentType(item.type).label }}
          </v-chip>
        </template>

        <!-- Kolumna: Cena -->
        <template v-slot:item.default_price="{ item }">
          <span class="font-weight-bold">
            {{ formatCurrency(item.default_price) }}
          </span>
          <span class="text-caption text-medium-emphasis ml-1">
            / {{ getUnitLabel(item.unit) }}
          </span>
        </template>

        <!-- Kolumna: Akcje -->
        <template v-slot:item.actions="{ item }">
          <div class="d-flex justify-end">
            <v-tooltip text="Edytuj" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  icon="mdi-pencil"
                  variant="text"
                  size="small"
                  color="primary"
                  v-bind="props"
                  @click="openEditDialog(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip :text="item.is_active ? 'Dezaktywuj' : 'Aktywuj'" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  :icon="item.is_active ? 'mdi-eye-off' : 'mdi-eye'"
                  variant="text"
                  size="small"
                  :color="item.is_active ? 'grey' : 'success'"
                  v-bind="props"
                  @click="toggleActive(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip text="Historia zmian" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  icon="mdi-history"
                  variant="text"
                  size="small"
                  color="info"
                  v-bind="props"
                  @click="openHistoryDialog(item)"
                />
              </template>
            </v-tooltip>
          </div>
        </template>

        <template v-slot:no-data>
          <div class="text-center py-8">
            <v-icon size="64" color="grey-lighten-1">mdi-package-variant-closed</v-icon>
            <div class="text-h6 mt-4 text-medium-emphasis">Brak asortymentu</div>
            <p class="text-body-2 text-medium-emphasis mb-4">
              Zmień filtry lub dodaj nową pozycję.
            </p>
            <v-btn color="primary" variant="outlined" @click="openCreateDialog">
              Dodaj pozycję
            </v-btn>
          </div>
        </template>
      </v-data-table-server>
    </v-card>

    <!-- Dialogi -->
    <assortment-form-dialog
      v-model="formDialog"
      :item="editingItem"
      @saved="refreshData"
    />

    <assortment-history-dialog v-model="historyDialog" :item="historyItem" />
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from "vue";
import PageHeader from "@/components/layout/PageHeader.vue";
import AssortmentFormDialog from "@/components/assortment/AssortmentFormDialog.vue";
import AssortmentHistoryDialog from "@/components/assortment/AssortmentHistoryDialog.vue";
import { useAssortmentStore } from "@/stores/assortment";
import { useMetadataStore } from "@/stores/metadata";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { useServerTable } from "@/composables/useServerTable";
import api from "@/services/api";

const { formatAssortmentType } = useStatusFormatter();
const assortmentStore = useAssortmentStore();
const metadataStore = useMetadataStore();

// Filtry
const showInactive = ref(false);
const categories = ref<string[]>([]);

const filters = ref<Record<string, any>>({
  type: null,
  category: null,
  is_active: true, // domyślnie tylko aktywne
});

// Server-side table
const {
  items,
  totalItems,
  loading,
  error,
  search,
  options,
  fetchData,
  updateOptions,
} = useServerTable("/assortment", {
  defaultPerPage: 20,
  defaultSortBy: "category",
  defaultSortDir: "asc",
  extraFilters: filters,
});

// Dialogi
const formDialog = ref(false);
const historyDialog = ref(false);
const editingItem = ref(null);
const historyItem = ref(null);

const typeOptions = [
  { label: "Wszystkie", value: null },
  { label: "Materiał", value: "material" },
  { label: "Usługa", value: "service" },
];

const headers = [
  { title: "Nazwa", key: "name", width: "30%" },
  { title: "Typ", key: "type", width: "15%" },
  { title: "Kategoria", key: "category", width: "20%" },
  { title: "Cena domyślna", key: "default_price", align: "end", width: "20%" },
  { title: "Akcje", key: "actions", align: "end", sortable: false, width: "15%" },
];

// Załaduj kategorie (z osobnego endpointu — lekkie dane)
const loadCategories = async () => {
  try {
    const params: any = {};
    if (filters.value.type) params.type = filters.value.type;
    const response = await api.get("/assortment-categories", { params });
    categories.value = response.data || [];
  } catch {
    categories.value = [];
  }
};

// Watch typ → przeładuj kategorie i zresetuj filtr kategorii
watch(
  () => filters.value.type,
  async (newType, oldType) => {
    if (newType !== oldType) {
      filters.value.category = null;
      await loadCategories();
    }
  }
);

const onInactiveToggle = (val: boolean) => {
  filters.value.is_active = val ? null : true;
};

// Helpers
const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);

const getUnitLabel = (unit: string) => {
  const unitMap: Record<string, string> = {
    m2: "m²",
    m: "mb",
    kg: "kg",
    szt: "szt",
    h: "h",
    l: "l",
  };
  return unitMap[unit] || unit;
};

// Akcje
const openCreateDialog = () => {
  editingItem.value = null;
  formDialog.value = true;
};

const openEditDialog = (item: any) => {
  editingItem.value = { ...item };
  formDialog.value = true;
};

const openHistoryDialog = (item: any) => {
  historyItem.value = item;
  historyDialog.value = true;
};

const toggleActive = async (item: any) => {
  try {
    await api.patch(`/assortment/${item.id}/toggle-active`);
    await fetchData();
  } catch (err) {
    console.error("Błąd zmiany statusu:", err);
  }
};

const refreshData = async () => {
  await fetchData();
  await loadCategories();
};

onMounted(async () => {
  await loadCategories();
  await fetchData();
});
</script>


=================================================================================
FILE: src/views/auth/Login.vue
LOCATION: .//src/views/auth/Login.vue
=================================================================================

<template>
  <v-app>
    <v-main class="d-flex align-center justify-center bg-grey-lighten-4">
      <v-container>
        <v-row justify="center">
          <v-col cols="12" sm="8" md="6" lg="4">
            <v-card elevation="8" rounded="lg">
              <v-card-text class="pa-8">
                <!-- Logo/Tytuł -->
                <div class="text-center mb-6">
                  <v-icon size="80" color="primary">mdi-factory</v-icon>
                  <h1 class="text-h4 font-weight-bold mt-4">CSERP</h1>
                  <p class="text-subtitle-1 text-medium-emphasis">Custom Solutions ERP</p>
                </div>

                <!-- Alert błędu -->
                <v-alert
                  v-if="authStore.error"
                  type="error"
                  variant="tonal"
                  class="mb-4"
                  closable
                  @click:close="authStore.error = null"
                >
                  {{ authStore.error }}
                </v-alert>

                <!-- Alert sesji wygasłej -->
                <v-alert
                  v-if="route.query.session === 'expired'"
                  type="warning"
                  variant="tonal"
                  class="mb-4"
                >
                  <v-alert-title>Sesja wygasła</v-alert-title>
                  Zaloguj się ponownie aby kontynuować
                </v-alert>

                <!-- Formularz logowania -->
                <v-form ref="formRef" @submit.prevent="handleLogin">
                  <v-text-field
                    v-model="email"
                    label="Email"
                    type="email"
                    variant="outlined"
                    prepend-inner-icon="mdi-email"
                    :rules="[rules.required, rules.email]"
                    class="mb-3"
                  />

                  <v-text-field
                    v-model="password"
                    label="Hasło"
                    :type="showPassword ? 'text' : 'password'"
                    variant="outlined"
                    prepend-inner-icon="mdi-lock"
                    :append-inner-icon="showPassword ? 'mdi-eye' : 'mdi-eye-off'"
                    @click:append-inner="showPassword = !showPassword"
                    :rules="[rules.required]"
                    class="mb-4"
                  />

                  <v-btn
                    type="submit"
                    color="primary"
                    variant="elevated"
                    size="large"
                    block
                    :loading="authStore.loading"
                  >
                    <v-icon start>mdi-login</v-icon>
                    Zaloguj się
                  </v-btn>
                </v-form>

                <!-- Demo credentials -->
                <v-divider class="my-6" />
                <div class="text-center text-caption text-medium-emphasis">
                  <p class="mb-2">Demo credentials:</p>
                  <p><strong>Admin:</strong> admin@cserp.pl / pa$$word</p>
                  <p><strong>Manager:</strong> manager@cserp.pl / pa$$word</p>
                  <p><strong>Pracownik:</strong> jan@cserp.pl / pa$$word</p>
                </div>
              </v-card-text>
            </v-card>

            <!-- System Info -->
            <v-card elevation="2" class="mt-4">
              <v-card-text class="text-center text-caption">
                <v-icon size="small" class="mr-1">mdi-information</v-icon>
                CSERP v1.0 • Laravel 11 + Vue 3
              </v-card-text>
            </v-card>

            <v-btn
              variant="text"
              color="primary"
              block
              class="mt-4"
              @click="switchLoginView()"
              prepend-icon="mdi-dialpad"
            >
              Logowanie PIN (Produkcja)
            </v-btn>
          </v-col>
        </v-row>
      </v-container>
    </v-main>
  </v-app>
</template>

<script setup lang="ts">
import { ref } from "vue";
import { useRouter, useRoute } from "vue-router";
import { useAuthStore } from "@/stores/auth";

const router = useRouter();
const route = useRoute();
const authStore = useAuthStore();

const formRef = ref(null);
const email = ref("admin@cserp.pl");
const password = ref("pa$$word");
const showPassword = ref(false);

const rules = {
  required: (v) => !!v || "Pole jest wymagane",
  email: (v) => /.+@.+\..+/.test(v) || "Nieprawidłowy email",
};

const switchLoginView = () => {
  localStorage.removeItem("login_mode");
  router.push("/login-pin");
};

const handleLogin = async () => {
  // Walidacja formularza
  const { valid } = await formRef.value.validate();
  if (!valid) return;

  // Logowanie
  const success = await authStore.login(email.value, password.value);

  if (success) {
    // Przekieruj do strony z query redirect lub dashboard
    const redirectPath = route.query.redirect || "/dashboard";
    router.push(redirectPath);
  }
};
</script>

<style scoped>
.v-main {
  min-height: 100vh;
}
</style>


=================================================================================
FILE: src/views/auth/LoginPin.vue
LOCATION: .//src/views/auth/LoginPin.vue
=================================================================================

<template>
  <!-- Template pozostaje bez zmian -->
  <v-container
    fluid
    class="fill-height bg-grey-lighten-3 d-flex align-center justify-center"
  >
    <v-card elevation="8" class="rounded-xl overflow-hidden" width="100%" max-width="450">
      <div class="bg-primary pa-6 text-center">
        <v-icon size="48" color="white" class="mb-2">mdi-factory</v-icon>
        <h2 class="text-h5 font-weight-bold text-white">CSERP Produkcja</h2>
        <div class="text-caption text-blue-lighten-4">
          Wprowadź swój identyfikator PIN
        </div>
      </div>

      <v-card-text class="pa-6">
        <!-- Wyświetlacz PIN (Kropki) -->
        <div class="d-flex justify-center gap-4 my-6">
          <div
            v-for="i in 4"
            :key="i"
            class="pin-dot transition-all"
            :class="{
              filled: pin.length >= i,
              'error-shake': shakeError,
            }"
          ></div>
        </div>

        <!-- Komunikat błędu -->
        <v-expand-transition>
          <div
            v-if="authStore.error"
            class="text-center text-error mb-4 font-weight-bold"
          >
            {{ authStore.error }}
          </div>
        </v-expand-transition>

        <!-- Loading -->
        <div v-if="authStore.loading" class="text-center py-8">
          <v-progress-circular indeterminate color="primary"></v-progress-circular>
          <div class="mt-2 text-caption">Autoryzacja...</div>
        </div>

        <!-- Klawiatura Ekranowa -->
        <v-row dense class="numpad" v-else>
          <v-col v-for="n in [1, 2, 3, 4, 5, 6, 7, 8, 9]" :key="n" cols="4">
            <v-btn
              block
              height="70"
              variant="outlined"
              class="text-h4 font-weight-regular rounded-lg mb-3"
              @click="appendPin(n)"
              :ripple="false"
            >
              {{ n }}
            </v-btn>
          </v-col>

          <!-- Przycisk powrotu do logowania hasłem -->
          <v-col cols="4">
            <v-btn
              block
              height="70"
              variant="text"
              class="rounded-lg mb-3"
              @click="switchLoginView()"
              color="grey"
              tabindex="-1"
            >
              <v-icon>mdi-account-tie</v-icon>
            </v-btn>
          </v-col>

          <v-col cols="4">
            <v-btn
              block
              height="70"
              variant="outlined"
              class="text-h4 font-weight-regular rounded-lg mb-3"
              @click="appendPin(0)"
              :ripple="false"
            >
              0
            </v-btn>
          </v-col>

          <v-col cols="4">
            <v-btn
              block
              height="70"
              color="error"
              variant="tonal"
              class="rounded-lg mb-3"
              @click="clearPin"
            >
              <v-icon size="32">mdi-backspace-outline</v-icon>
            </v-btn>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from "vue"; // Dodano onUnmounted
import { useRouter } from "vue-router";
import { useAuthStore } from "@/stores/auth";

const router = useRouter();
const authStore = useAuthStore();

const pin = ref("");
const shakeError = ref(false);

// Funkcja obsługująca klawiaturę fizyczną
const handleKeyboardInput = (event) => {
  // Ignoruj jeśli trwa ładowanie
  if (authStore.loading) return;

  const key = event.key;

  // Cyfry 0-9
  if (/^[0-9]$/.test(key)) {
    appendPin(parseInt(key));
    return;
  }

  // Backspace
  if (key === "Backspace") {
    clearPin();
    return;
  }

  // Enter (opcjonalnie, bo logowanie jest automatyczne po 4 cyfrze,
  // ale jeśli ktoś wciśnie Enter przy 4 cyfrach, to też zadziała)
  if (key === "Enter") {
    if (pin.value.length === 4) {
      handleLogin();
    }
  }
};

onMounted(() => {
  if (authStore.isAuthenticated) {
    router.push("/dashboard");
  }
  // Wyczyść błędy przy wejściu
  authStore.error = null;

  // Dodaj nasłuchiwanie klawiatury
  window.addEventListener("keydown", handleKeyboardInput);
});

onUnmounted(() => {
  // Usuń nasłuchiwanie klawiatury przy wyjściu z widoku
  window.removeEventListener("keydown", handleKeyboardInput);
});

const switchLoginView = () => {
  localStorage.removeItem("login_mode");
  router.push("/login");
};

const appendPin = (num) => {
  if (pin.value.length < 4) {
    pin.value += num;
    authStore.error = null;
    shakeError.value = false;

    // Automatyczne logowanie po wpisaniu 4 cyfry
    if (pin.value.length === 4) {
      handleLogin();
    }
  }
};

const clearPin = () => {
  // Usuwa ostatni znak (działa jak Backspace)
  pin.value = pin.value.slice(0, -1);
  authStore.error = null;
  shakeError.value = false;
};

const handleLogin = async () => {
  // Wywołanie akcji w Pinia (bez userId, sam pin)
  const success = await authStore.loginWithPin(pin.value);

  if (success) {
    router.push("/rcp/workstation");
  } else {
    triggerShake();
    setTimeout(() => {
      pin.value = "";
    }, 500); // Wyczyść pin po animacji błędu
  }
};

const triggerShake = () => {
  shakeError.value = true;
  setTimeout(() => {
    shakeError.value = false;
  }, 500);
};
</script>

<style scoped>
.pin-dot {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid #bdbdbd;
  background-color: transparent;
  transition: all 0.2s ease;
  margin: 5px;
}

.pin-dot.filled {
  background-color: rgb(var(--v-theme-primary));
  border-color: rgb(var(--v-theme-primary));
  transform: scale(1.1);
  box-shadow: 0 0 10px rgba(var(--v-theme-primary), 0.4);
}

.error-shake {
  animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
  border-color: rgb(var(--v-theme-error)) !important;
  background-color: rgb(var(--v-theme-error)) !important;
}

@keyframes shake {
  10%,
  90% {
    transform: translate3d(-1px, 0, 0);
  }
  20%,
  80% {
    transform: translate3d(2px, 0, 0);
  }
  30%,
  50%,
  70% {
    transform: translate3d(-4px, 0, 0);
  }
  40%,
  60% {
    transform: translate3d(4px, 0, 0);
  }
}

.numpad .v-btn {
  font-size: 1.5rem !important;
}
</style>


=================================================================================
FILE: src/views/customers/CustomerDetail.vue
LOCATION: .//src/views/customers/CustomerDetail.vue
=================================================================================

<template>
  <v-container fluid>
    <!-- Loading -->
    <div v-if="loading" class="text-center py-12">
      <v-progress-circular indeterminate size="64" color="primary" />
      <p class="mt-4 text-h6">Ładowanie danych klienta...</p>
    </div>

    <!-- Error -->
    <v-alert v-else-if="error" type="error" variant="tonal" prominent>
      <v-alert-title>Błąd</v-alert-title>
      {{ error }}
      <template v-slot:append>
        <v-btn color="error" variant="outlined" @click="fetchCustomer">
          Spróbuj ponownie
        </v-btn>
      </template>
    </v-alert>

    <!-- Content -->
    <template v-else-if="customer">
      <!-- Nagłówek -->
      <page-header
        :title="customer.name"
        :subtitle="`${customer.type} ${customer.nip ? '• NIP: ' + customer.nip : ''}`"
        :icon="customer.type === 'B2B' ? 'mdi-domain' : 'mdi-account'"
        :icon-color="customer.type === 'B2B' ? 'blue' : 'purple'"
        :breadcrumbs="[
          { title: 'Klienci', to: '/customers' },
          { title: customer.name, disabled: true },
        ]"
      >
        <template #actions>
          <v-chip
            :color="customer.is_active ? 'success' : 'error'"
            variant="flat"
            class="mr-4"
          >
            {{ customer.is_active ? "Aktywny" : "Nieaktywny" }}
          </v-chip>

          <v-btn
            color="warning"
            variant="elevated"
            prepend-icon="mdi-pencil"
            class="mr-2"
            @click="openEditDialog"
          >
            EDYTUJ
          </v-btn>

          <v-btn
            :color="customer.is_active ? 'error' : 'success'"
            variant="outlined"
            :prepend-icon="customer.is_active ? 'mdi-account-off' : 'mdi-account-check'"
            @click="toggleActive"
          >
            {{ customer.is_active ? "DEZAKTYWUJ" : "AKTYWUJ" }}
          </v-btn>
        </template>
      </page-header>

      <v-row>
        <!-- Lewa kolumna - dane klienta -->
        <v-col cols="12" md="4">
          <!-- Dane kontaktowe -->
          <v-card elevation="2" class="mb-4">
            <v-card-title class="bg-grey-lighten-4">
              <v-icon class="mr-2">mdi-card-account-details</v-icon>
              Dane kontaktowe
            </v-card-title>
            <v-card-text class="pa-4">
              <v-list density="compact" class="bg-transparent">
                <v-list-item v-if="customer.email">
                  <template v-slot:prepend>
                    <v-icon color="blue">mdi-email</v-icon>
                  </template>
                  <v-list-item-title>{{ customer.email }}</v-list-item-title>
                  <v-list-item-subtitle>Email</v-list-item-subtitle>
                </v-list-item>

                <v-list-item v-if="customer.phone">
                  <template v-slot:prepend>
                    <v-icon color="green">mdi-phone</v-icon>
                  </template>
                  <v-list-item-title>{{ customer.phone }}</v-list-item-title>
                  <v-list-item-subtitle>Telefon</v-list-item-subtitle>
                </v-list-item>

                <v-list-item v-if="customer.address">
                  <template v-slot:prepend>
                    <v-icon color="red">mdi-map-marker</v-icon>
                  </template>
                  <v-list-item-title>{{ customer.address }}</v-list-item-title>
                  <v-list-item-subtitle>Adres</v-list-item-subtitle>
                </v-list-item>

                <v-list-item v-if="customer.nip">
                  <template v-slot:prepend>
                    <v-icon color="purple">mdi-identifier</v-icon>
                  </template>
                  <v-list-item-title>{{ customer.nip }}</v-list-item-title>
                  <v-list-item-subtitle>NIP</v-list-item-subtitle>
                </v-list-item>

                <v-list-item>
                  <template v-slot:prepend>
                    <v-icon color="teal">mdi-tag</v-icon>
                  </template>
                  <v-list-item-title>
                    <v-chip
                      size="small"
                      :color="customer.type === 'B2B' ? 'blue' : 'purple'"
                    >
                      {{ customer.type === "B2B" ? "Firma (B2B)" : "Indywidualny (B2C)" }}
                    </v-chip>
                  </v-list-item-title>
                  <v-list-item-subtitle>Typ klienta</v-list-item-subtitle>
                </v-list-item>

                <v-list-item>
                  <template v-slot:prepend>
                    <v-icon color="grey">mdi-calendar</v-icon>
                  </template>
                  <v-list-item-title>{{
                    formatDate(customer.created_at)
                  }}</v-list-item-title>
                  <v-list-item-subtitle>Data utworzenia</v-list-item-subtitle>
                </v-list-item>
              </v-list>
            </v-card-text>
          </v-card>

          <!-- Statystyki -->
          <v-card elevation="2">
            <v-card-title class="bg-grey-lighten-4">
              <v-icon class="mr-2">mdi-chart-bar</v-icon>
              Statystyki
            </v-card-title>
            <v-card-text class="pa-4">
              <v-row dense>
                <v-col cols="6">
                  <div class="text-center pa-3 rounded bg-blue-lighten-5">
                    <div class="text-h4 font-weight-bold text-blue">
                      {{ customer.stats?.total_orders || 0 }}
                    </div>
                    <div class="text-caption">Wszystkich zamówień</div>
                  </div>
                </v-col>
                <v-col cols="6">
                  <div class="text-center pa-3 rounded bg-orange-lighten-5">
                    <div class="text-h4 font-weight-bold text-orange">
                      {{ customer.stats?.active_orders || 0 }}
                    </div>
                    <div class="text-caption">Aktywnych</div>
                  </div>
                </v-col>
                <v-col cols="6">
                  <div class="text-center pa-3 rounded bg-green-lighten-5">
                    <div class="text-h4 font-weight-bold text-green">
                      {{ customer.stats?.completed_orders || 0 }}
                    </div>
                    <div class="text-caption">Zakończonych</div>
                  </div>
                </v-col>
                <v-col cols="6">
                  <div class="text-center pa-3 rounded bg-red-lighten-5">
                    <div class="text-h4 font-weight-bold text-red">
                      {{ customer.stats?.cancelled_orders || 0 }}
                    </div>
                    <div class="text-caption">Anulowanych</div>
                  </div>
                </v-col>
              </v-row>

              <v-divider class="my-4" />

              <!-- Status płatności -->
              <div class="text-subtitle-2 mb-2">Status płatności</div>
              <div class="d-flex justify-space-between mb-1">
                <span class="text-body-2">Opłacone:</span>
                <v-chip size="x-small" color="success">{{
                  customer.stats?.paid_orders || 0
                }}</v-chip>
              </div>
              <div class="d-flex justify-space-between">
                <span class="text-body-2">Nieopłacone:</span>
                <v-chip size="x-small" color="warning">{{
                  customer.stats?.unpaid_orders || 0
                }}</v-chip>
              </div>
            </v-card-text>
          </v-card>
        </v-col>

        <!-- Prawa kolumna - zamówienia -->
        <v-col cols="12" md="8">
          <v-card elevation="2">
            <v-card-title class="bg-grey-lighten-4 d-flex align-center">
              <v-icon class="mr-2">mdi-clipboard-list</v-icon>
              Ostatnie zamówienia
              <v-spacer />
              <v-btn
                color="primary"
                variant="elevated"
                size="small"
                prepend-icon="mdi-plus"
                @click="openOrderDialog"
              >
                Nowe zamówienie
              </v-btn>
            </v-card-title>

            <v-card-text class="pa-0">
              <v-data-table
                :headers="ordersHeaders"
                :items="customer.orders || []"
                :items-per-page="10"
                hover
                class="orders-table"
                @click:row="viewOrder"
              >
                <!-- Numer zamówienia (Pełny) -->
                <template v-slot:item.full_order_number="{ item }">
                  <span class="font-weight-bold text-primary">{{
                    item.full_order_number
                  }}</span>
                </template>

                <!-- Opis (zamiast Brief) -->
                <template v-slot:item.description="{ item }">
                  <div class="text-truncate" style="max-width: 300px">
                    {{ item.description || "-" }}
                  </div>
                </template>

                <!-- Status -->
                <template v-slot:item.overall_status="{ item }">
                  <v-chip
                    size="small"
                    :color="getStatusColor(item.overall_status)"
                    variant="flat"
                  >
                    {{ getStatusLabel(item.overall_status) }}
                  </v-chip>
                </template>

                <!-- Płatność -->
                <template v-slot:item.payment_status="{ item }">
                  <v-chip
                    size="small"
                    :color="getPaymentColor(item.payment_status)"
                    variant="tonal"
                  >
                    {{ getPaymentLabel(item.payment_status) }}
                  </v-chip>
                </template>

                <!-- Data -->
                <template v-slot:item.created_at="{ item }">
                  {{ formatDate(item.created_at) }}
                </template>

                <!-- Brak zamówień -->
                <template v-slot:no-data>
                  <div class="text-center py-8">
                    <v-icon size="64" color="grey">mdi-clipboard-text-off</v-icon>
                    <div class="text-h6 mt-4 text-medium-emphasis">Brak zamówień</div>
                    <v-btn
                      color="primary"
                      variant="outlined"
                      class="mt-4"
                      @click="openOrderDialog"
                    >
                      Utwórz pierwsze zamówienie
                    </v-btn>
                  </div>
                </template>
              </v-data-table>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>
    </template>

    <!-- Dialog edycji klienta -->
    <customer-form-dialog
      v-model="editDialog"
      :customer="customer"
      @saved="handleCustomerSaved"
    />

    <!-- Dialog nowego zamówienia -->
    <order-form-dialog
      v-model="orderDialog"
      :order="null"
      :preselected-customer-id="customer?.id"
      @saved="handleOrderSaved"
    />

    <!-- Snackbar -->
    <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000">
      {{ snackbar.message }}
      <template v-slot:actions>
        <v-btn variant="text" @click="snackbar.show = false">Zamknij</v-btn>
      </template>
    </v-snackbar>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";
import PageHeader from "@/components/layout/PageHeader.vue";
import CustomerFormDialog from "@/components/customers/CustomerFormDialog.vue";
import OrderFormDialog from "@/components/orders/OrderFormDialog.vue";
import customerService from "@/services/customerService";

const route = useRoute();
const router = useRouter();

// State
const loading = ref(true);
const error = ref(null);
const customer = ref(null);

// Dialog states
const editDialog = ref(false);
const orderDialog = ref(false);

// Snackbar
const snackbar = ref({
  show: false,
  message: "",
  color: "success",
});

// Orders table headers (Zaktualizowane)
const ordersHeaders = [
  { title: "Numer", key: "full_order_number", width: "160px" },
  { title: "Opis", key: "description" },
  { title: "Status", key: "overall_status", align: "center", width: "130px" },
  { title: "Płatność", key: "payment_status", align: "center", width: "120px" },
  { title: "Data", key: "created_at", align: "center", width: "110px" },
];

// Methods
const fetchCustomer = async () => {
  try {
    loading.value = true;
    error.value = null;

    const response = await customerService.getById(route.params.id);
    customer.value = response.data || response;
  } catch (err) {
    console.error("Błąd pobierania klienta:", err);
    error.value = err.response?.data?.message || "Nie udało się pobrać danych klienta";
  } finally {
    loading.value = false;
  }
};

// Customer dialog handlers
const openEditDialog = () => {
  editDialog.value = true;
};

const handleCustomerSaved = async () => {
  await fetchCustomer();
  showSnackbar("Dane klienta zaktualizowane", "success");
};

const toggleActive = async () => {
  try {
    await customerService.toggleActive(customer.value.id);
    await fetchCustomer();
    showSnackbar(
      customer.value.is_active ? "Klient dezaktywowany" : "Klient aktywowany",
      "success"
    );
  } catch (err) {
    console.error("Błąd zmiany statusu:", err);
    showSnackbar(err.response?.data?.message || "Błąd zmiany statusu", "error");
  }
};

// Order dialog handlers
const openOrderDialog = () => {
  orderDialog.value = true;
};

const handleOrderSaved = async () => {
  // Odśwież dane klienta (w tym listę zamówień)
  await fetchCustomer();
  showSnackbar("Zamówienie utworzone pomyślnie", "success");
};

// Navigation
const viewOrder = (event, { item }) => {
  router.push(`/orders/${item.id}`);
};

// Helpers
const formatDate = (date) => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("pl-PL");
};

const getStatusColor = (status) => {
  const colors = {
    draft: "grey",
    quotation: "blue",
    prototype: "purple",
    production: "orange",
    delivery: "cyan",
    completed: "success",
    cancelled: "error",
  };
  return colors[status] || "grey";
};

const getStatusLabel = (status) => {
  const labels = {
    draft: "Szkic",
    quotation: "Wycena",
    prototype: "Prototyp",
    production: "Produkcja",
    delivery: "Dostawa",
    completed: "Zakończone",
    cancelled: "Anulowane",
  };
  return labels[status] || status;
};

const getPaymentColor = (status) => {
  const colors = {
    unpaid: "warning",
    partial: "orange",
    paid: "success",
    overdue: "error",
  };
  return colors[status] || "grey";
};

const getPaymentLabel = (status) => {
  const labels = {
    unpaid: "Nieopłacone",
    partial: "Częściowo",
    paid: "Opłacone",
    overdue: "Zaległe",
  };
  return labels[status] || status;
};

const showSnackbar = (message, color = "success") => {
  snackbar.value = { show: true, message, color };
};

// Lifecycle
onMounted(() => {
  fetchCustomer();
});
</script>

<style scoped>
.orders-table :deep(tbody tr) {
  cursor: pointer;
  transition: background-color 0.2s;
}

.text-truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>


=================================================================================
FILE: src/views/customers/CustomerList.vue
LOCATION: .//src/views/customers/CustomerList.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Klienci"
      subtitle="Zarządzaj bazą klientów"
      icon="mdi-account-group"
      icon-color="teal"
      :breadcrumbs="[{ title: 'Klienci', disabled: true }]"
    >
      <template #actions>
        <v-btn
          color="primary"
          variant="elevated"
          prepend-icon="mdi-plus"
          size="large"
          @click="openCreateDialog"
        >
          NOWY KLIENT
        </v-btn>
      </template>
    </page-header>

    <!-- Filtry -->
    <v-card elevation="2" class="mb-4">
      <v-card-text>
        <v-row align="center">
          <v-col cols="12" md="4">
            <v-text-field
              v-model="search"
              label="Szukaj klienta"
              prepend-inner-icon="mdi-magnify"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              placeholder="Nazwa, NIP, email, telefon..."
            />
          </v-col>

          <v-col cols="12" md="2">
            <v-select
              v-model="filters.type"
              label="Typ klienta"
              :items="typeOptions"
              variant="outlined"
              density="compact"
              hide-details
            />
          </v-col>

          <v-col cols="12" md="2">
            <v-select
              v-model="filters.is_active"
              label="Status"
              :items="activeOptions"
              variant="outlined"
              density="compact"
              hide-details
            />
          </v-col>

          <v-col cols="12" md="4" class="d-flex justify-end gap-2">
            <v-btn variant="outlined" prepend-icon="mdi-refresh" @click="fetchData">
              Odśwież
            </v-btn>
            <v-btn
              variant="outlined"
              prepend-icon="mdi-filter-remove"
              @click="clearFilters"
            >
              Wyczyść filtry
            </v-btn>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>

    <!-- Statystyki (obliczane z paginowanej meta, lub osobny endpoint) -->
    <!-- UWAGA: Statystyki "Wszystkich klientów" itd. wymagają osobnego lekkiego
         endpointu GET /api/customers/stats, bo teraz nie mamy ALL w jednym request.
         Tymczasowo ukrywamy je lub zostawiamy jako TODO. -->

    <!-- Loading -->
    <v-card v-if="loading && items.length === 0" elevation="2" class="text-center py-12">
      <v-progress-circular indeterminate size="64" color="primary" />
      <p class="mt-4 text-h6">Ładowanie klientów...</p>
    </v-card>

    <!-- Error -->
    <v-alert
      v-else-if="error"
      type="error"
      variant="tonal"
      prominent
      closable
      class="mb-4"
      @click:close="error = null"
    >
      <v-alert-title>Błąd</v-alert-title>
      {{ error }}
      <template v-slot:append>
        <v-btn color="error" variant="outlined" @click="fetchData">
          Spróbuj ponownie
        </v-btn>
      </template>
    </v-alert>

    <!-- Tabela klientów z server-side pagination -->
    <v-card v-else elevation="2">
      <v-data-table-server
        :headers="headers"
        :items="items"
        :items-length="totalItems"
        :loading="loading"
        :items-per-page="options.itemsPerPage"
        :page="options.page"
        :sort-by="options.sortBy"
        hover
        class="customers-table"
        @click:row="handleRowClick"
        @update:options="updateOptions"
      >
        <!-- Nazwa klienta -->
        <template v-slot:item.name="{ item }">
          <div class="d-flex align-center py-2">
            <v-avatar
              :color="item.type === 'B2B' ? 'blue' : 'purple'"
              size="40"
              class="mr-3"
            >
              <v-icon color="white">
                {{ item.type === "B2B" ? "mdi-domain" : "mdi-account" }}
              </v-icon>
            </v-avatar>
            <div>
              <div class="font-weight-bold">{{ item.name }}</div>
              <div class="text-caption text-medium-emphasis">
                {{ item.type }}
                <span v-if="item.nip"> • NIP: {{ item.nip }}</span>
              </div>
            </div>
          </div>
        </template>

        <!-- Kontakt -->
        <template v-slot:item.contact="{ item }">
          <div>
            <div v-if="item.email" class="text-body-2">
              <v-icon size="small" class="mr-1">mdi-email</v-icon>
              {{ item.email }}
            </div>
            <div v-if="item.phone" class="text-body-2">
              <v-icon size="small" class="mr-1">mdi-phone</v-icon>
              {{ item.phone }}
            </div>
            <span v-if="!item.email && !item.phone" class="text-medium-emphasis">-</span>
          </div>
        </template>

        <!-- Adres -->
        <template v-slot:item.address="{ item }">
          <div class="text-truncate" style="max-width: 250px">
            {{ item.address || "-" }}
          </div>
        </template>

        <!-- Liczba zamówień -->
        <template v-slot:item.orders_count="{ item }">
          <v-chip
            size="small"
            :color="item.orders_count > 0 ? 'blue' : 'grey'"
            variant="tonal"
          >
            {{ item.orders_count || 0 }} {{ getOrdersLabel(item.orders_count) }}
          </v-chip>
        </template>

        <!-- Status -->
        <template v-slot:item.is_active="{ item }">
          <v-chip
            size="small"
            :color="item.is_active ? 'success' : 'error'"
            variant="flat"
          >
            {{ item.is_active ? "Aktywny" : "Nieaktywny" }}
          </v-chip>
        </template>

        <!-- Akcje -->
        <template v-slot:item.actions="{ item }">
          <div class="d-flex gap-1">
            <v-tooltip text="Szczegóły">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  icon="mdi-eye"
                  size="small"
                  variant="text"
                  color="info"
                  @click.stop="viewCustomer(item.id)"
                />
              </template>
            </v-tooltip>

            <v-tooltip text="Edytuj">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  icon="mdi-pencil"
                  size="small"
                  variant="text"
                  color="warning"
                  @click.stop="openEditDialog(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip :text="item.is_active ? 'Dezaktywuj' : 'Aktywuj'">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  :icon="item.is_active ? 'mdi-account-off' : 'mdi-account-check'"
                  size="small"
                  variant="text"
                  :color="item.is_active ? 'error' : 'success'"
                  @click.stop="toggleActive(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip text="Usuń">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  icon="mdi-delete"
                  size="small"
                  variant="text"
                  color="error"
                  :disabled="item.orders_count > 0"
                  @click.stop="confirmDelete(item)"
                />
              </template>
            </v-tooltip>
          </div>
        </template>

        <!-- Brak danych -->
        <template v-slot:no-data>
          <div class="text-center py-8">
            <v-icon size="64" color="grey">mdi-account-group-outline</v-icon>
            <div class="text-h6 mt-4 text-medium-emphasis">Brak klientów</div>
            <v-btn
              color="primary"
              variant="outlined"
              class="mt-4"
              @click="openCreateDialog"
            >
              Dodaj pierwszego klienta
            </v-btn>
          </div>
        </template>
      </v-data-table-server>
    </v-card>

    <!-- Dialog formularza klienta -->
    <customer-form-dialog
      v-model="formDialog"
      :customer="editingCustomer"
      @saved="handleCustomerSaved"
    />

    <!-- Dialog potwierdzenia usunięcia -->
    <v-dialog v-model="deleteDialog" max-width="400">
      <v-card>
        <v-card-title>Potwierdzenie usunięcia</v-card-title>
        <v-card-text>
          Czy na pewno chcesz usunąć klienta
          <strong>{{ customerToDelete?.name }}</strong
          >? Tej operacji nie można cofnąć.
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn variant="text" @click="deleteDialog = false">Anuluj</v-btn>
          <v-btn
            color="error"
            variant="elevated"
            :loading="deleting"
            @click="deleteCustomer"
          >
            Usuń
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- Snackbar -->
    <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000">
      {{ snackbar.message }}
      <template v-slot:actions>
        <v-btn variant="text" @click="snackbar.show = false">Zamknij</v-btn>
      </template>
    </v-snackbar>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import PageHeader from "@/components/layout/PageHeader.vue";
import CustomerFormDialog from "@/components/customers/CustomerFormDialog.vue";
import customerService from "@/services/customerService";
import { useServerTable } from "@/composables/useServerTable";

const router = useRouter();

// Filtry (reaktywne → automatycznie przeładowują tabelę)
const filters = ref({
  type: "all",
  is_active: "all", // "all" | "true" | "false"
});

// Server-side table
const {
  items,
  totalItems,
  loading,
  error,
  search,
  options,
  fetchData,
  updateOptions,
} = useServerTable("/customers", {
  defaultPerPage: 15,
  defaultSortBy: "name",
  defaultSortDir: "asc",
  extraFilters: filters,
});

// Dialog state
const formDialog = ref(false);
const editingCustomer = ref(null);
const deleteDialog = ref(false);
const customerToDelete = ref<any>(null);
const deleting = ref(false);

// Snackbar
const snackbar = ref({
  show: false,
  message: "",
  color: "success",
});

// Options
const typeOptions = [
  { title: "Wszyscy", value: "all" },
  { title: "B2B (Firmy)", value: "B2B" },
  { title: "B2C (Indywidualni)", value: "B2C" },
];

const activeOptions = [
  { title: "Wszyscy", value: "all" },
  { title: "Aktywni", value: "true" },
  { title: "Nieaktywni", value: "false" },
];

// Table headers
const headers = [
  { title: "Klient", key: "name", width: "250px" },
  { title: "Kontakt", key: "contact", width: "220px", sortable: false },
  { title: "Adres", key: "address", width: "250px", sortable: false },
  { title: "Zamówienia", key: "orders_count", align: "center", width: "120px" },
  { title: "Status", key: "is_active", align: "center", width: "110px", sortable: false },
  { title: "Akcje", key: "actions", align: "center", width: "160px", sortable: false },
];

// Helpers
const getOrdersLabel = (count: number) => {
  if (!count || count === 0) return "zamówień";
  if (count === 1) return "zamówienie";
  if (count >= 2 && count <= 4) return "zamówienia";
  return "zamówień";
};

const clearFilters = () => {
  search.value = "";
  filters.value.type = "all";
  filters.value.is_active = "all";
};

// Actions
const openCreateDialog = () => {
  editingCustomer.value = null;
  formDialog.value = true;
};

const openEditDialog = (customer: any) => {
  editingCustomer.value = { ...customer };
  formDialog.value = true;
};

const handleCustomerSaved = async () => {
  await fetchData();
  snackbar.value = {
    show: true,
    message: "Klient zapisany pomyślnie",
    color: "success",
  };
};

const viewCustomer = (id: number) => {
  router.push(`/customers/${id}`);
};

const handleRowClick = (_event: any, { item }: any) => {
  viewCustomer(item.id);
};

const toggleActive = async (customer: any) => {
  try {
    await customerService.toggleActive(customer.id);
    await fetchData();
    snackbar.value = {
      show: true,
      message: customer.is_active ? "Klient dezaktywowany" : "Klient aktywowany",
      color: "success",
    };
  } catch (err) {
    snackbar.value = {
      show: true,
      message: "Błąd zmiany statusu",
      color: "error",
    };
  }
};

const confirmDelete = (customer: any) => {
  customerToDelete.value = customer;
  deleteDialog.value = true;
};

const deleteCustomer = async () => {
  try {
    deleting.value = true;
    await customerService.delete(customerToDelete.value.id);
    deleteDialog.value = false;
    await fetchData();
    snackbar.value = {
      show: true,
      message: "Klient usunięty",
      color: "success",
    };
  } catch (err: any) {
    snackbar.value = {
      show: true,
      message: err.response?.data?.message || "Błąd usuwania klienta",
      color: "error",
    };
  } finally {
    deleting.value = false;
  }
};

onMounted(() => {
  fetchData();
});
</script>

<style scoped>
.customers-table :deep(tbody tr) {
  cursor: pointer;
  transition: background-color 0.2s;
}
</style>


=================================================================================
FILE: src/views/orders/OrderDetail.vue
LOCATION: .//src/views/orders/OrderDetail.vue
=================================================================================

<template>
  <v-container fluid>
    <!-- ===== Stan ładowania ===== -->
    <div v-if="loading" class="text-center py-12">
      <v-progress-circular indeterminate size="64" color="primary" />
      <p class="mt-4 text-h6">Ładowanie zamówienia...</p>
    </div>

    <!-- ===== Stan błędu ===== -->
    <v-alert v-else-if="error" type="error" variant="tonal" prominent class="mb-4">
      <v-alert-title>Błąd</v-alert-title>
      {{ error }}
      <template v-slot:append>
        <v-btn color="error" variant="outlined" @click="init">Spróbuj ponownie</v-btn>
      </template>
    </v-alert>

    <!-- ===== Główna treść ===== -->
    <template v-else-if="order">
      <!-- NAGŁÓWEK -->
      <page-header
        :title="order.full_order_number"
        :subtitle="`Zamówienie • ${order.customer?.name || 'Klient'}`"
        icon="mdi-clipboard-text"
        :icon-color="formatOrderStatus(order.overall_status).color"
        :breadcrumbs="[
          { title: 'Zamówienia', to: '/orders', disabled: false },
          { title: order.full_order_number, disabled: true },
        ]"
      >
        <template #actions>
          <v-btn
            variant="outlined"
            prepend-icon="mdi-arrow-left"
            class="mr-2"
            @click="$router.push('/orders')"
          >
            Wróć
          </v-btn>
          <v-btn
            color="deep-purple"
            variant="outlined"
            prepend-icon="mdi-layers-plus"
            class="mr-2"
            @click="openCreateSeriesDialog"
          >
            Nowa seria
          </v-btn>
          <v-btn prepend-icon="mdi-pencil" color="primary" @click="openEditOrder">
            Edytuj
          </v-btn>
        </template>
      </page-header>

      <v-row>
        <!-- ============================================================ -->
        <!-- LEWA KOLUMNA (8) – opis + finanse + warianty                 -->
        <!-- ============================================================ -->
        <v-col cols="12" md="8">
          <!-- Opis zamówienia -->
          <order-description :description="order.description" />

          <!-- Podsumowanie finansowe -->
          <order-financial-summary
            class="mt-6"
            :financial-summary="financialSummary"
            :loading="loadingFinancial"
          />

          <!-- Lista grup i wariantów -->
          <order-variants-grid
            class="mt-6"
            :variants="order.variants || []"
            @add-group="openAddGroup"
            @add-child="openAddChild"
            @view="viewVariant"
            @edit="openEdit"
            @duplicate="openDuplicate"
            @delete="handleVariantDelete"
            @delete-group-force="handleGroupDeleteForce"
          />
        </v-col>

        <!-- ============================================================ -->
        <!-- PRAWA KOLUMNA (4) – panel serii + sidebar                    -->
        <!-- ============================================================ -->
        <v-col cols="12" md="4">
          <!-- Panel serii zamówienia -->
          <series-list-panel
            ref="seriesPanelRef"
            :current-order-id="order.id"
            :order-number="order.order_number"
            class="mb-4"
            @create-series="openCreateSeriesDialog"
          />

          <!-- Szczegóły + Klient -->
          <order-sidebar
            :order="order"
            :inline-loading="inlineLoading"
            @update-inline="handleInlineUpdate"
          />
        </v-col>
      </v-row>
    </template>

    <!-- ===================================================================
         DIALOGI
    ==================================================================== -->

    <!--
      Dialog tworzenia/edycji grupy lub wariantu.
      Prop `mode` steruje zachowaniem:
        'group'        → tworzy grupę (POST /orders/{id}/variants)
        'variant'      → tworzy wariant jako dziecko (POST /orders/{id}/variants/{parent}/children)
        'edit-group'   → edytuje grupę (PUT /variants/{id})
        'edit-variant' → edytuje wariant (PUT /variants/{id})
    -->
    <variant-form-dialog
      v-model="variantDialog"
      :mode="variantDialogMode"
      :order-id="order?.id"
      :parent="variantDialogParent"
      :item="variantDialogItem"
      :existing-variants="order?.variants || []"
      @saved="handleVariantSaved"
    />

    <!-- Dialog edycji zamówienia -->
    <order-form-dialog
      v-model="editOrderDialog"
      :order="order"
      @saved="handleOrderSaved"
    />

    <!--
      Dialog duplikowania grupy lub wariantu.
      Komponent sam wykrywa typ źródła (is_group || quantity===0).
    -->
    <variant-duplicate-dialog
      v-model="duplicateDialog"
      :source-variant="duplicatingVariant"
      :existing-variants="order?.variants || []"
      @saved="handleDuplicateSaved"
    />

    <!-- Dialog tworzenia nowej serii zamówienia -->
    <create-series-dialog
      v-model="createSeriesDialog"
      :source-order="
        order
          ? {
              id: order.id,
              order_number: order.order_number,
              series: order.series,
              full_order_number: order.full_order_number,
            }
          : null
      "
      @saved="handleSeriesCreated"
    />

    <!-- Snackbar powiadomień -->
    <v-snackbar
      v-model="snackbar.show"
      :color="snackbar.color"
      :timeout="4000"
      location="bottom right"
    >
      <v-icon start>{{ snackbar.icon }}</v-icon>
      {{ snackbar.message }}
      <template v-slot:actions>
        <v-btn variant="text" @click="snackbar.show = false">Zamknij</v-btn>
      </template>
    </v-snackbar>
  </v-container>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";

// Serwisy / narzędzia
import api from "@/services/api";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { useVariantsStore } from "@/stores/variants";

// Komponenty layout
import PageHeader from "@/components/layout/PageHeader.vue";
import OrderDescription from "@/components/orders/OrderDescription.vue";
import OrderVariantsGrid from "@/components/orders/OrderVariantsGrid.vue";
import OrderSidebar from "@/components/orders/OrderSidebar.vue";
import OrderFinancialSummary from "@/components/orders/OrderFinancialSummary.vue";

// Dialogi
import VariantFormDialog from "@/components/orders/VariantFormDialog.vue";
import VariantDuplicateDialog from "@/components/orders/VariantDuplicateDialog.vue";
import OrderFormDialog from "@/components/orders/OrderFormDialog.vue";
import SeriesListPanel from "@/components/orders/SeriesListPanel.vue";
import CreateSeriesDialog from "@/components/orders/CreateSeriesDialog.vue";

// ─── Instancje ────────────────────────────────────────────────────────────────

const route = useRoute();
const router = useRouter();
const variantsStore = useVariantsStore();
const { formatOrderStatus } = useStatusFormatter();

// ─── Referencje do komponentów ────────────────────────────────────────────────

const seriesPanelRef = ref<InstanceType<typeof SeriesListPanel> | null>(null);

// ─── Stan główny ──────────────────────────────────────────────────────────────

const loading = ref(true);
const loadingFinancial = ref(false);
const error = ref<string | null>(null);
const order = ref<any>(null);
const inlineLoading = ref<string | null>(null);
const financialSummary = ref<any>(null);

// ─── Stan — dialogi wariantów ─────────────────────────────────────────────────

const variantDialog = ref(false);

/**
 * Tryb dialogu formularza:
 *   'group'        — tworzenie nowej grupy top-level
 *   'variant'      — tworzenie wariantu jako dziecko grupy/wariantu
 *   'edit-group'   — edycja istniejącej grupy
 *   'edit-variant' — edycja istniejącego wariantu
 */
const variantDialogMode = ref<"group" | "variant" | "edit-group" | "edit-variant">(
  "group"
);

/** Rodzic wariantu (tylko przy mode='variant') */
const variantDialogParent = ref<any>(null);

/** Element do edycji (tylko przy mode='edit-*') */
const variantDialogItem = ref<any>(null);

// ─── Stan — dialog duplikowania ───────────────────────────────────────────────

const duplicateDialog = ref(false);
const duplicatingVariant = ref<any>(null);

// ─── Stan — pozostałe dialogi ─────────────────────────────────────────────────

const editOrderDialog = ref(false);
const createSeriesDialog = ref(false);

// ─── Snackbar ─────────────────────────────────────────────────────────────────

const snackbar = ref({
  show: false,
  message: "",
  color: "success",
  icon: "mdi-check-circle",
});

// ─── Pomocnicza funkcja snackbar ──────────────────────────────────────────────

function showSnackbar(
  message: string,
  color: "success" | "error" | "warning" | "info" = "success"
) {
  snackbar.value = {
    show: true,
    message,
    color,
    icon: color === "success" ? "mdi-check-circle" : "mdi-alert-circle",
  };
}

// ─── Pobieranie danych ────────────────────────────────────────────────────────

/**
 * Pobiera dane zamówienia wraz z zagnieżdżonymi wariantami.
 * Backend zwraca płaską listę variants[] z is_group/quantity jako dyskryminator.
 */
async function fetchOrder() {
  loading.value = true;
  error.value = null;
  try {
    const res = await api.get(`/orders/${route.params.id}`);
    order.value = res.data.data || res.data;
  } catch (err: any) {
    error.value = err.response?.data?.message || "Nie udało się pobrać zamówienia";
  } finally {
    loading.value = false;
  }
}

/** Pobiera podsumowanie finansowe oddzielnym zapytaniem (może być wolniejsze) */
async function fetchFinancialSummary() {
  if (!order.value?.id) return;
  loadingFinancial.value = true;
  try {
    const res = await api.get(`/orders/${order.value.id}/financial-summary`);
    financialSummary.value = res.data;
  } catch {
    // Nieblokujące — podsumowanie może być niedostępne
    financialSummary.value = null;
  } finally {
    loadingFinancial.value = false;
  }
}

/** Pełna inicjalizacja — zamówienie + finanse (finanse nie blokują) */
async function init() {
  await fetchOrder();
  // Ładuj finanse równolegle po załadowaniu zamówienia, nie blokując UI
  fetchFinancialSummary();
}

// ─── Inline update (sidebar) ──────────────────────────────────────────────────

async function handleInlineUpdate(field: string, value: any) {
  if (!order.value) return;
  inlineLoading.value = field;
  try {
    const res = await api.patch(`/orders/${order.value.id}`, { [field]: value });
    order.value = { ...order.value, ...res.data };
  } catch (err: any) {
    alert(err.response?.data?.message || `Błąd aktualizacji pola "${field}"`);
  } finally {
    inlineLoading.value = null;
  }
}

// ─── Akcje UI — zamówienie ────────────────────────────────────────────────────

const openEditOrder = () => {
  editOrderDialog.value = true;
};

const openCreateSeriesDialog = () => {
  createSeriesDialog.value = true;
};

// ─── Akcje UI — warianty / grupy ─────────────────────────────────────────────

/**
 * Otwiera dialog tworzenia nowej GRUPY top-level.
 * Wywoływane przez @add-group z OrderVariantsGrid.
 * Backend: POST /orders/{id}/variants (z quantity=0 automatycznie)
 */
const openAddGroup = () => {
  variantDialogMode.value = "group";
  variantDialogParent.value = null;
  variantDialogItem.value = null;
  variantDialog.value = true;
};

/**
 * Otwiera dialog tworzenia WARIANTU jako dziecka grupy lub innego wariantu.
 * Wywoływane przez @add-child z OrderVariantsGrid.
 * Backend: POST /orders/{id}/variants/{parentId}/children
 *
 * @param parent - Obiekt grupy lub wariantu-rodzica
 */
const openAddChild = (parent: any) => {
  variantDialogMode.value = "variant";
  variantDialogParent.value = parent;
  variantDialogItem.value = null;
  variantDialog.value = true;
};

/**
 * Otwiera dialog edycji — automatycznie wykrywa czy to grupa czy wariant.
 * Wywoływane przez @edit z OrderVariantsGrid.
 *
 * Discriminator: is_group === true LUB quantity === 0 → grupa
 */
const openEdit = (item: any) => {
  const isGroup = item.is_group === true || item.quantity === 0;
  variantDialogMode.value = isGroup ? "edit-group" : "edit-variant";
  variantDialogParent.value = null;
  variantDialogItem.value = item;
  variantDialog.value = true;
};

/**
 * Otwiera dialog duplikowania grupy lub wariantu.
 * Wywoływane przez @duplicate z OrderVariantsGrid.
 * VariantDuplicateDialog sam wykrywa typ i pokazuje odpowiedni UI.
 */
const openDuplicate = (item: any) => {
  duplicatingVariant.value = item;
  duplicateDialog.value = true;
};

/** Nawiguje do widoku szczegółów wariantu */
const viewVariant = (variantId: number) => {
  router.push({
    name: "VariantDetail",
    params: { orderId: order.value.id, id: variantId },
  });
};

// ─── Usuwanie wariantów ───────────────────────────────────────────────────────

/**
 * Usuwa pojedynczy wariant (bez dzieci).
 * Wywoływane przez @delete z OrderVariantsGrid.
 *
 * Jeśli backend zwróci 422 (wariant ma dzieci), informuje użytkownika
 * żeby skorzystał z opcji "Usuń grupę" w menu grupy.
 */
const handleVariantDelete = async (variant: any) => {
  const label = variant.is_group
    ? `grupę ${variant.variant_number} (${variant.name})`
    : `wariant ${variant.variant_number} (${variant.name})`;

  if (!confirm(`Czy na pewno chcesz usunąć ${label}?`)) return;

  try {
    await variantsStore.deleteVariant(variant.id, false);
    showSnackbar(`Usunięto ${variant.variant_number}`);
    await init();
  } catch (err: any) {
    if (err.response?.status === 422) {
      // Backend odmówił — to grupa z dziećmi
      alert(
        `Nie można usunąć grupy ${variant.variant_number} — zawiera warianty.\n` +
          `Użyj opcji "Usuń grupę" z menu grupy, aby usunąć razem z całą zawartością.`
      );
    } else {
      alert("Nie udało się usunąć: " + (err.response?.data?.message || "Nieznany błąd"));
    }
  }
};

/**
 * Usuwa grupę RAZEM z wszystkimi dziećmi (force=true).
 * Wywoływane przez @delete-group-force z OrderVariantsGrid,
 * po wewnętrznym potwierdzeniu wewnątrz komponentu.
 *
 * Backend: DELETE /variants/{id}?force=true
 */
const handleGroupDeleteForce = async (group: any) => {
  try {
    await variantsStore.deleteVariant(group.id, true);
    showSnackbar(`Grupa ${group.variant_number} i jej warianty zostały usunięte`);
    await init();
  } catch (err: any) {
    alert(
      "Nie udało się usunąć grupy: " + (err.response?.data?.message || "Nieznany błąd")
    );
  }
};

// ─── Callbacki zapisu ─────────────────────────────────────────────────────────

const handleOrderSaved = async () => {
  await init();
  showSnackbar("Zamówienie zaktualizowane");
};

const handleVariantSaved = async () => {
  await init();
  showSnackbar("Zapisano pomyślnie");
};

const handleDuplicateSaved = async () => {
  await init();
  showSnackbar("Zduplikowano pomyślnie");
};

async function handleSeriesCreated(result: any) {
  const summary = result?.summary;
  const newOrderId = summary?.new_order_id;
  const newNumber = summary?.new_full_order_number;

  showSnackbar(
    `Seria ${newNumber} utworzona! (${summary?.variants_created || 0} wariantów)`
  );

  // Odśwież panel serii natychmiast
  seriesPanelRef.value?.loadSeries();

  // Przekieruj do nowej serii po chwili
  if (newOrderId) {
    setTimeout(() => router.push(`/orders/${newOrderId}`), 900);
  }
}

// ─── Lifecycle ────────────────────────────────────────────────────────────────

onMounted(init);

/**
 * Nasłuchuje zmian route.params.id.
 *
 * Gdy użytkownik klika inną serię w SeriesListPanel, router.push zmienia
 * tylko parametr — Vue nie odmontowuje komponentu, więc onMounted nie odpala.
 * Ten watch zapewnia pełne przeładowanie danych przy każdej zmianie ID.
 */
watch(
  () => route.params.id,
  (newId, oldId) => {
    if (newId && newId !== oldId) {
      init();
    }
  }
);
</script>


=================================================================================
FILE: src/views/orders/OrderList.vue
LOCATION: .//src/views/orders/OrderList.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Zamówienia"
      subtitle="Zarządzaj zamówieniami klientów"
      icon="mdi-clipboard-text"
      icon-color="blue"
      :breadcrumbs="[{ title: 'Zamówienia', disabled: true }]"
    >
      <template #actions>
        <v-btn
          color="primary"
          variant="elevated"
          prepend-icon="mdi-plus"
          size="large"
          @click="createNewOrder"
        >
          NOWE ZAMÓWIENIE
        </v-btn>
      </template>
    </page-header>

    <!-- Filtry -->
    <v-card elevation="2" class="mb-4">
      <v-card-text>
        <v-row align="center">
          <v-col cols="12" md="4">
            <v-text-field
              v-model="search"
              label="Szukaj zamówienia lub klienta"
              prepend-inner-icon="mdi-magnify"
              variant="outlined"
              density="compact"
              hide-details
              clearable
            />
          </v-col>

          <v-col cols="12" md="3">
            <v-select
              v-model="filters.status"
              label="Filtruj po statusie"
              :items="statusOptions"
              item-title="label"
              item-value="value"
              variant="outlined"
              density="compact"
              hide-details
            />
          </v-col>

          <v-col cols="12" md="5" class="d-flex justify-end">
            <v-btn-toggle
              v-model="filters.quick_filter"
              variant="outlined"
              divided
              mandatory
            >
              <v-btn value="active" prepend-icon="mdi-clock-outline"> AKTYWNE </v-btn>
              <v-btn value="completed" prepend-icon="mdi-check-circle">
                ZAKOŃCZONE
              </v-btn>
              <v-btn value="all" prepend-icon="mdi-infinity"> WSZYSTKIE </v-btn>
            </v-btn-toggle>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>

    <!-- Error -->
    <v-alert
      v-if="error"
      type="error"
      variant="tonal"
      prominent
      closable
      class="mb-4"
      @click:close="error = null"
    >
      <v-alert-title>Błąd</v-alert-title>
      {{ error }}
      <template v-slot:append>
        <v-btn color="error" variant="outlined" @click="fetchData">
          Spróbuj ponownie
        </v-btn>
      </template>
    </v-alert>

    <!-- Tabela z paginacją server-side -->
    <v-card elevation="2">
      <v-data-table-server
        :headers="headers"
        :items="items"
        :items-length="totalItems"
        :loading="loading"
        :items-per-page="options.itemsPerPage"
        :page="options.page"
        :sort-by="options.sortBy"
        hover
        class="orders-table"
        @click:row="handleRowClick"
        @update:options="updateOptions"
      >
        <!-- Pełny numer zamówienia -->
        <template v-slot:item.full_order_number="{ item }">
          <span class="font-weight-bold text-primary">{{ item.full_order_number }}</span>
        </template>

        <template v-slot:item.customer="{ item }">
          <div v-if="item.customer">
            <div class="font-weight-bold">{{ item.customer.name }}</div>
          </div>
          <span v-else class="text-medium-emphasis">-</span>
        </template>

        <template v-slot:item.description="{ item }">
          <div class="text-truncate" style="max-width: 400px">
            {{ item.description || "-" }}
          </div>
        </template>

        <template v-slot:item.lines="{ item }">
          <v-chip size="small" color="blue" variant="tonal">
            {{ item.variants?.length || item.product_lines?.length || 0 }}
          </v-chip>
        </template>

        <template v-slot:item.planned_delivery_date="{ item }">
          <span v-if="item.planned_delivery_date">
            {{ formatDate(item.planned_delivery_date) }}
          </span>
          <span v-else class="text-medium-emphasis">-</span>
        </template>

        <template v-slot:item.status="{ item }">
          <v-chip
            size="small"
            :color="formatOrderStatus(item.overall_status).color"
            variant="flat"
          >
            <v-icon start size="small">
              {{ formatOrderStatus(item.overall_status).icon }}
            </v-icon>
            {{ formatOrderStatus(item.overall_status).label }}
          </v-chip>
        </template>

        <template v-slot:item.created_at="{ item }">
          {{ formatDate(item.created_at) }}
        </template>

        <template v-slot:no-data>
          <div class="text-center py-8">
            <v-icon size="64" color="grey">mdi-clipboard-text-off</v-icon>
            <div class="text-h6 mt-4 text-medium-emphasis">Brak zamówień</div>
            <v-btn
              color="primary"
              variant="outlined"
              class="mt-4"
              @click="createNewOrder"
            >
              Utwórz pierwsze zamówienie
            </v-btn>
          </div>
        </template>
      </v-data-table-server>
    </v-card>

    <!-- Dialog tworzenia/edycji zamówienia -->
    <order-form-dialog
      v-model="orderDialog"
      :order="editingOrder"
      @saved="handleOrderSaved"
    />
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from "vue";
import { useRouter } from "vue-router";
import PageHeader from "@/components/layout/PageHeader.vue";
import OrderFormDialog from "@/components/orders/OrderFormDialog.vue";
import { useMetadataStore } from "@/stores/metadata";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { useServerTable } from "@/composables/useServerTable";

const metadataStore = useMetadataStore();
const { formatOrderStatus } = useStatusFormatter();
const router = useRouter();

// Filtry (reaktywne — automatycznie przeładowują tabelę)
const filters = ref({
  status: "all",
  quick_filter: "active",
});

// Server-side table
const {
  items,
  totalItems,
  loading,
  error,
  search,
  options,
  fetchData,
  updateOptions,
} = useServerTable("/orders", {
  defaultPerPage: 15,
  defaultSortBy: "created_at",
  defaultSortDir: "desc",
  extraFilters: filters,
});

// Dialog state
const orderDialog = ref(false);
const editingOrder = ref(null);

const statusOptions = computed(() => [
  { label: "Wszystkie", value: "all" },
  ...metadataStore.orderStatuses,
]);

const headers = [
  { title: "Numer", key: "full_order_number", width: "160px", sortable: false },
  { title: "Klient", key: "customer", width: "200px", sortable: false },
  { title: "Opis", key: "description", width: "400px", sortable: false },
  { title: "Warianty", key: "lines", align: "center", width: "20px", sortable: false },
  { title: "Realizacja", key: "planned_delivery_date", align: "end", width: "130px" },
  { title: "Status", key: "overall_status", align: "center", width: "160px" },
  { title: "Utworzono", key: "created_at", align: "center", width: "120px" },
];

const formatDate = (date: string) => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("pl-PL");
};

const createNewOrder = () => {
  editingOrder.value = null;
  orderDialog.value = true;
};

const handleOrderSaved = async () => {
  await fetchData();
};

const viewOrder = (id: number) => {
  router.push(`/orders/${id}`);
};

const handleRowClick = (_event: any, { item }: any) => {
  viewOrder(item.id);
};

onMounted(() => {
  fetchData();
});
</script>

<style scoped>
.orders-table :deep(tbody tr) {
  cursor: pointer;
  transition: background-color 0.2s;
}
.text-truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>


=================================================================================
FILE: src/views/orders/VariantDetail.vue
LOCATION: .//src/views/orders/VariantDetail.vue
=================================================================================

<template>
  <v-container fluid>
    <!-- NAGŁÓWEK -->
    <variant-header
      :variant="variant"
      :loading="inlineLoading === 'name'"
      @update-name="handleInlineUpdate('name', $event)"
      @go-back="goBack"
      @edit-full="editDialog = true"
    />

    <!-- Stan ładowania -->
    <div v-if="variantsStore.loading && !variant" class="text-center py-12">
      <v-progress-circular indeterminate size="64" color="primary" />
      <p class="mt-4 text-h6">Ładowanie...</p>
    </div>

    <!-- GŁÓWNA ZAWARTOŚĆ -->
    <div v-else-if="variant">
      <v-row>
        <!-- LEWA KOLUMNA -->
        <v-col cols="12" md="8">
          <!-- 1. Opis / Specyfikacja -->
          <variant-description
            :variant="variant"
            :loading="inlineLoading === 'description'"
            @update-desc="handleInlineUpdate('description', $event)"
          />

          <!-- 2. Kontrola kosztów -->
          <variant-cost-control
            :budget-materials="budgetMaterials"
            :budget-services="budgetServices"
            :actual-materials-cost="actualMaterialsCost"
            :actual-services-cost="actualServicesCost"
          />

          <!-- 3. Wyceny -->
          <variant-quotations
            :quotations="quotations"
            :loading="loadingQuotations"
            :duplicating-id="duplicatingId"
            @create="openCreateDialog"
            @view="viewQuotation"
            @edit="editQuotation"
            @duplicate="handleDuplicate"
            @export="openExportDialog"
            @approve="approveQuotation"
            @delete="confirmDeleteQuotation"
          />

          <!-- 4. Usługi wykonane (RCP) -->
          <variant-rcp-services
            :tasks="productionTasks"
            :total-cost="actualServicesCost"
          />

          <!-- 5. Materiały -->
          <variant-materials-tab
            v-if="variant.id"
            :key="`materials-${variant.id}-${materialsRefreshKey}`"
            :variant-id="variant.id"
            :readonly="variant.status === 'COMPLETED' || variant.status === 'CANCELLED'"
            @data-loaded="onMaterialsLoaded"
            @updated="refreshVariant"
          />
        </v-col>

        <!-- PRAWA KOLUMNA (SIDEBAR) -->
        <v-col cols="12" md="4">
          <variant-sidebar
            :variant="variant"
            :status-loading="statusLoading"
            :inline-loading="inlineLoading"
            @update-inline="handleInlineUpdate"
            @update-status="handleInlineStatusChange"
            @open-review="openReview"
            @open-cancel="cancelDialog = true"
          />
        </v-col>
      </v-row>
    </div>

    <!-- DIALOGI -->

    <!-- Formularz wyceny -->
    <quotation-form-dialog
      v-if="variant"
      v-model="createQuotationDialog"
      :variant="variant"
      :quotation="editingQuotation"
      @saved="handleQuotationSaved"
    />

    <!-- Podgląd wyceny -->
    <quotation-details-dialog
      v-model="viewQuotationDialog"
      :quotation="selectedQuotation"
      @close="viewQuotationDialog = false"
    />

    <!-- Eksport materiałów -->
    <quotation-export-materials-dialog
      v-model="exportMaterialsDialog"
      :quotation="quotationToExport"
      @exported="onMaterialsExported"
    />

    <!-- Edycja wariantu -->
    <variant-form-dialog
      v-model="editDialog"
      :variant="variant"
      @saved="refreshVariant"
    />

    <!-- Potwierdzenie usunięcia wyceny -->
    <variant-delete-quotation-dialog
      v-model="deleteQuotationDialog"
      :version-number="quotationToDelete?.version_number"
      :loading="loadingQuotations"
      @confirm="handleDeleteQuotation"
    />

    <!-- Review prototypu -->
    <variant-review-dialog
      v-model="reviewDialog"
      :action="reviewAction"
      :loading="reviewLoading"
      @submit="submitReview"
    />
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";
import { useVariantsStore } from "@/stores/variants";
import { useQuotationsStore } from "@/stores/quotations";

// Zaimportowane wyodrębnione komponenty wariantu
import VariantHeader from "@/components/variants/VariantHeader.vue";
import VariantDescription from "@/components/variants/VariantDescription.vue";
import VariantCostControl from "@/components/variants/VariantCostControl.vue";
import VariantRcpServices from "@/components/variants/VariantRcpServices.vue";
import VariantQuotations from "@/components/variants/VariantQuotations.vue";
import VariantSidebar from "@/components/variants/VariantSidebar.vue";

// Zaimportowane dialogi
import VariantReviewDialog from "@/components/variants/VariantReviewDialog.vue";
import VariantDeleteQuotationDialog from "@/components/variants/VariantDeleteQuotationDialog.vue";

// Główne komponenty istniejące wcześniej (Materiały, Wyceny, Formularze)
import VariantMaterialsTab from "@/components/materials/VariantMaterialsTab.vue";
import QuotationFormDialog from "@/components/quotations/QuotationFormDialog.vue";
import QuotationDetailsDialog from "@/components/quotations/QuotationDetailsDialog.vue";
import QuotationExportMaterialsDialog from "@/components/quotations/QuotationExportMaterialsDialog.vue";
import VariantFormDialog from "@/components/orders/VariantFormDialog.vue";

// Inicjalizacja i sklepy
const route = useRoute();
const router = useRouter();
const variantsStore = useVariantsStore();
const quotationsStore = useQuotationsStore();

// STATE

// Główny obiekt wariantu
const variant = computed(() => variantsStore.currentVariant);

// Flagi ładowania
const statusLoading = ref(false);
const inlineLoading = ref<string | null>(null);
const loadingQuotations = ref(false);
const reviewLoading = ref(false);

// Dialogi
const reviewDialog = ref(false);
const cancelDialog = ref(false);
const editDialog = ref(false);
const createQuotationDialog = ref(false);
const viewQuotationDialog = ref(false);
const deleteQuotationDialog = ref(false);
const exportMaterialsDialog = ref(false);

// Wyceny
const quotations = ref<any[]>([]);
const selectedQuotation = ref<any>(null);
const quotationToDelete = ref<any>(null);
const quotationToExport = ref<any>(null);
const editingQuotation = ref<any>(null);
const duplicatingId = ref<number | null>(null);

// Prototyp review
const reviewAction = ref<"approve" | "reject">("approve");

// Materiały
const actualMaterialsCost = ref(0);
const materialsRefreshKey = ref(0);

// COMPUTED - Obliczenia kosztowe

const budgetMaterials = computed(
  () => Number(quotationsStore.approvedQuotation?.total_materials_cost) || 0
);

const budgetServices = computed(
  () => Number(quotationsStore.approvedQuotation?.total_services_cost) || 0
);

const productionTasks = computed(() => {
  const tasks = variant.value?.production_order?.services || [];
  return tasks.filter((t: any) => t.status !== "PLANNED");
});

const actualServicesCost = computed(() => {
  return productionTasks.value.reduce((sum: number, task: any) => {
    let cost = Number(task.actual_cost) || 0;
    // Ręczne przeliczenie dla IN_PROGRESS na poziomie wariantu nie jest wymagane,
    // ponieważ VariantRcpServices.vue zajmuje się wizualizacją w tabeli, ale ogólny zarys możemy tu policzyć.
    // Dla prostoty polegamy na zapisanych wartościach, a dynamiczne podsumowanie polega na tabeli
    return sum + cost;
  }, 0);
});

// LIFECYCLE

onMounted(async () => {
  const id = Array.isArray(route.params.id) ? route.params.id[0] : route.params.id;
  await variantsStore.fetchVariant(id);
  await loadQuotations();
});

// METHODS - Nawigacja & Odświeżanie

const goBack = () => router.back();

const refreshVariant = async () => {
  if (!variant.value?.id) return;
  await variantsStore.fetchVariant(variant.value.id);
};

// METHODS - Zmiany z boku i góry (Inline)

const handleInlineUpdate = async (field: string, value: any) => {
  if (!variant.value) return;
  inlineLoading.value = field;
  try {
    await variantsStore.updateVariant(variant.value.id, { [field]: value });
    await refreshVariant();
  } catch {
    alert(`Błąd podczas aktualizacji pola "${field}"`);
  } finally {
    inlineLoading.value = null;
  }
};

const handleInlineStatusChange = async (newStatus: string) => {
  if (!newStatus || !variant.value) return;
  statusLoading.value = true;
  try {
    await variantsStore.updateStatus(variant.value.id, newStatus);
    await refreshVariant();
  } catch {
    alert("Błąd podczas zmiany statusu");
  } finally {
    statusLoading.value = false;
  }
};

// METHODS - Wyceny

const loadQuotations = async () => {
  if (!variant.value?.id) return;
  loadingQuotations.value = true;
  try {
    const id = Array.isArray(route.params.id) ? route.params.id[0] : route.params.id;
    await quotationsStore.fetchQuotations(id);
    quotations.value = quotationsStore.quotations;
  } finally {
    loadingQuotations.value = false;
  }
};

const openCreateDialog = () => {
  editingQuotation.value = null;
  createQuotationDialog.value = true;
};

const editQuotation = (q: any) => {
  editingQuotation.value = q;
  createQuotationDialog.value = true;
};

const viewQuotation = (q: any) => {
  selectedQuotation.value = q;
  viewQuotationDialog.value = true;
};

const handleQuotationSaved = () => {
  createQuotationDialog.value = false;
  editingQuotation.value = null;
  loadQuotations();
};

const approveQuotation = async (q: any) => {
  try {
    await quotationsStore.approveQuotation(q.id);
    await loadQuotations();
    await refreshVariant();
  } catch {
    alert("Błąd podczas zatwierdzania wyceny");
  }
};

const confirmDeleteQuotation = (q: any) => {
  quotationToDelete.value = q;
  deleteQuotationDialog.value = true;
};

const handleDeleteQuotation = async () => {
  if (!quotationToDelete.value) return;
  try {
    await quotationsStore.deleteQuotation(quotationToDelete.value.id);
    deleteQuotationDialog.value = false;
    quotationToDelete.value = null;
    await loadQuotations();
  } catch {
    alert("Błąd podczas usuwania wyceny");
  }
};

const handleDuplicate = async (quotation: any) => {
  if (duplicatingId.value === quotation.id) return;
  duplicatingId.value = quotation.id;
  try {
    await quotationsStore.duplicateQuotation(quotation.id);
    await loadQuotations();
  } catch {
    alert("Błąd podczas duplikowania wyceny");
  } finally {
    duplicatingId.value = null;
  }
};

// METHODS - Materiały (Import)

const openExportDialog = (quotation: any) => {
  quotationToExport.value = quotation;
  exportMaterialsDialog.value = true;
};

const onMaterialsExported = () => {
  materialsRefreshKey.value++;
};

const onMaterialsLoaded = (data: { totalCost: number; summary: any }) => {
  actualMaterialsCost.value = data.totalCost;
};

// METHODS - Prototyp (Review)

const openReview = (action: "approve" | "reject") => {
  reviewAction.value = action;
  reviewDialog.value = true;
};

const submitReview = async (feedback: string) => {
  if (!variant.value) return;
  reviewLoading.value = true;
  try {
    await variantsStore.reviewPrototype(variant.value.id, reviewAction.value, feedback);
    reviewDialog.value = false;
    await refreshVariant();
  } catch {
    alert("Błąd podczas zmiany decyzji o prototypie");
  } finally {
    reviewLoading.value = false;
  }
};

// METHODS - Anulowanie

const submitCancel = async () => {
  if (!variant.value) return;
  statusLoading.value = true;
  try {
    await variantsStore.updateStatus(variant.value.id, "CANCELLED");
    cancelDialog.value = false;
    await refreshVariant();
  } catch {
    alert("Błąd podczas anulowania wariantu");
  } finally {
    statusLoading.value = false;
  }
};
</script>


=================================================================================
FILE: src/views/production/RcpManagement.vue
LOCATION: .//src/views/production/RcpManagement.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Zarządzanie RCP"
      subtitle="Korekta czasów pracy i monitoring zadań"
      icon="mdi-timer-cog"
      icon-color="teal"
      :breadcrumbs="[{ title: 'RCP Admin', disabled: true }]"
    />
    <!-- Filtry -->
    <v-card elevation="2" class="mb-4">
      <v-card-text>
        <v-row align="center" dense>
          <!-- Szukaj -->
          <v-col cols="12" md="4">
            <v-text-field
              v-model="filters.search"
              label="Szukaj (zadanie, wariant, klient)"
              prepend-inner-icon="mdi-magnify"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              @update:model-value="debouncedSearch"
            />
          </v-col>

          <!-- Status -->
          <v-col cols="12" md="2">
            <v-select
              v-model="filters.status"
              label="Status"
              :items="statusOptions"
              item-title="label"
              item-value="value"
              variant="outlined"
              density="compact"
              hide-details
              @update:model-value="applyFilters"
            />
          </v-col>

          <!-- Pracownik -->
          <v-col cols="12" md="3">
            <v-autocomplete
              v-model="filters.worker_id"
              label="Pracownik"
              :items="workers"
              item-title="name"
              item-value="id"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              placeholder="Wszyscy"
              @update:model-value="applyFilters"
            />
          </v-col>

          <!-- Stanowisko -->
          <v-col cols="12" md="3">
            <v-autocomplete
              v-model="filters.workstation_id"
              label="Stanowisko"
              :items="workstations"
              item-title="name"
              item-value="id"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              placeholder="Wszystkie"
              @update:model-value="applyFilters"
            />
          </v-col>

          <!-- Data OD (datetime-local) -->
          <v-col cols="12" md="3">
            <v-text-field
              v-model="filters.date_from"
              label="Data i czas od"
              type="datetime-local"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              prepend-inner-icon="mdi-calendar-start"
              @update:model-value="applyFilters"
            />
          </v-col>

          <!-- Data DO (datetime-local) -->
          <v-col cols="12" md="3">
            <v-text-field
              v-model="filters.date_to"
              label="Data i czas do"
              type="datetime-local"
              variant="outlined"
              density="compact"
              hide-details
              clearable
              prepend-inner-icon="mdi-calendar-end"
              @update:model-value="applyFilters"
            />
          </v-col>

          <!-- Reset -->
          <v-col cols="12" md="6" class="d-flex justify-end align-center">
            <v-btn
              variant="text"
              prepend-icon="mdi-refresh"
              @click="resetFilters"
              color="primary"
            >
              Resetuj filtry
            </v-btn>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>

    <!-- Tabela Zadań -->
    <v-card elevation="2">
      <v-data-table-server
        v-model:items-per-page="itemsPerPage"
        v-model:sort-by="sortBy"
        :headers="headers"
        :items="rcpAdminStore.tasks"
        :items-length="rcpAdminStore.totalTasks"
        :loading="rcpAdminStore.loading"
        :page="rcpAdminStore.currentPage"
        @update:options="handleTableOptions"
        hover
        density="comfortable"
        class="rcp-admin-table"
        :row-props="rowProps"
      >
        <!-- Kolumna: Zadanie + Wariant Produktowa -->
        <template v-slot:item.task_info="{ item }">
          <div class="py-2">
            <div
              class="text-subtitle-1 font-weight-bold text-grey-darken-3 mb-1 d-flex align-center"
            >
              {{ item.service_name }}
              <v-chip
                v-if="item.status === 'IN_PROGRESS'"
                size="x-small"
                color="red"
                variant="flat"
                class="ml-2 font-weight-bold pulse-animation"
                label
              >
                LIVE
              </v-chip>
            </div>

            <div class="d-flex align-center flex-wrap gap-2">
              <v-chip
                v-if="item.production_order?.variant?.variant_number"
                size="x-small"
                color="blue-grey"
                variant="tonal"
                class="font-weight-bold"
              >
                Wariant {{ item.production_order.variant.variant_number }}
              </v-chip>

              <router-link
                v-if="item.production_order?.variant?.id"
                :to="`/orders/${item.production_order.variant.order_id}/variants/${item.production_order.variant.id}`"
                class="text-caption text-decoration-none text-primary font-weight-medium hover-underline"
                @click.stop
              >
                {{ item.production_order.variant.name }}
              </router-link>
              <span v-else class="text-caption text-medium-emphasis">-</span>

              <span
                class="text-caption text-medium-emphasis text-truncate"
                style="max-width: 150px"
              >
                • {{ item.production_order?.variant?.order?.customer?.name }}
              </span>
            </div>
          </div>
        </template>

        <!-- Kolumna: Pracownik -->
        <template v-slot:item.worker="{ item }">
          <div class="d-flex align-center justify-start" v-if="item.assigned_worker">
            <v-tooltip location="top">
              <template v-slot:activator="{ props }">
                <v-avatar
                  v-bind="props"
                  color="primary"
                  size="32"
                  variant="tonal"
                  class="cursor-help mr-2"
                >
                  <span class="text-caption font-weight-bold">
                    {{ item.assigned_worker.name?.charAt(0) }}
                  </span>
                </v-avatar>
              </template>
              <span>{{ item.assigned_worker.name }}</span>
            </v-tooltip>
            <span class="text-body-2 font-weight-medium">
              {{ formatWorkerName(item.assigned_worker.name) }}
            </span>
          </div>
          <div v-else class="text-medium-emphasis">-</div>
        </template>

        <!-- Kolumna: Start -->
        <template v-slot:item.actual_start_date="{ item }">
          <div class="text-caption font-weight-medium text-grey-darken-2">
            {{ formatDateTime(item.actual_start_date) }}
          </div>
        </template>

        <!-- Kolumna: Koniec -->
        <template v-slot:item.actual_end_date="{ item }">
          <div class="text-caption font-weight-medium text-grey-darken-2">
            {{ formatDateTime(item.actual_end_date) }}
          </div>
        </template>

        <!-- Kolumna: Stanowisko -->
        <template v-slot:item.workstation="{ item }">
          <div class="text-body-2 text-medium-emphasis">
            {{ item.workstation?.name || "-" }}
          </div>
        </template>

        <!-- Kolumna: Czas -->
        <template v-slot:item.time="{ item }">
          <div class="d-flex flex-column align-end">
            <span
              class="text-body-2 font-weight-bold"
              :class="
                item.status === 'IN_PROGRESS'
                  ? 'text-green-darken-2'
                  : 'text-grey-darken-3'
              "
            >
              {{ calculateLiveDuration(item) }}
            </span>
            <span class="text-caption text-medium-emphasis">
              Est: {{ formatDuration(item.estimated_time_hours) }}
            </span>
          </div>
        </template>

        <!-- Kolumna: Status -->
        <template v-slot:item.status="{ item }">
          <v-chip
            size="small"
            :color="formatProductionStatus(item.status).color"
            variant="flat"
            class="font-weight-bold"
          >
            {{ formatProductionStatus(item.status).label }}
          </v-chip>
        </template>

        <!-- Akcje -->
        <template v-slot:item.actions="{ item }">
          <div class="d-flex justify-end">
            <v-btn
              icon="mdi-pencil"
              size="small"
              variant="text"
              color="primary"
              @click="openEditDialog(item)"
              title="Edytuj zadanie"
            />
            <v-btn
              icon="mdi-history"
              size="small"
              variant="text"
              color="orange"
              @click="openLogsDialog(item)"
              title="Logi czasu"
            />
          </div>
        </template>
      </v-data-table-server>
    </v-card>

    <task-edit-dialog
      v-model="editDialog"
      :task="selectedTask"
      :workers="workers"
      @saved="refreshData"
    />

    <time-logs-dialog v-model="logsDialog" :task="selectedTask" @updated="refreshData" />
  </v-container>
</template>
<script setup lang="ts">
import { ref, onMounted, onUnmounted } from "vue";
import PageHeader from "@/components/layout/PageHeader.vue";
import TaskEditDialog from "@/components/production/TaskEditDialog.vue";
import TimeLogsDialog from "@/components/production/TimeLogsDialog.vue";
import { useRcpAdminStore } from "@/stores/rcpAdmin";
import { useWorkstationStore } from "@/stores/workstations";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { debounce } from "lodash";

const rcpAdminStore = useRcpAdminStore();
const workstationStore = useWorkstationStore();
const { formatProductionStatus } = useStatusFormatter();

const itemsPerPage = ref(20);
const sortBy = ref([{ key: "updated_at", order: "desc" }]);
const editDialog = ref(false);
const logsDialog = ref(false);
const selectedTask = ref(null);
const workers = ref([]);
const workstations = ref([]);

// Filtry - daty są teraz datetime-local
const filters = ref({
  search: "",
  status: "all",
  worker_id: null,
  workstation_id: null,
  date_from: null,
  date_to: null,
});

const now = ref(new Date());
let timerInterval: ReturnType<typeof setInterval> | null = null;

const statusOptions = [
  { label: "Wszystkie", value: "all" },
  { label: "W toku", value: "IN_PROGRESS" },
  { label: "Zakończone", value: "COMPLETED" },
  { label: "Anulowane", value: "CANCELLED" },
];

const headers = [
  { title: "Zadanie / Wariant", key: "task_info", sortable: false, width: "350px" },
  { title: "Pracownik", key: "worker", sortable: false, align: "start", width: "180px" },
  { title: "Stanowisko", key: "workstation", sortable: false, width: "150px" },
  { title: "Start", key: "actual_start_date", width: "140px", sortable: true },
  { title: "Koniec", key: "actual_end_date", width: "140px", sortable: true },
  { title: "Czas", key: "time", align: "end", sortable: false, width: "120px" },
  { title: "Status", key: "status", align: "center", sortable: false, width: "130px" },
  { title: "Akcje", key: "actions", align: "end", sortable: false, width: "100px" },
];

const rowProps = (item) => {
  if (item.item.status === "IN_PROGRESS") {
    return { class: "bg-green-lighten-5" };
  }
  return {};
};

const fetchData = async () => {
  await workstationStore.fetchWorkers();
  workers.value = workstationStore.workers;

  await workstationStore.fetchWorkstations();
  workstations.value = workstationStore.items;
};

const handleTableOptions = ({ page }) => {
  rcpAdminStore.fetchTasks(page);
};

const applyFilters = () => {
  rcpAdminStore.updateFilters(filters.value);
};

const debouncedSearch = debounce(applyFilters, 500);

const resetFilters = () => {
  filters.value = {
    search: "",
    status: "all",
    worker_id: null,
    workstation_id: null,
    date_from: null,
    date_to: null,
  };
  applyFilters();
};

const openEditDialog = (task) => {
  selectedTask.value = task;
  editDialog.value = true;
};

const openLogsDialog = (task) => {
  selectedTask.value = task;
  logsDialog.value = true;
};

const refreshData = () => {
  rcpAdminStore.fetchTasks(rcpAdminStore.currentPage);
};

const calculateLiveDuration = (item) => {
  if (item.status === "IN_PROGRESS" && item.actual_start_date) {
    const start = new Date(item.actual_start_date).getTime();
    const current = now.value.getTime();
    const diffMs = Math.max(0, current - start);
    const hours = diffMs / (1000 * 60 * 60);
    const pauseHours = (item.total_pause_duration_seconds || 0) / 3600;
    return formatDuration(Math.max(0, hours - pauseHours));
  }
  return formatDuration(item.actual_time_hours);
};

const formatDuration = (hours) => {
  if (!hours) return "0h 0m";
  const totalMin = Math.round(hours * 60);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return `${h}h ${m}m`;
};

const formatDateTime = (dateStr) => {
  if (!dateStr) return "-";
  return new Date(dateStr).toLocaleString("pl-PL", {
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const formatWorkerName = (fullName) => {
  if (!fullName) return "-";
  const parts = fullName.split(" ");
  if (parts.length >= 2) {
    const firstName = parts[0];
    const lastName = parts.slice(1).join(" ");
    return `${firstName.charAt(0)}. ${lastName}`;
  }
  return fullName;
};

onMounted(() => {
  fetchData();
  timerInterval = setInterval(() => {
    now.value = new Date();
  }, 1000);
});

onUnmounted(() => {
  if (timerInterval) clearInterval(timerInterval);
});
</script>
<style scoped>
.rcp-admin-table :deep(td) {
  vertical-align: middle !important;
}
.hover-underline:hover {
  text-decoration: underline !important;
}
.gap-2 {
  gap: 8px;
}
.cursor-help {
  cursor: help;
}
@keyframes pulse-red {
  0% {
    box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
  }
  70% {
    box-shadow: 0 0 0 6px rgba(244, 67, 54, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
  }
}
.pulse-animation {
  animation: pulse-red 1.5s infinite;
}
</style>


=================================================================================
FILE: src/views/quotations/QuotationsList.vue
LOCATION: .//src/views/quotations/QuotationsList.vue
=================================================================================

<template>
  <v-container fluid class="py-6">
    <div class="d-flex align-center mb-6">
      <v-btn icon @click="$router.back()">
        <v-icon>mdi-arrow-left</v-icon>
      </v-btn>
      <h1 class="text-h4 font-weight-bold ml-4">
        <v-icon class="mr-2">mdi-calculator</v-icon>
        Wyceny - {{ order?.order_number }}
      </h1>
      <v-spacer />
      <v-btn color="primary" variant="elevated" size="large" @click="createDialog = true">
        <v-icon start>mdi-plus</v-icon>
        Nowa wycena
      </v-btn>
    </div>

    <!-- Loading -->
    <div v-if="quotationsStore.loading" class="text-center py-12">
      <v-progress-circular indeterminate size="64" color="primary" />
      <p class="mt-4 text-h6">Ładowanie wycen...</p>
    </div>

    <!-- Quotations Grid -->
    <v-row v-else-if="quotations.length > 0">
      <v-col v-for="quotation in quotations" :key="quotation.id" cols="12" md="6" lg="4">
        <quotation-card
          :quotation="quotation"
          @view="viewQuotation(quotation)"
          @approve="approveQuotation(quotation)"
          @pdf="downloadPDF(quotation)"
        />
      </v-col>
    </v-row>

    <!-- Empty State -->
    <v-card v-else elevation="2" class="text-center pa-12">
      <v-icon size="80" color="grey-lighten-1">mdi-calculator-variant-outline</v-icon>
      <h3 class="text-h5 mt-4 text-medium-emphasis">Brak wycen</h3>
      <p class="text-body-2 text-medium-emphasis mt-2">
        Utwórz pierwszą wycenę dla tego zamówienia
      </p>
      <v-btn color="primary" variant="elevated" class="mt-4" @click="createDialog = true">
        <v-icon start>mdi-plus</v-icon>
        Utwórz wycenę
      </v-btn>
    </v-card>

    <!-- Create Dialog -->
    <quotation-form-dialog v-model="createDialog" :order="order" @saved="handleSaved" />

    <!-- Approve Confirmation -->
    <v-dialog v-model="approveDialog" max-width="500">
      <v-card>
        <v-card-title class="bg-success text-white">
          <v-icon start color="white">mdi-check-circle</v-icon>
          Zatwierdź wycenę
        </v-card-title>
        <v-card-text class="pt-4">
          <p>Czy na pewno chcesz zatwierdzić wycenę:</p>
          <p class="font-weight-bold mt-2">
            Wycena v{{ quotationToApprove?.version_number }}
          </p>
          <p class="text-h6 text-primary mt-2">
            {{ formatCurrency(quotationToApprove?.total_gross) }}
          </p>
          <v-alert type="info" variant="tonal" class="mt-4">
            Tylko jedna wycena może być zatwierdzona. Inne wyceny zostaną automatycznie
            odznaczone.
          </v-alert>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn @click="approveDialog = false">Anuluj</v-btn>
          <v-btn
            color="success"
            variant="elevated"
            :loading="quotationsStore.loading"
            @click="handleApprove"
          >
            Zatwierdź
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-container>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from "vue";
import { useRoute, useRouter } from "vue-router";
import { useOrdersStore } from "@/stores/orders";
import { useQuotationsStore } from "@/stores/quotations";
import QuotationCard from "@/components/quotations/QuotationCard.vue";
import QuotationFormDialog from "@/components/quotations/QuotationFormDialog.vue";

const route = useRoute();
const router = useRouter();
const ordersStore = useOrdersStore();
const quotationsStore = useQuotationsStore();

const createDialog = ref(false);
const approveDialog = ref(false);
const quotationToApprove = ref(null);

const order = computed(() => ordersStore.currentOrder);
const quotations = computed(() => quotationsStore.quotations);

onMounted(async () => {
  await ordersStore.fetchOrder(route.params.orderId);
  await quotationsStore.fetchQuotations(route.params.orderId);
});

const viewQuotation = (quotation) => {
  router.push(`/quotations/${quotation.id}`);
};

const approveQuotation = (quotation) => {
  quotationToApprove.value = quotation;
  approveDialog.value = true;
};

const handleApprove = async () => {
  try {
    await quotationsStore.approveQuotation(quotationToApprove.value.id);
    approveDialog.value = false;
    quotationToApprove.value = null;
  } catch (error) {
    console.error("Approve error:", error);
  }
};

const downloadPDF = async (quotation) => {
  console.log("Download PDF:", quotation.id);
  // TODO: Implement PDF download
};

const handleSaved = () => {
  createDialog.value = false;
  quotationsStore.fetchQuotations(route.params.orderId);
};

const formatCurrency = (value) => {
  if (!value) return "0,00 PLN";
  return new Intl.NumberFormat("pl-PL", {
    style: "currency",
    currency: "PLN",
  }).format(value);
};
</script>


=================================================================================
FILE: src/views/rcp/Timer.vue
LOCATION: .//src/views/rcp/Timer.vue
=================================================================================

<template>
  <v-app>
    <!-- Header bez przycisku wstecz -->
    <v-main class="bg-grey-lighten-4" style="overflow: hidden">
      <v-container class="mt-60 align-center justify-center pa-0">
        <!-- Loading State -->
        <div v-if="loading" class="text-center w-100">
          <v-progress-circular indeterminate size="64" color="primary" />
          <p class="mt-4 text-h6 text-medium-emphasis">Synchronizacja czasu...</p>
        </div>

        <!-- Error State -->
        <v-alert
          v-else-if="error"
          type="error"
          variant="tonal"
          prominent
          class="mx-4"
          max-width="600"
        >
          <v-alert-title>Błąd</v-alert-title>
          {{ error }}
          <template v-slot:append>
            <v-btn variant="outlined" @click="router.push('/rcp/workstation')"
              >Powrót</v-btn
            >
          </template>
        </v-alert>

        <!-- CANCELLED STATE -->
        <div
          v-else-if="task && task.status === 'CANCELLED'"
          class="d-flex flex-column align-center justify-center text-center w-100"
        >
          <v-icon size="120" color="grey-lighten-1" class="mb-6">mdi-cancel</v-icon>
          <h2 class="text-h4 font-weight-bold text-grey-darken-2 mb-2">
            Zadanie Anulowane
          </h2>
          <p class="text-subtitle-1 text-medium-emphasis mb-8">
            To zadanie zostało anulowane przez administratora.
          </p>
          <v-btn
            color="primary"
            size="x-large"
            height="64"
            width="240"
            @click="router.push('/rcp/workstation')"
          >
            POWRÓT DO LISTY
          </v-btn>
        </div>

        <!-- COMPLETED STATE (Zabezpieczenie) -->
        <div
          v-else-if="task && task.status === 'COMPLETED'"
          class="d-flex flex-column align-center justify-center text-center w-100"
        >
          <v-icon size="120" color="success" class="mb-6">mdi-check-circle</v-icon>
          <h2 class="text-h4 font-weight-bold text-success mb-2">Zadanie Zakończone</h2>
          <v-btn
            color="primary"
            size="x-large"
            height="64"
            width="240"
            class="mt-8"
            @click="router.push('/rcp/workstation')"
          >
            POWRÓT
          </v-btn>
        </div>

        <!-- ACTIVE TIMER VIEW -->
        <div
          v-else-if="task"
          class="d-flex flex-column align-center justify-center text-center w-100"
        >
          <!-- Pulsing Icon (Mniejszy dla 1366x768) -->
          <div class="pulse-ring mb-6">
            <v-avatar color="success" size="120" elevation="6">
              <v-icon size="60" color="white">mdi-timer-sand</v-icon>
            </v-avatar>
          </div>

          <!-- Task Name -->
          <div
            class="text-h4 font-weight-bold mb-1 text-high-emphasis text-truncate px-4"
            style="max-width: 90%"
          >
            {{ task.service_name }}
          </div>

          <!-- Workstation Name -->
          <div class="text-h6 text-medium-emphasis mb-4">
            {{ task.workstation?.name }}
          </div>

          <!-- Order Info -->
          <div
            v-if="task.production_order?.variant"
            class="text-subtitle-1 text-grey-darken-1 mb-6 px-4"
          >
            <span class="text-primary font-weight-bold">
              {{ task.production_order.variant.order?.full_order_number || "---" }}
            </span>
            • {{ task.production_order.variant.name }}
          </div>

          <!-- Timer Display (Ogromny) -->
          <div class="timer-display mb-8">
            {{ formattedTime }}
          </div>

          <!-- STOP Button (Tylko jeden przycisk, bardzo duży) -->
          <v-btn
            color="red"
            size="x-large"
            height="72"
            width="240"
            class="text-h5 font-weight-bold rounded-pill elevation-4"
            @click="openCompletionDialog"
          >
            <v-icon start size="36">mdi-stop</v-icon>
            STOP PRACY
          </v-btn>
        </div>
      </v-container>
    </v-main>

    <!-- Completion Dialog -->
    <v-dialog v-model="completionDialog" max-width="500" persistent>
      <v-card class="rounded-lg">
        <v-card-title
          class="bg-primary text-white py-4 px-6 d-flex justify-center align-center"
        >
          <v-icon icon="mdi-check-circle-outline" size="28" class="mr-2"></v-icon>
          <span class="text-h6 font-weight-bold">Potwierdzenie Zakończenia</span>
        </v-card-title>

        <v-card-text class="pt-6 px-6 text-center">
          <div class="text-body-1 font-weight-regular text-grey-darken-3 mb-4">
            Czy na pewno chcesz zakończyć pracę?
          </div>

          <v-sheet border rounded="lg" class="pa-3 bg-grey-lighten-5 mb-2">
            <div
              class="text-caption text-uppercase text-medium-emphasis font-weight-bold mb-1"
            >
              Czas pracy
            </div>
            <div class="text-h4 font-weight-black text-primary font-monospace">
              {{ formattedTime }}
            </div>
          </v-sheet>
        </v-card-text>

        <v-card-actions class="pa-4">
          <v-row dense>
            <v-col cols="6">
              <v-btn
                variant="outlined"
                size="large"
                block
                color="grey-darken-1"
                @click="completionDialog = false"
              >
                Anuluj
              </v-btn>
            </v-col>
            <v-col cols="6">
              <v-btn
                color="primary"
                variant="elevated"
                size="large"
                block
                @click="confirmStop"
                :loading="stopping"
              >
                <v-icon start>mdi-check</v-icon>
                Zakończ
              </v-btn>
            </v-col>
          </v-row>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-app>
</template>
<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from "vue";
import { useRouter, useRoute } from "vue-router";
import { timerService } from "@/services/timerService";
import RcpHeader from "@/components/layout/RcpHeader.vue";
const router = useRouter();
const route = useRoute();
// State
const loading = ref(true);
const stopping = ref(false);
const error = ref<string | null>(null);
const task = ref<any>(null);
const completionDialog = ref(false);
const elapsedSeconds = ref(0);
let timerInterval: ReturnType<typeof setInterval> | null = null;
// Computed for Display
const formattedTime = computed(() => {
  const totalSeconds = Math.floor(elapsedSeconds.value);
  const h = Math.floor(totalSeconds / 3600)
    .toString()
    .padStart(2, "0");
  const m = Math.floor((totalSeconds % 3600) / 60)
    .toString()
    .padStart(2, "0");
  const s = (totalSeconds % 60).toString().padStart(2, "0");
  return `${h}:${m}:${s}`;
});
onMounted(async () => {
  const taskId = route.params.taskId;
  if (!taskId) {
    error.value = "Brak ID zadania";
    loading.value = false;
    return;
  }
  try {
    const data = await timerService.getTaskDetails(taskId);
    task.value = data;
    // Sprawdź status zadania
    if (data.status === "CANCELLED" || data.status === "COMPLETED") {
      loading.value = false;
      return; // Nie uruchamiaj timera dla anulowanych/zakończonych
    }

    elapsedSeconds.value = data.current_duration_seconds || 0;
    startLocalTicker();
  } catch (err: any) {
    console.error("Error loading task:", err);
    error.value = err.response?.data?.message || "Nie udało się załadować zadania";
  } finally {
    loading.value = false;
  }
});
onUnmounted(() => {
  stopLocalTicker();
});
const startLocalTicker = () => {
  stopLocalTicker(); // Ensure clean state
  timerInterval = setInterval(() => {
    elapsedSeconds.value++;
  }, 1000);
};
const stopLocalTicker = () => {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
};
const openCompletionDialog = () => {
  completionDialog.value = true;
};
const confirmStop = async () => {
  stopping.value = true;
  try {
    stopLocalTicker();
    await timerService.stop(task.value.id);
    completionDialog.value = false;
    router.push("/rcp/workstation");
  } catch (e: any) {
    console.error(e);
    alert("Błąd podczas zatrzymywania: " + (e.response?.data?.message || e.message));
    // Wznów timer jeśli błąd
    startLocalTicker();
  } finally {
    stopping.value = false;
  }
};
</script>
<style scoped>
.mt-60 {
  margin-top: 60px;
}
.timer-display {
  font-family: "Roboto Mono", monospace;
  font-size: 5rem; /* Zmniejszono z 6rem dla bezpiecznego fitu */
  font-weight: 900;
  color: #333;
  letter-spacing: -2px;
  line-height: 1;
}

.pulse-ring {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}
.pulse-ring::before {
  content: "";
  position: absolute;
  width: 120px; /* Dopasowane do avatara */
  height: 120px;
  border-radius: 50%;
  border: 4px solid rgba(76, 175, 80, 0.5);
  animation: ripple 2s infinite;
  z-index: 0;
}

@keyframes ripple {
  0% {
    width: 120px;
    height: 120px;
    opacity: 1;
  }
  100% {
    width: 180px;
    height: 180px;
    opacity: 0;
  }
}

.font-monospace {
  font-family: "Roboto Mono", monospace !important;
}
</style>


=================================================================================
FILE: src/views/rcp/WorkstationSelect.vue
LOCATION: .//src/views/rcp/WorkstationSelect.vue
=================================================================================

<!-- src/views/rcp/WorkstationSelect.vue -->
<!-- Panel RCP - Proces wyboru: Wariant → Stanowisko → Czynność -->
<template>
  <v-container
    fluid
    class="fill-height pa-0 d-flex flex-column bg-grey-lighten-4 position-relative"
  >
    <!-- ============================================================== -->
    <!-- PRZYCISK WSTECZ - stała pozycja lewy górny róg                 -->
    <!-- ============================================================== -->
    <v-btn
      v-if="step > 1"
      color="white"
      variant="elevated"
      size="large"
      class="back-button"
      @click="goBack"
    >
      <v-icon start size="24">mdi-arrow-left</v-icon>
      Wstecz
    </v-btn>

    <!-- Loading Overlay -->
    <v-overlay
      :model-value="checkingActiveTask"
      class="align-center justify-center"
      persistent
    >
      <v-progress-circular indeterminate size="64" color="primary" />
      <div class="text-white mt-4 font-weight-bold">Wczytywanie...</div>
    </v-overlay>

    <!-- ============================================================== -->
    <!-- KROK 1: Lista Wariantów do Produkcji                           -->
    <!-- ============================================================== -->
    <div
      v-if="step === 1"
      class="d-flex flex-column flex-grow-1 w-100 pa-4"
      style="height: 100%"
    >
      <!-- Górna belka -->
      <div class="d-flex align-center justify-space-between mb-2 flex-shrink-0">
        <h2 class="text-h5 font-weight-bold text-grey-darken-3">
          <v-icon start color="primary">mdi-clipboard-list</v-icon>
          Dostępne Zlecenia
        </h2>
        <div style="width: 400px">
          <v-text-field
            v-model="variantSearch"
            prepend-inner-icon="mdi-magnify"
            label="Szukaj (Numer, Nazwa, Klient)..."
            variant="outlined"
            density="compact"
            hide-details
            bg-color="white"
            single-line
          ></v-text-field>
        </div>
      </div>

      <!-- Tabela -->
      <v-card
        elevation="1"
        class="flex-grow-1 d-flex flex-column rounded-lg border"
        style="overflow: hidden"
      >
        <v-data-table
          :headers="variantHeaders"
          :items="availableVariants"
          :search="variantSearch"
          :loading="variantsLoading"
          :custom-filter="customSearch"
          density="compact"
          fixed-header
          hover
          items-per-page="-1"
          class="rcp-table flex-grow-1"
          style="height: 100%; overflow-y: auto"
          @click:row="handleVariantClick"
          v-model:sort-by="sortBy"
        >
          <template v-slot:item.priority="{ item }">
            <v-chip
              :color="getPriorityColor(item.priority)"
              label
              size="small"
              class="font-weight-bold text-uppercase"
            >
              {{ getPriorityLabel(item.priority) }}
            </v-chip>
          </template>

          <template v-slot:item.order_info="{ item }">
            <span class="font-weight-bold text-primary text-body-1">
              {{ item.full_order_number }}
            </span>
            <span class="text-caption text-grey ml-1"> [{{ item.variant_number }}] </span>
          </template>

          <template v-slot:item.name="{ item }">
            <span class="text-body-1 font-weight-medium">{{ item.name }}</span>
          </template>

          <template v-slot:item.quantity="{ item }">
            <v-chip size="small" variant="tonal" color="blue-grey">
              {{ item.quantity }} szt.
            </v-chip>
          </template>

          <template v-slot:item.actions>
            <v-icon color="grey-lighten-1">mdi-chevron-right</v-icon>
          </template>
        </v-data-table>
      </v-card>
    </div>

    <!-- ============================================================== -->
    <!-- KROK 2: Wybór Stanowiska                                       -->
    <!-- ============================================================== -->
    <div
      v-else-if="step === 2"
      class="d-flex flex-column flex-grow-1 w-100 pa-4"
      style="height: 100%"
    >
      <!-- Nagłówek -->
      <div class="text-center mb-4 flex-shrink-0">
        <h2 class="text-h4 font-weight-bold">Wybierz stanowisko</h2>
        <div class="text-subtitle-1 text-medium-emphasis mt-1">
          Zlecenie:
          <span class="text-primary font-weight-bold">{{
            selectedVariant?.full_order_number
          }}</span>
          <span class="text-grey ml-2">({{ selectedVariant?.name }})</span>
        </div>
      </div>

      <div
        v-if="workstations.length === 0 && !workstationStore.loading"
        class="d-flex flex-column justify-center align-center flex-grow-1 text-center"
        style="opacity: 0.7"
      >
        <v-icon
          icon="mdi-alert-circle-outline"
          size="80"
          color="warning"
          class="mb-4"
        ></v-icon>

        <h3 class="text-h5 font-weight-bold text-grey-darken-3">Brak stanowisk</h3>

        <p class="text-body-1 text-grey-darken-1 mt-2" style="max-width: 400px">
          Nie znaleziono stanowisk przypisanych do tego użytkownika. Skontatuj się z
          kierownikiem.
        </p>
      </div>

      <!-- Grid Kart (Scrollowalny) -->
      <div
        class="d-flex flex-wrap justify-center align-start gap-4 w-100 pa-2"
        style="overflow-y: auto; flex-grow: 1"
      >
        <v-hover v-for="ws in workstations" :key="ws.id" v-slot="{ isHovering, props }">
          <v-card
            v-bind="props"
            @click="ws.status === 'IDLE' ? selectWorkstation(ws) : null"
            :elevation="isHovering && ws.status === 'IDLE' ? 6 : 1"
            :variant="ws.status === 'IDLE' ? 'elevated' : 'outlined'"
            class="workstation-card d-flex flex-column pa-4 transition-swing position-relative"
            :class="[
              ws.status === 'IDLE'
                ? 'cursor-pointer border-primary-hover'
                : 'bg-grey-lighten-5 cursor-not-allowed opacity-80',
            ]"
            width="300"
            height="200"
            rounded="lg"
          >
            <!-- Górna belka karty: Status -->
            <div class="d-flex justify-space-between align-start mb-3">
              <v-chip
                size="small"
                :color="ws.status === 'IDLE' ? 'success' : 'warning'"
                label
                class="font-weight-bold"
              >
                <v-icon start size="x-small">
                  {{ ws.status === "IDLE" ? "mdi-check-circle" : "mdi-clock-outline" }}
                </v-icon>
                {{ ws.status === "IDLE" ? "WOLNE" : "ZAJĘTE" }}
              </v-chip>
            </div>

            <!-- Nazwa i Lokalizacja -->
            <div class="mb-2">
              <div class="text-h6 font-weight-bold text-high-emphasis text-truncate">
                {{ ws.name }}
              </div>
              <div
                class="text-body-2 text-medium-emphasis d-flex align-center mt-1 text-truncate"
              >
                <v-icon size="small" class="mr-1">mdi-map-marker-outline</v-icon>
                {{ ws.location || "Nie zdefiniowano" }}
              </div>
            </div>

            <v-divider class="mt-auto mb-3" v-if="ws.status !== 'IDLE'"></v-divider>

            <!-- Info o zajętości -->
            <div v-if="ws.status !== 'IDLE'" class="d-flex flex-column mt-auto">
              <div
                class="text-caption font-weight-bold text-uppercase text-medium-emphasis mb-1"
              >
                Zajęte przez:
              </div>
              <div class="d-flex align-center">
                <v-avatar size="28" color="grey-lighten-2" class="mr-2">
                  <span class="text-caption font-weight-bold">{{
                    getWorkerInitial(ws)
                  }}</span>
                </v-avatar>
                <span
                  class="text-body-2 font-weight-bold text-grey-darken-3 text-truncate"
                >
                  {{ getWorkerName(ws) }}
                </span>
              </div>
            </div>

            <!-- Akcja (Hover effect dla IDLE) -->
            <div
              v-else
              class="mt-auto pt-2 d-flex align-center text-primary font-weight-bold transition-opacity justify-end text-h6"
              :style="{ opacity: isHovering ? 1 : 0.6 }"
            >
              WYBIERZ
              <v-icon end size="large">mdi-arrow-right</v-icon>
            </div>
          </v-card>
        </v-hover>
      </div>
    </div>

    <!-- ============================================================== -->
    <!-- KROK 3: Wybór Usługi (Czynności)                               -->
    <!-- ============================================================== -->
    <div
      v-else-if="step === 3"
      class="d-flex flex-column flex-grow-1 w-100 align-center pa-4"
    >
      <!-- Nagłówek -->
      <div class="text-center mb-6 flex-shrink-0">
        <h2 class="text-h4 font-weight-bold text-grey-darken-3">Co będziesz robić?</h2>
        <div class="text-subtitle-1 text-medium-emphasis mt-1">
          Stanowisko:
          <span class="text-primary font-weight-bold">{{
            selectedWorkstation?.name
          }}</span>
          <span class="text-grey mx-2">|</span>
          Zlecenie:
          <span class="text-primary font-weight-bold">{{
            selectedVariant?.full_order_number
          }}</span>
        </div>
      </div>

      <div v-if="servicesLoading" class="text-center mt-10">
        <v-progress-circular indeterminate color="primary" size="64" />
      </div>

      <div
        v-else-if="allowedServices.length > 0"
        class="w-100 d-flex flex-column align-center"
        style="overflow-y: auto; flex-grow: 1"
      >
        <v-row class="w-100" justify="center" style="max-width: 1000px">
          <v-col v-for="service in allowedServices" :key="service.id" cols="12" sm="6">
            <v-hover v-slot="{ isHovering, props }">
              <v-card
                v-bind="props"
                @click="startTask(service)"
                class="pa-4 cursor-pointer service-card"
                :class="{ 'service-card-hover': isHovering }"
                elevation="0"
                border
              >
                <div class="d-flex align-center">
                  <v-avatar
                    color="primary"
                    size="56"
                    variant="tonal"
                    class="mr-4 rounded-lg"
                  >
                    <v-icon size="32">mdi-wrench</v-icon>
                  </v-avatar>

                  <div class="flex-grow-1">
                    <div class="text-h6 font-weight-bold text-grey-darken-3">
                      {{ service.name }}
                    </div>
                    <div class="text-subtitle-2 text-medium-emphasis text-uppercase mt-1">
                      {{ service.category }}
                    </div>
                  </div>

                  <v-btn
                    color="success"
                    size="large"
                    icon="mdi-play"
                    variant="elevated"
                    :loading="startingTask"
                  ></v-btn>
                </div>
              </v-card>
            </v-hover>
          </v-col>
        </v-row>
      </div>

      <div
        v-else
        class="d-flex flex-column justify-center align-center flex-grow-1 text-center"
        style="opacity: 0.7"
      >
        <v-icon
          icon="mdi-alert-circle-outline"
          size="80"
          color="warning"
          class="mb-4"
        ></v-icon>

        <h3 class="text-h5 font-weight-bold text-grey-darken-3">Brak usług</h3>

        <p class="text-body-1 text-grey-darken-1 mt-2" style="max-width: 400px">
          Nie znaleziono usług przypisanych do tego stanowiska dla wybranego zlecenia.
        </p>

        <v-btn variant="outlined" color="primary" class="mt-6" @click="goBack">
          Wybierz inne stanowisko
        </v-btn>
      </div>
    </div>
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from "vue";
import { useRouter } from "vue-router";
import { useWorkstationStore } from "@/stores/workstations";
import { timerService } from "@/services/timerService";
import api from "@/services/api";

const router = useRouter();
const workstationStore = useWorkstationStore();

// ============================================================
// STATE
// ============================================================
const checkingActiveTask = ref(true);
const step = ref(1);
const variantsLoading = ref(false);
const servicesLoading = ref(false);
const startingTask = ref(false);
const variantSearch = ref("");

const sortBy = ref([{ key: "priority", order: "desc" }]);

const availableVariants = ref<any[]>([]);
const workstations = computed(() => workstationStore.myItems);
const allowedServices = ref<any[]>([]);

const selectedVariant = ref<any>(null);
const selectedWorkstation = ref<any>(null);

const priorityMap: Record<string, number> = { urgent: 4, high: 3, normal: 2, low: 1 };

// ============================================================
// NAGŁÓWKI TABELI
// ============================================================
const variantHeaders = [
  {
    title: "Priorytet",
    key: "priority",
    align: "center" as const,
    width: "100px",
    sort: (a: string, b: string) =>
      priorityMap[a?.toLowerCase()] - priorityMap[b?.toLowerCase()],
  },
  { title: "Zlecenie", key: "order_info", align: "start" as const, width: "180px" },
  { title: "Produkt", key: "name", align: "start" as const },
  { title: "Klient", key: "customer_name", align: "start" as const, width: "180px" },
  { title: "Ilość", key: "quantity", align: "center" as const, width: "90px" },
  { title: "", key: "actions", align: "end" as const, sortable: false, width: "50px" },
];

// ============================================================
// LIFECYCLE
// ============================================================
onMounted(async () => {
  await checkForActiveTask();
  if (!checkingActiveTask.value) {
    loadVariants();
    loadWorkstations();
  }
});

// ============================================================
// METODY
// ============================================================

/**
 * Cofnij do poprzedniego kroku
 */
const goBack = () => {
  if (step.value > 1) {
    step.value--;
  }
};

/**
 * Własny filtr wyszukiwania po numerze zlecenia, nazwie produktu, kliencie
 */
const customSearch = (value: any, query: string, item: any) => {
  if (!query) return true;
  const q = query.toLowerCase();
  const raw = item.raw;
  return (
    (raw.full_order_number && raw.full_order_number.toLowerCase().includes(q)) ||
    (raw.order_number && raw.order_number.toLowerCase().includes(q)) ||
    (raw.name && raw.name.toLowerCase().includes(q)) ||
    (raw.customer_name && raw.customer_name.toLowerCase().includes(q))
  );
};

/**
 * Sprawdź czy pracownik ma aktywne zadanie — jeśli tak, przekieruj do timera
 */
const checkForActiveTask = async () => {
  checkingActiveTask.value = true;
  try {
    const result = await timerService.checkActiveTask();
    if (result.has_active_task && result.task_id) {
      router.push({ name: "Timer", params: { taskId: result.task_id } });
    }
  } catch (error) {
    console.error("Błąd sprawdzania aktywnego zadania:", error);
  } finally {
    checkingActiveTask.value = false;
  }
};

/**
 * Pobierz listę dostępnych wariantów (status PRODUCTION, z aktywnym zleceniem)
 */
const loadVariants = async () => {
  variantsLoading.value = true;
  try {
    const res = await api.get("/rcp/variants");
    availableVariants.value = res.data.map((variant: any) => ({
      ...variant,
      full_order_number:
        variant.full_order_number ||
        `Z/${variant.order_number}/${variant.series || "0001"}`,
    }));
  } catch (e) {
    console.error("Błąd pobierania wariantów:", e);
  } finally {
    variantsLoading.value = false;
  }
};

/**
 * Pobierz stanowiska przypisane do zalogowanego pracownika
 */
const loadWorkstations = async () => {
  await workstationStore.fetchMyWorkstations();
};

/**
 * Obsługa kliknięcia w wiersz tabeli (krok 1)
 */
const handleVariantClick = (event: Event, { item }: { item: any }) => {
  selectVariant(item);
};

/**
 * Wybierz wariant i przejdź do kroku 2
 */
const selectVariant = (variant: any) => {
  selectedVariant.value = variant;
  step.value = 2;
};

/**
 * Wybierz stanowisko i przejdź do kroku 3 (ładuje dostępne usługi dla stanowiska)
 */
const selectWorkstation = async (ws: any) => {
  selectedWorkstation.value = ws;
  step.value = 3;
  servicesLoading.value = true;

  try {
    const res = await api.get(`/workstations/${ws.id}/services`);
    allowedServices.value = res.data;
  } catch (e) {
    console.error("Błąd pobierania usług:", e);
  } finally {
    servicesLoading.value = false;
  }
};

/**
 * Uruchom zadanie i przejdź do ekranu timera.
 *
 * Używa timerService.startWork() który wysyła POST /rcp/start z:
 *   variant_id, workstation_id, service_id
 *
 * Backend (RcpService.startWork) tworzy zadanie przez firstOrCreate —
 * jeśli zadanie już istnieje (np. wznowienie), nie tworzy duplikatu.
 */
const startTask = async (service: any) => {
  startingTask.value = true;
  try {
    const result = await timerService.startWork(
      selectedVariant.value.id,
      selectedWorkstation.value.id,
      service.id
    );

    const taskId = result.current_task_id || result.task?.id;
    if (taskId) {
      router.push({ name: "Timer", params: { taskId } });
    } else {
      throw new Error("Nie otrzymano ID zadania");
    }
  } catch (e: any) {
    alert("Błąd startu: " + (e.response?.data?.message || e.message));
    startingTask.value = false;
  }
};

// ============================================================
// HELPERY UI
// ============================================================

const getPriorityColor = (priority: string) => {
  const map: Record<string, string> = {
    urgent: "red",
    high: "orange",
    normal: "blue",
    low: "grey",
  };
  return map[priority?.toLowerCase()] || "grey";
};

const getPriorityLabel = (priority: string) => {
  const map: Record<string, string> = {
    urgent: "PILNE",
    high: "WYSOKI",
    normal: "NORMALNY",
    low: "NISKI",
  };
  return map[priority?.toLowerCase()] || priority || "NORMALNY";
};

const getWorkerName = (ws: any) => {
  if (ws.current_task?.assigned_worker?.name) {
    return ws.current_task.assigned_worker.name;
  }
  if (ws.operators && ws.operators.length > 0) {
    const primary =
      ws.operators.find((op: any) => op.pivot?.is_primary) || ws.operators[0];
    return primary.name;
  }
  return "Nieznany";
};

const getWorkerInitial = (ws: any) => {
  const name = getWorkerName(ws);
  return name.charAt(0).toUpperCase();
};
</script>

<style scoped>
/* Przycisk Wstecz - stała pozycja, kolor biały */
.back-button {
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 100;
  font-weight: 600;
  text-transform: none;
  color: #333 !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.back-button:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Tabela zleceń */
.rcp-table :deep(td) {
  height: 48px !important;
  cursor: pointer;
}

.rcp-table :deep(tr:hover) {
  background-color: #f0f7ff !important;
}

/* Karty stanowisk */
.workstation-card {
  transition: all 0.2s ease;
}

/* Karty usług */
.service-card {
  border-radius: 12px;
  transition: all 0.15s ease;
}

.service-card-hover {
  border-color: rgb(var(--v-theme-primary)) !important;
  background-color: rgba(var(--v-theme-primary), 0.04) !important;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08) !important;
}
</style>


=================================================================================
FILE: src/views/users/UserList.vue
LOCATION: .//src/views/users/UserList.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Pracownicy"
      subtitle="Zarządzaj użytkownikami systemu"
      icon="mdi-account-group"
      icon-color="indigo"
      :breadcrumbs="[{ title: 'Użytkownicy', disabled: true }]"
    >
      <template #actions>
        <v-btn
          color="primary"
          variant="elevated"
          prepend-icon="mdi-plus"
          @click="openCreateDialog"
        >
          Dodaj użytkownika
        </v-btn>
      </template>
    </page-header>

    <v-card elevation="2" class="mt-4">
      <v-data-table
        :headers="headers"
        :items="usersStore.items"
        :loading="usersStore.loading"
        :search="search"
        hover
      >
        <template v-slot:top>
          <v-toolbar flat density="compact" color="transparent" class="px-4 py-2">
            <v-text-field
              v-model="search"
              prepend-inner-icon="mdi-magnify"
              label="Szukaj (imię, email)..."
              single-line
              hide-details
              density="compact"
              variant="outlined"
              style="max-width: 400px"
            ></v-text-field>
            <v-spacer></v-spacer>
            <v-btn
              icon
              color="primary"
              @click="refreshList"
              :loading="usersStore.loading"
            >
              <v-icon>mdi-refresh</v-icon>
            </v-btn>
          </v-toolbar>
        </template>

        <!-- Role Column -->
        <template v-slot:item.role="{ item }">
          <v-chip
            size="small"
            :color="formatUserRole(item.role).color"
            class="font-weight-medium"
          >
            <v-icon start size="small">{{ formatUserRole(item.role).icon }}</v-icon>
            {{ formatUserRole(item.role).label }}
          </v-chip>
        </template>

        <!-- RCP Access Column (PIN) -->
        <template v-slot:item.has_pin="{ item }">
          <v-tooltip
            location="top"
            :text="
              item.has_pin
                ? 'Dostęp do panelu RCP (PIN ustawiony)'
                : 'Brak dostępu do panelu RCP'
            "
          >
            <template v-slot:activator="{ props }">
              <div v-bind="props" class="d-flex justify-center">
                <v-icon
                  v-if="item.has_pin"
                  color="success"
                  icon="mdi-check-bold"
                ></v-icon>
                <v-icon v-else color="grey-lighten-2" icon="mdi-minus"></v-icon>
              </div>
            </template>
          </v-tooltip>
        </template>

        <!-- Status Column -->
        <template v-slot:item.is_active="{ item }">
          <v-chip
            size="small"
            :color="item.is_active ? 'success' : 'error'"
            variant="flat"
          >
            {{ item.is_active ? "Aktywny" : "Nieaktywny" }}
          </v-chip>
        </template>

        <!-- Actions -->
        <template v-slot:item.actions="{ item }">
          <div class="d-flex justify-end">
            <v-tooltip text="Edytuj" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  icon="mdi-pencil"
                  size="small"
                  variant="text"
                  color="primary"
                  @click="editUser(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip :text="item.is_active ? 'Dezaktywuj' : 'Aktywuj'" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  :icon="item.is_active ? 'mdi-account-off' : 'mdi-account-check'"
                  size="small"
                  variant="text"
                  :color="item.is_active ? 'warning' : 'success'"
                  @click="toggleActive(item)"
                />
              </template>
            </v-tooltip>

            <v-tooltip text="Usuń" location="top">
              <template v-slot:activator="{ props }">
                <v-btn
                  v-bind="props"
                  icon="mdi-delete"
                  size="small"
                  variant="text"
                  color="error"
                  @click="deleteUser(item)"
                />
              </template>
            </v-tooltip>
          </div>
        </template>

        <!-- No Data State -->
        <template v-slot:no-data>
          <div class="text-center py-8 text-medium-emphasis">
            <v-icon size="48" class="mb-2">mdi-account-off</v-icon>
            <div>Brak użytkowników do wyświetlenia</div>
            <v-btn variant="text" color="primary" class="mt-2" @click="refreshList">
              Odśwież
            </v-btn>
          </div>
        </template>
      </v-data-table>
    </v-card>

    <!-- Dialog tworzenia/edycji użytkownika -->
    <user-form-dialog v-model="dialog" :user="editedUser" @saved="refreshList" />
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useUsersStore } from "@/stores/users";
import PageHeader from "@/components/layout/PageHeader.vue";
import UserFormDialog from "@/components/users/UserFormDialog.vue";
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const usersStore = useUsersStore();
const { formatUserRole } = useStatusFormatter();

const search = ref("");
const dialog = ref(false);
const editedUser = ref(null);

const headers = [
  { title: "Imię i Nazwisko", key: "name", align: "start" },
  { title: "Email", key: "email", align: "start" },
  { title: "Rola", key: "role", align: "start" },
  { title: "Dostęp RCP", key: "has_pin", align: "center" }, // Nowa kolumna
  { title: "Status", key: "is_active", align: "center" },
  { title: "Akcje", key: "actions", align: "end", sortable: false },
];

const refreshList = async () => {
  await usersStore.fetchUsers();
};

const openCreateDialog = () => {
  editedUser.value = null; // null oznacza tryb tworzenia
  dialog.value = true;
};

const editUser = (user: any) => {
  editedUser.value = user; // Przekazujemy obiekt usera do edycji
  dialog.value = true;
};

const toggleActive = async (user: any) => {
  const action = user.is_active ? "dezaktywować" : "aktywować";
  if (confirm(`Czy na pewno chcesz ${action} konto użytkownika ${user.name}?`)) {
    await usersStore.toggleActive(user);
  }
};

const deleteUser = async (user: any) => {
  if (confirm(`Czy na pewno trwale usunąć użytkownika ${user.name}?`)) {
    await usersStore.deleteUser(user.id);
  }
};

onMounted(() => {
  refreshList();
});
</script>


=================================================================================
FILE: src/views/workstations/WorkstationList.vue
LOCATION: .//src/views/workstations/WorkstationList.vue
=================================================================================

<template>
  <v-container fluid>
    <page-header
      title="Stanowiska Robocze"
      subtitle="Zarządzaj parkiem maszynowym i operatorami"
      icon="mdi-factory"
      icon-color="blue-grey"
      :breadcrumbs="[{ title: 'Stanowiska', disabled: true }]"
    >
      <template #actions>
        <v-btn
          color="primary"
          variant="elevated"
          prepend-icon="mdi-plus"
          @click="openCreate"
        >
          Nowe Stanowisko
        </v-btn>
      </template>
    </page-header>

    <v-card elevation="2" class="mt-4">
      <v-data-table
        :headers="headers"
        :items="workstationStore.items"
        :loading="workstationStore.loading"
        :search="search"
        :custom-filter="customFilter"
        hover
      >
        <template v-slot:top>
          <v-toolbar flat density="compact" color="transparent" class="px-4 py-2">
            <v-text-field
              v-model="search"
              prepend-inner-icon="mdi-magnify"
              label="Szukaj (nazwa, lokalizacja, pracownik)..."
              single-line
              hide-details
              density="compact"
              variant="outlined"
              style="max-width: 400px"
            ></v-text-field>
            <v-spacer></v-spacer>
            <v-btn
              icon
              color="primary"
              @click="refreshList"
              :loading="workstationStore.loading"
            >
              <v-icon>mdi-refresh</v-icon>
            </v-btn>
          </v-toolbar>
        </template>

        <!-- Typ -->
        <template v-slot:item.type="{ item }">
          <v-chip
            size="small"
            :color="getTypeColor(item.type)"
            variant="tonal"
            class="font-weight-bold"
          >
            <!-- ZMIANA: Używamy helpera do etykiety -->
            {{ getTypeLabel(item.type) }}
          </v-chip>
        </template>

        <!-- Status -->
        <template v-slot:item.status="{ item }">
          <!-- ZMIANA: Używamy helperów do koloru i etykiety -->
          <v-chip
            size="small"
            :color="getStatusColor(item.status)"
            label
            class="font-weight-bold"
          >
            {{ getStatusLabel(item.status) }}
          </v-chip>
        </template>

        <!-- Operatorzy (AWATARY) -->
        <template v-slot:item.operators="{ item }">
          <div
            v-if="item.operators && item.operators.length > 0"
            class="d-flex align-center pl-2"
          >
            <!-- Awatary operatorów -->
            <v-avatar
              v-for="(op, index) in item.operators.slice(0, 3)"
              :key="op.id"
              size="32"
              color="grey-lighten-2"
              class="avatar-stack-item"
            >
              <span class="text-grey-darken-3 font-weight-bold" style="font-size: 12px">
                {{ getInitials(op.name) }}
              </span>
              <v-tooltip activator="parent" location="top">{{ op.name }}</v-tooltip>
            </v-avatar>

            <!-- Licznik (jeśli jest więcej) -->
            <v-avatar
              v-if="item.operators.length > 3"
              size="32"
              color="grey-darken-3"
              class="avatar-stack-item"
            >
              <span class="text-white font-weight-bold" style="font-size: 11px">
                +{{ item.operators.length - 3 }}
              </span>
              <v-tooltip activator="parent" location="top">
                Pozostali pracownicy (łącznie: {{ item.operators.length }})
              </v-tooltip>
            </v-avatar>
          </div>
          <span v-else class="text-caption text-disabled font-italic pl-2">Brak</span>
        </template>

        <!-- Akcje -->
        <template v-slot:item.actions="{ item }">
          <div class="d-flex justify-end align-center" style="white-space: nowrap">
            <v-btn
              icon="mdi-pencil"
              size="small"
              variant="text"
              color="primary"
              @click="openEdit(item)"
              title="Edytuj"
            ></v-btn>
            <v-btn
              icon="mdi-delete"
              size="small"
              variant="text"
              color="error"
              @click="deleteItem(item)"
              title="Usuń"
            ></v-btn>
          </div>
        </template>
      </v-data-table>
    </v-card>

    <workstation-form-dialog
      v-model="dialog"
      :workstation="editingItem"
      @saved="refreshList"
    />
  </v-container>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useWorkstationStore } from "@/stores/workstations";
import PageHeader from "@/components/layout/PageHeader.vue";
import WorkstationFormDialog from "@/components/workstations/WorkstationFormDialog.vue";
// Import API tylko do pobrania metadanych
import api from "@/services/api";

const workstationStore = useWorkstationStore();

const search = ref("");
const dialog = ref(false);
const editingItem = ref(null);

// Słowniki metadanych (do tłumaczeń statusów)
const workstationStatuses = ref([]);
const workstationTypes = ref([]);

const headers = [
  { title: "Nazwa", key: "name", align: "start" },
  { title: "Typ", key: "type", align: "start" },
  { title: "Lokalizacja", key: "location", align: "start" },
  { title: "Operatorzy", key: "operators", align: "start", sortable: false },
  { title: "Status", key: "status", align: "center" },
  { title: "Akcje", key: "actions", align: "end", sortable: false, width: "120px" },
];

const refreshList = async () => {
  await workstationStore.fetchWorkstations();
};

const customFilter = (value, query, item) => {
  if (value == null || query == null) return false;
  const searchText = query.toString().toLowerCase();

  // Filtrowanie po polach zagnieżdżonych (operators)
  if (item.raw.name && item.raw.name.toLowerCase().includes(searchText)) return true;
  if (item.raw.location && item.raw.location.toLowerCase().includes(searchText))
    return true;
  if (item.raw.operators && Array.isArray(item.raw.operators)) {
    return item.raw.operators.some((op) => op.name.toLowerCase().includes(searchText));
  }
  return false;
};

const openCreate = () => {
  editingItem.value = null;
  dialog.value = true;
};

const openEdit = (item) => {
  // Klonowanie obiektu, aby edycja w dialogu nie zmieniała od razu tabeli
  editingItem.value = JSON.parse(JSON.stringify(item));
  dialog.value = true;
};

const deleteItem = async (item) => {
  if (confirm(`Czy na pewno usunąć stanowisko ${item.name}?`)) {
    try {
      await workstationStore.deleteWorkstation(item.id);
    } catch (e) {
      alert("Błąd usuwania: " + e.message);
    }
  }
};

// --- HELPERY ENUM ---

const getTypeLabel = (typeValue) => {
  const type = workstationTypes.value.find((t) => t.value === typeValue);
  return type ? type.label : typeValue;
};

const getTypeColor = (type) => {
  const map = { LASER: "red", CNC: "blue", ASSEMBLY: "green", PAINTING: "orange" };
  return map[type] || "grey";
};

const getStatusLabel = (statusValue) => {
  const status = workstationStatuses.value.find((s) => s.value === statusValue);
  return status ? status.label : statusValue;
};

const getStatusColor = (statusValue) => {
  // Priorytet: kolor z backendu -> mapa lokalna -> grey
  const status = workstationStatuses.value.find((s) => s.value === statusValue);
  if (status && status.color) return status.color;

  const map = {
    IDLE: "success",
    ACTIVE: "primary",
    PAUSED: "warning",
    MAINTENANCE: "error",
  };
  return map[statusValue] || "grey";
};

const getInitials = (name) => {
  if (!name) return "?";
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .substring(0, 2)
    .toUpperCase();
};

// --- INICJALIZACJA ---

onMounted(async () => {
  // Pobieramy listę stanowisk
  refreshList();

  // Pobieramy metadane do tłumaczeń (typy, statusy)
  try {
    const metaRes = await api.get("/metadata");
    if (metaRes.data) {
      workstationStatuses.value = metaRes.data.workstation_statuses || [];
      workstationTypes.value = metaRes.data.workstation_types || [];
    }
  } catch (error) {
    console.error("Błąd pobierania metadanych:", error);
  }
});
</script>

<style scoped>
/* Styl dla nakładających się awatarów */
.avatar-stack-item {
  border: 2px solid white; /* Biała ramka oddzielająca */
  margin-left: -10px; /* Ujemny margines powoduje nakładanie */
  transition: transform 0.2s, z-index 0.2s; /* Animacja przy najechaniu */
  cursor: default;
}

/* Pierwszy awatar nie może mieć ujemnego marginesu */
.avatar-stack-item:first-child {
  margin-left: 0;
}

/* Efekt po najechaniu myszką - wyciągnięcie na wierzch */
.avatar-stack-item:hover {
  z-index: 10;
  transform: translateY(-3px);
  border-color: #f5f5f5;
}
</style>


=================================================================================
FILE: src/components/assortment/AssortmentDetailsDialog.vue
LOCATION: .//src/components/assortment/AssortmentDetailsDialog.vue
=================================================================================

<template>
  <v-dialog 
    :model-value="modelValue" 
    @update:model-value="$emit('update:modelValue', $event)" 
    max-width="900" 
    scrollable
  >
    <v-card v-if="item">
      <v-card-title class="bg-primary text-white d-flex align-center py-4">
        <v-icon start color="white" size="large">mdi-information</v-icon>
        <span class="text-h5">Szczegóły pozycji</span>
        <v-spacer />
        <v-btn
          icon="mdi-pencil"
          color="white"
          variant="text"
          @click="$emit('edit', item)"
        />
        <v-btn
          icon="mdi-close"
          color="white"
          variant="text"
          @click="$emit('close')"
        />
      </v-card-title>

      <v-divider />

      <v-card-text class="pt-6">
        <!-- Basic Info -->
        <v-row>
          <v-col cols="12" md="6">
            <v-card variant="outlined">
              <v-card-text>
                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Typ</div>
                  <v-chip 
                    :color="item.type === 'material' ? 'blue' : 'purple'" 
                    size="small"
                  >
                    <v-icon start size="small">
                      {{ item.type === 'material' ? 'mdi-cube' : 'mdi-wrench' }}
                    </v-icon>
                    {{ item.type === 'material' ? 'Materiał' : 'Usługa' }}
                  </v-chip>
                </div>

                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Nazwa</div>
                  <div class="text-h6 font-weight-bold">{{ item.name }}</div>
                </div>

                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Kategoria</div>
                  <v-chip size="small" variant="outlined">
                    {{ item.category }}
                  </v-chip>
                </div>

                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Status</div>
                  <v-chip 
                    :color="item.is_active ? 'success' : 'grey'" 
                    size="small"
                  >
                    {{ item.is_active ? 'Aktywna' : 'Nieaktywna' }}
                  </v-chip>
                </div>
              </v-card-text>
            </v-card>
          </v-col>

          <v-col cols="12" md="6">
            <v-card variant="outlined">
              <v-card-text>
                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Cena domyślna</div>
                  <div class="text-h5 font-weight-bold text-success">
                    {{ formatCurrency(item.default_price) }}
                  </div>
                  <div class="text-caption text-medium-emphasis">
                    za {{ item.unit }}
                  </div>
                </div>

                <div class="mb-4">
                  <div class="text-caption text-medium-emphasis">Jednostka</div>
                  <div class="text-h6">{{ item.unit }}</div>
                </div>

                <div>
                  <div class="text-caption text-medium-emphasis">Utworzono</div>
                  <div>{{ formatDate(item.created_at) }}</div>
                </div>

                <div class="mt-2">
                  <div class="text-caption text-medium-emphasis">Zaktualizowano</div>
                  <div>{{ formatDate(item.updated_at) }}</div>
                </div>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>

        <!-- Description -->
        <v-card v-if="item.description" variant="outlined" class="mt-4">
          <v-card-text>
            <div class="text-caption text-medium-emphasis mb-2">Opis</div>
            <div class="text-body-2">{{ item.description }}</div>
          </v-card-text>
        </v-card>

        <!-- History -->
        <v-card class="mt-6" elevation="2">
          <v-card-title class="bg-grey-lighten-4">
            <v-icon start>mdi-history</v-icon>
            Historia zmian
          </v-card-title>

          <v-card-text class="pa-0">
            <div v-if="loadingHistory" class="text-center py-6">
              <v-progress-circular indeterminate color="primary" />
            </div>

            <v-timeline v-else-if="history.length > 0" density="compact" side="end">
              <v-timeline-item
                v-for="entry in history"
                :key="entry.id"
                :dot-color="getActionColor(entry.action)"
                size="small"
              >
                <template v-slot:icon>
                  <v-icon size="small" color="white">
                    {{ getActionIcon(entry.action) }}
                  </v-icon>
                </template>

                <v-card variant="outlined" class="mb-2">
                  <v-card-text class="py-2">
                    <div class="d-flex align-center mb-1">
                      <v-chip :color="getActionColor(entry.action)" size="x-small" class="mr-2">
                        {{ getActionLabel(entry.action) }}
                      </v-chip>
                      <span class="text-caption text-medium-emphasis">
                        {{ formatDate(entry.created_at) }}
                      </span>
                      <v-spacer />
                      <v-chip size="x-small" variant="outlined" v-if="entry.user">
                        <v-icon start size="x-small">mdi-account</v-icon>
                        {{ entry.user.name }}
                      </v-chip>
                    </div>

                    <div v-if="entry.description" class="text-body-2">
                      {{ entry.description }}
                    </div>

                    <!-- Change Details -->
                    <div v-if="entry.old_values && entry.new_values" class="mt-2">
                      <v-expansion-panels variant="accordion" density="compact">
                        <v-expansion-panel>
                          <v-expansion-panel-title class="text-caption">
                            Szczegóły zmian
                          </v-expansion-panel-title>
                          <v-expansion-panel-text>
                            <div 
                              v-for="(newValue, key) in entry.new_values" 
                              :key="key"
                              class="mb-2"
                            >
                              <strong>{{ getFieldLabel(key) }}:</strong>
                              <span class="text-error">{{ formatValue(key, entry.old_values[key]) }}</span>
                              →
                              <span class="text-success">{{ formatValue(key, newValue) }}</span>
                            </div>
                          </v-expansion-panel-text>
                        </v-expansion-panel>
                      </v-expansion-panels>
                    </div>
                  </v-card-text>
                </v-card>
              </v-timeline-item>
            </v-timeline>

            <v-alert v-else type="info" variant="tonal" class="ma-4">
              Brak historii zmian dla tej pozycji
            </v-alert>
          </v-card-text>
        </v-card>
      </v-card-text>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue'
import api from '@/services/api'

const props = defineProps({
  modelValue: Boolean,
  item: Object
})

defineEmits(['update:modelValue', 'edit', 'close'])

const history = ref([])
const loadingHistory = ref(false)

watch(() => props.modelValue, async (newVal) => {
  if (newVal && props.item) {
    await loadHistory()
  }
})

const loadHistory = async () => {
  if (!props.item?.id) return
  
  loadingHistory.value = true
  try {
    const response = await api.get(`/assortment/${props.item.id}/history`)
    history.value = response.data
  } catch (error) {
    console.error('History error:', error)
    history.value = []
  } finally {
    loadingHistory.value = false
  }
}

const getActionColor = (action) => {
  const colors = {
    'created': 'success',
    'updated': 'info',
    'deleted': 'error',
    'activated': 'green',
    'deactivated': 'orange'
  }
  return colors[action] || 'grey'
}

const getActionIcon = (action) => {
  const icons = {
    'created': 'mdi-plus',
    'updated': 'mdi-pencil',
    'deleted': 'mdi-delete',
    'activated': 'mdi-check',
    'deactivated': 'mdi-close'
  }
  return icons[action] || 'mdi-circle'
}

const getActionLabel = (action) => {
  const labels = {
    'created': 'Utworzono',
    'updated': 'Zaktualizowano',
    'deleted': 'Usunięto',
    'activated': 'Aktywowano',
    'deactivated': 'Dezaktywowano'
  }
  return labels[action] || action
}

const getFieldLabel = (field) => {
  const labels = {
    'name': 'Nazwa',
    'type': 'Typ',
    'category': 'Kategoria',
    'unit': 'Jednostka',
    'default_price': 'Cena',
    'description': 'Opis',
    'is_active': 'Status'
  }
  return labels[field] || field
}

const formatValue = (field, value) => {
  if (value === null || value === undefined) return '-'
  
  if (field === 'is_active') {
    return value ? 'Aktywna' : 'Nieaktywna'
  }
  
  if (field === 'default_price') {
    return formatCurrency(value)
  }
  
  return value
}

const formatCurrency = (value) => {
  if (!value) return '0,00 PLN'
  return new Intl.NumberFormat('pl-PL', {
    style: 'currency',
    currency: 'PLN'
  }).format(value)
}

const formatDate = (date) => {
  if (!date) return '-'
  return new Date(date).toLocaleString('pl-PL', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}
</script>


=================================================================================
FILE: src/components/assortment/AssortmentFormDialog.vue
LOCATION: .//src/components/assortment/AssortmentFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="600"
    persistent
  >
    <v-card>
      <v-card-title class="bg-primary text-white">
        <v-icon start color="white">
          {{ isEdit ? "mdi-pencil" : "mdi-plus" }}
        </v-icon>
        {{ isEdit ? "Edytuj pozycję" : "Nowa pozycja asortymentu" }}
      </v-card-title>

      <v-card-text class="pt-6">
        <v-form ref="formRef" v-model="valid" @submit.prevent="handleSubmit">
          <v-row>
            <!-- Typ -->
            <v-col cols="12" md="6">
              <v-select
                v-model="form.type"
                label="Typ *"
                :items="metadataStore.assortmentTypes"
                item-title="label"
                item-value="value"
                variant="outlined"
                :rules="[(v) => !!v || 'Typ jest wymagany']"
                prepend-inner-icon="mdi-shape"
                @update:model-value="loadCategoriesForType"
              />
            </v-col>

            <!-- Kategoria (Combobox - pozwala dodać nową) -->
            <v-col cols="12" md="6">
              <v-combobox
                v-model="form.category"
                label="Kategoria *"
                :items="assortmentStore.categories"
                variant="outlined"
                :rules="[(v) => !!v || 'Kategoria jest wymagana']"
                prepend-inner-icon="mdi-tag"
                placeholder="Wybierz lub wpisz nową"
              />
            </v-col>

            <!-- Nazwa -->
            <v-col cols="12">
              <v-text-field
                v-model="form.name"
                label="Nazwa *"
                variant="outlined"
                :rules="[(v) => !!v || 'Nazwa jest wymagana']"
                prepend-inner-icon="mdi-format-title"
              />
            </v-col>

            <!-- Jednostka -->
            <v-col cols="12" md="6">
              <v-select
                v-model="form.unit"
                label="Jednostka miary *"
                :items="metadataStore.units"
                item-title="label"
                item-value="value"
                variant="outlined"
                :rules="[(v) => !!v || 'Jednostka jest wymagana']"
                prepend-inner-icon="mdi-ruler"
              />
            </v-col>

            <!-- Cena -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model.number="form.default_price"
                label="Cena domyślna (netto) *"
                type="number"
                min="0"
                step="0.01"
                variant="outlined"
                :rules="[(v) => v >= 0 || 'Cena nie może być ujemna']"
                prepend-inner-icon="mdi-cash"
                suffix="PLN"
              />
            </v-col>

            <!-- Opis -->
            <v-col cols="12">
              <v-textarea
                v-model="form.description"
                label="Opis / Uwagi"
                variant="outlined"
                rows="3"
                prepend-inner-icon="mdi-text"
              />
            </v-col>

            <!-- Status (Tylko przy edycji) -->
            <v-col cols="12" v-if="isEdit">
              <v-switch
                v-model="form.is_active"
                label="Aktywny"
                color="success"
                hide-details
              />
            </v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-divider />

      <v-card-actions class="pa-4">
        <v-spacer />
        <v-btn variant="text" @click="close">Anuluj</v-btn>
        <v-btn color="primary" variant="elevated" :loading="saving" @click="handleSubmit">
          <v-icon start>mdi-check</v-icon>
          Zapisz
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted } from "vue";
import { useAssortmentStore } from "@/stores/assortment";
import { useMetadataStore } from "@/stores/metadata";

const props = defineProps({
  modelValue: Boolean,
  item: {
    type: Object,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

const assortmentStore = useAssortmentStore();
const metadataStore = useMetadataStore();

const formRef = ref(null);
const valid = ref(false);
const saving = ref(false);

const isEdit = computed(() => !!props.item);

const defaultForm = {
  type: "MATERIAL", // FIX: changed from "material" to "MATERIAL"
  category: null,
  name: "",
  unit: "SZT", // FIX: changed from "szt" to "SZT" (likely matches Enum AssortmentUnit better)
  default_price: 0,
  description: "",
  is_active: true,
};

const form = ref({ ...defaultForm });

// Wypełnianie formularza przy otwarciu
watch(
  () => props.modelValue,
  async (val) => {
    if (val) {
      if (props.item) {
        form.value = { ...props.item };
      } else {
        form.value = { ...defaultForm };
      }
      // Pobierz kategorie dla aktualnego typu
      await loadCategoriesForType(form.value.type);
    }
  }
);

const loadCategoriesForType = async (type) => {
  if (type) {
    await assortmentStore.fetchCategories(type);
  }
};

const handleSubmit = async () => {
  const { valid } = await formRef.value.validate();
  if (!valid) return;

  saving.value = true;
  try {
    if (isEdit.value) {
      await assortmentStore.updateItem(props.item.id, form.value);
    } else {
      await assortmentStore.createItem(form.value);
    }
    emit("saved");
    close();
  } catch (error) {
    console.error("Błąd zapisu:", error);
    alert("Wystąpił błąd podczas zapisywania.");
  } finally {
    saving.value = false;
  }
};

const close = () => {
  emit("update:modelValue", false);
  formRef.value?.resetValidation();
};

onMounted(() => {
  // Upewnij się, że metadata są załadowane (np. jednostki)
  if (!metadataStore.loaded) {
    metadataStore.fetchMetadata();
  }
});
</script>


=================================================================================
FILE: src/components/assortment/AssortmentHistoryDialog.vue
LOCATION: .//src/components/assortment/AssortmentHistoryDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="700"
  >
    <v-card>
      <v-card-title class="bg-info text-white">
        <v-icon start color="white">mdi-history</v-icon>
        Historia zmian: {{ item?.name }}
      </v-card-title>

      <v-card-text class="pt-6" style="max-height: 600px; overflow-y: auto">
        <div v-if="loading" class="text-center py-8">
          <v-progress-circular indeterminate color="info" />
        </div>

        <v-timeline v-else-if="history.length > 0" density="compact" align="start">
          <v-timeline-item
            v-for="entry in history"
            :key="entry.id"
            :dot-color="formatHistoryAction(entry.action).color"
            size="small"
          >
            <template #opposite>
              <!-- ZMIANA: nowa Date().toLocaleString() → formatDate z useFormatters (date-fns) -->
              <div class="text-caption text-medium-emphasis">
                {{ formatDate(entry.created_at) }}
              </div>
            </template>

            <div class="mb-2">
              <div class="font-weight-bold">
                <!-- ZMIANA: lokalna mapa getActionLabel → formatHistoryAction().label -->
                {{ formatHistoryAction(entry.action).label }}
                <span class="text-caption font-weight-regular ml-2">
                  przez {{ entry.user?.name || "System" }}
                </span>
              </div>
              <div class="text-body-2 text-medium-emphasis">
                {{ entry.change_description || entry.description }}
              </div>
            </div>
          </v-timeline-item>
        </v-timeline>

        <v-alert v-else type="info" variant="tonal" class="mt-2">
          Brak historii zmian dla tej pozycji.
        </v-alert>
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn @click="$emit('update:modelValue', false)">Zamknij</v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch, computed } from "vue";
import { useAssortmentStore } from "@/stores/assortment";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps({
  modelValue: Boolean,
  item: Object,
});

defineEmits(["update:modelValue"]);

const assortmentStore = useAssortmentStore();
const loading = computed(() => assortmentStore.loading);
const history = computed(() => assortmentStore.history);

// ZMIANA: pobieramy z composables zamiast definiować lokalnie
const { formatHistoryAction } = useStatusFormatter();
const { formatDate } = useFormatters();

watch(
  () => props.modelValue,
  async (isOpen) => {
    if (isOpen && props.item) {
      await assortmentStore.fetchHistory(props.item.id);
    }
  }
);
</script>


=================================================================================
FILE: src/components/common/BreadcrumbsBar.vue
LOCATION: .//src/components/common/BreadcrumbsBar.vue
=================================================================================

<template>
  <v-card elevation="0" class="mb-4 breadcrumbs-bar">
    <v-card-text class="py-3">
      <v-breadcrumbs
        :items="breadcrumbItems"
        class="pa-0"
      >
        <template v-slot:divider>
          <v-icon>mdi-chevron-right</v-icon>
        </template>

        <template v-slot:item="{ item }">
          <v-breadcrumbs-item
            :disabled="item.disabled"
            :to="item.to"
            :exact="item.exact"
          >
            <v-icon v-if="item.icon" :size="18" class="mr-2">
              {{ item.icon }}
            </v-icon>
            {{ item.title }}
          </v-breadcrumbs-item>
        </template>
      </v-breadcrumbs>

      <!-- Current Page Title -->
      <div class="d-flex align-center mt-2">
        <v-icon v-if="pageIcon" size="32" class="mr-3" :color="pageIconColor">
          {{ pageIcon }}
        </v-icon>
        <div>
          <h1 class="text-h4 font-weight-bold">{{ pageTitle }}</h1>
          <p v-if="pageSubtitle" class="text-body-2 text-medium-emphasis mt-1">
            {{ pageSubtitle }}
          </p>
        </div>
      </div>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue'

const props = defineProps({
  items: {
    type: Array,
    default: () => []
  },
  pageTitle: {
    type: String,
    required: true
  },
  pageSubtitle: {
    type: String,
    default: ''
  },
  pageIcon: {
    type: String,
    default: ''
  },
  pageIconColor: {
    type: String,
    default: 'primary'
  }
})

const breadcrumbItems = computed(() => {
  return [
    {
      title: 'Dashboard',
      icon: 'mdi-home',
      to: { name: 'Dashboard' },
      exact: true
    },
    ...props.items
  ]
})
</script>

<style scoped>
.breadcrumbs-bar {
  background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
  border-bottom: 2px solid #e0e0e0;
}
</style>


=================================================================================
FILE: src/components/common/ImageGallery.vue
LOCATION: .//src/components/common/ImageGallery.vue
=================================================================================

<template>
  <v-card elevation="2" class="rounded-lg">
    <v-card-title class="bg-primary text-white d-flex align-center py-3 px-4">
      <v-icon start color="white">mdi-image-multiple</v-icon>
      <span class="text-subtitle-1 font-weight-bold">Galeria zdjęć zamówienia ({{ images.length }})</span>
      <v-spacer />
      <v-btn
        v-if="canUpload"
        color="white"
        variant="text"
        size="small"
        @click="uploadDialog = true"
      >
        <v-icon start>mdi-plus</v-icon>
        Dodaj
      </v-btn>
    </v-card-title>

    <v-card-text class="pa-4">
      <v-row v-if="images.length > 0" dense>
        <v-col
          v-for="(image, index) in images"
          :key="image.id"
          cols="4"
          sm="3"
          md="2"
        >
          <v-hover v-slot:default="{ isHovering, props: hoverProps }">
            <v-card
              v-bind="hoverProps"
              :elevation="isHovering ? 8 : 2"
              class="thumbnail-card rounded-md"
              @click="openFullscreen(index)"
            >
              <v-img :src="image.thumbnail_url || image.url" :aspect-ratio="1" cover>
                <v-overlay :model-value="isHovering" contained scrim="primary" class="align-center justify-center">
                  <v-icon color="white" size="32">mdi-magnify-plus</v-icon>
                </v-overlay>
              </v-img>
            </v-card>
          </v-hover>
        </v-col>
      </v-row>
      <div v-else class="text-center py-8 bg-grey-lighten-4 rounded-lg border-dashed">
        <v-icon size="48" color="grey-lighten-1">mdi-image-off-outline</v-icon>
        <p class="text-body-2 text-medium-emphasis mt-2">Brak zdjęć w tym zamówieniu</p>
      </div>
    </v-card-text>

    <v-dialog v-model="fullscreenDialog" max-width="1100px">
      <v-card color="white" class="rounded-lg overflow-hidden">
        <v-toolbar density="compact" color="white" border="bottom">
          <v-toolbar-title class="text-body-2 font-weight-bold">
            {{ images[currentIndex]?.description || images[currentIndex]?.filename || 'Podgląd' }}
          </v-toolbar-title>
          <v-spacer />
          <v-btn icon="mdi-download-outline" color="primary" variant="text" @click="downloadImage(images[currentIndex])" />
          <v-btn v-if="canDelete" icon="mdi-delete-outline" color="error" variant="text" @click="confirmDelete(images[currentIndex])" />
          <v-btn icon="mdi-close" variant="text" @click="fullscreenDialog = false" />
        </v-toolbar>

        <v-card-text class="pa-0 position-relative d-flex align-center justify-center bg-grey-lighten-4" style="min-height: 50vh; max-height: 70vh;">
          <v-btn v-if="images.length > 1" icon="mdi-chevron-left" variant="elevated" color="white" class="nav-btn left" @click="prevImage" />
          <v-img :key="currentIndex" :src="images[currentIndex]?.url" contain class="w-100 h-100" />
          <v-btn v-if="images.length > 1" icon="mdi-chevron-right" variant="elevated" color="white" class="nav-btn right" @click="nextImage" />
        </v-card-text>

        <v-divider />
        <v-sheet color="white" class="pa-3 d-flex justify-center gap-2 overflow-x-auto">
          <v-avatar v-for="(img, idx) in images" :key="img.id" size="50" class="cursor-pointer thumbnail-mini" :class="{ 'active-mini': idx === currentIndex }" @click="currentIndex = idx">
            <v-img :src="img.thumbnail_url || img.url" cover />
          </v-avatar>
        </v-sheet>
      </v-card>
    </v-dialog>

    <v-dialog v-model="uploadDialog" max-width="500">
      <v-card class="rounded-lg">
        <v-card-title class="bg-primary text-white">Dodaj zdjęcia do zamówienia</v-card-title>
        <v-card-text class="pt-6">
           <v-file-input v-input v-model="selectedFiles" label="Wybierz pliki" accept="image/*" multiple variant="outlined" show-size chips />
        </v-card-text>
        <v-card-actions class="pa-4">
          <v-spacer />
          <v-btn variant="text" @click="uploadDialog = false">Anuluj</v-btn>
          <v-btn color="primary" variant="elevated" @click="handleUpload" :loading="uploading">Prześlij</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<script setup lang="ts">
import { ref } from 'vue'

const props = defineProps({
  images: { type: Array, default: () => [] },
  canUpload: { type: Boolean, default: true },
  canDelete: { type: Boolean, default: true }
})

const emit = defineEmits(['upload', 'delete'])
const uploadDialog = ref(false)
const fullscreenDialog = ref(false)
const currentIndex = ref(0)
const selectedFiles = ref(null)
const uploading = ref(false)

const openFullscreen = (index) => {
  currentIndex.value = index
  fullscreenDialog.value = true
}

const nextImage = () => { currentIndex.value = (currentIndex.value + 1) % props.images.length }
const prevImage = () => { currentIndex.value = (currentIndex.value - 1 + props.images.length) % props.images.length }

const downloadImage = (image) => {
  const link = document.createElement('a');
  link.href = image.url;
  link.download = image.filename || 'zdjecie.jpg';
  link.click();
}

const handleUpload = async () => {
  if (!selectedFiles.value) return
  uploading.value = true
  emit('upload', { files: selectedFiles.value })
  uploadDialog.value = false
  selectedFiles.value = null
  uploading.value = false
}
</script>

<style scoped>
.thumbnail-card { cursor: pointer; overflow: hidden; transition: 0.2s; }
.thumbnail-card:hover { transform: translateY(-2px); }
.nav-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; }
.nav-btn.left { left: 15px; }
.nav-btn.right { right: 15px; }
.thumbnail-mini { opacity: 0.4; border: 2px solid transparent; cursor: pointer; }
.active-mini { opacity: 1; border-color: #1976d2; transform: scale(1.1); }
.border-dashed { border: 2px dashed #ccc !important; }
</style>


=================================================================================
FILE: src/components/common/InlineEditField.vue
LOCATION: .//src/components/common/InlineEditField.vue
=================================================================================

<template>
  <div
    class="inline-edit-container rounded px-2 py-1"
    :class="{ hoverable: !isEditing && !loading, editing: isEditing }"
    @click="startEditing"
  >
    <!-- TRYB EDYCJI -->
    <div v-if="isEditing" class="d-flex align-center w-100">
      <!-- SELECT (np. Status) -->
      <v-select
        v-if="type === 'select'"
        ref="inputRef"
        v-model="internalValue"
        v-model:menu="isMenuOpen"
        :items="items"
        :item-title="itemTitle"
        :item-value="itemValue"
        variant="outlined"
        density="compact"
        hide-details
        menu-icon="mdi-chevron-down"
        class="flex-grow-1"
        @update:model-value="save"
        @keydown.esc="cancel"
      >
        <!-- Przekazywanie slotu dla wybranego elementu (W TRAKCIE EDYCJI) -->
        <template v-if="$slots.selection" v-slot:selection="slotProps">
          <slot name="selection" v-bind="slotProps"></slot>
        </template>

        <!-- Przekazywanie slotu dla elementów rozwijanej listy -->
        <template v-if="$slots.item" v-slot:item="slotProps">
          <slot name="item" v-bind="slotProps"></slot>
        </template>
      </v-select>

      <!-- TEXTAREA -->
      <v-textarea
        v-else-if="type === 'textarea'"
        ref="inputRef"
        v-model="internalValue"
        variant="outlined"
        density="compact"
        hide-details
        auto-grow
        rows="1"
        class="flex-grow-1"
        @keydown.enter.prevent="save"
        @keydown.esc="cancel"
        @blur="save"
      ></v-textarea>

      <!-- TEXT / NUMBER / DATE -->
      <v-text-field
        v-else
        ref="inputRef"
        v-model="internalValue"
        :type="inputType"
        variant="outlined"
        density="compact"
        hide-details
        single-line
        @keydown.enter="save"
        @keydown.esc="cancel"
        @blur="save"
      ></v-text-field>
    </div>

    <!-- TRYB WYŚWIETLANIA -->
    <div
      v-else
      :class="textClass"
      class="d-flex align-center w-100"
      style="min-height: 32px"
    >
      <!-- Loading Spinner -->
      <v-progress-circular
        v-if="loading"
        indeterminate
        size="20"
        width="2"
        color="primary"
        class="mr-2"
      />

      <div
        :class="textClass"
        class="flex-grow-1 d-flex align-center justify-space-between"
      >
        <!-- Ikona ołówka Z LEWEJ -->
        <v-icon
          v-if="!loading && showEditIcon && iconPosition === 'left'"
          icon="mdi-pencil"
          size="x-small"
          class="edit-icon mr-2 text-medium-emphasis"
        ></v-icon>

        <!-- Wartość -->
        <slot name="display" :value="modelValue">
          <span v-if="displayValue" :class="textClass" style="white-space: pre-wrap">{{
            displayValue
          }}</span>
          <span v-else :class="textClass" class="text-medium-emphasis font-italic">{{
            placeholder
          }}</span>
        </slot>

        <!-- Ikona ołówka Z PRAWEJ (domyślnie) -->
        <v-icon
          v-if="!loading && showEditIcon && iconPosition === 'right'"
          icon="mdi-pencil"
          size="x-small"
          class="edit-icon ml-2 text-medium-emphasis"
        ></v-icon>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, nextTick, watch } from "vue";

const props = defineProps({
  modelValue: {
    type: [String, Number, Boolean],
    default: "",
  },
  type: {
    type: String,
    default: "text", // 'text', 'number', 'textarea', 'select', 'date'
  },
  items: {
    type: Array,
    default: () => [],
  },
  itemTitle: {
    type: String,
    default: "title",
  },
  itemValue: {
    type: String,
    default: "value",
  },
  placeholder: {
    type: String,
    default: "Kliknij, aby edytować...",
  },
  textClass: {
    type: String,
    default: "",
  },
  loading: {
    type: Boolean,
    default: false,
  },
  suffix: {
    type: String,
    default: "",
  },
  showEditIcon: {
    type: Boolean,
    default: true,
  },
  iconPosition: {
    type: String as () => "left" | "right",
    default: "right", // Domyślnie z prawej
  },
});

const emit = defineEmits(["update:modelValue", "save"]);

const isEditing = ref(false);
const isMenuOpen = ref(false); // <--- NOWE: Steruje otwarciem listy rozwijanej
const internalValue = ref(props.modelValue);
const inputRef = ref(null);

const inputType = computed(() => {
  if (["number", "date", "datetime-local"].includes(props.type)) return props.type;
  return "text";
});

const displayValue = computed(() => {
  if (
    props.modelValue === null ||
    props.modelValue === undefined ||
    props.modelValue === ""
  )
    return null;
  return props.suffix ? `${props.modelValue} ${props.suffix}` : props.modelValue;
});

watch(
  () => props.modelValue,
  (newVal) => {
    internalValue.value = newVal;
  }
);

// Obserwator zamykania menu selecta (np. kliknięcie obok)
watch(isMenuOpen, (isOpen) => {
  if (!isOpen && isEditing.value) {
    cancel();
  }
});

const startEditing = async () => {
  if (props.loading || isEditing.value) return;
  internalValue.value = props.modelValue;
  isEditing.value = true;

  await nextTick();

  if (props.type === "select") {
    // Od razu otwórz dropdown!
    isMenuOpen.value = true;
  } else {
    // Focus na zwykły input
    const el = inputRef.value;
    if (el && typeof (el as any).focus === "function") {
      (el as any).focus();
    }
  }
};

const save = () => {
  if (internalValue.value !== props.modelValue) {
    emit("save", internalValue.value);
  }
  isEditing.value = false;
  isMenuOpen.value = false;
};

const cancel = () => {
  setTimeout(() => {
    isEditing.value = false;
    isMenuOpen.value = false;
    internalValue.value = props.modelValue;
  }, 100);
};
</script>

<style scoped>
.inline-edit-container {
  border: 1px solid transparent;
  cursor: pointer;
  position: relative;
  min-height: 40px;
  display: flex;
  align-items: center;
}

.hoverable:hover {
  background-color: rgba(0, 0, 0, 0.04);
  border-radius: 4px;
}

.edit-icon {
  opacity: 0;
  transition: opacity 0.2s;
}

.hoverable:hover .edit-icon {
  opacity: 1;
}

.editing {
  cursor: default;
  padding: 0 !important;
  background-color: transparent !important;
}
</style>


=================================================================================
FILE: src/components/customers/CustomerFormDialog.vue
LOCATION: .//src/components/customers/CustomerFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="600"
    persistent
  >
    <v-card>
      <!-- Header -->
      <v-card-title class="d-flex align-center pa-4 bg-teal text-white">
        <v-icon class="mr-2">{{
          isEdit ? "mdi-account-edit" : "mdi-account-plus"
        }}</v-icon>
        {{ isEdit ? "Edytuj klienta" : "Nowy klient" }}
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" density="compact" @click="closeDialog" />
      </v-card-title>

      <v-form ref="formRef" v-model="formValid" @submit.prevent="submitForm">
        <v-card-text class="pa-6">
          <!-- Typ klienta -->
          <v-radio-group v-model="form.type" inline hide-details class="mb-4">
            <v-radio label="B2B (Firma)" value="B2B" color="blue" />
            <v-radio label="B2C (Osoba prywatna)" value="B2C" color="purple" />
          </v-radio-group>

          <v-row>
            <!-- NIP (tylko dla B2B) -->
            <v-col v-if="form.type === 'B2B'" cols="12">
              <v-text-field
                v-model="form.nip"
                label="NIP"
                placeholder="1234567890"
                variant="outlined"
                prepend-inner-icon="mdi-identifier"
                maxlength="13"
                :loading="nipLoading"
                :rules="[rules.nip]"
                :error-messages="nipError"
                hint="Wpisz NIP aby automatycznie pobrać dane firmy"
                persistent-hint
                @update:model-value="onNipInput"
                @blur="lookupNip"
              >
                <template v-slot:append-inner>
                  <v-icon v-if="nipSuccess" color="success">mdi-check-circle</v-icon>
                </template>
              </v-text-field>

              <!-- Komunikat o wyniku wyszukiwania NIP -->
              <v-alert
                v-if="nipMessage"
                :type="nipSuccess ? 'success' : 'warning'"
                variant="tonal"
                density="compact"
                class="mt-2"
              >
                {{ nipMessage }}
              </v-alert>
            </v-col>

            <!-- Nazwa -->
            <v-col cols="12">
              <v-text-field
                v-model="form.name"
                :label="form.type === 'B2B' ? 'Nazwa firmy *' : 'Imię i nazwisko *'"
                :placeholder="form.type === 'B2B' ? 'ACME Sp. z o.o.' : 'Jan Kowalski'"
                variant="outlined"
                prepend-inner-icon="mdi-domain"
                :rules="[rules.required]"
                :bg-color="nipAutoFilled.name ? 'green-lighten-5' : undefined"
              />
            </v-col>

            <!-- Email -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.email"
                label="Email"
                placeholder="kontakt@firma.pl"
                variant="outlined"
                prepend-inner-icon="mdi-email"
                :rules="[rules.email]"
              />
            </v-col>

            <!-- Telefon -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.phone"
                label="Telefon"
                placeholder="+48 123 456 789"
                variant="outlined"
                prepend-inner-icon="mdi-phone"
              />
            </v-col>

            <!-- Adres -->
            <v-col cols="12">
              <v-textarea
                v-model="form.address"
                label="Adres"
                placeholder="ul. Przykładowa 1, 00-001 Warszawa"
                variant="outlined"
                prepend-inner-icon="mdi-map-marker"
                rows="2"
                :bg-color="nipAutoFilled.address ? 'green-lighten-5' : undefined"
              />
            </v-col>

            <!-- Status aktywności -->
            <v-col cols="12">
              <v-switch
                v-model="form.is_active"
                label="Klient aktywny"
                color="success"
                hide-details
              />
            </v-col>
          </v-row>
        </v-card-text>

        <v-divider />

        <v-card-actions class="pa-4">
          <v-btn
            variant="text"
            color="grey"
            prepend-icon="mdi-close"
            @click="closeDialog"
            :disabled="saving"
          >
            Anuluj
          </v-btn>
          <v-spacer />
          <v-btn
            color="teal"
            variant="elevated"
            type="submit"
            :loading="saving"
            :disabled="!formValid"
            prepend-icon="mdi-content-save"
          >
            {{ isEdit ? "Zapisz zmiany" : "Dodaj klienta" }}
          </v-btn>
        </v-card-actions>
      </v-form>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, reactive, watch, computed } from "vue";
import api from "@/services/api";

// Props - kompatybilne z v-model
const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false,
  },
  customer: {
    type: Object,
    default: null,
  },
});

// Emits
const emit = defineEmits(["update:modelValue", "saved"]);

// Form state
const formRef = ref(null);
const formValid = ref(false);
const saving = ref(false);

// NIP lookup state
const nipLoading = ref(false);
const nipSuccess = ref(false);
const nipMessage = ref("");
const nipError = ref("");
let nipLookupTimeout = null;

// Form data
const defaultForm = {
  name: "",
  type: "B2B",
  nip: "",
  email: "",
  phone: "",
  address: "",
  is_active: true,
};

const form = reactive({ ...defaultForm });

// Śledzenie które pola zostały auto-uzupełnione
const nipAutoFilled = reactive({
  name: false,
  address: false,
});

// Computed
const isEdit = computed(() => props.customer !== null);

// Validation rules
const rules = {
  required: (v) => !!v || "Pole wymagane",
  email: (v) =>
    !v || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v) || "Nieprawidłowy format email",
  nip: (v) => {
    if (!v) return true;
    const nip = v.replace(/[^0-9]/g, "");
    return nip.length === 0 || nip.length === 10 || "NIP musi mieć 10 cyfr";
  },
};

// Watch for dialog open
watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen) {
      resetForm();
      if (props.customer) {
        // Edycja - wypełnij formularz
        Object.assign(form, {
          name: props.customer.name || "",
          type: props.customer.type || "B2B",
          nip: props.customer.nip || "",
          email: props.customer.email || "",
          phone: props.customer.phone || "",
          address: props.customer.address || "",
          is_active: props.customer.is_active ?? true,
        });
      }
    }
  }
);

// Watch for type change
watch(
  () => form.type,
  () => {
    if (form.type === "B2C") {
      form.nip = "";
      nipMessage.value = "";
      nipSuccess.value = false;
      nipError.value = "";
    }
  }
);

// Methods
function resetForm() {
  Object.assign(form, { ...defaultForm });
  Object.assign(nipAutoFilled, { name: false, address: false });
  nipMessage.value = "";
  nipSuccess.value = false;
  nipError.value = "";
  formRef.value?.reset();
}

function closeDialog() {
  emit("update:modelValue", false);
}

// Formatuj NIP podczas wpisywania
function onNipInput(value) {
  // Usuń nie-cyfry
  form.nip = (value || "").replace(/[^0-9]/g, "");

  // Reset stanów
  nipSuccess.value = false;
  nipMessage.value = "";
  nipError.value = "";

  // Auto-lookup po wpisaniu 10 cyfr (z debounce)
  if (form.nip.length === 10) {
    clearTimeout(nipLookupTimeout);
    nipLookupTimeout = setTimeout(() => {
      lookupNip();
    }, 500);
  }
}

// Pobierz dane firmy po NIP
async function lookupNip() {
  const nip = form.nip.replace(/[^0-9]/g, "");

  if (nip.length !== 10) {
    return;
  }

  nipLoading.value = true;
  nipMessage.value = "";
  nipSuccess.value = false;
  nipError.value = "";

  try {
    const response = await api.get(`/nip/${nip}`);

    if (response.data.success) {
      const data = response.data.data;

      // Auto-uzupełnij pola (tylko jeśli są puste lub user pozwoli nadpisać)
      const shouldOverwrite =
        !form.name || true || confirm("Znaleziono firmę. Czy nadpisać dane?");

      if (shouldOverwrite) {
        form.name = data.name || form.name;
        form.address = data.working_address || data.address || form.address;

        // Oznacz pola jako auto-uzupełnione
        nipAutoFilled.name = !!data.name;
        nipAutoFilled.address = !!(data.working_address || data.address);

        // Usunięcie podświetlenia po 3 sekundach
        setTimeout(() => {
          nipAutoFilled.name = false;
          nipAutoFilled.address = false;
        }, 3000);
      }

      nipSuccess.value = true;
      nipMessage.value = `✓ Znaleziono: ${data.name}`;

      // Status VAT
      if (data.status_vat) {
        nipMessage.value += ` (VAT: ${data.status_vat})`;
      }
    }
  } catch (error) {
    console.error("NIP lookup error:", error);

    if (error.response?.status === 404) {
      nipMessage.value = "Nie znaleziono firmy o podanym NIP";
    } else if (error.response?.status === 422) {
      nipError.value = error.response.data.message || "Nieprawidłowy NIP";
    } else {
      nipMessage.value = "Błąd podczas sprawdzania NIP. Spróbuj ponownie.";
    }
  } finally {
    nipLoading.value = false;
  }
}

// Zapisz formularz
async function submitForm() {
  const { valid } = await formRef.value.validate();
  if (!valid) return;

  saving.value = true;

  try {
    const payload = {
      name: form.name.trim(),
      type: form.type,
      nip: form.type === "B2B" ? form.nip || null : null,
      email: form.email || null,
      phone: form.phone || null,
      address: form.address || null,
      is_active: form.is_active,
    };

    let response;
    if (isEdit.value) {
      response = await api.put(`/customers/${props.customer.id}`, payload);
    } else {
      response = await api.post("/customers", payload);
    }

    emit("saved", response.data);
    closeDialog();
  } catch (error) {
    console.error("Save customer error:", error);

    if (error.response?.data?.errors) {
      const serverErrors = error.response.data.errors;
      const messages = Object.values(serverErrors).flat().join("\n");
      alert("Błąd walidacji:\n" + messages);
    } else {
      alert(error.response?.data?.message || "Błąd podczas zapisywania klienta");
    }
  } finally {
    saving.value = false;
  }
}
</script>

<style scoped>
/* Animacja dla podświetlenia auto-uzupełnionych pól jest obsługiwana przez Vuetify bg-color */
</style>


=================================================================================
FILE: src/components/layout/AppFooter.vue
LOCATION: .//src/components/layout/AppFooter.vue
=================================================================================

<template>
  <v-footer color="background" class="border-t" style="max-height:60px">
    <v-container fluid class="pa-0">
      <v-row no-gutters align="center">
        
        <v-col cols="12" sm="6" class="px-4 text-center text-sm-left">
          <span class="text-caption text-medium-emphasis font-weight-bold mr-2">
            CSERP
          </span>
          <span class="text-caption text-disabled">
            © {{ new Date().getFullYear() }} Wszelkie prawa zastrzeżone.
          </span>
        </v-col>

        <v-col cols="12" sm="6" class="px-4 text-center text-sm-right">
          <v-chip
            size="x-small"
            variant="flat"
            color="grey-lighten-4"
            class="text-caption text-medium-emphasis"
          >
            <v-icon start icon="mdi-server" size="x-small" color="primary"></v-icon>
            v1.0.0-beta
          </v-chip>
        </v-col>

      </v-row>
    </v-container>
  </v-footer>
</template>

<script setup lang="ts">
// Brak dodatkowej logiki
</script>

=================================================================================
FILE: src/components/layout/AppHeader.vue
LOCATION: .//src/components/layout/AppHeader.vue
=================================================================================

<template>
  <v-app-bar color="primary" elevation="2">
    <v-app-bar-nav-icon
      class="d-md-none"
      variant="text"
      @click.stop="$emit('toggle-drawer')"
    />

    <v-app-bar-title class="font-weight-bold d-flex align-center">
      <v-icon start class="mr-2">mdi-factory</v-icon>
      CSERP
    </v-app-bar-title>

    <!-- Desktop Navigation -->
    <template v-if="!isMobile">
      <v-btn
        v-for="item in menuItems"
        :key="item.to"
        :to="item.to"
        variant="text"
        class="ml-1"
      >
        <v-icon start>{{ item.icon }}</v-icon>
        {{ item.title }}
      </v-btn>
    </template>

    <v-spacer />

    <!-- User Menu -->
    <v-menu v-if="authStore.user">
      <template v-slot:activator="{ props }">
        <v-btn v-bind="props" variant="text" class="px-2">
          <v-avatar color="white" size="32" class="mr-2 text-primary">
            <span class="text-subtitle-2 font-weight-bold">
              {{ userInitials }}
            </span>
          </v-avatar>
          <v-icon end>mdi-chevron-down</v-icon>
        </v-btn>
      </template>
      <v-list width="200">
        <v-list-item>
          <template v-slot:prepend>
            <v-icon>mdi-account-circle</v-icon>
          </template>
          <v-list-item-title class="font-weight-bold">
            {{ userRoleLabel }}
          </v-list-item-title>
        </v-list-item>
        <v-divider class="my-1" />
        <v-list-item
          prepend-icon="mdi-logout"
          title="Wyloguj"
          value="logout"
          color="error"
          @click="handleLogout"
        />
      </v-list>
    </v-menu>
  </v-app-bar>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { useRouter } from "vue-router";
import { useAuthStore } from "@/stores/auth";
import { useMetadataStore } from "@/stores/metadata"; // Potrzebne do wyświetlenia ładnej nazwy roli
import { useDisplay } from "vuetify";

const emit = defineEmits<{
  (e: "toggle-drawer"): void;
}>();

const router = useRouter();
const authStore = useAuthStore();
const metadataStore = useMetadataStore();
const { mobile } = useDisplay();

const isMobile = computed(() => mobile.value);

// Obliczanie inicjałów
const userInitials = computed(() => {
  const name = authStore.user?.name || "";
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
});

const userRoleLabel = computed(() => {
  const role = authStore.user?.role;
  if (!role) return "";
  const roleObj = metadataStore.userRoles.find((r: any) => r.value === role);
  return roleObj ? roleObj.label : role;
});

// Dynamiczna lista menu na podstawie gettera ze store
const menuItems = computed(() => {
  const items = [{ title: "Dashboard", icon: "mdi-view-dashboard", to: "/dashboard" }];

  // Używamy gettera logiki biznesowej, a nie sprawdzania stringów
  if (authStore.canManageSystem) {
    items.push(
      { title: "Zamówienia", icon: "mdi-file-document-outline", to: "/orders" },
      { title: "Klienci", icon: "mdi-account-group", to: "/customers" },
      { title: "Asortyment", icon: "mdi-package-variant-closed", to: "/assortment" },
      { title: "Stanowiska", icon: "mdi-robot", to: "/workstations" },
      { title: "Panel RCP", icon: "mdi-factory", to: "/admin/rcp" }
    );
  }

  if (authStore.isAdmin) {
    items.push({ title: "Użytkownicy", icon: "mdi-account-cog", to: "/users" });
  }

  // Panel pracownika (dostępny dla wszystkich w tym demo, lub użyj authStore.isWorker)
  items.push({ title: "Panel Pracownika", icon: "mdi-timer", to: "/rcp/workstation" });

  return items;
});

const handleLogout = async () => {
  await authStore.logout();
  router.push("/login");
};
</script>


=================================================================================
FILE: src/components/layout/PageHeader.vue
LOCATION: .//src/components/layout/PageHeader.vue
=================================================================================

<template>
  <div class="page-header">
    <!-- Breadcrumbs -->
    <v-breadcrumbs
      v-if="breadcrumbs.length > 0"
      :items="breadcrumbItems"
      density="compact"
      class="pa-0 mb-2"
    >
      <template v-slot:divider>
        <v-icon size="small">mdi-chevron-right</v-icon>
      </template>

      <template v-slot:item="{ item }">
        <v-breadcrumbs-item :to="item.to" :disabled="item.disabled" class="text-caption">
          {{ item.title }}
        </v-breadcrumbs-item>
      </template>
    </v-breadcrumbs>

    <!-- Title Section -->
    <div class="d-flex align-center mb-2">
      <!-- Icon -->
      <v-avatar v-if="icon" size="56" class="mr-4" rounded>
        <v-icon :color="iconColor" size="32">{{ icon }}</v-icon>
      </v-avatar>

      <!-- Title & Subtitle -->
      <div class="flex-grow-1">
        <h1 class="text-h4 font-weight-bold title">
          <!-- ZMIANA: Dodano slot 'title' z fallbackiem do props.title -->
          <slot name="title">
            {{ title }}
          </slot>
        </h1>
        <div class="text-subtitle-1 text-medium-emphasis ma-0">
          <!-- ZMIANA: Dodano slot 'subtitle' z fallbackiem do props.subtitle -->
          <slot name="subtitle">
            {{ subtitle }}
          </slot>
        </div>
      </div>

      <!-- Actions Slot -->
      <div v-if="$slots.actions" class="ml-4">
        <slot name="actions" />
      </div>
    </div>

    <!-- Divider -->
    <v-divider class="mb-6" />
  </div>
</template>

<script setup lang="ts">
import { computed } from "vue";

const props = defineProps({
  title: {
    type: String,
    required: true,
  },
  subtitle: {
    type: String,
    default: "",
  },
  icon: {
    type: String,
    default: "",
  },
  iconColor: {
    type: String,
    default: "primary",
  },
  breadcrumbs: {
    type: Array,
    default: () => [],
  },
});

// Breadcrumb items with home
const breadcrumbItems = computed(() => {
  const items = [
    {
      title: "Dashboard",
      to: "/dashboard",
      disabled: false,
    },
  ];

  return [...items, ...props.breadcrumbs];
});
</script>

<style scoped>
.page-header {
  padding-top: 0px;
  padding-bottom: 0;
}
.title {
  border: 1px solid transparent;
}
</style>


=================================================================================
FILE: src/components/layout/RcpHeader.vue
LOCATION: .//src/components/layout/RcpHeader.vue
=================================================================================

<template>
  <v-app-bar color="primary" elevation="2">
    <v-app-bar-title class="text-h6 font-weight-bold"> Panel operatora </v-app-bar-title>

    <v-spacer />

    <!-- Sekcja Użytkownika i Wylogowania -->
    <div class="d-flex align-center mr-4">
      <div class="text-right mr-4 d-none d-sm-block">
        <div class="text-caption">Zalogowany jako:</div>
        <div class="text-h6 font-weight-bold text-white" style="line-height: 1.2">
          {{ authStore.user?.name }}
        </div>
      </div>

      <v-btn
        variant="tonal"
        size="large"
        prepend-icon="mdi-logout"
        @click="handleLogout"
        class="font-weight-bold px-6 text-none"
      >
        WYLOGUJ
      </v-btn>
    </div>
  </v-app-bar>
</template>
<script setup lang="ts">
import { useRouter } from "vue-router";
import { useAuthStore } from "@/stores/auth";

defineProps({
  showBack: {
    type: Boolean,
    default: false,
  },
});

defineEmits(["back"]);

const authStore = useAuthStore();

const handleLogout = async () => {
  // Bez potwierdzenia (instant logout)
  await authStore.logout();
};
</script>


=================================================================================
FILE: src/components/materials/BatchMaterialAddDialog.vue
LOCATION: .//src/components/materials/BatchMaterialAddDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="1000"
    persistent
  >
    <v-card>
      <v-card-title class="bg-teal-darken-1 text-white d-flex align-center">
        <v-icon start color="white">mdi-table-arrow-down</v-icon>
        Import materiałów
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" @click="close" />
      </v-card-title>

      <v-card-text class="pt-6">
        <v-row>
          <!-- LEWA STRONA: Wklejanie -->
          <v-col cols="12" md="5">
            <div class="text-subtitle-2 mb-2">1. Skopiuj kolumny (bez nagłówków):</div>
            <div class="text-caption text-medium-emphasis mb-2 font-italic">
              Kolejność: <strong>[Nazwa]</strong> [TAB] <strong>[Ilość]</strong> [TAB]
              <strong>[J.m.]</strong> [TAB] <strong>[Cena (opcjonalnie)]</strong>
            </div>

            <v-textarea
              v-model="rawInput"
              placeholder="Kliknij tutaj i wciśnij Ctrl+V...

Przykładowe dane:
Śruby M12   20   szt   0,50
Profil 40x40   5,5   mb   12.99
Mydło   2   opk"
              variant="outlined"
              rows="14"
              no-resize
              class="font-monospace"
              @update:model-value="parseInput"
            ></v-textarea>
          </v-col>

          <!-- ŚRODEK: Strzałka -->
          <v-col cols="12" md="1" class="d-flex align-center justify-center">
            <v-icon size="32" color="grey-lighten-1" class="d-none d-md-flex"
              >mdi-arrow-right-bold</v-icon
            >
            <v-icon size="32" color="grey-lighten-1" class="d-flex d-md-none my-2"
              >mdi-arrow-down-bold</v-icon
            >
          </v-col>

          <!-- PRAWA STRONA: Podgląd -->
          <v-col cols="12" md="6">
            <div class="text-subtitle-2 mb-2 d-flex justify-space-between">
              <span>2. Sprawdź poprawność:</span>
              <span v-if="parsedItems.length > 0" class="text-teal font-weight-bold">
                {{ parsedItems.length }} pozycji
              </span>
            </div>

            <v-table density="compact" class="border rounded" fixed-header height="414px">
              <thead>
                <tr class="bg-grey-lighten-4">
                  <th>Nazwa</th>
                  <th class="text-right">Ilość</th>
                  <th class="text-center">J.m.</th>
                  <th class="text-right">Cena jedn.</th>
                  <th class="text-center" style="width: 50px"></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in parsedItems" :key="index">
                  <td class="text-truncate" style="max-width: 150px" :title="item.name">
                    {{ item.name }}
                  </td>
                  <td class="text-right font-weight-bold">{{ item.quantity }}</td>
                  <td class="text-center">
                    <v-chip
                      size="x-small"
                      :color="item.isUnitRecognized ? 'teal' : 'grey'"
                      label
                    >
                      {{ item.unit }}
                    </v-chip>
                  </td>
                  <td class="text-right">
                    {{ item.unit_price ? formatCurrency(item.unit_price) : "-" }}
                  </td>
                  <td class="text-center">
                    <v-btn
                      icon="mdi-close"
                      size="x-small"
                      variant="text"
                      color="error"
                      @click="removeItem(index)"
                      title="Usuń ten wiersz"
                    />
                  </td>
                </tr>
                <tr v-if="parsedItems.length === 0">
                  <td colspan="5" class="text-center text-medium-emphasis py-12">
                    <v-icon class="mb-2">mdi-clipboard-text-off-outline</v-icon><br />
                    Brak danych.<br />Wklej tekst po lewej stronie.
                  </td>
                </tr>
              </tbody>
            </v-table>

            <v-alert
              v-if="validationError"
              type="warning"
              variant="tonal"
              density="compact"
              class="mt-2"
              icon="mdi-alert"
            >
              {{ validationError }}
            </v-alert>
          </v-col>
        </v-row>
      </v-card-text>

      <v-divider />

      <v-card-actions class="pa-4 bg-grey-lighten-5">
        <v-btn variant="text" color="grey-darken-1" @click="clear">Wyczyść</v-btn>
        <v-spacer />
        <v-btn variant="text" @click="close">Anuluj</v-btn>
        <v-btn
          color="teal"
          variant="elevated"
          :disabled="parsedItems.length === 0 || !!validationError"
          :loading="loading"
          @click="save"
          prepend-icon="mdi-check"
        >
          Importuj ({{ parsedItems.length }})
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";

const props = defineProps({
  modelValue: Boolean,
  loading: Boolean,
});

const emit = defineEmits(["update:modelValue", "save"]);

const rawInput = ref("");
const parsedItems = ref<any[]>([]);
const validationError = ref<string | null>(null);

// Reset po otwarciu
watch(
  () => props.modelValue,
  (val) => {
    if (val) {
      clear();
    }
  }
);

const clear = () => {
  rawInput.value = "";
  parsedItems.value = [];
  validationError.value = null;
};

// --- LOGIKA NORMALIZACJI JEDNOSTEK (Bez zmian) ---
const normalizeUnit = (inputUnit: string): { unit: string; recognized: boolean } => {
  if (!inputUnit) return { unit: "SZT", recognized: false };

  const u = inputUnit.toLowerCase().trim().replace(".", "");

  const map: Record<string, string> = {
    szt: "SZT",
    sztuka: "SZT",
    sztuki: "SZT",
    pcs: "SZT",
    stk: "SZT",
    mb: "MB",
    m: "MB",
    metr: "MB",
    metry: "MB",
    biezacy: "MB",
    m2: "M2",
    mkw: "M2",
    sqm: "M2",
    kg: "KG",
    kilogram: "KG",
    op: "OP",
    opk: "OP",
    opak: "OP",
    opakowanie: "OP",
    paczka: "OP",
    karton: "OP",
    kpl: "KPL",
    komplet: "KPL",
    set: "KPL",
    l: "L",
    litr: "L",
    h: "H",
    godz: "H",
    rbh: "H",
  };

  if (map[u]) {
    return { unit: map[u], recognized: true };
  }
  return { unit: "SZT", recognized: false };
};

const parseInput = () => {
  if (!rawInput.value) {
    parsedItems.value = [];
    validationError.value = null;
    return;
  }

  const rows = rawInput.value.trim().split(/\r?\n/);
  const items: any[] = [];
  let error: string | null = null;

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i].trim();
    if (!row) continue;

    // Dzielimy po tabulatorze LUB sekwencji min. 2 spacji.
    const parts = row.split(/\t|\s{2,}/);

    // Oczekujemy: [0] Nazwa, [1] Ilość, [2] Jednostka, [3] Cena (opcjonalna)
    const name = parts[0]?.trim();

    if (!name) continue;

    // Parsowanie ilości
    let quantityStr = parts[1]?.trim();
    if (quantityStr) {
      quantityStr = quantityStr.replace(/\s/g, "").replace(",", ".");
    } else {
      quantityStr = "0";
    }
    const quantity = parseFloat(quantityStr);

    if (isNaN(quantity)) {
      error = `Wiersz ${i + 1}: "${name}" - nieprawidłowa ilość.`;
      break;
    }

    // Parsowanie jednostki
    const rawUnit = parts[2]?.trim() || "";
    const { unit, recognized } = normalizeUnit(rawUnit);

    // Parsowanie ceny (NOWE)
    let unitPrice = null;
    let priceStr = parts[3]?.trim();
    if (priceStr) {
      // Usuwamy "zł", spacje, zamieniamy przecinek na kropkę
      priceStr = priceStr.replace(/[^\d.,]/g, "").replace(",", ".");
      const parsedPrice = parseFloat(priceStr);
      if (!isNaN(parsedPrice)) {
        unitPrice = parsedPrice;
      }
    }

    items.push({
      name,
      quantity,
      unit,
      unit_price: unitPrice, // Może być null
      isUnitRecognized: recognized,
    });
  }

  parsedItems.value = items;
  validationError.value = error;
};

const removeItem = (index: number) => {
  parsedItems.value.splice(index, 1);
};

const save = () => {
  const payload = parsedItems.value.map((item) => ({
    name: item.name,
    quantity: item.quantity,
    unit: item.unit,
    unit_price: item.unit_price, // Przekazujemy cenę
  }));
  emit("save", payload);
};

const close = () => {
  emit("update:modelValue", false);
};

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);
</script>

<style scoped>
.font-monospace {
  font-family: "Roboto Mono", monospace !important;
  font-size: 0.85rem;
}
</style>


=================================================================================
FILE: src/components/materials/MaterialFormDialog.vue
LOCATION: .//src/components/materials/MaterialFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="700"
    persistent
  >
    <v-card>
      <v-card-title class="bg-teal text-white d-flex align-center">
        <v-icon start color="white">{{ isEdit ? "mdi-pencil" : "mdi-plus" }}</v-icon>
        {{ isEdit ? "Edytuj materiał" : "Dodaj materiał" }}
      </v-card-title>

      <v-card-text class="pt-6">
        <v-form ref="formRef" v-model="formValid" @submit.prevent="save">
          <v-row>
            <!-- Assortment select -->
            <v-col cols="12">
              <v-autocomplete
                v-model="form.assortment_id"
                :items="assortmentItems"
                item-title="name"
                item-value="id"
                label="Materiał z asortymentu *"
                :rules="[(v) => !!v || 'Wybierz materiał']"
                variant="outlined"
                density="compact"
                :disabled="isEdit"
                :loading="loadingAssortment"
                placeholder="Wpisz aby wyszukać..."
                @update:model-value="onAssortmentChange"
                auto-select-first
              >
                <template v-slot:item="{ item, props: itemProps }">
                  <v-list-item v-bind="itemProps">
                    <template v-slot:prepend>
                      <v-icon color="blue" size="small">mdi-package-variant</v-icon>
                    </template>
                    <v-list-item-subtitle>
                      {{
                        item.raw.default_price
                          ? formatCurrency(item.raw.default_price)
                          : ""
                      }}
                      {{ item.raw.unit ? "/ " + item.raw.unit : "" }}
                    </v-list-item-subtitle>
                  </v-list-item>
                </template>
              </v-autocomplete>
            </v-col>

            <!-- Quantity -->
            <v-col cols="6">
              <v-text-field
                v-model.number="form.quantity"
                label="Ilość *"
                type="number"
                min="0.01"
                step="0.01"
                :rules="[(v) => v > 0 || 'Podaj ilość']"
                variant="outlined"
                density="compact"
              />
            </v-col>

            <!-- Unit (ZMIANA NA SELECT) -->
            <v-col cols="6">
              <v-select
                v-model="form.unit"
                :items="metadataStore.units"
                item-title="label"
                item-value="value"
                label="Jednostka *"
                :rules="[(v) => !!v || 'Podaj jednostkę']"
                variant="outlined"
                density="compact"
              />
            </v-col>

            <!-- Unit Price -->
            <v-col cols="6">
              <v-text-field
                v-model.number="form.unit_price"
                label="Cena jednostkowa (PLN) *"
                type="number"
                min="0"
                step="0.01"
                :rules="[(v) => v >= 0 || 'Podaj cenę']"
                variant="outlined"
                density="compact"
              />
            </v-col>

            <!-- Total (Readonly) -->
            <v-col cols="6">
              <v-text-field
                :model-value="calculatedTotal"
                label="Koszt całkowity (PLN)"
                variant="outlined"
                density="compact"
                readonly
                bg-color="grey-lighten-4"
              />
            </v-col>

            <v-col cols="12">
              <v-divider class="mb-2" />
              <div class="text-subtitle-2 text-medium-emphasis mb-2">
                <v-icon size="small" class="mr-1">mdi-truck-delivery</v-icon>
                Logistyka
              </div>
            </v-col>

            <!-- Status -->
            <v-col cols="6">
              <v-select
                v-model="form.status"
                :items="statusOptions"
                item-title="label"
                item-value="value"
                label="Status"
                variant="outlined"
                density="compact"
              >
                <template v-slot:item="{ item, props: itemProps }">
                  <v-list-item v-bind="itemProps">
                    <template v-slot:prepend>
                      <v-icon :color="item.raw.color" size="small">{{
                        item.raw.icon
                      }}</v-icon>
                    </template>
                  </v-list-item>
                </template>
                <template v-slot:selection="{ item }">
                  <v-chip
                    :color="item.raw.color"
                    :prepend-icon="item.raw.icon"
                    size="small"
                  >
                    {{ item.raw.label }}
                  </v-chip>
                </template>
              </v-select>
            </v-col>

            <!-- Supplier -->
            <v-col cols="6">
              <v-text-field
                v-model="form.supplier"
                label="Dostawca"
                variant="outlined"
                density="compact"
                clearable
              />
            </v-col>

            <!-- Expected delivery date -->
            <v-col cols="6">
              <v-text-field
                v-model="form.expected_delivery_date"
                label="Oczekiwana data dostawy"
                type="date"
                variant="outlined"
                density="compact"
                clearable
              />
            </v-col>

            <!-- Ordered at -->
            <v-col cols="6">
              <v-text-field
                v-model="form.ordered_at"
                label="Data zamówienia"
                type="date"
                variant="outlined"
                density="compact"
                clearable
              />
            </v-col>

            <!-- Quantity in stock / ordered (for partial) -->
            <template v-if="form.status === 'PARTIALLY_IN_STOCK'">
              <v-col cols="6">
                <v-text-field
                  v-model.number="form.quantity_in_stock"
                  label="Ilość na stanie"
                  type="number"
                  min="0"
                  step="0.01"
                  variant="outlined"
                  density="compact"
                />
              </v-col>
              <v-col cols="6">
                <v-text-field
                  v-model.number="form.quantity_ordered"
                  label="Ilość zamówiona"
                  type="number"
                  min="0"
                  step="0.01"
                  variant="outlined"
                  density="compact"
                />
              </v-col>
            </template>

            <!-- Notes -->
            <v-col cols="12">
              <v-textarea
                v-model="form.notes"
                label="Notatki"
                variant="outlined"
                density="compact"
                rows="2"
                auto-grow
              />
            </v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn @click="close">Anuluj</v-btn>
        <v-btn
          color="teal"
          variant="elevated"
          :loading="saving"
          :disabled="!formValid"
          @click="save"
        >
          {{ isEdit ? "Zapisz" : "Dodaj" }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted } from "vue";
import { assortmentService } from "@/services/assortmentService";
import { useMetadataStore } from "@/stores/metadata"; // IMPORT STORE

const props = defineProps({
  modelValue: Boolean,
  material: {
    type: Object as () => any,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

// STORES
const metadataStore = useMetadataStore();

const formRef = ref();
const formValid = ref(false);
const saving = ref(false);
const assortmentItems = ref<any[]>([]);
const loadingAssortment = ref(false);

const isEdit = computed(() => !!props.material?.id);

const statusOptions = [
  { value: "NOT_ORDERED", label: "Niezamówiony", color: "red", icon: "mdi-cart-outline" },
  {
    value: "ORDERED",
    label: "Zamówiony",
    color: "orange",
    icon: "mdi-truck-fast-outline",
  },
  {
    value: "PARTIALLY_IN_STOCK",
    label: "Częściowo na stanie",
    color: "blue",
    icon: "mdi-package-variant",
  },
  {
    value: "IN_STOCK",
    label: "Na stanie",
    color: "green",
    icon: "mdi-package-variant-closed-check",
  },
];

const defaultForm = () => ({
  assortment_id: null as number | null,
  quantity: 1,
  unit: "SZT", // Domyślnie z dużej litery, zgodnie z Enum
  unit_price: 0,
  status: "NOT_ORDERED",
  supplier: "",
  expected_delivery_date: null as string | null,
  ordered_at: null as string | null,
  quantity_in_stock: 0,
  quantity_ordered: 0,
  notes: "",
});

const form = ref(defaultForm());

const calculatedTotal = computed(() => {
  const total = (form.value.quantity || 0) * (form.value.unit_price || 0);
  return new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(
    total
  );
});

watch(
  () => props.modelValue,
  async (open) => {
    if (open) {
      // Upewnij się, że metadata są załadowane dla selecta jednostek
      if (!metadataStore.loaded) {
        await metadataStore.fetchMetadata();
      }

      await loadAssortment();

      if (props.material) {
        form.value = {
          assortment_id: props.material.assortment_id,
          quantity: Number(props.material.quantity),
          unit: props.material.unit,
          unit_price: Number(props.material.unit_price),
          status: props.material.status,
          supplier: props.material.supplier || "",
          expected_delivery_date: props.material.expected_delivery_date
            ? props.material.expected_delivery_date.substring(0, 10)
            : null,
          ordered_at: props.material.ordered_at
            ? props.material.ordered_at.substring(0, 10)
            : null,
          quantity_in_stock: Number(props.material.quantity_in_stock || 0),
          quantity_ordered: Number(props.material.quantity_ordered || 0),
          notes: props.material.notes || "",
        };
      } else {
        form.value = defaultForm();
      }
    }
  }
);

// Ładowanie asortymentu z parametrami paginacji
const loadAssortment = async () => {
  loadingAssortment.value = true;
  try {
    const items = await assortmentService.getAll({
      type: "material",
      per_page: 500,
      sort_by: "created_at",
      sort_dir: "desc",
    });
    assortmentItems.value = items;
  } catch (err) {
    console.error("Błąd ładowania asortymentu:", err);
  } finally {
    loadingAssortment.value = false;
  }
};

const onAssortmentChange = (id: number) => {
  const item = assortmentItems.value.find((a: any) => a.id === id);
  if (item) {
    form.value.unit = item.unit || "SZT";
    // POPRAWKA: Używamy default_price, ponieważ w asortymencie nie ma pola unit_price
    form.value.unit_price = Number(item.default_price) || 0;
  }
};

const save = () => {
  const payload = {
    ...form.value,
    total_cost: (form.value.quantity || 0) * (form.value.unit_price || 0),
  };
  saving.value = true;
  emit("saved", payload);
};

// Reset saving when dialog closes
watch(
  () => props.modelValue,
  (open) => {
    if (!open) {
      saving.value = false;
    }
  }
);

const close = () => {
  emit("update:modelValue", false);
};

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);
</script>


=================================================================================
FILE: src/components/materials/MaterialsPanel.vue
LOCATION: .//src/components/materials/MaterialsPanel.vue
=================================================================================

<template>
  <v-card
    elevation="2"
    class="mb-4 transition-swing"
    :class="{ 'fullscreen-card': isFullscreen }"
  >
    <!-- NAGŁÓWEK (Bez zmian) -->
    <v-card-title
      class="bg-teal text-white d-flex align-center py-3"
      style="height: 48px"
    >
      <!-- STAN 1: ZAZNACZONO ELEMENTY -->
      <template v-if="selected.length > 0">
        <v-btn icon variant="text" color="white" @click="selected = []">
          <v-icon>mdi-close</v-icon>
        </v-btn>
        <span class="text-subtitle-1 font-weight-bold ml-2">
          Wybrano: {{ selected.length }}
        </span>
        <v-spacer />

        <v-menu location="bottom end">
          <template v-slot:activator="{ props }">
            <v-btn
              color="white"
              variant="text"
              class="mr-2"
              v-bind="props"
              prepend-icon="mdi-list-status"
            >
              Zmień status
            </v-btn>
          </template>
          <v-list density="compact">
            <v-list-item
              v-for="status in materialStatuses"
              :key="status.value"
              :value="status.value"
              @click="bulkUpdateStatus(status.value)"
            >
              <template v-slot:prepend>
                <v-icon :color="status.color" size="small">{{ status.icon }}</v-icon>
              </template>
              <v-list-item-title>{{ status.label }}</v-list-item-title>
            </v-list-item>
          </v-list>
        </v-menu>

        <v-btn color="white" variant="text" prepend-icon="mdi-delete" @click="bulkDelete">
          Usuń
        </v-btn>

        <v-divider vertical color="white" class="mx-2 opacity-50"></v-divider>
        <v-btn icon size="small" variant="text" color="white" @click="toggleFullscreen">
          <v-icon>{{ isFullscreen ? "mdi-fullscreen-exit" : "mdi-fullscreen" }}</v-icon>
        </v-btn>
      </template>

      <!-- STAN 2: STANDARDOWY -->
      <template v-else>
        <v-icon start color="white">mdi-cube-outline</v-icon>
        Materiały ({{ materials.length }})

        <template v-if="summary && summary.total > 0 && !isFullscreen">
          <v-chip
            v-if="summary.all_ready"
            size="x-small"
            color="white"
            variant="flat"
            class="ml-3 font-weight-bold text-teal"
          >
            <v-icon start size="x-small">mdi-check-all</v-icon> Gotowe
          </v-chip>
          <template v-else>
            <v-chip
              v-if="summary.not_ordered > 0"
              size="x-small"
              color="red-lighten-4"
              class="ml-2 text-red-darken-4 font-weight-bold"
            >
              {{ summary.not_ordered }} niezam.
            </v-chip>
          </template>
        </template>

        <v-spacer />

        <template v-if="!readonly">
          <v-btn
            color="white"
            variant="text"
            size="small"
            class="mr-1"
            @click="$emit('importBatch')"
          >
            <v-icon start>mdi-table-arrow-down</v-icon>
            <span class="d-none d-sm-inline">Importuj</span>
          </v-btn>
          <v-btn color="white" variant="text" size="small" @click="$emit('add')">
            <v-icon start>mdi-plus</v-icon>
            <span class="d-none d-sm-inline">Dodaj</span>
          </v-btn>
        </template>

        <v-divider vertical color="white" class="mx-2 opacity-50"></v-divider>

        <v-btn icon size="small" variant="text" color="white" @click="toggleFullscreen">
          <v-icon>{{ isFullscreen ? "mdi-fullscreen-exit" : "mdi-fullscreen" }}</v-icon>
        </v-btn>
      </template>
    </v-card-title>

    <v-card-text class="pa-0 flex-grow-1 overflow-auto">
      <div v-if="loading" class="text-center py-6">
        <v-progress-circular indeterminate color="teal" />
      </div>

      <div v-else-if="materials.length === 0" class="text-center py-8">
        <v-icon size="64" color="grey-lighten-2">mdi-cube-outline</v-icon>
        <p class="text-body-2 text-medium-emphasis mt-2">Brak materiałów</p>
        <div v-if="!readonly" class="mt-4">
          <v-btn
            variant="outlined"
            color="teal"
            class="mr-2"
            @click="$emit('importBatch')"
            >Importuj</v-btn
          >
          <v-btn variant="elevated" color="teal" @click="$emit('add')"
            >Dodaj ręcznie</v-btn
          >
        </div>
      </div>

      <!-- TABELA Z SORTOWANIEM -->
      <v-table
        v-else
        density="compact"
        hover
        fixed-header
        :height="isFullscreen ? 'calc(100vh - 120px)' : undefined"
      >
        <thead>
          <tr class="bg-grey-lighten-4">
            <!-- Checkbox All -->
            <th style="width: 50px" class="text-center">
              <v-checkbox-btn
                :model-value="areAllSelected"
                :indeterminate="isIndeterminate"
                @update:model-value="toggleSelectAll"
                color="teal"
                density="compact"
                hide-details
              ></v-checkbox-btn>
            </th>
            <!-- Lp -->
            <th style="width: 50px" class="text-center text-medium-emphasis">Lp</th>

            <!-- KOLUMNY SORTOWALNE -->
            <th style="width: 25%" class="sortable-header" @click="handleSort('name')">
              Nazwa materiału
              <v-icon v-if="sortBy === 'name'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th
              class="text-right sortable-header"
              style="width: 10%"
              @click="handleSort('quantity')"
            >
              Ilość
              <v-icon v-if="sortBy === 'quantity'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th
              class="text-right sortable-header"
              style="width: 10%"
              @click="handleSort('unit_price')"
            >
              Cena jedn.
              <v-icon v-if="sortBy === 'unit_price'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th
              class="text-right sortable-header"
              style="width: 10%"
              @click="handleSort('total_cost')"
            >
              Koszt
              <v-icon v-if="sortBy === 'total_cost'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th
              style="width: 15%"
              class="sortable-header"
              @click="handleSort('supplier')"
            >
              Dostawca
              <v-icon v-if="sortBy === 'supplier'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th style="width: 15%">Notatki</th>

            <th
              style="width: 10%; text-align: center"
              class="sortable-header"
              @click="handleSort('expected_delivery_date')"
            >
              Data dostawy
              <v-icon
                v-if="sortBy === 'expected_delivery_date'"
                size="x-small"
                class="ml-1"
              >
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>

            <th
              class="text-center sortable-header"
              style="width: 140px"
              @click="handleSort('status')"
            >
              Status
              <v-icon v-if="sortBy === 'status'" size="x-small" class="ml-1">
                {{ sortDesc ? "mdi-arrow-down" : "mdi-arrow-up" }}
              </v-icon>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Iterujemy po sortedMaterials zamiast materials -->
          <tr
            v-for="(material, index) in sortedMaterials"
            :key="material.id"
            :class="{ 'bg-blue-lighten-5': selected.includes(material.id) }"
          >
            <!-- Checkbox -->
            <td class="text-center">
              <v-checkbox-btn
                v-model="selected"
                :value="material.id"
                color="teal"
                density="compact"
                hide-details
              ></v-checkbox-btn>
            </td>

            <!-- LP -->
            <td class="text-center text-caption text-medium-emphasis">
              {{ index + 1 }}
            </td>

            <!-- 1. Nazwa -->
            <td class="py-2 align-middle">
              <div class="font-weight-medium text-body-2">
                {{ material.assortment?.name || "Materiał #" + material.assortment_id }}
              </div>
            </td>

            <!-- 2. Ilość -->
            <td class="text-right align-middle">
              <div class="d-flex align-center justify-end">
                <inline-edit-field
                  v-if="!readonly"
                  :model-value="material.quantity"
                  type="number"
                  text-class="font-weight-bold"
                  :show-edit-icon="false"
                  @save="(val) => emitUpdate(material, 'quantity', val)"
                />
                <span v-else class="font-weight-bold">{{ material.quantity }}</span>
                <span class="text-caption text-medium-emphasis ml-1">{{
                  material.unit
                }}</span>
              </div>
              <div
                v-if="material.status === 'PARTIALLY_IN_STOCK'"
                class="text-caption mt-n1 text-right"
              >
                <span class="text-success">{{ material.quantity_in_stock }}</span> /
                <span class="text-orange">{{ material.quantity_ordered }}</span>
              </div>
            </td>

            <!-- 3. Cena Jednostkowa -->
            <td class="text-right align-middle">
              <inline-edit-field
                v-if="!readonly"
                :model-value="material.unit_price"
                textClass="text-right"
                type="number"
                :show-edit-icon="false"
                @save="(val) => emitUpdate(material, 'unit_price', val)"
              >
                <template #display="{ value }">
                  <span class="text-medium-emphasis">{{ formatCurrency(value) }}</span>
                </template>
              </inline-edit-field>
              <span v-else>{{ formatCurrency(material.unit_price) }}</span>
            </td>

            <!-- 4. Koszt -->
            <td class="text-right align-middle font-weight-bold">
              {{ formatCurrency(material.quantity * material.unit_price) }}
            </td>

            <!-- 5. Dostawca -->
            <td class="align-middle">
              <inline-edit-field
                v-if="!readonly"
                :model-value="material.supplier"
                placeholder="—"
                :show-edit-icon="false"
                @save="(val) => emitUpdate(material, 'supplier', val)"
              />
              <span v-else>{{ material.supplier || "—" }}</span>
            </td>

            <!-- 6. Notatki -->
            <td class="align-middle">
              <inline-edit-field
                v-if="!readonly"
                :model-value="material.notes"
                placeholder="+ Dodaj"
                type="textarea"
                text-class="text-caption text-medium-emphasis font-italic"
                :show-edit-icon="false"
                @save="(val) => emitUpdate(material, 'notes', val)"
              />
              <div v-else class="text-caption text-medium-emphasis">
                {{ material.notes }}
              </div>
            </td>

            <!-- 7. Data Dostawy -->
            <td class="align-middle text-center">
              <v-menu
                v-if="!readonly"
                :close-on-content-click="false"
                location="bottom center"
              >
                <template v-slot:activator="{ props }">
                  <div
                    v-bind="props"
                    class="cursor-pointer py-1 px-2 rounded hover-bg"
                    :class="
                      !material.expected_delivery_date ? 'text-disabled text-caption' : ''
                    "
                  >
                    <v-icon
                      v-if="!material.expected_delivery_date"
                      size="x-small"
                      class="mr-1"
                      >mdi-calendar-blank</v-icon
                    >
                    <span
                      :class="isOverdue(material) ? 'text-error font-weight-bold' : ''"
                    >
                      {{
                        material.expected_delivery_date
                          ? formatDate(material.expected_delivery_date)
                          : "Ustaw datę"
                      }}
                    </span>
                  </div>
                </template>

                <v-date-picker
                  color="teal"
                  hide-header
                  @update:model-value="
                    (date) => {
                      updateDate(material, date);
                    }
                  "
                ></v-date-picker>
              </v-menu>

              <div v-else>
                {{ formatDate(material.expected_delivery_date) }}
              </div>
            </td>

            <!-- 8. Status -->
            <td class="text-center align-middle">
              <v-menu v-if="!readonly" location="bottom end">
                <template v-slot:activator="{ props }">
                  <v-chip
                    v-bind="props"
                    :color="getStatusConfig(material.status).color"
                    size="small"
                    variant="flat"
                    class="cursor-pointer font-weight-bold px-2"
                    label
                    style="min-width: 110px; justify-content: center"
                  >
                    <v-icon start size="small">{{
                      getStatusConfig(material.status).icon
                    }}</v-icon>
                    {{ getStatusConfig(material.status).label }}
                  </v-chip>
                </template>
                <v-list density="compact">
                  <v-list-item
                    v-for="status in materialStatuses"
                    :key="status.value"
                    :value="status.value"
                    @click="$emit('statusChange', material, status.value)"
                  >
                    <template v-slot:prepend>
                      <v-icon :color="status.color" size="small">{{
                        status.icon
                      }}</v-icon>
                    </template>
                    <v-list-item-title>{{ status.label }}</v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
              <v-chip
                v-else
                :color="getStatusConfig(material.status).color"
                size="small"
                variant="flat"
                label
              >
                {{ getStatusConfig(material.status).label }}
              </v-chip>
            </td>
          </tr>
        </tbody>

        <!-- FOOTER -->
        <tfoot v-if="materials.length > 0">
          <tr class="bg-grey-lighten-4 font-weight-bold">
            <td colspan="5" class="text-right text-uppercase text-caption">
              Suma kosztów:
            </td>
            <td class="text-right text-teal text-body-2">
              {{ formatCurrency(calculatedTotalCost) }}
            </td>
            <td :colspan="4"></td>
          </tr>
        </tfoot>
      </v-table>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, computed } from "vue";
import InlineEditField from "@/components/common/InlineEditField.vue";

const props = defineProps({
  materials: { type: Array as () => any[], default: () => [] },
  summary: { type: Object as () => any, default: null },
  totalCost: { type: Number, default: 0 },
  loading: { type: Boolean, default: false },
  readonly: { type: Boolean, default: false },
});

const emit = defineEmits([
  "add",
  "edit",
  "delete",
  "statusChange",
  "markAllOrdered",
  "importBatch",
  "updateItem",
  "bulkDelete",
  "bulkStatusChange",
]);

const isFullscreen = ref(false);
const selected = ref<number[]>([]);

// Stan sortowania
const sortBy = ref<string | null>(null);
const sortDesc = ref(false);

// --- LOGIKA SORTOWANIA (COMPUTED) ---
const sortedMaterials = computed(() => {
  if (!sortBy.value) {
    return props.materials;
  }

  const items = [...props.materials];

  return items.sort((a, b) => {
    let valA = a[sortBy.value!];
    let valB = b[sortBy.value!];

    // Specjalna obsługa dla nazw (zagnieżdżony obiekt assortment)
    if (sortBy.value === "name") {
      valA = a.assortment?.name || "";
      valB = b.assortment?.name || "";
    }
    // Specjalna obsługa dla kosztu całkowitego (wyliczanego)
    else if (sortBy.value === "total_cost") {
      valA = a.quantity * a.unit_price;
      valB = b.quantity * b.unit_price;
    }

    // Sortowanie numeryczne
    if (typeof valA === "number" && typeof valB === "number") {
      return sortDesc.value ? valB - valA : valA - valB;
    }

    // Sortowanie stringów
    valA = String(valA || "").toLowerCase();
    valB = String(valB || "").toLowerCase();

    if (valA < valB) return sortDesc.value ? 1 : -1;
    if (valA > valB) return sortDesc.value ? -1 : 1;
    return 0;
  });
});

const handleSort = (key: string) => {
  if (sortBy.value === key) {
    sortDesc.value = !sortDesc.value; // Odwróć kolejność
  } else {
    sortBy.value = key;
    sortDesc.value = false; // Domyślnie rosnąco
  }
};

// --- LOGIKA CHECKBOXÓW ---
const areAllSelected = computed(() => {
  return props.materials.length > 0 && selected.value.length === props.materials.length;
});

const isIndeterminate = computed(() => {
  return selected.value.length > 0 && selected.value.length < props.materials.length;
});

const toggleSelectAll = () => {
  if (areAllSelected.value) {
    selected.value = [];
  } else {
    selected.value = props.materials.map((m) => m.id);
  }
};

const bulkDelete = () => {
  if (confirm(`Czy na pewno chcesz usunąć ${selected.value.length} elementów?`)) {
    emit("bulkDelete", [...selected.value]);
    selected.value = [];
  }
};

const bulkUpdateStatus = (status: string) => {
  emit("bulkStatusChange", [...selected.value], status);
  selected.value = [];
};

const calculatedTotalCost = computed(() => {
  return props.materials.reduce((sum, material) => {
    return sum + Number(material.quantity || 0) * Number(material.unit_price || 0);
  }, 0);
});

const toggleFullscreen = () => {
  isFullscreen.value = !isFullscreen.value;
};

const emitUpdate = (material: any, field: string, value: any) => {
  emit("updateItem", material, { [field]: value });
};

const updateDate = (material: any, dateVal: any) => {
  if (!dateVal) return;
  const d = new Date(dateVal);
  const offset = d.getTimezoneOffset();
  const adjustedDate = new Date(d.getTime() - offset * 60 * 1000);
  const dateString = adjustedDate.toISOString().split("T")[0];
  emitUpdate(material, "expected_delivery_date", dateString);
};

const materialStatuses = [
  { value: "NOT_ORDERED", label: "Niezamówiony", color: "red", icon: "mdi-cart-off" },
  { value: "ORDERED", label: "Zamówiony", color: "orange", icon: "mdi-truck-fast" },
  {
    value: "PARTIALLY_IN_STOCK",
    label: "Częściowo",
    color: "blue",
    icon: "mdi-chart-pie",
  },
  {
    value: "IN_STOCK",
    label: "Na stanie",
    color: "green",
    icon: "mdi-package-variant-closed-check",
  },
];

const hasUnordered = computed(() =>
  props.materials.some((m: any) => m.status === "NOT_ORDERED")
);

const getStatusConfig = (status: string) => {
  return (
    materialStatuses.find((s) => s.value === status) || {
      label: status,
      color: "grey",
      icon: "mdi-help-circle",
    }
  );
};

const isOverdue = (material: any) => {
  if (!material.expected_delivery_date) return false;
  const delivery = new Date(material.expected_delivery_date).setHours(0, 0, 0, 0);
  const today = new Date().setHours(0, 0, 0, 0);
  return delivery < today && material.status !== "IN_STOCK";
};

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);

const formatDate = (date: string) =>
  date ? new Date(date).toLocaleDateString("pl-PL") : "—";
</script>

<style scoped>
.cursor-pointer {
  cursor: pointer;
}

:deep(.inline-edit-container) {
  justify-content: flex-end;
}

tbody td:nth-child(7) :deep(.inline-edit-container), /* Dostawca */
tbody td:nth-child(8) :deep(.inline-edit-container) {
  /* Notatki */
  justify-content: flex-start;
}

.v-table__wrapper tbody tr td {
  height: 56px;
  vertical-align: middle;
}

.hover-bg:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.fullscreen-card {
  position: fixed !important;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  border-radius: 0 !important;
  display: flex;
  flex-direction: column;
}

.transition-swing {
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
}

/* Sortable Headers */
.sortable-header {
  cursor: pointer;
  transition: background-color 0.2s;
  user-select: none;
}

.sortable-header:hover {
  background-color: #e0e0e0; /* Delikatne podświetlenie przy najechaniu */
  color: black;
}
td,
th {
  padding: 0 10px !important;
}
</style>


=================================================================================
FILE: src/components/materials/VariantMaterialsTab.vue
LOCATION: .//src/components/materials/VariantMaterialsTab.vue
=================================================================================

<template>
  <div>
    <!-- Panel Materiałów (Lista + Przyciski) -->
    <materials-panel
      :materials="materials"
      :summary="summary"
      :total-cost="totalCost"
      :loading="loading"
      :readonly="readonly"
      @add="openAddDialog"
      @edit="editMaterial"
      @delete="confirmDeleteMaterial"
      @status-change="handleStatusChange"
      @mark-all-ordered="handleMarkAllOrdered"
      @import-batch="batchDialog = true"
      @updateItem="handleInlineUpdate"
      @bulk-delete="handleBulkDelete"
      @bulk-status-change="handleBulkStatusChange"
    />

    <!-- Dialog Dodawania/Edycji Pojedynczego Materiału -->
    <material-form-dialog
      v-model="materialFormDialog"
      :material="editingMaterial"
      @saved="handleSaved"
    />

    <!-- Dialog Masowego Importu -->
    <batch-material-add-dialog
      v-model="batchDialog"
      :loading="batchLoading"
      @save="handleBatchSave"
    />

    <!-- Dialog Potwierdzenia Usunięcia -->
    <v-dialog v-model="deleteDialog" max-width="400">
      <v-card>
        <v-card-title class="bg-error text-white d-flex align-center">
          <v-icon start color="white">mdi-alert-circle</v-icon>
          Usuń materiał
        </v-card-title>
        <v-card-text class="pt-6">
          Czy na pewno chcesz usunąć materiał:
          <div class="font-weight-bold mt-2">
            {{ deletingMaterial?.assortment?.name || "Wybrany materiał" }}
          </div>
          <div class="text-caption text-medium-emphasis mt-1">
            Ta operacja jest nieodwracalna.
          </div>
        </v-card-text>
        <v-card-actions class="pa-4">
          <v-spacer />
          <v-btn variant="text" @click="deleteDialog = false">Anuluj</v-btn>
          <v-btn color="error" variant="elevated" @click="handleDelete">Usuń</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";
import { variantMaterialService } from "@/services/variantMaterialService";

// Komponenty
import MaterialsPanel from "@/components/materials/MaterialsPanel.vue";
import MaterialFormDialog from "@/components/materials/MaterialFormDialog.vue";
import BatchMaterialAddDialog from "@/components/materials/BatchMaterialAddDialog.vue";

const props = defineProps({
  variantId: {
    type: [Number, String],
    required: true,
  },
  readonly: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(["updated", "data-loaded"]);

// --- STATE ---
const loading = ref(false);
const materials = ref<any[]>([]);
const summary = ref<any>(null);
const totalCost = ref(0);

// Dialogs State
const materialFormDialog = ref(false);
const editingMaterial = ref<any>(null);

const batchDialog = ref(false);
const batchLoading = ref(false);

const deleteDialog = ref(false);
const deletingMaterial = ref<any>(null);

// --- LIFECYCLE & WATCHERS ---

watch(() => props.variantId, loadMaterials, { immediate: true });

// --- DATA LOADING ---

async function loadMaterials() {
  if (!props.variantId) return;
  loading.value = true;
  try {
    const data = await variantMaterialService.getAll(props.variantId);

    if (data && typeof data === "object") {
      materials.value = Array.isArray(data.materials)
        ? data.materials
        : Array.isArray(data)
        ? data
        : [];
      summary.value = data.summary || null;

      // POPRAWKA: Obliczamy sumę ręcznie na froncie, aby była zgodna z tabelą
      // (zamiast polegać na data.total_cost, który może nie być odświeżony w backendzie)
      totalCost.value = materials.value.reduce((sum, item) => {
        return sum + Number(item.quantity || 0) * Number(item.unit_price || 0);
      }, 0);

      // Emituj dane do rodzica (VariantDetail) z poprawną sumą
      emit("data-loaded", {
        totalCost: totalCost.value,
        summary: summary.value,
      });
    } else {
      materials.value = [];
      totalCost.value = 0;
      emit("data-loaded", { totalCost: 0, summary: null });
    }
  } catch (err) {
    console.error("Błąd ładowania materiałów wariantu:", err);
    materials.value = [];
  } finally {
    loading.value = false;
  }
}

// --- SINGLE MATERIAL ACTIONS ---

function openAddDialog() {
  editingMaterial.value = null;
  materialFormDialog.value = true;
}

function editMaterial(material: any) {
  editingMaterial.value = material;
  materialFormDialog.value = true;
}

async function handleSaved(payload: any) {
  try {
    if (editingMaterial.value?.id) {
      await variantMaterialService.update(editingMaterial.value.id, payload);
    } else {
      await variantMaterialService.create(props.variantId, payload);
    }
    materialFormDialog.value = false;
    await loadMaterials();
    emit("updated");
  } catch (err: any) {
    console.error("Błąd zapisu materiału:", err);
    alert(err.response?.data?.message || "Błąd zapisu materiału");
  }
}

// --- BATCH IMPORT ACTIONS ---

async function handleBatchSave(items: any[]) {
  if (!items || items.length === 0) return;

  batchLoading.value = true;
  try {
    await variantMaterialService.batchCreate(props.variantId, items);
    batchDialog.value = false;
    await loadMaterials();
    emit("updated");
  } catch (err: any) {
    console.error("Błąd importu masowego:", err);
    alert(err.response?.data?.message || "Wystąpił błąd podczas importu danych.");
  } finally {
    batchLoading.value = false;
  }
}

// --- DELETE ACTIONS ---

function confirmDeleteMaterial(material: any) {
  deletingMaterial.value = material;
  deleteDialog.value = true;
}

async function handleDelete() {
  if (!deletingMaterial.value) return;

  try {
    await variantMaterialService.delete(deletingMaterial.value.id);
    deleteDialog.value = false;
    deletingMaterial.value = null;
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd usuwania materiału:", err);
    alert("Nie udało się usunąć materiału.");
  }
}

// --- BULK / STATUS ACTIONS ---

async function handleStatusChange(material: any, newStatus: string) {
  try {
    await variantMaterialService.updateStatus(material.id, newStatus);
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd zmiany statusu:", err);
    alert("Nie udało się zmienić statusu.");
  }
}

async function handleMarkAllOrdered() {
  if (
    !confirm(
      "Czy na pewno chcesz oznaczyć wszystkie niezamówione materiały jako ZAMÓWIONE?"
    )
  )
    return;

  try {
    await variantMaterialService.markAllOrdered(props.variantId);
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd masowego zamawiania:", err);
    alert("Wystąpił błąd.");
  }
}

async function handleInlineUpdate(material: any, changes: any) {
  try {
    Object.assign(material, changes);
    await variantMaterialService.update(material.id, changes);
    emit("updated");
    // Po aktualizacji inline warto odświeżyć sumy, jeśli zmieniono cenę/ilość
    if (changes.quantity !== undefined || changes.unit_price !== undefined) {
      await loadMaterials();
    }
  } catch (err: any) {
    console.error("Błąd aktualizacji:", err);
    alert(err.response?.data?.message || "Nie udało się zaktualizować pola.");
    await loadMaterials();
  }
}

async function handleBulkDelete(ids: number[]) {
  try {
    await Promise.all(ids.map((id) => variantMaterialService.delete(id)));
    await loadMaterials();
    emit("updated");
  } catch (e) {
    console.error(e);
    alert("Błąd podczas usuwania");
  }
}

async function handleBulkStatusChange(ids: number[], status: string) {
  try {
    await Promise.all(ids.map((id) => variantMaterialService.updateStatus(id, status)));
    await loadMaterials();
    emit("updated");
  } catch (e) {
    console.error(e);
    alert("Błąd zmiany statusu");
  }
}

defineExpose({ loadMaterials });
</script>


=================================================================================
FILE: src/components/orders/CreateSeriesDialog.vue
LOCATION: .//src/components/orders/CreateSeriesDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    max-width="720"
    persistent
    scrollable
    @update:model-value="$emit('update:modelValue', $event)"
  >
    <v-card
      class="rounded-lg d-flex flex-column"
      style="max-height: 90vh; overflow: hidden"
    >
      <!-- ── Nagłówek karty (fixed) ── -->
      <v-card-title
        class="bg-deep-purple text-white d-flex align-center pa-4 flex-shrink-0"
      >
        <v-icon start color="white">mdi-layers-plus</v-icon>
        <span class="text-h6 font-weight-bold">Nowa seria zamówienia</span>
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" color="white" @click="close" />
      </v-card-title>

      <!-- ── Scrollowalna zawartość (stepper header + treść kroków) ── -->
      <v-card-text
        class="pa-0 flex-grow-1"
        style="overflow-y: auto; overflow-x: hidden; min-height: 0"
      >
        <!--
          VStepper musi wrappować VStepperItem (wymaga kontekstu grupy).
          flat + hide-actions wyłącza domyślne przyciski i padding.
          Treść kroków renderujemy sami przez v-if poniżej.
        -->
        <v-stepper
          v-model="step"
          flat
          hide-actions
          class="pa-0 compact-stepper"
          style="background: transparent"
          alt-labels
        >
          <v-stepper-header style="box-shadow: none">
            <!-- Krok 1: zawsze aktywny -->
            <v-stepper-item
              :value="1"
              :complete="step > 1"
              color="deep-purple"
              title="Dane serii"
            />
            <v-divider />
            <!-- Krok 2: warianty - wizualnie wyszarzony gdy pomijamy -->
            <v-stepper-item
              :value="2"
              :complete="step > 2"
              :color="stepVariantsSkipped ? 'grey' : 'deep-purple'"
              title="Warianty"
              :class="{ 'opacity-40': stepVariantsSkipped }"
            />
            <v-divider />
            <!-- Krok 3: podsumowanie -->
            <v-stepper-item
              :value="3"
              :complete="step > 3"
              color="deep-purple"
              title="Podsumowanie"
            />
          </v-stepper-header>
        </v-stepper>

        <!-- ═══════════════════════════════════════════════════
             KROK 1 — Dane serii
        ════════════════════════════════════════════════════ -->
        <div v-if="step === 1" class="pa-5">
          <v-alert
            type="info"
            variant="tonal"
            density="compact"
            class="mb-4"
            icon="mdi-information-outline"
          >
            Tworzysz nową serię dla zamówienia
            <strong>{{ sourceOrder?.order_number }}</strong
            >. Nowy numer:
            <strong>{{ sourceOrder?.order_number }}/{{ nextSeriesLabel }}</strong>
          </v-alert>

          <v-text-field
            v-model="form.description"
            label="Opis / nazwa serii"
            placeholder="np. Seria Q3 2025, Edycja letnia..."
            variant="outlined"
            prepend-inner-icon="mdi-text"
            class="mb-3"
          />

          <v-text-field
            v-model="form.planned_delivery_date"
            label="Planowana data dostawy"
            type="date"
            variant="outlined"
            prepend-inner-icon="mdi-calendar"
            class="mb-3"
          />

          <v-select
            v-model="form.priority"
            :items="priorityOptions"
            label="Priorytet"
            variant="outlined"
            prepend-inner-icon="mdi-flag"
            item-title="label"
            item-value="value"
            class="mb-3"
          />

          <v-divider class="mb-4" />

          <div class="text-subtitle-1 font-weight-bold mb-3 d-flex align-center">
            <v-icon class="mr-2" color="deep-purple">mdi-content-copy</v-icon>
            Kopiowanie wariantów z poprzedniej serii
          </div>

          <v-switch
            v-model="form.copyVariants"
            color="deep-purple"
            label="Kopiuj warianty z wybranej serii"
            hide-details
            class="mb-3"
          />

          <v-expand-transition>
            <div v-if="form.copyVariants">
              <v-select
                v-model="form.copyFromOrderId"
                :items="availableSeries"
                :loading="loadingSeries"
                label="Seria źródłowa (skąd kopiować)"
                variant="outlined"
                item-title="display_label"
                item-value="id"
                prepend-inner-icon="mdi-layers"
                no-data-text="Brak innych serii"
                class="mb-2 mt-2"
                @update:model-value="onSourceOrderChange"
              >
                <template v-slot:item="{ item, props: iProps }">
                  <v-list-item v-bind="iProps">
                    <template v-slot:subtitle>
                      <span class="text-caption">
                        {{ item.raw.variants?.length ?? 0 }} wariantów •
                        {{ item.raw.overall_status }} •
                        {{ item.raw?.created_at?.split("T")?.[0] }}
                      </span>
                    </template>
                  </v-list-item>
                </template>
              </v-select>

              <!-- Loader po wyborze serii -->
              <div
                v-if="loadingVariants"
                class="d-flex align-center text-caption text-medium-emphasis mb-2"
              >
                <v-progress-circular indeterminate size="14" width="2" class="mr-2" />
                Sprawdzanie wariantów...
              </div>

              <!-- Ostrzeżenie: brak wariantów w wybranej serii -->
              <v-alert
                v-if="
                  form.copyFromOrderId && !loadingVariants && variantsForCopy.length === 0
                "
                type="warning"
                variant="tonal"
                density="compact"
                icon="mdi-alert-outline"
                class="mb-2"
              >
                Wybrana seria nie ma wariantów. Seria zostanie utworzona
                <strong>bez kopiowania</strong> — możesz wybrać inną serię lub
                kontynuować.
              </v-alert>

              <!-- Info: ile wariantów załadowano -->
              <v-alert
                v-if="
                  form.copyFromOrderId && !loadingVariants && variantsForCopy.length > 0
                "
                type="success"
                variant="tonal"
                density="compact"
                icon="mdi-check-circle-outline"
                class="mb-2"
              >
                Znaleziono <strong>{{ variantsForCopy.length }}</strong>
                {{ variantsForCopy.length === 1 ? "wariant" : "wariantów" }} do
                skopiowania.
              </v-alert>
            </div>
          </v-expand-transition>
        </div>

        <!-- ═══════════════════════════════════════════════════
             KROK 2 — Wybór wariantów
        ════════════════════════════════════════════════════ -->
        <div v-else-if="step === 2" class="pa-5">
          <div class="d-flex align-center mb-4">
            <div class="text-subtitle-1 font-weight-bold">
              Wybierz warianty do skopiowania
            </div>
            <v-spacer />
            <v-btn
              size="small"
              variant="text"
              color="deep-purple"
              @click="selectAllVariants"
            >
              Zaznacz wszystkie
            </v-btn>
            <v-btn size="small" variant="text" color="grey" @click="deselectAllVariants">
              Odznacz
            </v-btn>
          </div>

          <v-card
            v-for="variant in variantsForCopy"
            :key="variant.id"
            variant="outlined"
            class="mb-3 variant-copy-card"
            :class="{ 'variant-selected': isVariantSelected(variant.id) }"
          >
            <v-card-text class="pa-3">
              <div class="d-flex align-center">
                <v-checkbox
                  :model-value="isVariantSelected(variant.id)"
                  color="deep-purple"
                  hide-details
                  density="compact"
                  class="mr-2 flex-shrink-0"
                  @update:model-value="toggleVariant(variant.id, $event as boolean)"
                />
                <div class="flex-grow-1">
                  <div class="d-flex align-center flex-wrap">
                    <span class="font-weight-bold mr-2"
                      >[{{ variant.variant_number }}] {{ variant.name }}</span
                    >
                    <v-chip size="x-small" variant="outlined" class="mr-1">
                      {{ variant.quantity }} szt
                    </v-chip>
                    <v-chip
                      size="x-small"
                      :color="variant.type === 'PROTOTYPE' ? 'purple' : 'blue'"
                      variant="flat"
                      label
                    >
                      {{ variant.type === "PROTOTYPE" ? "PROTOTYP" : "SERIA" }}
                    </v-chip>
                  </div>

                  <v-expand-transition>
                    <div v-if="isVariantSelected(variant.id)" class="mt-2 pl-1">
                      <div class="d-flex flex-wrap gap-2">
                        <div class="text-caption text-medium-emphasis">Co skopiować:</div>
                        <v-chip
                          :color="
                            getVariantConfig(variant.id).copy_quotation ? 'green' : 'grey'
                          "
                          :variant="
                            getVariantConfig(variant.id).copy_quotation
                              ? 'flat'
                              : 'outlined'
                          "
                          size="small"
                          class="cursor-pointer copy-option-chip"
                          :disabled="!variant.has_quotation"
                          @click="toggleCopyOption(variant.id, 'copy_quotation')"
                        >
                          <v-icon start size="x-small">
                            {{
                              getVariantConfig(variant.id).copy_quotation
                                ? "mdi-check"
                                : "mdi-close"
                            }}
                          </v-icon>
                          Wycena
                          <span v-if="variant.quotation_info" class="ml-1 opacity-70">
                            (v{{ variant.quotation_info.version_number }}
                            <template v-if="variant.quotation_info.is_approved"
                              >✓</template
                            >)
                          </span>
                          <span v-else class="ml-1 opacity-50">(brak)</span>
                        </v-chip>

                        <v-chip
                          :color="
                            getVariantConfig(variant.id).copy_materials
                              ? 'orange'
                              : 'grey'
                          "
                          :variant="
                            getVariantConfig(variant.id).copy_materials
                              ? 'flat'
                              : 'outlined'
                          "
                          size="small"
                          class="cursor-pointer copy-option-chip"
                          :disabled="!variant.has_materials"
                          @click="toggleCopyOption(variant.id, 'copy_materials')"
                        >
                          <v-icon start size="x-small">
                            {{
                              getVariantConfig(variant.id).copy_materials
                                ? "mdi-check"
                                : "mdi-close"
                            }}
                          </v-icon>
                          Materiały
                          <span
                            v-if="variant.materials_count > 0"
                            class="ml-1 opacity-70"
                          >
                            ({{ variant.materials_count }})
                          </span>
                          <span v-else class="ml-1 opacity-50">(brak)</span>
                        </v-chip>
                      </div>
                    </div>
                  </v-expand-transition>
                </div>
              </div>
            </v-card-text>
          </v-card>

          <!-- Podsumowanie wyboru w kroku 2 -->
          <v-alert
            v-if="selectedVariantCount > 0"
            type="success"
            variant="tonal"
            density="compact"
            class="mt-2"
          >
            Wybrano <strong>{{ selectedVariantCount }}</strong> z
            {{ variantsForCopy.length }} wariantów.
            <span v-if="countCopyOptions.quotations > 0">
              {{ countCopyOptions.quotations }} z wycenami.
            </span>
            <span v-if="countCopyOptions.materials > 0">
              {{ countCopyOptions.materials }} z materiałami.
            </span>
          </v-alert>

          <!-- Ostrzeżenie gdy żaden nie zaznaczony -->
          <v-alert
            v-else
            type="warning"
            variant="tonal"
            density="compact"
            icon="mdi-alert-outline"
            class="mt-2"
          >
            Nie zaznaczono żadnego wariantu. Seria zostanie utworzona bez kopiowania.
          </v-alert>
        </div>

        <!-- ═══════════════════════════════════════════════════
             KROK 3 — Podsumowanie
        ════════════════════════════════════════════════════ -->
        <div v-else-if="step === 3" class="pa-5">
          <div class="text-subtitle-1 font-weight-bold mb-4 d-flex align-center">
            <v-icon class="mr-2" color="deep-purple">mdi-clipboard-check-outline</v-icon>
            Podsumowanie — sprawdź przed utworzeniem
          </div>

          <!-- Dane serii -->
          <v-card variant="outlined" class="mb-4 summary-card">
            <v-card-title
              class="text-subtitle-2 font-weight-bold pa-3 pb-2 summary-card-title"
            >
              <v-icon size="small" class="mr-1" color="deep-purple"
                >mdi-information-outline</v-icon
              >
              Dane serii
            </v-card-title>
            <v-card-text class="pa-3 pt-2">
              <div class="summary-row">
                <span class="summary-label">Numer serii</span>
                <span class="summary-value font-weight-bold">
                  {{ sourceOrder?.order_number }}/{{ nextSeriesLabel }}
                </span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Opis</span>
                <span class="summary-value">{{ form.description || "—" }}</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Planowana dostawa</span>
                <span class="summary-value">{{ form.planned_delivery_date || "—" }}</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Priorytet</span>
                <span class="summary-value">
                  <v-chip size="x-small" :color="priorityColor" variant="flat" label>
                    {{ priorityLabel }}
                  </v-chip>
                </span>
              </div>
            </v-card-text>
          </v-card>

          <!-- Kopiowanie wariantów -->
          <v-card variant="outlined" class="mb-3 summary-card">
            <v-card-title
              class="text-subtitle-2 font-weight-bold pa-3 pb-2 summary-card-title"
            >
              <v-icon size="small" class="mr-1" color="deep-purple"
                >mdi-content-copy</v-icon
              >
              Kopiowanie wariantów
            </v-card-title>
            <v-card-text class="pa-3 pt-2">
              <!-- A: kopiowanie wyłączone -->
              <template v-if="!form.copyVariants">
                <v-alert
                  type="info"
                  variant="tonal"
                  density="compact"
                  icon="mdi-information"
                >
                  Kopiowanie wyłączone — seria zostanie utworzona bez wariantów.
                </v-alert>
              </template>

              <!-- B: kopiowanie włączone, ale nie wybrano serii -->
              <template v-else-if="!form.copyFromOrderId">
                <v-alert
                  type="warning"
                  variant="tonal"
                  density="compact"
                  icon="mdi-alert-outline"
                >
                  Nie wybrano serii źródłowej — seria zostanie utworzona bez wariantów.
                </v-alert>
              </template>

              <!-- C: kopiowanie włączone, wybrano serię, ale nie ma w niej wariantów -->
              <template v-else-if="variantsForCopy.length === 0">
                <v-alert
                  type="warning"
                  variant="tonal"
                  density="compact"
                  icon="mdi-alert-outline"
                >
                  Wybrana seria <strong>{{ sourceSeriesLabel }}</strong>
                  nie zawiera wariantów — seria zostanie utworzona bez kopiowania.
                </v-alert>
              </template>

              <!-- D: są warianty, ale żaden nie zaznaczony -->
              <template v-else-if="selectedVariantCount === 0">
                <v-alert
                  type="warning"
                  variant="tonal"
                  density="compact"
                  icon="mdi-alert-outline"
                >
                  Nie zaznaczono żadnego wariantu z serii
                  <strong>{{ sourceSeriesLabel }}</strong>
                  — seria zostanie utworzona bez kopiowania.
                </v-alert>
              </template>

              <!-- E: wszystko OK — lista wybranych wariantów -->
              <template v-else>
                <div class="summary-row mb-3">
                  <span class="summary-label">Seria źródłowa</span>
                  <span class="summary-value font-weight-bold">{{
                    sourceSeriesLabel
                  }}</span>
                </div>
                <div class="summary-row mb-3">
                  <span class="summary-label">Liczba wariantów</span>
                  <span class="summary-value">
                    <v-chip size="x-small" color="deep-purple" variant="flat">
                      {{ selectedVariantCount }} / {{ variantsForCopy.length }}
                    </v-chip>
                    <span
                      v-if="
                        countCopyOptions.quotations > 0 || countCopyOptions.materials > 0
                      "
                      class="text-caption text-medium-emphasis ml-2"
                    >
                      ({{ countCopyOptions.quotations }} z wycenami,
                      {{ countCopyOptions.materials }} z materiałami)
                    </span>
                  </span>
                </div>

                <!-- Lista wybranych wariantów -->
                <div
                  v-for="variantId in Array.from(variantCopyMap.keys())"
                  :key="variantId"
                  class="summary-variant-row"
                >
                  <div class="d-flex align-center flex-wrap py-1">
                    <v-icon size="small" color="deep-purple" class="mr-2"
                      >mdi-check-circle</v-icon
                    >
                    <span class="text-body-2 font-weight-medium mr-2">
                      [{{ getVariantNumber(variantId) }}] {{ getVariantName(variantId) }}
                    </span>
                    <v-chip
                      v-if="getVariantConfig(variantId).copy_quotation"
                      size="x-small"
                      color="green"
                      variant="flat"
                      class="mr-1"
                    >
                      wycena
                    </v-chip>
                    <v-chip
                      v-if="getVariantConfig(variantId).copy_materials"
                      size="x-small"
                      color="orange"
                      variant="flat"
                    >
                      materiały
                    </v-chip>
                  </div>
                </div>
              </template>
            </v-card-text>
          </v-card>
        </div>
      </v-card-text>

      <!-- ── Przyciski nawigacji (fixed na dole) ── -->
      <v-divider />
      <v-card-actions class="pa-4 flex-shrink-0">
        <v-btn variant="text" @click="close">Anuluj</v-btn>
        <v-spacer />

        <!-- KROK 1 → dalej -->
        <template v-if="step === 1">
          <v-btn
            color="deep-purple"
            variant="elevated"
            append-icon="mdi-arrow-right"
            :loading="loadingVariants"
            :disabled="form.copyVariants && !form.copyFromOrderId"
            @click="navigateFromStep1"
          >
            Dalej
          </v-btn>
        </template>

        <!-- KROK 2 → wróć + dalej -->
        <template v-else-if="step === 2">
          <v-btn
            variant="outlined"
            prepend-icon="mdi-arrow-left"
            class="mr-2"
            @click="step = 1"
          >
            Wróć
          </v-btn>
          <v-btn
            color="deep-purple"
            variant="elevated"
            append-icon="mdi-arrow-right"
            @click="step = 3"
          >
            Podsumowanie
          </v-btn>
        </template>

        <!-- KROK 3 → wróć + utwórz -->
        <template v-else-if="step === 3">
          <v-btn
            variant="outlined"
            prepend-icon="mdi-arrow-left"
            class="mr-2"
            @click="navigateBackFromStep3"
          >
            Wróć
          </v-btn>
          <v-btn
            color="deep-purple"
            variant="elevated"
            :loading="saving"
            prepend-icon="mdi-check"
            @click="save"
          >
            Utwórz serię
          </v-btn>
        </template>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { seriesService } from "@/services/seriesService";
import type { VariantForCopy, VariantCopyConfig } from "@/services/seriesService";

// ─── Props / Emits ────────────────────────────────────────────────────────────

const props = defineProps<{
  modelValue: boolean;
  sourceOrder: {
    id: number;
    order_number: string;
    series: string;
    full_order_number: string;
  } | null;
}>();

const emit = defineEmits<{
  "update:modelValue": [value: boolean];
  saved: [result: any];
}>();

// ─── Stan ─────────────────────────────────────────────────────────────────────

const step = ref(1);
const saving = ref(false);
const loadingSeries = ref(false);
const loadingVariants = ref(false);

const availableSeries = ref<any[]>([]);
const variantsForCopy = ref<VariantForCopy[]>([]);
const variantCopyMap = ref<Map<number, VariantCopyConfig>>(new Map());

const form = ref({
  description: "",
  planned_delivery_date: null as string | null,
  priority: "NORMAL",
  copyVariants: false,
  copyFromOrderId: null as number | null,
});

// ─── Stałe ────────────────────────────────────────────────────────────────────

const priorityOptions = [
  { label: "Niski", value: "low" },
  { label: "Normalny", value: "NORMAL" },
  { label: "Wysoki", value: "high" },
  { label: "Pilny", value: "urgent" },
];

// ─── Computed ─────────────────────────────────────────────────────────────────

/** Etykieta następnej serii (np. "0005") */
const nextSeriesLabel = computed(() => {
  if (!availableSeries.value.length) return "????";
  const max = Math.max(
    ...availableSeries.value.map((s) => parseInt(s.series || "0", 10))
  );
  return String(max + 1).padStart(4, "0");
});

/**
 * Czy krok 2 (Warianty) jest pomijany.
 * Pomijamy gdy: kopiowanie wyłączone, nie wybrano serii lub seria nie ma wariantów.
 */
const stepVariantsSkipped = computed(() => {
  return (
    !form.value.copyVariants ||
    !form.value.copyFromOrderId ||
    variantsForCopy.value.length === 0
  );
});

/** Liczba zaznaczonych wariantów */
const selectedVariantCount = computed(() => variantCopyMap.value.size);

/** Podsumowanie opcji kopiowania */
const countCopyOptions = computed(() => {
  let quotations = 0;
  let materials = 0;
  variantCopyMap.value.forEach((cfg) => {
    if (cfg.copy_quotation) quotations++;
    if (cfg.copy_materials) materials++;
  });
  return { quotations, materials };
});

/** Etykieta wybranej serii źródłowej (do podsumowania) */
const sourceSeriesLabel = computed(() => {
  const found = availableSeries.value.find((s) => s.id === form.value.copyFromOrderId);
  return found?.display_label ?? "—";
});

/** Kolor chipa priorytetu */
const priorityColor = computed(() => {
  const map: Record<string, string> = {
    low: "grey",
    normal: "blue",
    high: "orange",
    urgent: "red",
  };
  return map[form.value.priority] ?? "grey";
});

/** Polska nazwa priorytetu */
const priorityLabel = computed(() => {
  return priorityOptions.find((o) => o.value === form.value.priority)?.label ?? "—";
});

// ─── Watchery ─────────────────────────────────────────────────────────────────

watch(
  () => props.modelValue,
  async (isOpen) => {
    if (isOpen && props.sourceOrder) {
      resetForm();
      await loadAvailableSeries();
    }
  }
);

// ─── Metody ───────────────────────────────────────────────────────────────────

/** Załaduj dostępne serie dla zamówienia */
const loadAvailableSeries = async () => {
  if (!props.sourceOrder) return;
  loadingSeries.value = true;
  try {
    const all = await seriesService.getAllSeries(props.sourceOrder.id);
    availableSeries.value = all.map((s) => ({
      ...s,
      display_label: `${s.full_order_number} — ${s.description || "Brak opisu"}`,
    }));
  } catch (err) {
    console.error("Błąd ładowania serii:", err);
  } finally {
    loadingSeries.value = false;
  }
};

/** Po wyborze serii źródłowej — załaduj jej warianty i wyczyść poprzedni wybór */
const onSourceOrderChange = async (orderId: number | null) => {
  variantsForCopy.value = [];
  variantCopyMap.value = new Map();
  if (!orderId) return;

  loadingVariants.value = true;
  try {
    variantsForCopy.value = await seriesService.getVariantsForSelector(orderId);
  } catch (err) {
    console.error("Błąd ładowania wariantów:", err);
  } finally {
    loadingVariants.value = false;
  }
};

/**
 * Nawigacja z kroku 1 → 2 lub 3.
 *
 * Krok 2 pokazujemy TYLKO gdy:
 *   - kopiowanie włączone
 *   - wybrano serię źródłową
 *   - seria ma co najmniej 1 wariant
 *
 * W każdym innym przypadku (brak serii, brak wariantów, kopiowanie wyłączone)
 * pomijamy krok 2 i przechodzimy prosto do podsumowania.
 */
const navigateFromStep1 = () => {
  const hasVariants =
    form.value.copyVariants &&
    form.value.copyFromOrderId &&
    variantsForCopy.value.length > 0;

  step.value = hasVariants ? 2 : 3;
};

/**
 * Nawigacja "Wróć" z kroku 3.
 * Wracamy do kroku 2 tylko jeśli był on faktycznie pokazany (nie był pomijany).
 */
const navigateBackFromStep3 = () => {
  step.value = stepVariantsSkipped.value ? 1 : 2;
};

/** Czy dany wariant jest zaznaczony */
const isVariantSelected = (id: number): boolean => variantCopyMap.value.has(id);

/** Pobierz config wariantu (domyślny jeśli brak w mapie) */
const getVariantConfig = (id: number): VariantCopyConfig => {
  return (
    variantCopyMap.value.get(id) || {
      source_variant_id: id,
      copy_quotation: false,
      copy_materials: false,
    }
  );
};

/** Pobierz nazwę wariantu po ID */
const getVariantName = (id: number): string => {
  return variantsForCopy.value.find((v) => v.id === id)?.name ?? `Wariant #${id}`;
};

const getVariantNumber = (id: number): string => {
  return (
    variantsForCopy.value.find((v) => v.id === id)?.variant_number ?? `Wariant #${id}`
  );
};

/** Zaznacz/odznacz wariant */
const toggleVariant = (id: number, selected: boolean) => {
  if (selected) {
    const variant = variantsForCopy.value.find((v) => v.id === id);
    variantCopyMap.value.set(id, {
      source_variant_id: id,
      copy_quotation: variant?.has_quotation ?? false,
      copy_materials: variant?.has_materials ?? false,
    });
  } else {
    variantCopyMap.value.delete(id);
  }
  variantCopyMap.value = new Map(variantCopyMap.value);
};

/** Przełącz opcję kopiowania (wycena/materiały) */
const toggleCopyOption = (id: number, field: "copy_quotation" | "copy_materials") => {
  const cfg = getVariantConfig(id);
  const variant = variantsForCopy.value.find((v) => v.id === id);
  if (field === "copy_quotation" && !variant?.has_quotation) return;
  if (field === "copy_materials" && !variant?.has_materials) return;
  variantCopyMap.value.set(id, { ...cfg, [field]: !cfg[field] });
  variantCopyMap.value = new Map(variantCopyMap.value);
};

/** Zaznacz wszystkie warianty */
const selectAllVariants = () => {
  variantsForCopy.value.forEach((v) => {
    variantCopyMap.value.set(v.id, {
      source_variant_id: v.id,
      copy_quotation: v.has_quotation,
      copy_materials: v.has_materials,
    });
  });
  variantCopyMap.value = new Map(variantCopyMap.value);
};

/** Odznacz wszystkie warianty */
const deselectAllVariants = () => {
  variantCopyMap.value = new Map();
};

/** Zbuduj payload do API */
const buildPayload = () => {
  const payload: any = {
    description: form.value.description || null,
    planned_delivery_date: form.value.planned_delivery_date || undefined,
    priority: form.value.priority,
  };

  // Dołącz warianty tylko jeśli faktycznie coś zaznaczono
  if (
    form.value.copyVariants &&
    form.value.copyFromOrderId &&
    variantCopyMap.value.size > 0
  ) {
    payload.copy_from_order_id = form.value.copyFromOrderId;
    payload.variants = Array.from(variantCopyMap.value.values());
  }

  return payload;
};

/** Zapisz serię (zawsze z kroku 3 — podsumowania) */
const save = async () => {
  saving.value = true;
  try {
    const payload = buildPayload();
    const result = await seriesService.createSeries(props.sourceOrder!.id, payload);
    emit("saved", result);
    close();
  } catch (err: any) {
    const msg = err.response?.data?.message || "Błąd tworzenia serii";
    alert(msg);
  } finally {
    saving.value = false;
  }
};

/** Zamknij dialog */
const close = () => {
  emit("update:modelValue", false);
};

/** Reset stanu do wartości początkowych */
const resetForm = () => {
  step.value = 1;
  saving.value = false;
  variantsForCopy.value = [];
  variantCopyMap.value = new Map();
  form.value = {
    description: "",
    planned_delivery_date: null,
    priority: "NORMAL",
    copyVariants: false,
    copyFromOrderId: null,
  };
};
</script>

<style scoped>
/* ── Kompaktowy stepper ── */

:deep(.compact-stepper.v-stepper) {
  background: transparent !important;
  padding: 0 !important;
}

:deep(.compact-stepper .v-stepper-header) {
  box-shadow: none !important;
  min-height: 52px !important;
  padding: 0 !important;
}

:deep(.compact-stepper .v-stepper-item) {
  padding-top: 8px !important;
  padding-bottom: 8px !important;
}

:deep(.compact-stepper .v-stepper-item__title) {
  font-size: 0.8rem !important;
  white-space: nowrap;
}

:deep(.compact-stepper .v-avatar) {
  width: 26px !important;
  height: 26px !important;
  min-width: 26px !important;
  font-size: 0.78rem !important;
}

/* Ukryj domyślną treść VStepper (używamy własnej) */
:deep(.compact-stepper .v-stepper-window) {
  display: none !important;
}

/* ── Krok 2 wyszarzony gdy pomijany ── */
.opacity-40 {
  opacity: 0.4;
}

/* ── Podsumowanie (krok 3) ── */

.summary-card {
  border-color: #e0e0e0 !important;
}

.summary-card-title {
  background: rgba(103, 58, 183, 0.04);
  border-bottom: 1px solid #e0e0e0;
}

.summary-row {
  display: flex;
  align-items: center;
  padding: 4px 0;
  gap: 12px;
}

.summary-label {
  min-width: 140px;
  font-size: 0.8rem;
  color: rgba(0, 0, 0, 0.55);
  flex-shrink: 0;
}

.summary-value {
  font-size: 0.875rem;
}

.summary-variant-row {
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

.summary-variant-row:last-child {
  border-bottom: none;
}

/* ── Karty wariantów (krok 2) ── */

.variant-copy-card {
  border-color: #e0e0e0 !important;
  transition: all 0.2s ease;
}

.variant-copy-card:hover {
  border-color: #9c27b0 !important;
}

.variant-selected {
  border-color: #9c27b0 !important;
  background-color: rgba(156, 39, 176, 0.03) !important;
}

.copy-option-chip {
  cursor: pointer;
  transition: all 0.15s ease;
}

.copy-option-chip:not(.v-chip--disabled):hover {
  opacity: 0.85;
  transform: translateY(-1px);
}

.gap-2 {
  gap: 8px;
}
</style>


=================================================================================
FILE: src/components/orders/OrderDescription.vue
LOCATION: .//src/components/orders/OrderDescription.vue
=================================================================================

<template>
  <v-card v-if="description" elevation="2">
    <v-card-title class="bg-blue text-white d-flex align-center">
      <v-icon start color="white">mdi-text-box-outline</v-icon>
      Opis projektu
    </v-card-title>
    <v-card-text class="pt-4">
      <p class="text-body-1" style="white-space: pre-line">
        {{ description }}
      </p>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
defineProps<{
  description: string | null | undefined;
}>();
</script>


=================================================================================
FILE: src/components/orders/OrderFinancialSummary.vue
LOCATION: .//src/components/orders/OrderFinancialSummary.vue
=================================================================================

<template>
  <v-card elevation="2">
    <v-card-title class="bg-blue-grey text-white d-flex align-center">
      <v-icon start color="white">mdi-chart-areaspline</v-icon>
      Kontrola Kosztów
      <v-spacer />
      <v-progress-circular
        v-if="loading"
        indeterminate
        size="18"
        width="2"
        color="white"
      />
    </v-card-title>

    <v-card-text class="pt-6">
      <!-- Skeleton -->
      <template v-if="loading">
        <v-skeleton-loader type="heading" class="mb-4" />
        <v-row>
          <v-col cols="6"><v-skeleton-loader type="card" /></v-col>
          <v-col cols="6"><v-skeleton-loader type="card" /></v-col>
        </v-row>
      </template>

      <!-- Brak zatwierdzonych wycen -->
      <template
        v-else-if="!financialSummary || financialSummary.total_approved_gross === 0"
      >
        <div class="text-center py-4">
          <v-icon size="40" color="grey-lighten-1">mdi-file-chart-outline</v-icon>
          <p class="mt-2 text-body-2 text-medium-emphasis">
            Brak zatwierdzonych wycen w wariantach
          </p>
          <p class="text-caption text-medium-emphasis">
            Zatwierdź wycenę wariantu, aby zobaczyć budżet
          </p>
        </div>
      </template>

      <!-- Dane finansowe -->
      <template v-else>
        <!-- Budżet vs Rzeczywistość -->
        <v-row class="mb-4">
          <v-col cols="6">
            <div
              class="text-caption text-uppercase font-weight-bold text-medium-emphasis"
            >
              Budżet (z wycen)
            </div>
            <div class="text-h4 font-weight-black text-blue-grey-darken-2">
              {{ formatCurrency(financialSummary.total_approved_gross) }}
            </div>
            <div class="text-caption text-medium-emphasis mt-1">brutto</div>
          </v-col>
          <v-col cols="6" class="text-right">
            <div
              class="text-caption text-uppercase font-weight-bold text-medium-emphasis"
            >
              Rzeczywiste koszty
            </div>
            <div
              class="text-h4 font-weight-black"
              :class="
                financialSummary.total_actual > financialSummary.total_approved_gross
                  ? 'text-error'
                  : 'text-success'
              "
            >
              {{ formatCurrency(financialSummary.total_actual) }}
            </div>
            <div class="mt-1">
              <v-chip
                size="x-small"
                :color="
                  financialSummary.total_actual > financialSummary.total_approved_gross
                    ? 'error'
                    : 'success'
                "
                variant="tonal"
                class="font-weight-bold"
              >
                {{ utilizationPercent }}%
              </v-chip>
            </div>
          </v-col>
        </v-row>

        <v-divider class="mb-4" />

        <!-- Materiały vs Usługi -->
        <v-row>
          <v-col cols="12" md="6">
            <v-card variant="outlined" class="pa-3">
              <div class="d-flex align-center mb-2">
                <v-icon color="blue" class="mr-2">mdi-cube-outline</v-icon>
                <span class="text-subtitle-1 font-weight-bold">Materiały</span>
              </div>
              <div class="d-flex justify-space-between text-body-2 mb-1">
                <span class="text-medium-emphasis">Budżet:</span>
                <strong>{{
                  formatCurrency(financialSummary.total_approved_materials)
                }}</strong>
              </div>
              <div class="d-flex justify-space-between text-body-2 mb-2">
                <span class="text-medium-emphasis">Rzeczywiste:</span>
                <strong
                  :class="
                    financialSummary.total_actual_materials >
                    financialSummary.total_approved_materials
                      ? 'text-error'
                      : 'text-grey-darken-3'
                  "
                >
                  {{ formatCurrency(financialSummary.total_actual_materials) }}
                </strong>
              </div>
              <v-progress-linear
                :model-value="
                  calcPercent(
                    financialSummary.total_actual_materials,
                    financialSummary.total_approved_materials
                  )
                "
                :color="
                  financialSummary.total_actual_materials >
                  financialSummary.total_approved_materials
                    ? 'error'
                    : 'blue'
                "
                height="8"
                rounded
              />
            </v-card>
          </v-col>

          <v-col cols="12" md="6">
            <v-card variant="outlined" class="pa-3">
              <div class="d-flex align-center mb-2">
                <v-icon color="orange" class="mr-2">mdi-wrench-outline</v-icon>
                <span class="text-subtitle-1 font-weight-bold">Usługi</span>
              </div>
              <div class="d-flex justify-space-between text-body-2 mb-1">
                <span class="text-medium-emphasis">Budżet:</span>
                <strong>{{
                  formatCurrency(financialSummary.total_approved_services)
                }}</strong>
              </div>
              <div class="d-flex justify-space-between text-body-2 mb-2">
                <span class="text-medium-emphasis">Rzeczywiste:</span>
                <strong
                  :class="
                    financialSummary.total_actual_services >
                    financialSummary.total_approved_services
                      ? 'text-error'
                      : 'text-grey-darken-3'
                  "
                >
                  {{ formatCurrency(financialSummary.total_actual_services) }}
                </strong>
              </div>
              <v-progress-linear
                :model-value="
                  calcPercent(
                    financialSummary.total_actual_services,
                    financialSummary.total_approved_services
                  )
                "
                :color="
                  financialSummary.total_actual_services >
                  financialSummary.total_approved_services
                    ? 'error'
                    : 'orange'
                "
                height="8"
                rounded
              />
            </v-card>
          </v-col>
        </v-row>

        <!-- Zysk -->
        <v-card class="mt-4 pa-3" variant="outlined">
          <div class="d-flex justify-space-between align-center">
            <div class="d-flex align-center">
              <v-icon :color="varianceColor" size="small" class="mr-2">
                {{ varianceIcon }}
              </v-icon>
              <span class="text-body-2 font-weight-bold">Zysk</span>
            </div>
            <span
              class="text-subtitle-1 font-weight-bold"
              :class="`text-${varianceColor}`"
            >
              {{ varianceSign
              }}{{ formatCurrency(Math.abs(financialSummary.total_variance)) }}
              <span
                v-if="financialSummary.variance_percent !== null"
                class="text-caption ml-1"
              >
                ({{ varianceSign }}{{ Math.abs(financialSummary.variance_percent) }}%)
              </span>
            </span>
          </div>
        </v-card>
      </template>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps<{
  financialSummary: any;
  loading: boolean;
}>();

const { formatCurrency } = useFormatters();

const calcPercent = (actual: number, total: number): number => {
  if (!total || total === 0) return 0;
  return Math.min(Math.round((actual / total) * 100), 100);
};

const utilizationPercent = computed<number>(() => {
  if (!props.financialSummary) return 0;
  return calcPercent(
    props.financialSummary.total_actual,
    props.financialSummary.total_approved_gross
  );
});

const varianceColor = computed<string>(() => {
  if (!props.financialSummary) return "grey";
  const v = props.financialSummary.total_variance;
  if (v > 0) return "error";
  if (v < 0) return "success";
  return "grey";
});

const varianceIcon = computed<string>(() => {
  if (!props.financialSummary) return "mdi-trending-neutral";
  const v = props.financialSummary.total_variance;
  if (v > 0) return "mdi-trending-down";
  if (v < 0) return "mdi-trending-up";
  return "mdi-trending-neutral";
});

const varianceSign = computed<string>(() => {
  if (!props.financialSummary) return "";
  return props.financialSummary.total_variance > 0 ? "+" : "";
});
</script>


=================================================================================
FILE: src/components/orders/OrderFormDialog.vue
LOCATION: .//src/components/orders/OrderFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="650"
    persistent
  >
    <v-card>
      <v-card-title class="d-flex align-center pa-4 bg-primary">
        <v-icon class="mr-2">{{
          isEditing ? "mdi-clipboard-edit" : "mdi-clipboard-plus"
        }}</v-icon>
        {{ isEditing ? "Edytuj zamówienie" : "Nowe zamówienie" }}
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" density="compact" @click="closeDialog" />
      </v-card-title>

      <v-form ref="formRef" v-model="formValid" @submit.prevent="saveOrder">
        <v-card-text class="pa-6">
          <v-row>
            <!-- Numer zamówienia - tylko podgląd (serwer auto-przypisuje) -->
            <v-col cols="12" md="6">
              <!-- TRYB TWORZENIA: Pokaż podgląd auto-generowanego numeru -->
              <v-text-field
                v-if="!isEditing"
                :model-value="nextNumberPreview"
                label="Numer zamówienia"
                variant="outlined"
                prepend-inner-icon="mdi-pound"
                readonly
                :loading="loadingNumber"
                hint="Automatycznie przydzielany przez system"
                persistent-hint
                bg-color="grey-lighten-4"
              >
                <template v-slot:append-inner>
                  <v-tooltip text="Odśwież podgląd numeru">
                    <template v-slot:activator="{ props: tooltipProps }">
                      <v-btn
                        v-bind="tooltipProps"
                        icon="mdi-refresh"
                        size="small"
                        variant="text"
                        color="grey"
                        :loading="loadingNumber"
                        @click="fetchNextNumber"
                      />
                    </template>
                  </v-tooltip>
                </template>
              </v-text-field>

              <!-- TRYB EDYCJI: Pokaż bieżący numer jako read-only -->
              <v-text-field
                v-else
                :model-value="order?.order_number"
                label="Numer zamówienia"
                variant="outlined"
                prepend-inner-icon="mdi-pound"
                readonly
                bg-color="grey-lighten-4"
                hint="Numer zamówienia nie może być zmieniony"
                persistent-hint
              />
            </v-col>

            <!-- Data realizacji -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.planned_delivery_date"
                label="Planowana data realizacji *"
                type="date"
                variant="outlined"
                prepend-inner-icon="mdi-calendar"
                :rules="[rules.required]"
              />
            </v-col>

            <!-- Klient -->
            <v-col cols="12">
              <v-autocomplete
                v-model="form.customer_id"
                :items="customers"
                item-title="name"
                item-value="id"
                label="Klient *"
                prepend-inner-icon="mdi-account"
                variant="outlined"
                :rules="[rules.required]"
                :loading="loadingCustomers"
                placeholder="Wybierz lub wyszukaj klienta..."
                no-data-text="Brak klientów. Dodaj nowego!"
                clearable
                :custom-filter="filterCustomers"
              >
                <template v-slot:item="{ item, props }">
                  <v-list-item v-bind="props">
                    <template v-slot:prepend>
                      <v-avatar
                        :color="item.raw.type === 'B2B' ? 'blue' : 'purple'"
                        size="32"
                      >
                        <v-icon size="small" color="white">
                          {{ item.raw.type === "B2B" ? "mdi-domain" : "mdi-account" }}
                        </v-icon>
                      </v-avatar>
                    </template>
                    <template v-slot:subtitle>
                      <span>{{ item.raw.type }}</span>
                      <span v-if="item.raw.nip"> • NIP: {{ item.raw.nip }}</span>
                    </template>
                  </v-list-item>
                </template>

                <template v-slot:selection="{ item }">
                  <v-chip
                    size="small"
                    :color="item.raw.type === 'B2B' ? 'blue' : 'purple'"
                  >
                    <v-icon start size="small">
                      {{ item.raw.type === "B2B" ? "mdi-domain" : "mdi-account" }}
                    </v-icon>
                    {{ item.raw.name }}
                  </v-chip>
                </template>

                <template v-slot:append>
                  <v-tooltip text="Dodaj nowego klienta">
                    <template v-slot:activator="{ props }">
                      <v-btn
                        v-bind="props"
                        icon="mdi-account-plus"
                        color="success"
                        variant="flat"
                        rounded="sm"
                        height="56"
                        width="56"
                        class="ml-2"
                        @click="openCustomerDialog"
                      />
                    </template>
                  </v-tooltip>
                </template>
              </v-autocomplete>

              <v-expand-transition>
                <v-alert
                  v-if="selectedCustomer"
                  type="info"
                  variant="tonal"
                  density="compact"
                  class="mt-2"
                >
                  <div class="d-flex align-center">
                    <div>
                      <strong>{{ selectedCustomer.name }}</strong>
                      <div class="text-caption">
                        {{
                          selectedCustomer.nip
                            ? "NIP: " + selectedCustomer.nip
                            : "E-mail: " + selectedCustomer.email
                        }}
                      </div>
                    </div>
                    <v-spacer />
                    <v-chip
                      size="x-small"
                      :color="selectedCustomer.type === 'B2B' ? 'blue' : 'purple'"
                    >
                      {{ selectedCustomer.type }}
                    </v-chip>
                  </div>
                </v-alert>
              </v-expand-transition>
            </v-col>

            <!-- Opis (Brief) -->
            <v-col cols="12">
              <v-textarea
                v-model="form.description"
                label="Opis zamówienia *"
                prepend-inner-icon="mdi-text"
                variant="outlined"
                rows="4"
                :rules="[rules.required]"
                placeholder="Opisz szczegółowo czego potrzebuje klient: wymiary, materiały, kolory, ilości..."
                counter
                maxlength="2000"
              />
            </v-col>

            <!-- Priorytet -->
            <v-col cols="12" md="6">
              <v-select
                v-model="form.priority"
                label="Priorytet"
                prepend-inner-icon="mdi-flag"
                variant="outlined"
                :items="priorityOptions"
              />
            </v-col>
          </v-row>
        </v-card-text>

        <v-divider />

        <v-card-actions class="pa-4">
          <v-btn
            variant="text"
            color="grey"
            prepend-icon="mdi-close"
            @click="closeDialog"
            :disabled="saving"
          >
            Anuluj
          </v-btn>
          <v-spacer />
          <v-btn
            color="primary"
            variant="elevated"
            type="submit"
            :loading="saving"
            :disabled="!formValid"
            prepend-icon="mdi-content-save"
          >
            {{ isEditing ? "Zapisz zmiany" : "Utwórz zamówienie" }}
          </v-btn>
        </v-card-actions>
      </v-form>
    </v-card>
  </v-dialog>

  <customer-form-dialog
    v-model="customerDialog"
    :customer="null"
    @saved="handleCustomerSaved"
  />
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import CustomerFormDialog from "@/components/customers/CustomerFormDialog.vue";
import api from "@/services/api";
import { orderService } from "@/services/orderService";

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false,
  },
  order: {
    type: Object,
    default: null,
  },
  preselectedCustomerId: {
    type: Number,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

// ─── Stan formularza ──────────────────────────────────────────────────────────

const formRef = ref(null);
const formValid = ref(false);
const saving = ref(false);
const loadingNumber = ref(false);

// Podgląd auto-generowanego numeru (tylko informacyjny)
const nextNumberPreview = ref("Ładowanie...");

// Klienci
const customers = ref<any[]>([]);
const loadingCustomers = ref(false);

// Dialog klienta
const customerDialog = ref(false);

// Dane formularza (BEZ order_number — serwer przydziela automatycznie)
const defaultForm = () => ({
  customer_id: null as number | null,
  description: "",
  planned_delivery_date: "",
  priority: "normal",
});

const form = ref(defaultForm());

// ─── Opcje ────────────────────────────────────────────────────────────────────

const priorityOptions = [
  { title: "Niski", value: "low" },
  { title: "Normalny", value: "normal" },
  { title: "Wysoki", value: "high" },
  { title: "Pilny", value: "urgent" },
];

const rules = {
  required: (v: any) => !!v || "Pole wymagane",
};

// ─── Computed ─────────────────────────────────────────────────────────────────

const isEditing = computed(() => !!props.order);

const selectedCustomer = computed(() => {
  if (!form.value.customer_id) return null;
  return customers.value.find((c) => c.id === form.value.customer_id) || null;
});

// ─── Metody ───────────────────────────────────────────────────────────────────

/** Pobierz podgląd kolejnego numeru (tylko informacyjnie, bez rezerwacji) */
const fetchNextNumber = async () => {
  if (isEditing.value) return;
  loadingNumber.value = true;
  try {
    nextNumberPreview.value = await orderService.getNextNumber();
  } catch (err) {
    console.error("Błąd pobierania numeru:", err);
    nextNumberPreview.value = "Auto";
  } finally {
    loadingNumber.value = false;
  }
};

/** Pobierz listę klientów */
const fetchCustomers = async () => {
  try {
    loadingCustomers.value = true;
    const response = await api.get("/customers/for-select");
    customers.value = response.data || [];
  } catch (error) {
    console.error("Błąd pobierania klientów:", error);
    try {
      const fallbackResponse = await api.get("/customers", {
        params: { is_active: true },
      });
      customers.value = fallbackResponse.data?.data || fallbackResponse.data || [];
    } catch {
      customers.value = [];
    }
  } finally {
    loadingCustomers.value = false;
  }
};

/** Customowy filtr: Nazwa LUB NIP */
const filterCustomers = (itemTitle: string, queryText: string, item: any) => {
  const text = queryText.toLowerCase();
  const name = item.raw.name.toLowerCase();
  const nip = item.raw.nip ? item.raw.nip.replace(/-/g, "") : "";
  return name.includes(text) || nip.includes(text.replace(/-/g, ""));
};

/** Otwórz dialog tworzenia klienta */
const openCustomerDialog = () => {
  customerDialog.value = true;
};

/** Po zapisaniu nowego klienta: odśwież listę i zaznacz go */
const handleCustomerSaved = async (savedCustomer: any) => {
  await fetchCustomers();
  if (savedCustomer?.data?.id) {
    form.value.customer_id = savedCustomer.data.id;
  } else {
    // Fallback: wybierz ostatnio dodanego
    const newestCustomer = customers.value.reduce(
      (max: any, c: any) => (c.id > max.id ? c : max),
      customers.value[0]
    );
    if (newestCustomer) {
      form.value.customer_id = newestCustomer.id;
    }
  }
};

/** Zamknij dialog */
const closeDialog = () => {
  emit("update:modelValue", false);
};

/** Zapisz zamówienie */
const saveOrder = async () => {
  const { valid } = await formRef.value!.validate();
  if (!valid) return;

  try {
    saving.value = true;

    // Payload BEZ order_number (serwer przydziela automatycznie przy tworzeniu)
    const data = {
      customer_id: form.value.customer_id,
      description: form.value.description,
      planned_delivery_date: form.value.planned_delivery_date,
      priority: form.value.priority,
    };

    if (isEditing.value) {
      // Przy edycji: wysyłamy bez order_number (nie może być zmieniony)
      await api.put(`/orders/${props.order!.id}`, data);
    } else {
      // Przy tworzeniu: serwer auto-generuje order_number
      await api.post("/orders", data);
    }

    emit("saved");
    closeDialog();
  } catch (error: any) {
    if (error.response?.status === 422 && error.response.data.errors) {
      const errors = error.response.data.errors;
      const messages = Object.values(errors).flat().join("\n");
      alert("Błąd walidacji:\n" + messages);
    } else {
      alert(
        error.response?.data?.message || "Wystąpił błąd podczas zapisywania zamówienia"
      );
    }
  } finally {
    saving.value = false;
  }
};

// ─── Watchery ─────────────────────────────────────────────────────────────────

/** Wypełnij formularz przy edycji */
watch(
  () => props.order,
  (newVal) => {
    if (newVal) {
      form.value = {
        customer_id: newVal.customer_id || null,
        description: newVal.description || "",
        planned_delivery_date: newVal.planned_delivery_date || "",
        priority: newVal.priority || "normal",
      };
    } else {
      form.value = defaultForm();
      // Domyślna data: dziś + 14 dni
      const date = new Date();
      date.setDate(date.getDate() + 14);
      form.value.planned_delivery_date = date.toISOString().split("T")[0];

      if (props.preselectedCustomerId) {
        form.value.customer_id = props.preselectedCustomerId;
      }
    }
  },
  { immediate: true }
);

/** Inicjalizuj przy otwarciu dialogu */
watch(
  () => props.modelValue,
  async (isOpen) => {
    if (isOpen) {
      await fetchCustomers();

      if (!props.order) {
        // Nowe zamówienie: ustaw domyślne wartości
        form.value = defaultForm();
        const date = new Date();
        date.setDate(date.getDate() + 14);
        form.value.planned_delivery_date = date.toISOString().split("T")[0];

        if (props.preselectedCustomerId) {
          form.value.customer_id = props.preselectedCustomerId;
        }

        formRef.value?.resetValidation();

        // Pobierz podgląd numeru
        await fetchNextNumber();
      }
    }
  }
);
</script>


=================================================================================
FILE: src/components/orders/OrderSidebar.vue
LOCATION: .//src/components/orders/OrderSidebar.vue
=================================================================================

<template>
  <div class="sticky-sidebar">
    <!-- ─── Szczegóły zamówienia ─── -->
    <v-card elevation="1" class="mb-4 bg-white border">
      <v-card-title class="d-flex align-center pb-2">
        <v-icon start size="small" color="primary">mdi-information-outline</v-icon>
        Szczegóły
      </v-card-title>
      <v-divider class="mb-2 mx-4" />

      <v-card-text class="pa-4 pt-0">
        <!-- Status -->
        <div class="detail-row">
          <div class="label">Status</div>
          <div class="value">
            <v-select
              :model-value="order.overall_status"
              :items="metadataStore.orderStatuses"
              item-title="label"
              item-value="value"
              density="compact"
              variant="outlined"
              hide-details
              :loading="inlineLoading === 'overall_status'"
              class="status-select"
              @update:model-value="(val) => $emit('update-inline', 'overall_status', val)"
            >
              <template v-slot:selection="{ item }">
                <div
                  class="d-flex align-center"
                  :class="`text-${formatOrderStatus(item.value).color}`"
                >
                  <v-icon size="small" class="mr-2">{{
                    formatOrderStatus(item.value).icon
                  }}</v-icon>
                  <span class="font-weight-bold" style="font-size: 0.85rem">
                    {{ formatOrderStatus(item.value).label }}
                  </span>
                </div>
              </template>
              <template v-slot:item="{ props: itemProps, item }">
                <v-list-item v-bind="itemProps" density="compact">
                  <template v-slot:title>
                    <div class="d-flex align-center">
                      <v-icon
                        :color="formatOrderStatus(item.value).color"
                        size="small"
                        class="mr-2"
                      >
                        {{ formatOrderStatus(item.value).icon }}
                      </v-icon>
                      <span style="font-size: 0.95rem; color: rgba(0, 0, 0, 0.87)">
                        {{ formatOrderStatus(item.value).label }}
                      </span>
                    </div>
                  </template>
                </v-list-item>
              </template>
            </v-select>
          </div>
        </div>

        <!-- Płatność -->
        <div class="detail-row">
          <div class="label">Płatność</div>
          <div class="value">
            <v-select
              :model-value="order.payment_status"
              :items="metadataStore.paymentStatuses"
              item-title="label"
              item-value="value"
              density="compact"
              variant="outlined"
              hide-details
              :loading="inlineLoading === 'payment_status'"
              class="status-select"
              @update:model-value="(val) => $emit('update-inline', 'payment_status', val)"
            >
              <template v-slot:selection="{ item }">
                <div
                  class="d-flex align-center"
                  :class="`text-${formatPaymentStatus(item.value).color}`"
                >
                  <v-icon size="small" class="mr-2">{{
                    formatPaymentStatus(item.value).icon
                  }}</v-icon>
                  <span class="font-weight-bold" style="font-size: 0.85rem">
                    {{ formatPaymentStatus(item.value).label }}
                  </span>
                </div>
              </template>
              <template v-slot:item="{ props: itemProps, item }">
                <v-list-item v-bind="itemProps" density="compact">
                  <template v-slot:title>
                    <div class="d-flex align-center">
                      <v-icon
                        :color="formatPaymentStatus(item.value).color"
                        size="small"
                        class="mr-2"
                      >
                        {{ formatPaymentStatus(item.value).icon }}
                      </v-icon>
                      <span style="font-size: 0.95rem; color: rgba(0, 0, 0, 0.87)">
                        {{ formatPaymentStatus(item.value).label }}
                      </span>
                    </div>
                  </template>
                </v-list-item>
              </template>
            </v-select>
          </div>
        </div>

        <!-- Priorytet -->
        <div class="detail-row">
          <div class="label">Priorytet</div>
          <div class="value">
            <v-select
              :model-value="String(order.priority || 'normal').toLowerCase()"
              :items="metadataStore.orderPriorities"
              item-title="label"
              item-value="value"
              density="compact"
              variant="outlined"
              hide-details
              :loading="inlineLoading === 'priority'"
              class="status-select"
              @update:model-value="(val) => $emit('update-inline', 'priority', val)"
            >
              <template v-slot:selection="{ item }">
                <div
                  class="d-flex align-center"
                  :class="`text-${formatPriority(item.value).color}`"
                >
                  <v-icon size="small" class="mr-2">{{
                    formatPriority(item.value).icon
                  }}</v-icon>
                  <span class="font-weight-bold" style="font-size: 0.85rem">
                    {{ formatPriority(item.value).label }}
                  </span>
                </div>
              </template>
              <template v-slot:item="{ props: itemProps, item }">
                <v-list-item v-bind="itemProps" density="compact">
                  <template v-slot:title>
                    <div class="d-flex align-center">
                      <v-icon
                        :color="formatPriority(item.value).color"
                        size="small"
                        class="mr-2"
                      >
                        {{ formatPriority(item.value).icon }}
                      </v-icon>
                      <span style="font-size: 0.95rem; color: rgba(0, 0, 0, 0.87)">
                        {{ formatPriority(item.value).label }}
                      </span>
                    </div>
                  </template>
                </v-list-item>
              </template>
            </v-select>
          </div>
        </div>

        <!-- Data utworzenia (Readonly) -->
        <div class="detail-row">
          <div class="label">Utworzone</div>
          <div class="value font-weight-medium">
            {{ formatDate(order.created_at) }}
          </div>
        </div>

        <!-- Termin realizacji -->
        <div class="detail-row">
          <div class="label">Termin realizacji</div>
          <div class="value">
            <inline-edit-field
              :model-value="
                order.planned_delivery_date
                  ? order.planned_delivery_date.slice(0, 10)
                  : ''
              "
              type="date"
              :loading="inlineLoading === 'planned_delivery_date'"
              :show-edit-icon="true"
              icon-position="left"
              @save="
                (val) => $emit('update-inline', 'planned_delivery_date', val || null)
              "
            >
              <template #display="{ value }">
                <span
                  class="font-weight-bold"
                  :class="value ? 'text-error' : 'text-medium-emphasis'"
                >
                  {{ formatDate(value) || "Nie ustalono" }}
                </span>
              </template>
            </inline-edit-field>
          </div>
        </div>
      </v-card-text>
    </v-card>

    <!-- ─── Klient ─── -->
    <v-card v-if="order.customer" elevation="1" class="mb-4 bg-white border">
      <v-card-title class="d-flex align-center pb-2">
        <v-icon start size="small" color="primary">mdi-account-outline</v-icon>
        Klient
      </v-card-title>
      <v-divider class="mb-2 mx-4" />

      <v-card-text class="pa-4 pt-0">
        <div class="detail-row">
          <div class="label">Nazwa</div>
          <div class="value">
            <router-link
              :to="`/customers/${order.customer.id}`"
              class="text-decoration-none text-primary font-weight-bold"
            >
              {{ order.customer.name }}
            </router-link>
          </div>
        </div>

        <div class="detail-row">
          <div class="label">Typ</div>
          <div class="value">
            <v-chip size="x-small" variant="tonal">
              {{ order.customer.type }}
            </v-chip>
          </div>
        </div>

        <div v-if="order.customer.email" class="detail-row">
          <div class="label">Email</div>
          <div class="value text-truncate text-caption">
            {{ order.customer.email }}
          </div>
        </div>

        <div v-if="order.customer.phone" class="detail-row">
          <div class="label">Telefon</div>
          <div class="value text-caption">
            {{ order.customer.phone }}
          </div>
        </div>
      </v-card-text>
    </v-card>
  </div>
</template>

<script setup lang="ts">
import { defineProps, defineEmits } from "vue";
import InlineEditField from "@/components/common/InlineEditField.vue";
import { useMetadataStore } from "@/stores/metadata";
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const props = defineProps<{
  order: any;
  inlineLoading: string | null;
}>();

defineEmits(["update-inline"]);

const metadataStore = useMetadataStore();
const { formatOrderStatus, formatPaymentStatus, formatPriority } = useStatusFormatter();

const formatDate = (date: string | null): string | null => {
  if (!date) return null;
  return new Date(date).toLocaleDateString("pl-PL");
};
</script>

<style scoped>
.sticky-sidebar {
  position: sticky;
  top: 80px;
  z-index: 1;
}

/* Klasy dla nowych, wbudowanych Selectów */
.status-select {
  max-width: 180px;
  width: 100%;
}
.status-select :deep(.v-field__input) {
  min-height: 32px;
  padding-top: 4px;
  padding-bottom: 4px;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #f5f5f5;
  min-height: 32px;
}

.detail-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.detail-row .label {
  font-size: 0.85rem;
  color: rgba(0, 0, 0, 0.6);
  font-weight: 500;
  min-width: 110px;
  flex-shrink: 0;
}

.detail-row .value {
  font-size: 0.95rem;
  font-weight: 500;
  text-align: right;
  flex-grow: 1;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  word-break: break-word;
}

.text-truncate {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  max-width: 100%;
}
</style>


=================================================================================
FILE: src/components/orders/OrderVariantsGrid.vue
LOCATION: .//src/components/orders/OrderVariantsGrid.vue
=================================================================================

<template>
  <v-card elevation="2" class="mb-6 rounded-lg overflow-hidden">
    <!-- ══ Nagłówek ══ -->
    <v-card-title class="bg-indigo text-white d-flex align-center py-3 px-4">
      <v-icon start color="white">mdi-format-list-bulleted-type</v-icon>
      Warianty ({{ variantsCount }})
      <v-spacer />
      <!-- Rozwiń / Zwiń wszystkie (tylko gdy są grupy) -->
      <v-btn
        v-if="hasAnyGroup"
        size="small"
        color="white"
        variant="text"
        :prepend-icon="allExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down'"
        class="mr-1 text-caption"
        @click="toggleAll"
      >
        {{ allExpanded ? "Zwiń" : "Rozwiń" }}
      </v-btn>
      <!-- Dodaj nową grupę -->
      <v-btn
        size="small"
        color="white"
        variant="outlined"
        prepend-icon="mdi-folder-plus"
        class="mr-2"
        @click="$emit('add-group')"
      >
        Dodaj grupę
      </v-btn>
    </v-card-title>

    <!-- ══ Drzewo ══ -->
    <div v-if="flatTree.length > 0">
      <template
        v-for="(node, index) in flatTree"
        :key="node.isEmpty ? 'empty-' + node.variant.id : node.variant.id"
      >
        <!-- ──────────────────────────────────────────────
             ROW: GRUPA  (is_group=true)
        ────────────────────────────────────────────── -->
        <template v-if="node.isGroup">
          <div
            class="group-row"
            :style="{ paddingLeft: groupIndent(node.depth) }"
            @click="toggleGroup(node.variant.id)"
          >
            <!-- Strzałka rozwijania -->
            <v-icon
              class="expand-icon"
              :class="{ 'expand-icon--open': isExpanded(node.variant.id) }"
              size="18"
              color="indigo"
            >
              mdi-chevron-right
            </v-icon>

            <!-- Folder icon -->
            <v-icon
              :color="isExpanded(node.variant.id) ? 'indigo' : 'indigo-lighten-2'"
              class="mr-2"
              size="20"
            >
              {{ isExpanded(node.variant.id) ? "mdi-folder-open" : "mdi-folder" }}
            </v-icon>

            <!-- Badge grupy -->
            <div
              class="group-badge mr-3"
              :style="{ background: badgeColor(node.variant.variant_number) }"
            >
              {{ node.variant.variant_number }}
            </div>

            <!-- Nazwa grupy -->
            <div class="group-info flex-grow-1">
              <span class="group-name">{{ node.variant.name }}</span>
              <span class="group-children-count ml-2">
                ({{ directChildCount(node.variant.id) }})
              </span>
            </div>

            <!-- Akcje grupy -->
            <div class="group-actions" @click.stop>
              <!-- Dodaj wariant do grupy -->
              <v-btn
                size="x-small"
                color="indigo"
                variant="tonal"
                prepend-icon="mdi-plus"
                class="mr-1"
                @click="$emit('add-child', node.variant)"
              >
                Wariant
              </v-btn>

              <!-- Menu grupy -->
              <v-menu location="bottom end" :close-on-content-click="true">
                <template #activator="{ props: menuProps }">
                  <v-btn
                    v-bind="menuProps"
                    icon="mdi-dots-vertical"
                    variant="text"
                    size="small"
                    color="grey-darken-1"
                  />
                </template>
                <v-list density="compact" elevation="3" min-width="180">
                  <v-list-item
                    prepend-icon="mdi-pencil"
                    @click="$emit('edit', node.variant)"
                  >
                    <v-list-item-title>Edytuj grupę</v-list-item-title>
                  </v-list-item>
                  <v-list-item
                    prepend-icon="mdi-content-copy"
                    class="text-deep-purple"
                    @click="$emit('duplicate', node.variant)"
                  >
                    <v-list-item-title>Duplikuj grupę</v-list-item-title>
                  </v-list-item>
                  <v-divider />
                  <v-list-item
                    v-if="directChildCount(node.variant.id) === 0"
                    prepend-icon="mdi-delete"
                    class="text-error"
                    @click="$emit('delete', node.variant)"
                  >
                    <v-list-item-title>Usuń grupę</v-list-item-title>
                  </v-list-item>
                  <v-list-item
                    v-else
                    prepend-icon="mdi-delete-sweep"
                    class="text-error"
                    @click="$emit('delete-group-force', node.variant)"
                  >
                    <v-list-item-title>Usuń grupę z wariantami</v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
            </div>
          </div>
          <v-divider />
        </template>

        <!-- ──────────────────────────────────────────────
             ROW: PUSTA GRUPA (placeholder)
        ────────────────────────────────────────────── -->
        <template v-else-if="node.isEmpty">
          <div
            class="empty-group-row"
            :style="{ paddingLeft: variantIndent(node.depth) }"
          >
            <v-icon size="18" color="grey-lighten-1" class="mr-2"
              >mdi-folder-open-outline</v-icon
            >
            <span class="empty-group-text">Brak wariantów w grupie</span>
            <v-btn
              size="x-small"
              color="indigo"
              variant="text"
              prepend-icon="mdi-plus"
              class="ml-3 font-weight-bold"
              @click="$emit('add-child', node.variant)"
            >
              Dodaj
            </v-btn>
          </div>
          <v-divider />
        </template>

        <!-- ──────────────────────────────────────────────
             ROW: WARIANT (is_group=false)
        ────────────────────────────────────────────── -->
        <template v-else>
          <div
            class="variant-row"
            :style="{ paddingLeft: variantIndent(node.depth) }"
            @click="$emit('view', node.variant.id)"
          >
            <!-- Linia drzewa + strzałka dziecka -->
            <div class="tree-connector" v-if="node.depth > 0">
              <!-- Pionowe/poziome linie drzewa generowane CSS'em przez wcięcie -->
              <span class="child-arrow">↳</span>
            </div>

            <!-- Badge wariantu -->
            <div
              class="variant-badge mr-3"
              :style="{
                background: badgeColor(node.variant.variant_number),
                fontSize: badgeFontSize(node.variant.variant_number),
              }"
            >
              {{ node.variant.variant_number }}
            </div>

            <!-- Nazwa + opis -->
            <div class="info-col">
              <div class="variant-name">
                {{ node.variant.name }}
                <v-chip
                  size="x-small"
                  :color="node.variant.type === 'PROTOTYPE' ? 'orange' : 'blue'"
                  variant="tonal"
                  class="ml-1 flex-shrink-0"
                >
                  <v-icon start size="10">
                    {{
                      node.variant.type === "PROTOTYPE"
                        ? "mdi-flask-outline"
                        : "mdi-factory"
                    }}
                  </v-icon>
                  {{ node.variant.type === "PROTOTYPE" ? "PROTOTYP" : "SERYJNA" }}
                </v-chip>
              </div>
              <div class="variant-desc">{{ node.variant.description || "—" }}</div>
            </div>

            <!-- Prawa kolumna -->
            <div class="append-col" @click.stop>
              <!-- Ilość -->
              <div class="quantity-block">
                <div class="quantity-label">ILOŚĆ</div>
                <div class="quantity-value">{{ node.variant.quantity }} szt.</div>
              </div>

              <!-- Status -->
              <v-chip
                :color="formatVariantStatus(node.variant.status).color"
                size="small"
                variant="flat"
                class="d-none d-sm-flex"
              >
                <v-icon start size="12">
                  {{ formatVariantStatus(node.variant.status).icon }}
                </v-icon>
                {{ formatVariantStatus(node.variant.status).label }}
              </v-chip>

              <!-- Menu wariantu -->
              <v-menu location="bottom end" :close-on-content-click="true">
                <template #activator="{ props: menuProps }">
                  <v-btn
                    v-bind="menuProps"
                    icon="mdi-dots-vertical"
                    variant="text"
                    size="small"
                    color="grey-darken-1"
                  />
                </template>
                <v-list density="compact" elevation="3" min-width="180">
                  <v-list-item
                    prepend-icon="mdi-eye"
                    @click="$emit('view', node.variant.id)"
                  >
                    <v-list-item-title>Szczegóły</v-list-item-title>
                  </v-list-item>
                  <v-list-item
                    prepend-icon="mdi-pencil"
                    @click="$emit('edit', node.variant)"
                  >
                    <v-list-item-title>Edytuj</v-list-item-title>
                  </v-list-item>
                  <!-- Dodaj podwariant -->
                  <v-list-item
                    prepend-icon="mdi-source-branch-plus"
                    @click="$emit('add-child', node.variant)"
                  >
                    <v-list-item-title>Dodaj podwariant</v-list-item-title>
                  </v-list-item>
                  <v-list-item
                    prepend-icon="mdi-content-copy"
                    class="text-deep-purple"
                    @click="$emit('duplicate', node.variant)"
                  >
                    <v-list-item-title>Duplikuj</v-list-item-title>
                  </v-list-item>
                  <v-divider />
                  <v-list-item
                    prepend-icon="mdi-delete"
                    class="text-error"
                    @click="$emit('delete', node.variant)"
                  >
                    <v-list-item-title>Usuń</v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
            </div>
          </div>
          <v-divider v-if="index < flatTree.length - 1" />
        </template>
      </template>
    </div>

    <!-- ══ Stan pusty ══ -->
    <v-card-text v-else class="text-center py-12">
      <v-icon size="64" color="grey-lighten-2">mdi-format-list-bulleted-type</v-icon>
      <div class="text-h6 text-grey mt-4">Brak wariantów</div>
      <p class="text-medium-emphasis mt-2">
        Zacznij od dodania grupy, w której umieścisz warianty produktu.
      </p>
      <v-btn
        color="indigo"
        variant="elevated"
        prepend-icon="mdi-folder-plus"
        size="large"
        class="mt-4"
        @click="$emit('add-group')"
      >
        Dodaj pierwszą grupę
      </v-btn>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const { formatVariantStatus } = useStatusFormatter();

// ─── Props / Emits ────────────────────────────────────────────────────────────

const props = defineProps<{
  variants: any[];
}>();

defineEmits([
  "add-group", // Dodaj nową grupę top-level
  "add-child", // Dodaj wariant do grupy/wariantu (payload: parent variant)
  "view", // Przejdź do widoku wariantu (payload: id)
  "edit", // Edytuj grupę lub wariant (payload: variant)
  "duplicate", // Duplikuj (payload: variant)
  "delete", // Usuń wariant lub pustą grupę (payload: variant)
  "delete-group-force", // Usuń grupę z wszystkimi dziećmi (payload: group variant)
]);

// ─── Expanded state (grupy domyślnie rozwinięte) ──────────────────────────────

/**
 * Zestaw ID grup, które są ROZWINIĘTE.
 * Domyślnie zawiera wszystkie grupy — rozwinięte od startu.
 */
const expandedGroups = ref<Set<number>>(new Set());

/**
 * Gdy lista wariantów się zmieni, automatycznie rozwiń nowe grupy.
 * Istniejące grupy zachowują swój stan (nie resetujemy).
 */
watch(
  () => props.variants,
  (variants) => {
    if (!variants) return;
    variants
      .filter((v) => v.is_group === true)
      .forEach((g) => {
        // Dodaj do expanded TYLKO jeśli jeszcze nie ma (nie resetuj ręcznych zwiniętych)
        if (!expandedGroups.value.has(g.id)) {
          expandedGroups.value.add(g.id);
        }
      });
  },
  { immediate: true, deep: false }
);

const isExpanded = (groupId: number): boolean => expandedGroups.value.has(groupId);

const toggleGroup = (groupId: number) => {
  if (expandedGroups.value.has(groupId)) {
    expandedGroups.value.delete(groupId);
  } else {
    expandedGroups.value.add(groupId);
  }
  // Wymuszamy reaktywność (Set nie jest reaktywny bez tego triku)
  expandedGroups.value = new Set(expandedGroups.value);
};

const hasAnyGroup = computed(() =>
  (props.variants ?? []).some((v) => v.is_group === true)
);

const allExpanded = computed(() => {
  const groups = (props.variants ?? []).filter((v) => v.is_group === true);
  return groups.every((g) => expandedGroups.value.has(g.id));
});

const toggleAll = () => {
  const groups = (props.variants ?? []).filter((v) => v.is_group === true);
  if (allExpanded.value) {
    // Zwiń wszystkie
    groups.forEach((g) => expandedGroups.value.delete(g.id));
  } else {
    // Rozwiń wszystkie
    groups.forEach((g) => expandedGroups.value.add(g.id));
  }
  expandedGroups.value = new Set(expandedGroups.value);
};

// ─── Budowanie spłaszczonego drzewa ──────────────────────────────────────────

/**
 * Węzeł w spłaszczonym drzewie.
 * depth=0 to top-level (grupy lub warianty bez grupy).
 */
interface FlatNode {
  variant: any;
  depth: number;
  isGroup: boolean;
  isEmpty?: boolean; // true gdy to wiersz "Brak wariantów w grupie"
}

/**
 * Zbuduj spłaszczone drzewo zachowując kolejność i wcięcia.
 *
 * Algorytm:
 * 1. Wyciągnij top-level (parent_variant_id=null), posortuj po variant_number
 * 2. Dla każdego węzła rekurencyjnie wstaw dzieci (jeśli expanded)
 * 3. Węzły niewidoczne (rodzic zwinięty) nie trafiają do wynikowej tablicy
 *
 * Obsługuje dowolną głębokość: A → A1 → A1_1 → A1_1_1 → ...
 */
const flatTree = computed<FlatNode[]>(() => {
  if (!props.variants?.length) return [];

  const result: FlatNode[] = [];

  function walk(parentId: number | null, depth: number) {
    const children = (props.variants ?? [])
      .filter((v) => (v.parent_variant_id ?? null) === parentId)
      .sort((a, b) =>
        a.variant_number.localeCompare(b.variant_number, "pl", { numeric: true })
      );

    for (const variant of children) {
      const isGroup = variant.is_group === true;
      result.push({ variant, depth, isGroup });

      // Wejdź w głąb tylko jeśli:
      //   a) to nie jest grupa (wariant ma dzieci podwariantów)
      //   b) to jest grupa I jest rozwinięta
      const shouldExpand = !isGroup || isExpanded(variant.id);
      if (shouldExpand) {
        const childrenExist = (props.variants ?? []).some(
          (v) => v.parent_variant_id === variant.id
        );
        if (isGroup && !childrenExist) {
          result.push({ variant, depth: depth + 1, isGroup: false, isEmpty: true });
        } else {
          walk(variant.id, depth + 1);
        }
      }
    }
  }

  walk(null, 0);
  return result;
});

// ─── Liczniki ─────────────────────────────────────────────────────────────────

/** Liczba wszystkich wariantów (bez grup) */
const variantsCount = computed(
  () => (props.variants ?? []).filter((v) => v.is_group !== true).length
);

/** Liczba bezpośrednich dzieci danego węzła */
const directChildCount = (parentId: number): number =>
  (props.variants ?? []).filter((v) => v.parent_variant_id === parentId).length;

// ─── Kolorowanie badge według głębokości ─────────────────────────────────────

/**
 * Kolor badge zależy od GŁĘBOKOŚCI w drzewie (depth):
 *   depth 0 → indigo      (A, B, C — grupy top-level)
 *   depth 1 → teal        (A1, B2 — warianty w grupach)
 *   depth 2 → deep-orange (A1_1 — podwarianty)
 *   depth 3+ → purple     (A1_1_1 i głębiej)
 *
 * Uwaga: głębokość odczytujemy z FlatNode, nie z variant_number!
 */
const DEPTH_COLORS: Record<number, string> = {
  0: "#3F51B5", // indigo
  1: "#009688", // teal
  2: "#F4511E", // deep-orange
  3: "#7B1FA2", // purple
};

function badgeColor(variantNumber: string): string {
  // Głębokość obliczona ze struktury numeru (jako fallback gdy brak depth)
  const depth = depthFromNumber(variantNumber);
  return DEPTH_COLORS[Math.min(depth, 3)] ?? "#9E9E9E";
}

function depthFromNumber(num: string): number {
  if (!num) return 0;
  const underscores = (num.match(/_/g) ?? []).length;
  if (underscores > 0) return underscores + 1;
  if (/^[A-Z]\d/i.test(num)) return 1;
  return 0;
}

function badgeFontSize(num: string): string {
  const len = num?.length ?? 0;
  if (len <= 1) return "1.1rem";
  if (len <= 2) return "0.95rem";
  if (len <= 4) return "0.8rem";
  if (len <= 6) return "0.7rem";
  return "0.62rem";
}

// ─── Wcięcia ─────────────────────────────────────────────────────────────────

/** Wcięcie poziome dla grup (px) */
function groupIndent(depth: number): string {
  // Każdy poziom = 20px dodatkowego wcięcia
  return `${16 + depth * 20}px`;
}

/** Wcięcie poziome dla wariantów (px) */
function variantIndent(depth: number): string {
  // Warianty mają trochę więcej bazowego wcięcia (space na strzałkę)
  return `${16 + depth * 20}px`;
}
</script>

<style scoped>
/* ═══════════════════════════════════════
   WIERSZ GRUPY
═══════════════════════════════════════ */
.group-row {
  display: flex;
  align-items: center;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-right: 12px;
  cursor: pointer;
  background: rgba(63, 81, 181, 0.04);
  border-left: 3px solid #3f51b5;
  transition: background 0.15s;
  min-height: 50px;
}

.group-row:hover {
  background: rgba(63, 81, 181, 0.09);
}

.expand-icon {
  transition: transform 0.2s ease;
  flex-shrink: 0;
  margin-right: 4px;
}

.expand-icon--open {
  transform: rotate(90deg);
}

.group-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  min-width: 36px;
  height: 36px;
  padding: 0 8px;
  white-space: nowrap;
  color: #fff;
  font-weight: 700;
  font-family: "Roboto Mono", "Courier New", monospace;
  font-size: 0.95rem;
  letter-spacing: -0.02em;
  flex-shrink: 0;
}

.group-info {
  display: flex;
  align-items: baseline;
  min-width: 0;
}

.group-name {
  font-weight: 600;
  font-size: 0.9rem;
  color: #3f51b5;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.group-children-count {
  font-size: 0.78rem;
  color: rgba(0, 0, 0, 0.42);
  flex-shrink: 0;
}

.group-actions {
  display: flex;
  align-items: center;
  flex-shrink: 0;
  gap: 4px;
}

/* ═══════════════════════════════════════
   WIERSZ WARIANTU
═══════════════════════════════════════ */
.variant-row {
  display: flex;
  align-items: center;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-right: 16px;
  cursor: pointer;
  border-left: 4px solid transparent;
  transition: background 0.15s, border-color 0.15s;
  min-height: 64px;
}

.variant-row:hover {
  background: rgba(0, 0, 0, 0.03);
  border-left-color: #3f51b5;
}

/* Connector drzewa */
.tree-connector {
  display: flex;
  align-items: center;
  flex-shrink: 0;
  margin-right: 4px;
}

.child-arrow {
  font-size: 1rem;
  color: #bbb;
  line-height: 1;
}

/* Badge wariantu (pill) */
.variant-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  min-width: 44px;
  height: 44px;
  padding: 0 10px;
  white-space: nowrap;
  color: #fff;
  font-weight: 700;
  font-family: "Roboto Mono", "Courier New", monospace;
  letter-spacing: -0.02em;
  line-height: 1;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.22);
  flex-shrink: 0;
  transition: transform 0.15s;
}

.variant-row:hover .variant-badge {
  transform: scale(1.06);
}

/* Kolumna środkowa */
.info-col {
  flex: 1;
  min-width: 0;
}

.variant-name {
  font-weight: 600;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 4px;
  line-height: 1.4;
}

.variant-desc {
  font-size: 0.8rem;
  color: rgba(0, 0, 0, 0.48);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Kolumna prawa */
.append-col {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  margin-left: 12px;
}

.quantity-block {
  text-align: right;
}

.quantity-label {
  font-size: 0.62rem;
  color: rgba(0, 0, 0, 0.42);
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

.quantity-value {
  font-weight: 700;
  font-size: 0.9rem;
  line-height: 1.2;
}
.empty-group-row {
  display: flex;
  align-items: center;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-right: 16px;
  min-height: 40px;
  background: rgba(0, 0, 0, 0.012);
}

.empty-group-text {
  font-size: 0.82rem;
  color: rgba(0, 0, 0, 0.38);
  font-style: italic;
}
</style>


=================================================================================
FILE: src/components/orders/PhaseChangeDialog.vue
LOCATION: .//src/components/orders/PhaseChangeDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="500"
  >
    <v-card>
      <v-card-title class="bg-primary text-white">
        <v-icon start color="white">mdi-timeline</v-icon>
        Zmień fazę wariantu
      </v-card-title>

      <v-card-text class="pt-6">
        <div class="mb-4">
          <div class="text-caption text-medium-emphasis">Wariant:</div>
          <div class="text-h6 font-weight-bold">
            {{ variant?.variant_number }} - {{ variant?.name }}
          </div>
        </div>

        <div class="mb-4">
          <div class="text-caption text-medium-emphasis">Obecna faza:</div>
          <v-chip :color="currentPhaseColor" class="mt-1">
            {{ currentPhaseLabel }}
          </v-chip>
        </div>

        <v-select
          v-model="selectedPhase"
          :items="availablePhases"
          item-title="label"
          item-value="value"
          label="Nowa faza *"
          variant="outlined"
          prepend-inner-icon="mdi-arrow-right"
        />

        <v-alert type="info" variant="tonal" class="mt-4">
          Zmiana fazy może wpłynąć na przepływ pracy całego zamówienia
        </v-alert>
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn @click="$emit('update:modelValue', false)">Anuluj</v-btn>
        <v-btn
          color="primary"
          variant="elevated"
          :loading="loading"
          :disabled="!selectedPhase || selectedPhase === variant?.status"
          @click="handleSubmit"
        >
          <v-icon start>mdi-check</v-icon>
          Zmień fazę
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useVariantsStore } from "@/stores/variants";
import { useMetadataStore } from "@/stores/metadata";

const props = defineProps({
  modelValue: Boolean,
  variant: Object, // ZMIANA: było line
});

const emit = defineEmits(["update:modelValue", "saved"]);

const variantsStore = useVariantsStore();
const metadataStore = useMetadataStore();
const loading = ref(false);
const selectedPhase = ref(null);

const availablePhases = computed(() => {
  // Pobierz statusy z metadata, odfiltruj obecny
  return metadataStore.orderStatuses.filter(
    (p) => p.value !== props.variant?.status
  );
});

const currentPhaseLabel = computed(() => {
  return metadataStore.getLabel("orderStatuses", props.variant?.status);
});

const currentPhaseColor = computed(() => {
  const colors: Record<string, string> = {
    QUOTATION: "blue",
    PROTOTYPE: "purple",
    PRODUCTION: "orange",
    DELIVERY: "cyan",
    COMPLETED: "green",
    CANCELLED: "red",
    DRAFT: "grey",
  };
  return colors[props.variant?.status] || "grey";
});

watch(
  () => props.modelValue,
  (newVal) => {
    if (newVal) {
      selectedPhase.value = null;
    }
  }
);

const handleSubmit = async () => {
  if (!selectedPhase.value) return;

  loading.value = true;
  try {
    await variantsStore.updatePhase(props.variant.id, selectedPhase.value);
    emit("saved");
    emit("update:modelValue", false);
  } catch (error: any) {
    console.error("Phase change error:", error);
    alert(
      "Błąd podczas zmiany fazy: " + (error.response?.data?.message || error.message)
    );
  } finally {
    loading.value = false;
  }
};
</script>


=================================================================================
FILE: src/components/orders/SeriesListPanel copy 2.vue
LOCATION: .//src/components/orders/SeriesListPanel copy 2.vue
=================================================================================

<template>
  <v-card elevation="2">
    <!-- Nagłówek -->
    <v-card-title class="bg-deep-purple-darken-1 text-white d-flex align-center pa-3">
      <v-icon start color="white" size="small">mdi-layers</v-icon>
      <span class="text-body-1 font-weight-bold">
        Serie zamówienia
        <span class="text-body-2 opacity-70 ml-1">{{ orderNumber }}</span>
      </span>
      <v-spacer />
      <v-progress-circular
        v-if="loading"
        indeterminate
        size="16"
        width="2"
        color="white"
      />
      <template v-else>
        <v-btn
          size="small"
          color="white"
          variant="outlined"
          prepend-icon="mdi-refresh"
          class="mr-2"
          @click="loadSeries"
        >
          Odśwież
        </v-btn>
        <v-btn
          size="small"
          color="white"
          variant="outlined"
          prepend-icon="mdi-plus"
          class="mr-2"
          @click="$emit('create-series')"
        >
          Dodaj
        </v-btn>
      </template>
    </v-card-title>

    <v-card-text class="pa-0">
      <!-- Skeleton loader -->
      <div v-if="loading" class="pa-3">
        <v-skeleton-loader
          v-for="i in 3"
          :key="i"
          type="list-item-two-line"
          class="mb-1"
        />
      </div>

      <!-- Brak serii -->
      <div v-else-if="series.length === 0" class="text-center pa-6 text-medium-emphasis">
        <v-icon size="32" color="grey">mdi-layers-off</v-icon>
        <p class="text-body-2 mt-2">Brak serii</p>
      </div>

      <!-- Lista serii -->
      <v-list v-else density="compact" class="pa-0">
        <v-list-item
          v-for="serie in series"
          :key="serie.id"
          :class="{
            'current-series': serie.id === currentOrderId,
            'other-series': serie.id !== currentOrderId,
          }"
          class="series-item px-3 py-2"
          @click="navigateToSeries(serie)"
        >
          <!-- Prefiks numeryczny serii -->
          <template v-slot:prepend>
            <span
              class="text-caption font-weight-bold mr-4"
              :class="
                serie.id === currentOrderId ? 'text-deep-purple' : 'text-grey-darken-2'
              "
            >
              #{{ serie.series }}
            </span>
          </template>

          <!-- Treść -->
          <v-list-item-title class="text-body-2">
            <span class="font-weight-bold">{{ serie.full_order_number }}</span>
          </v-list-item-title>
          <v-list-item-subtitle class="text-caption">
            <span v-if="serie.description" class="text-truncate">
              {{ serie.description }}
            </span>
            <span v-else class="text-medium-emphasis font-italic">Brak opisu</span>
          </v-list-item-subtitle>

          <!-- Status + data utworzenia -->
          <template v-slot:append>
            <div class="d-flex flex-column align-end">
              <v-chip
                :color="getStatusColor(serie.overall_status)"
                size="x-small"
                variant="tonal"
                class="mb-1"
              >
                {{ getStatusLabel(serie.overall_status) }}
              </v-chip>
              <span class="text-caption text-medium-emphasis">
                {{ formatDate(serie.created_at) }}
              </span>
            </div>
          </template>
        </v-list-item>
      </v-list>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from "vue";
import { useRouter } from "vue-router";
import { seriesService } from "@/services/seriesService";
import type { SeriesListItem } from "@/services/seriesService";
import { useMetadataStore } from "@/stores/metadata";

// ─── Props / Emits ────────────────────────────────────────────────────────────

const props = defineProps<{
  /** ID aktualnie wyświetlanego zamówienia */
  currentOrderId: number;
  /** Numer zamówienia do wyświetlenia (np. "Z/0001") */
  orderNumber?: string;
}>();

const emit = defineEmits<{
  "create-series": [];
  "series-changed": [orderId: number];
}>();

// ─── Instancje ────────────────────────────────────────────────────────────────

const router = useRouter();
const metadataStore = useMetadataStore();

// ─── Stan ─────────────────────────────────────────────────────────────────────

const series = ref<SeriesListItem[]>([]);
const loading = ref(false);

// ─── Lifecycle ────────────────────────────────────────────────────────────────

onMounted(() => {
  loadSeries();
});

watch(
  () => props.currentOrderId,
  () => {
    loadSeries();
  }
);

// ─── Metody ───────────────────────────────────────────────────────────────────

/** Załaduj listę serii */
const loadSeries = async () => {
  loading.value = true;
  try {
    series.value = await seriesService.getAllSeries(props.currentOrderId);
  } catch (err) {
    console.error("Błąd ładowania serii:", err);
    series.value = [];
  } finally {
    loading.value = false;
  }
};

/** Nawiguj do innej serii */
const navigateToSeries = (serie: SeriesListItem) => {
  if (serie.id === props.currentOrderId) return;
  emit("series-changed", serie.id);
  router.push(`/orders/${serie.id}`);
};

/** Kolor statusu zamówienia */
const getStatusColor = (status: string): string => {
  const config = metadataStore.getConfig("orderStatuses", status);
  return config?.color || "grey";
};

/** Etykieta statusu zamówienia */
const getStatusLabel = (status: string): string => {
  return metadataStore.getLabel("orderStatuses", status);
};

/** Formatuj datę jako DD.MM.YYYY */
const formatDate = (dateStr: string): string => {
  if (!dateStr) return "—";
  return new Date(dateStr).toLocaleDateString("pl-PL", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
};

// ─── Eksport ──────────────────────────────────────────────────────────────────

defineExpose({ loadSeries });
</script>

<style scoped>
.series-item {
  cursor: pointer;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  min-height: 56px;
}

.series-item:last-child {
  border-bottom: none;
}

.current-series {
  background-color: rgba(103, 58, 183, 0.06) !important;
}

.other-series:hover {
  background-color: rgba(0, 0, 0, 0.04) !important;
}
</style>


=================================================================================
FILE: src/components/orders/SeriesListPanel copy.vue
LOCATION: .//src/components/orders/SeriesListPanel copy.vue
=================================================================================

<template>
  <div class="series-panel">
    <!-- ── Nagłówek ── -->
    <div class="series-header">
      <div class="d-flex align-center gap-2">
        <v-icon size="15" color="deep-purple-lighten-2">mdi-layers</v-icon>
        <span
          class="text-caption font-weight-bold text-uppercase text-medium-emphasis"
          style="letter-spacing: 0.06em"
        >
          Serie zamówienia
        </span>
        <v-chip v-if="orderNumber" size="x-small" color="deep-purple" variant="tonal">
          {{ orderNumber }}
        </v-chip>
      </div>
      <v-btn
        :loading="loading"
        icon="mdi-refresh"
        size="x-small"
        variant="text"
        color="grey"
        @click="loadSeries"
      />
    </div>

    <!-- ── Skeleton ── -->
    <div v-if="loading" class="px-3 py-2">
      <v-skeleton-loader v-for="i in 3" :key="i" type="list-item-two-line" class="mb-1" />
    </div>

    <!-- ── Brak serii ── -->
    <div v-else-if="series.length === 0" class="empty-state">
      <v-icon size="30" color="grey-lighten-1">mdi-layers-off</v-icon>
      <span class="text-caption text-disabled mt-1">Brak serii</span>
    </div>

    <!-- ── Lista serii (oś czasu) ── -->
    <div v-else class="timeline-list">
      <div
        v-for="(serie, index) in series"
        :key="serie.id"
        class="timeline-row"
        :class="{
          'timeline-row--active': serie.id === currentOrderId,
          'timeline-row--clickable': serie.id !== currentOrderId,
        }"
        @click="navigateToSeries(serie)"
      >
        <!-- Pionowa oś czasu -->
        <div class="timeline-axis">
          <div
            class="timeline-dot"
            :class="
              serie.id === currentOrderId ? 'timeline-dot--active' : 'timeline-dot--idle'
            "
          />
          <div v-if="index < series.length - 1" class="timeline-line" />
        </div>

        <!-- Karta serii -->
        <div
          class="timeline-card"
          :class="{ 'timeline-card--active': serie.id === currentOrderId }"
        >
          <!-- Wiersz 1: numer + badge aktualnej + status -->
          <div class="d-flex align-center justify-space-between mb-1">
            <div class="d-flex align-center gap-1">
              <span
                class="text-body-2 font-weight-bold"
                :class="serie.id === currentOrderId ? 'text-deep-purple-darken-1' : ''"
              >
                {{ serie.full_order_number }}
              </span>
              <v-chip
                v-if="serie.id === currentOrderId"
                size="x-small"
                color="deep-purple"
                variant="flat"
                label
              >
                aktualna
              </v-chip>
            </div>

            <v-chip
              :color="getStatusColor(serie.overall_status)"
              size="x-small"
              variant="tonal"
            >
              {{ getStatusLabel(serie.overall_status) }}
            </v-chip>
          </div>

          <!-- Wiersz 2: opis + liczba wariantów -->
          <div class="d-flex align-center justify-space-between">
            <span
              class="text-caption text-medium-emphasis text-truncate"
              style="max-width: 155px"
              :title="serie.description || ''"
            >
              {{ serie.description || "Brak opisu" }}
            </span>
            <span class="text-caption text-disabled d-flex align-center">
              <v-icon size="11" class="mr-1">mdi-puzzle-outline</v-icon>
              {{ serie.variants_count }} war.
            </span>
          </div>

          <!-- Wiersz 3: data + strzałka nawigacji -->
          <div class="d-flex align-center justify-space-between mt-1">
            <span class="text-caption text-disabled">{{
              formatDate(serie.created_at)
            }}</span>
            <v-icon
              v-if="serie.id !== currentOrderId"
              class="nav-arrow"
              size="14"
              color="deep-purple-lighten-2"
            >
              mdi-arrow-right
            </v-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Stopka ── -->
    <div class="series-footer">
      <v-btn
        color="deep-purple"
        variant="tonal"
        size="small"
        prepend-icon="mdi-layers-plus"
        block
        @click="$emit('create-series')"
      >
        Nowa seria
      </v-btn>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from "vue";
import { useRouter } from "vue-router";
import { seriesService } from "@/services/seriesService";
import type { SeriesListItem } from "@/services/seriesService";
import { useMetadataStore } from "@/stores/metadata";

const props = defineProps<{
  currentOrderId: number;
  orderNumber?: string;
}>();

const emit = defineEmits<{
  "create-series": [];
  "series-changed": [orderId: number];
}>();

const router = useRouter();
const metaStore = useMetadataStore();
const series = ref<SeriesListItem[]>([]);
const loading = ref(false);

onMounted(loadSeries);
watch(() => props.currentOrderId, loadSeries);

async function loadSeries() {
  loading.value = true;
  try {
    series.value = await seriesService.getAllSeries(props.currentOrderId);
  } catch (e) {
    console.error("Błąd ładowania serii:", e);
    series.value = [];
  } finally {
    loading.value = false;
  }
}

/** Nawiguj do wybranej serii — router.push wywoła watch w OrderDetail */
function navigateToSeries(serie: SeriesListItem) {
  if (serie.id === props.currentOrderId) return;
  emit("series-changed", serie.id);
  router.push(`/orders/${serie.id}`);
}

function getStatusColor(status: string): string {
  return metaStore.getConfig("orderStatuses", status)?.color || "grey";
}

function getStatusLabel(status: string): string {
  return metaStore.getLabel("orderStatuses", status);
}

function formatDate(d: string): string {
  if (!d) return "—";
  return new Date(d).toLocaleDateString("pl-PL", {
    day: "2-digit",
    month: "2-digit",
    year: "2-digit",
  });
}

defineExpose({ loadSeries });
</script>

<style scoped>
/* ── Kontener ── */
.series-panel {
  background: #fff;
  border-radius: 12px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
  overflow: hidden;
}

/* ── Nagłówek ── */
.series-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 14px 9px;
  background: #f9f9fb;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

/* ── Empty state ── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 32px 16px;
}

/* ── Lista ── */
.timeline-list {
  padding: 6px 0 2px;
}

/* ── Wiersz ── */
.timeline-row {
  display: flex;
  align-items: stretch;
  padding: 0 10px 0 14px;
  transition: background-color 0.15s;
}

.timeline-row--clickable {
  cursor: pointer;
}
.timeline-row--clickable:hover {
  background: rgba(103, 58, 183, 0.04);
}
.timeline-row--active {
  background: rgba(103, 58, 183, 0.06);
}

/* ── Oś czasu ── */
.timeline-axis {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 18px;
  flex-shrink: 0;
  margin-right: 12px;
  padding-top: 16px;
}

.timeline-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  z-index: 1;
}

.timeline-dot--active {
  background: #7e57c2;
  box-shadow: 0 0 0 3px rgba(126, 87, 194, 0.2);
}

.timeline-dot--idle {
  background: #e0e0e0;
  border: 2px solid #bdbdbd;
}

.timeline-line {
  width: 2px;
  flex-grow: 1;
  margin-top: 4px;
  background: linear-gradient(to bottom, #d1c4e9, #e0e0e0);
}

/* ── Karta treści ── */
.timeline-card {
  flex-grow: 1;
  padding: 10px 0 10px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.045);
}

.timeline-row:last-child .timeline-card {
  border-bottom: none;
}
.timeline-card--active {
}

/* ── Strzałka ── */
.nav-arrow {
  opacity: 0;
  transform: translateX(-3px);
  transition: opacity 0.15s, transform 0.15s;
}

.timeline-row--clickable:hover .nav-arrow {
  opacity: 1;
  transform: translateX(0);
}

/* ── Stopka ── */
.series-footer {
  padding: 10px 14px;
  border-top: 1px solid rgba(0, 0, 0, 0.06);
  background: #f9f9fb;
}

.gap-1 {
  gap: 4px;
}
.gap-2 {
  gap: 8px;
}
</style>


=================================================================================
FILE: src/components/orders/SeriesListPanel.vue
LOCATION: .//src/components/orders/SeriesListPanel.vue
=================================================================================

<template>
  <v-card elevation="2">
    <!-- Nagłówek -->
    <v-card-title class="bg-deep-purple-darken-1 text-white d-flex align-center pa-3">
      <v-icon start color="white" size="small">mdi-layers</v-icon>
      <span class="text-body-1 font-weight-bold">
        Serie zamówienia
        <span class="text-body-2 opacity-70 ml-1">{{ orderNumber }}</span>
      </span>
      <v-spacer />
      <v-progress-circular
        v-if="loading"
        indeterminate
        size="16"
        width="2"
        color="white"
      />
      <template v-else>
        <v-btn
          size="small"
          color="white"
          variant="outlined"
          prepend-icon="mdi-refresh"
          class="mr-2"
          @click="loadSeries"
        >
          Odśwież
        </v-btn>
        <v-btn
          size="small"
          color="white"
          variant="outlined"
          prepend-icon="mdi-plus"
          class="mr-2"
          @click="$emit('create-series')"
        >
          Dodaj
        </v-btn>
      </template>
    </v-card-title>

    <v-card-text class="pa-0">
      <!-- Skeleton loader -->
      <div v-if="loading" class="pa-3">
        <v-skeleton-loader
          v-for="i in 3"
          :key="i"
          type="list-item-two-line"
          class="mb-1"
        />
      </div>

      <!-- Brak serii -->
      <div v-else-if="series.length === 0" class="text-center pa-6 text-medium-emphasis">
        <v-icon size="32" color="grey">mdi-layers-off</v-icon>
        <p class="text-body-2 mt-2">Brak serii</p>
      </div>

      <!-- Lista serii -->
      <v-list v-else density="compact" class="pa-0">
        <v-list-item
          v-for="serie in series"
          :key="serie.id"
          :class="{
            'current-series': serie.id === currentOrderId,
            'other-series': serie.id !== currentOrderId,
          }"
          class="series-item px-3 py-2"
          @click="navigateToSeries(serie)"
        >
          <!-- Prefiks numeryczny serii -->
          <template v-slot:prepend>
            <span
              class="text-caption font-weight-bold mr-4"
              :class="
                serie.id === currentOrderId ? 'text-deep-purple' : 'text-grey-darken-2'
              "
            >
              #{{ serie.series }}
            </span>
          </template>

          <!-- Treść -->
          <v-list-item-title class="text-body-2">
            <span class="font-weight-bold">{{ serie.full_order_number }}</span>
          </v-list-item-title>
          <v-list-item-subtitle class="text-caption">
            <span v-if="serie.description" class="text-truncate">
              {{ serie.description }}
            </span>
            <span v-else class="text-medium-emphasis font-italic">Brak opisu</span>
          </v-list-item-subtitle>

          <!-- Status + data utworzenia -->
          <template v-slot:append>
            <div class="d-flex flex-column align-end">
              <v-chip
                :color="getStatusColor(serie.overall_status)"
                size="x-small"
                variant="tonal"
                class="mb-1"
              >
                {{ getStatusLabel(serie.overall_status) }}
              </v-chip>
              <span class="text-caption text-medium-emphasis">
                {{ formatDate(serie.created_at) }}
              </span>
            </div>
          </template>
        </v-list-item>
      </v-list>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, watch, onMounted } from "vue";
import { useRouter } from "vue-router";
import { seriesService } from "@/services/seriesService";
import type { SeriesListItem } from "@/services/seriesService";
import { useMetadataStore } from "@/stores/metadata";

// ─── Props / Emits ────────────────────────────────────────────────────────────

const props = defineProps<{
  /** ID aktualnie wyświetlanego zamówienia */
  currentOrderId: number;
  /** Numer zamówienia do wyświetlenia (np. "Z/0001") */
  orderNumber?: string;
}>();

const emit = defineEmits<{
  "create-series": [];
  "series-changed": [orderId: number];
}>();

// ─── Instancje ────────────────────────────────────────────────────────────────

const router = useRouter();
const metadataStore = useMetadataStore();

// ─── Stan ─────────────────────────────────────────────────────────────────────

const series = ref<SeriesListItem[]>([]);
const loading = ref(false);

// ─── Lifecycle ────────────────────────────────────────────────────────────────

onMounted(() => {
  loadSeries();
});

watch(
  () => props.currentOrderId,
  () => {
    loadSeries();
  }
);

// ─── Metody ───────────────────────────────────────────────────────────────────

/** Załaduj listę serii */
const loadSeries = async () => {
  loading.value = true;
  try {
    series.value = await seriesService.getAllSeries(props.currentOrderId);
  } catch (err) {
    console.error("Błąd ładowania serii:", err);
    series.value = [];
  } finally {
    loading.value = false;
  }
};

/** Nawiguj do innej serii */
const navigateToSeries = (serie: SeriesListItem) => {
  if (serie.id === props.currentOrderId) return;
  emit("series-changed", serie.id);
  router.push(`/orders/${serie.id}`);
};

/** Kolor statusu zamówienia */
const getStatusColor = (status: string): string => {
  const config = metadataStore.getConfig("orderStatuses", status);
  return config?.color || "grey";
};

/** Etykieta statusu zamówienia */
const getStatusLabel = (status: string): string => {
  return metadataStore.getLabel("orderStatuses", status);
};

/** Formatuj datę jako DD.MM.YYYY */
const formatDate = (dateStr: string): string => {
  if (!dateStr) return "—";
  return new Date(dateStr).toLocaleDateString("pl-PL", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
};

// ─── Eksport ──────────────────────────────────────────────────────────────────

defineExpose({ loadSeries });
</script>

<style scoped>
.series-item {
  cursor: pointer;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  min-height: 56px;
}

.series-item:last-child {
  border-bottom: none;
}

.current-series {
  background-color: rgba(103, 58, 183, 0.06) !important;
}

.other-series:hover {
  background-color: rgba(0, 0, 0, 0.04) !important;
}
</style>


=================================================================================
FILE: src/components/orders/VariantCard.vue
LOCATION: .//src/components/orders/VariantCard.vue
=================================================================================

<template>
  <v-card
    elevation="2"
    class="variant-card"
    :class="{ 'border-success': variant.is_approved && variant.type === 'PROTOTYPE' }"
  >
    <v-card-title class="d-flex align-center pa-4">
      <!-- Avatar z numerem wariantu -->
      <v-avatar :color="statusConfig.color" size="48" class="mr-3">
        <span class="text-h5 font-weight-bold text-white">
          {{ variant.variant_number }}
        </span>
      </v-avatar>

      <!-- Nazwa i info -->
      <div class="flex-grow-1">
        <div class="d-flex align-center flex-wrap">
          <div class="text-h6 font-weight-bold mr-2">{{ variant.name }}</div>

          <!-- Typ -->
          <v-chip
            v-if="variant.type === 'PROTOTYPE'"
            size="x-small"
            color="purple"
            variant="flat"
            label
            class="mr-1 mb-1"
          >
            PROTOTYP
          </v-chip>
          <v-chip
            v-else
            size="x-small"
            color="blue"
            variant="flat"
            label
            class="mr-1 mb-1"
          >
            PRODUCKJA SERYJNA
          </v-chip>

          <!-- Chip: ma rodzica (dziecko) -->
          <v-chip
            v-if="variant.parent_variant_id"
            size="x-small"
            color="deep-purple"
            variant="tonal"
            class="mr-1 mb-1"
          >
            <v-icon start size="x-small">mdi-source-branch</v-icon>
            Podwariant
          </v-chip>
        </div>

        <div class="text-caption text-medium-emphasis mt-1 d-flex flex-wrap gap-1">
          <!-- Ilość -->
          <v-chip size="x-small" class="mr-1" variant="outlined">
            <v-icon start size="x-small">mdi-package</v-icon>
            {{ variant.quantity }} szt
          </v-chip>

          <!-- Status -->
          <v-chip size="x-small" :color="statusConfig.color" variant="tonal">
            <v-icon start size="x-small">{{ statusConfig.icon }}</v-icon>
            {{ statusConfig.label }}
          </v-chip>
        </div>
      </div>

      <!-- Menu akcji -->
      <v-menu>
        <template v-slot:activator="{ props }">
          <v-btn v-bind="props" icon="mdi-dots-vertical" variant="text" />
        </template>
        <v-list density="compact">
          <v-list-item @click="$emit('view')">
            <template v-slot:prepend>
              <v-icon>mdi-eye</v-icon>
            </template>
            <v-list-item-title>Szczegóły</v-list-item-title>
          </v-list-item>

          <v-list-item @click="$emit('edit')">
            <template v-slot:prepend>
              <v-icon>mdi-pencil</v-icon>
            </template>
            <v-list-item-title>Edytuj</v-list-item-title>
          </v-list-item>

          <!-- DUPLIKUJ -->
          <v-list-item @click="$emit('duplicate')">
            <template v-slot:prepend>
              <v-icon color="deep-purple">mdi-content-copy</v-icon>
            </template>
            <v-list-item-title class="text-deep-purple">Duplikuj</v-list-item-title>
          </v-list-item>

          <v-divider />

          <v-list-item
            v-if="variant.status !== 'CANCELLED'"
            @click="$emit('delete')"
            class="text-error"
          >
            <template v-slot:prepend>
              <v-icon color="error">mdi-delete</v-icon>
            </template>
            <v-list-item-title>Usuń</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </v-card-title>

    <v-card-text class="pt-0">
      <!-- Opis (skrócony) -->
      <div
        v-if="variant.description"
        class="text-body-2 text-truncate mb-3 text-medium-emphasis"
      >
        {{ variant.description }}
      </div>
      <div v-else class="text-caption text-medium-emphasis font-italic mb-3">
        Brak opisu
      </div>

      <!-- Info o zatwierdzeniu (tylko prototyp) -->
      <div
        v-if="variant.type === 'PROTOTYPE'"
        class="mb-3 pa-2 bg-grey-lighten-4 rounded"
      >
        <div
          v-if="variant.is_approved"
          class="text-caption text-success font-weight-bold d-flex align-center"
        >
          <v-icon size="small" color="success" class="mr-1">mdi-check-decagram</v-icon>
          ZATWIERDZONY
        </div>
        <div v-else class="text-caption text-grey-darken-1 d-flex align-center">
          <v-icon size="small" class="mr-1">mdi-clock-outline</v-icon>
          Oczekuje na decyzję
        </div>

        <div
          v-if="variant.feedback_notes"
          class="text-caption text-medium-emphasis mt-1 text-truncate"
        >
          Feedback: {{ variant.feedback_notes }}
        </div>
      </div>

      <!-- Daty -->
      <v-divider class="mb-2" />
      <div class="d-flex justify-space-between text-caption text-medium-emphasis">
        <div title="Data utworzenia">
          <v-icon size="small" class="mr-1">mdi-calendar-plus</v-icon>
          {{ formatDate(variant.created_at) }}
        </div>
        <div
          v-if="variant.updated_at !== variant.created_at"
          title="Ostatnia aktualizacja"
        >
          <v-icon size="small" class="mr-1">mdi-update</v-icon>
          {{ formatDate(variant.updated_at) }}
        </div>
      </div>
    </v-card-text>

    <v-card-actions>
      <v-btn size="small" variant="text" color="primary" @click="$emit('view')">
        <v-icon start>mdi-eye</v-icon>
        Szczegóły
      </v-btn>
      <v-spacer />
      <!-- Szybki przycisk duplikuj -->
      <v-btn size="small" variant="text" color="deep-purple" @click="$emit('duplicate')">
        <v-icon start>mdi-content-copy</v-icon>
        Duplikuj
      </v-btn>
    </v-card-actions>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from "vue";
import type { Variant } from "@/types";
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const { formatVariantStatus } = useStatusFormatter();

const props = defineProps<{
  variant: Variant;
}>();

defineEmits<{
  view: [];
  edit: [];
  delete: [];
  duplicate: []; // ← NOWE
}>();

const statusConfig = computed(() => formatVariantStatus(props.variant.status));

const formatDate = (date: string | undefined): string => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("pl-PL");
};
</script>

<style scoped>
.variant-card {
  transition: all 0.3s ease;
}

.variant-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.border-success {
  border: 1px solid rgb(var(--v-theme-success)) !important;
}

.gap-1 {
  gap: 4px;
}
</style>


=================================================================================
FILE: src/components/orders/VariantDuplicateDialog.vue
LOCATION: .//src/components/orders/VariantDuplicateDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="640"
    persistent
  >
    <v-card>
      <!-- ===== NAGŁÓWEK ===== -->
      <v-card-title
        :class="isGroup ? 'bg-indigo text-white' : 'bg-deep-purple text-white'"
        class="d-flex align-center pa-4"
      >
        <v-icon start color="white">
          {{ isGroup ? "mdi-folder-multiple" : "mdi-content-copy" }}
        </v-icon>
        {{ isGroup ? "Duplikuj grupę" : "Duplikuj wariant" }}
        {{ sourceVariant?.variant_number }}
        <v-spacer />
        <v-btn
          icon="mdi-close"
          variant="text"
          color="white"
          size="small"
          @click="handleCancel"
        />
      </v-card-title>

      <!-- ================================================================
           ŚCIEŻKA A — GRUPA (is_group === true)
           Prosty dialog: nazwa + checkbox copy_children
      ================================================================= -->
      <template v-if="isGroup">
        <v-card-text class="pa-6">
          <v-alert type="info" variant="tonal" density="compact" class="mb-5">
            <strong>Nowa grupa</strong> otrzyma kolejną wolną literę ({{
              nextGroupLetter
            }}). Możesz skopiować wszystkie warianty wewnątrz grupy.
          </v-alert>

          <!-- Nazwa grupy -->
          <v-form ref="groupFormRef">
            <v-text-field
              v-model="groupForm.name"
              label="Nazwa nowej grupy *"
              variant="outlined"
              prepend-inner-icon="mdi-folder-outline"
              :rules="[(v) => !!v || 'Nazwa jest wymagana']"
              class="mb-3"
              autofocus
            />

            <v-textarea
              v-model="groupForm.description"
              label="Opis"
              variant="outlined"
              rows="2"
              prepend-inner-icon="mdi-text"
            />

            <!-- Opcja kopiowania dzieci -->
            <v-card
              :class="[
                'copy-option-card pa-4 cursor-pointer mt-3',
                groupForm.copy_children ? 'border-indigo bg-indigo-lighten' : '',
              ]"
              flat
              @click="groupForm.copy_children = !groupForm.copy_children"
            >
              <div class="d-flex align-center">
                <div class="flex-grow-1">
                  <div class="d-flex align-center">
                    <v-icon color="indigo" class="mr-2">mdi-content-copy</v-icon>
                    <span class="text-subtitle-2 font-weight-bold">Kopiuj warianty</span>
                    <v-chip
                      v-if="childrenCount > 0"
                      size="x-small"
                      color="indigo"
                      class="ml-2"
                    >
                      {{ childrenCount }} wariantów
                    </v-chip>
                    <v-chip v-else size="x-small" color="grey" class="ml-2">
                      Pusta grupa
                    </v-chip>
                  </div>
                  <div class="text-caption text-medium-emphasis mt-1">
                    <template v-if="childrenCount > 0">
                      Kopiuje całe drzewo wariantów z nowymi numerami ({{
                        sourceVariant?.variant_number
                      }}1 → {{ nextGroupLetter }}1, itd.)
                    </template>
                    <template v-else> Brak wariantów do skopiowania </template>
                  </div>
                </div>
                <v-icon
                  :color="groupForm.copy_children ? 'indigo' : 'grey-lighten-2'"
                  size="28"
                >
                  {{
                    groupForm.copy_children ? "mdi-check-circle" : "mdi-circle-outline"
                  }}
                </v-icon>
              </div>
            </v-card>
          </v-form>

          <!-- Podsumowanie -->
          <v-card variant="tonal" color="indigo" class="mt-4 pa-3">
            <div class="text-caption font-weight-bold mb-2 text-uppercase">
              Podsumowanie:
            </div>
            <div class="d-flex flex-wrap gap-2">
              <v-chip size="small" color="indigo" variant="flat">
                <v-icon start size="x-small">mdi-folder-outline</v-icon>
                {{ sourceVariant?.variant_number }} → {{ nextGroupLetter }}
              </v-chip>
              <v-chip
                v-if="groupForm.copy_children && childrenCount > 0"
                size="small"
                color="success"
                variant="flat"
              >
                <v-icon start size="x-small">mdi-check</v-icon>
                {{ childrenCount }} wariantów
              </v-chip>
              <v-chip v-else size="small" color="grey" variant="flat">
                <v-icon start size="x-small">mdi-folder-open-outline</v-icon>
                Pusta
              </v-chip>
            </div>
          </v-card>
        </v-card-text>

        <v-divider />
        <v-card-actions class="pa-4 bg-grey-lighten-5">
          <v-spacer />
          <v-btn variant="text" color="grey-darken-1" @click="handleCancel">Anuluj</v-btn>
          <v-btn
            color="indigo"
            variant="elevated"
            :loading="saving"
            @click="handleGroupSubmit"
          >
            <v-icon start>mdi-content-copy</v-icon>
            Duplikuj grupę
          </v-btn>
        </v-card-actions>
      </template>

      <!-- ================================================================
           ŚCIEŻKA B — WARIANT (is_group === false)
           3-krokowy stepper (relacja → co kopiować → szczegóły)
      ================================================================= -->
      <template v-else>
        <v-stepper
          v-model="step"
          :items="['Relacja', 'Co kopiować', 'Szczegóły']"
          flat
          alt-labels
          class="elevation-0"
          hide-actions
        >
          <!-- KROK 1 — Relacja -->
          <template v-slot:item.1>
            <v-card flat class="pa-2">
              <v-card-text>
                <p class="text-body-2 text-medium-emphasis mb-4">
                  Wybierz jak nowy wariant ma się odnosić do
                  <strong
                    >{{ sourceVariant?.variant_number }} –
                    {{ sourceVariant?.name }}</strong
                  >:
                </p>

                <v-row>
                  <!-- Sibling -->
                  <v-col cols="6">
                    <v-card
                      :class="[
                        'relation-card pa-4 text-center cursor-pointer',
                        variantForm.relation === 'sibling'
                          ? 'border-primary border-thick bg-primary-lighten'
                          : 'border-dashed',
                      ]"
                      variant="outlined"
                      @click="variantForm.relation = 'sibling'"
                    >
                      <v-icon
                        size="48"
                        :color="variantForm.relation === 'sibling' ? 'primary' : 'grey'"
                      >
                        mdi-family-tree
                      </v-icon>
                      <div class="mt-2 text-subtitle-1 font-weight-bold">
                        Nowy wariant
                      </div>
                      <div class="text-caption text-medium-emphasis mt-1">
                        Nowa litera (np. {{ nextSiblingNumber }})
                      </div>
                      <div class="mt-3">
                        <v-chip size="small" color="grey" variant="tonal">
                          {{ sourceVariant?.variant_number }}
                        </v-chip>
                        <span class="text-caption mx-1 text-medium-emphasis">→</span>
                        <v-chip
                          size="small"
                          :color="variantForm.relation === 'sibling' ? 'primary' : 'grey'"
                          variant="flat"
                        >
                          {{ nextSiblingNumber }}
                        </v-chip>
                      </div>
                    </v-card>
                  </v-col>

                  <!-- Child -->
                  <v-col cols="6">
                    <v-card
                      :class="[
                        'relation-card pa-4 text-center cursor-pointer',
                        variantForm.relation === 'child'
                          ? 'border-primary border-thick bg-primary-lighten'
                          : 'border-dashed',
                      ]"
                      variant="outlined"
                      @click="variantForm.relation = 'child'"
                    >
                      <v-icon
                        size="48"
                        :color="variantForm.relation === 'child' ? 'primary' : 'grey'"
                      >
                        mdi-source-branch
                      </v-icon>
                      <div class="mt-2 text-subtitle-1 font-weight-bold">Podwariant</div>
                      <div class="text-caption text-medium-emphasis mt-1">
                        Ta sama litera z numerem (np. {{ nextChildNumber }})
                      </div>
                      <div class="mt-3">
                        <v-chip size="small" color="grey" variant="tonal">
                          {{ sourceVariant?.variant_number }}
                        </v-chip>
                        <span class="text-caption mx-1 text-medium-emphasis">→</span>
                        <v-chip
                          size="small"
                          :color="variantForm.relation === 'child' ? 'primary' : 'grey'"
                          variant="flat"
                        >
                          {{ nextChildNumber }}
                        </v-chip>
                      </div>
                    </v-card>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>
          </template>

          <!-- KROK 2 — Co kopiować -->
          <template v-slot:item.2>
            <v-card flat class="pa-2">
              <v-card-text>
                <p class="text-body-2 text-medium-emphasis mb-4">
                  Wybierz dane, które mają zostać skopiowane z wariantu
                  <strong>{{ sourceVariant?.variant_number }}</strong> do nowego:
                </p>

                <!-- Wycena -->
                <v-card
                  :class="[
                    'copy-option-card mb-3 pa-4 cursor-pointer',
                    variantForm.copy_quotation ? 'border-success bg-success-lighten' : '',
                  ]"
                  flat
                  @click="variantForm.copy_quotation = !variantForm.copy_quotation"
                >
                  <div class="d-flex align-center">
                    <div class="flex-grow-1">
                      <div class="d-flex align-center">
                        <v-icon color="success" class="mr-2"
                          >mdi-file-document-outline</v-icon
                        >
                        <span class="text-subtitle-2 font-weight-bold">Wycena</span>
                        <v-chip
                          v-if="sourceHasApprovedQuotation"
                          size="x-small"
                          color="success"
                          class="ml-2"
                        >
                          <v-icon start size="x-small">mdi-check-circle</v-icon>
                          Zatwierdzona
                        </v-chip>
                        <v-chip
                          v-else-if="sourceHasAnyQuotation"
                          size="x-small"
                          color="warning"
                          class="ml-2"
                        >
                          Robocza v{{ sourceLatestQuotationVersion }}
                        </v-chip>
                        <v-chip v-else size="x-small" color="grey" class="ml-2"
                          >Brak wyceny</v-chip
                        >
                      </div>
                      <div class="text-caption text-medium-emphasis mt-1">
                        <template v-if="sourceHasApprovedQuotation">
                          Kopiuje zatwierdzoną wycenę jako nową roboczą v1
                          (niezatwierdzoną)
                        </template>
                        <template v-else-if="sourceHasAnyQuotation">
                          Kopiuje ostatnią wersję wyceny jako roboczą v1 (niezatwierdzoną)
                        </template>
                        <template v-else>
                          Brak wyceny do skopiowania – opcja niedostępna
                        </template>
                      </div>
                    </div>
                    <v-icon
                      :color="variantForm.copy_quotation ? 'success' : 'grey-lighten-2'"
                      size="28"
                    >
                      {{
                        variantForm.copy_quotation
                          ? "mdi-check-circle"
                          : "mdi-circle-outline"
                      }}
                    </v-icon>
                  </div>
                </v-card>

                <!-- Materiały -->
                <v-card
                  :class="[
                    'copy-option-card mb-3 pa-4 cursor-pointer',
                    variantForm.copy_materials ? 'border-blue bg-blue-lighten' : '',
                  ]"
                  flat
                  @click="variantForm.copy_materials = !variantForm.copy_materials"
                >
                  <div class="d-flex align-center">
                    <div class="flex-grow-1">
                      <div class="d-flex align-center">
                        <v-icon color="blue" class="mr-2">mdi-cube-outline</v-icon>
                        <span class="text-subtitle-2 font-weight-bold">Materiały</span>
                        <v-chip
                          v-if="sourceMaterialsCount > 0"
                          size="x-small"
                          color="blue"
                          class="ml-2"
                        >
                          {{ sourceMaterialsCount }} poz.
                        </v-chip>
                        <v-chip v-else size="x-small" color="grey" class="ml-2"
                          >Brak materiałów</v-chip
                        >
                      </div>
                      <div class="text-caption text-medium-emphasis mt-1">
                        Kopiuje listę materiałów ze statusem "Niezamówione"
                      </div>
                    </div>
                    <v-icon
                      :color="variantForm.copy_materials ? 'blue' : 'grey-lighten-2'"
                      size="28"
                    >
                      {{
                        variantForm.copy_materials
                          ? "mdi-check-circle"
                          : "mdi-circle-outline"
                      }}
                    </v-icon>
                  </div>
                </v-card>

                <v-alert
                  type="info"
                  variant="tonal"
                  density="compact"
                  icon="mdi-information-outline"
                >
                  Zrealizowane usługi produkcyjne (RCP)
                  <strong>nigdy nie są kopiowane</strong>. Nowy wariant startuje bez
                  historii produkcji.
                </v-alert>
              </v-card-text>
            </v-card>
          </template>

          <!-- KROK 3 — Szczegóły -->
          <template v-slot:item.3>
            <v-card flat class="pa-2">
              <v-card-text>
                <p class="text-body-2 text-medium-emphasis mb-4">
                  Podaj szczegóły nowego wariantu
                  <v-chip size="x-small" color="primary" class="ml-1">
                    {{
                      variantForm.relation === "sibling"
                        ? nextSiblingNumber
                        : nextChildNumber
                    }} </v-chip
                  >:
                </p>

                <v-form ref="variantFormRef">
                  <div class="mb-6">
                    <div
                      class="text-caption text-medium-emphasis mb-2 font-weight-bold text-uppercase"
                    >
                      Typ wariantu
                    </div>
                    <v-btn-toggle
                      v-model="variantForm.type"
                      mandatory
                      divided
                      variant="outlined"
                      color="primary"
                      class="w-100"
                    >
                      <v-btn value="SERIAL" class="w-50">
                        <v-icon start>mdi-factory</v-icon>
                        Produkcja seryjna
                      </v-btn>
                      <v-btn value="PROTOTYPE" class="w-50">
                        <v-icon start>mdi-flask-outline</v-icon>
                        Prototyp
                      </v-btn>
                    </v-btn-toggle>
                  </div>

                  <v-text-field
                    v-model="variantForm.name"
                    label="Nazwa wariantu *"
                    variant="outlined"
                    prepend-inner-icon="mdi-tag"
                    :rules="[(v) => !!v || 'Nazwa jest wymagana']"
                    class="mb-2"
                  />

                  <v-text-field
                    v-model.number="variantForm.quantity"
                    label="Ilość *"
                    type="number"
                    min="1"
                    variant="outlined"
                    prepend-inner-icon="mdi-counter"
                    suffix="szt"
                    :rules="[(v) => v > 0 || 'Ilość musi być większa od 0']"
                    class="mb-2"
                  />

                  <v-textarea
                    v-model="variantForm.description"
                    label="Opis / Specyfikacja"
                    variant="outlined"
                    rows="2"
                    prepend-inner-icon="mdi-text"
                    placeholder="Różnice względem oryginału..."
                  />
                </v-form>

                <!-- Podsumowanie -->
                <v-card variant="tonal" color="deep-purple" class="mt-2 pa-3">
                  <div class="text-caption font-weight-bold mb-2 text-uppercase">
                    Podsumowanie duplikacji:
                  </div>
                  <div class="d-flex flex-wrap gap-2">
                    <v-chip
                      size="small"
                      :color="
                        variantForm.relation === 'sibling' ? 'primary' : 'secondary'
                      "
                      variant="flat"
                    >
                      <v-icon start size="x-small">
                        {{
                          variantForm.relation === "sibling"
                            ? "mdi-family-tree"
                            : "mdi-source-branch"
                        }}
                      </v-icon>
                      {{ variantForm.relation === "sibling" ? "Wariant" : "Podwariant" }}
                      {{ sourceVariant?.variant_number }} →
                      {{
                        variantForm.relation === "sibling"
                          ? nextSiblingNumber
                          : nextChildNumber
                      }}
                    </v-chip>
                    <v-chip
                      v-if="variantForm.copy_quotation && sourceHasAnyQuotation"
                      size="small"
                      color="success"
                      variant="flat"
                    >
                      <v-icon start size="x-small">mdi-check</v-icon>
                      Wycena v1 (robocza)
                    </v-chip>
                    <v-chip
                      v-if="variantForm.copy_materials && sourceMaterialsCount > 0"
                      size="small"
                      color="blue"
                      variant="flat"
                    >
                      <v-icon start size="x-small">mdi-check</v-icon>
                      {{ sourceMaterialsCount }} materiałów
                    </v-chip>
                    <v-chip size="small" color="grey" variant="flat">
                      <v-icon start size="x-small">mdi-close</v-icon>
                      Bez usług RCP
                    </v-chip>
                  </div>
                </v-card>
              </v-card-text>
            </v-card>
          </template>
        </v-stepper>

        <!-- Akcje steppera -->
        <v-divider />
        <v-card-actions class="pa-4 bg-grey-lighten-5">
          <v-btn
            variant="outlined"
            color="grey-darken-1"
            :disabled="step === 1"
            @click="step--"
          >
            <v-icon start>mdi-arrow-left</v-icon>
            Wstecz
          </v-btn>

          <v-spacer />

          <v-btn variant="text" color="grey-darken-1" @click="handleCancel">Anuluj</v-btn>

          <v-btn v-if="step < 3" color="primary" variant="elevated" @click="step++">
            Dalej
            <v-icon end>mdi-arrow-right</v-icon>
          </v-btn>

          <v-btn
            v-else
            color="deep-purple"
            variant="elevated"
            :loading="saving"
            @click="handleVariantSubmit"
          >
            <v-icon start>mdi-content-copy</v-icon>
            Duplikuj
          </v-btn>
        </v-card-actions>
      </template>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import api from "@/services/api";

// ─── Props ────────────────────────────────────────────────────────────────────

const props = defineProps<{
  modelValue: boolean;
  sourceVariant: any | null;
  existingVariants: any[];
}>();

const emit = defineEmits<{
  "update:modelValue": [value: boolean];
  saved: [newVariant: any];
}>();

// ─── Kluczowy computed — typ źródła ──────────────────────────────────────────

/**
 * GŁÓWNY DISCRIMINATOR.
 * is_group=true  → pokazuj ścieżkę A (prosta, 1 krok)
 * is_group=false → pokazuj ścieżkę B (stepper, 3 kroki)
 *
 * Po dodaniu migracji is_group backend zawsze zwraca to pole.
 */
const isGroup = computed<boolean>(() => {
  return props.sourceVariant?.is_group === true;
});

// ─── Wspólne ─────────────────────────────────────────────────────────────────

const saving = ref(false);

const handleCancel = () => {
  emit("update:modelValue", false);
};

// ─── ŚCIEŻKA A — Formularz grupy ─────────────────────────────────────────────

const groupFormRef = ref<any>(null);

const defaultGroupForm = () => ({
  name: "",
  description: "",
  copy_children: false,
});

const groupForm = ref(defaultGroupForm());

/** Liczba bezpośrednich dzieci grupy źródłowej */
const childrenCount = computed<number>(() => {
  if (!props.sourceVariant) return 0;
  return props.existingVariants.filter(
    (v) => v.parent_variant_id === props.sourceVariant.id
  ).length;
});

/** Następna wolna litera dla nowej grupy top-level */
const nextGroupLetter = computed<string>(() => {
  const letters = props.existingVariants
    .filter((v) => !v.parent_variant_id && v.variant_number?.length === 1)
    .map((v) => v.variant_number as string);

  let letter = "A";
  while (letters.includes(letter)) {
    letter = String.fromCharCode(letter.charCodeAt(0) + 1);
  }
  return letter;
});

const handleGroupSubmit = async () => {
  const { valid } = await groupFormRef.value?.validate();
  if (!valid) return;

  saving.value = true;
  try {
    const response = await api.post(`/variants/${props.sourceVariant.id}/duplicate`, {
      name: groupForm.value.name,
      description: groupForm.value.description || null,
      copy_children: groupForm.value.copy_children,
    });

    emit("saved", response.data.variant);
    emit("update:modelValue", false);
  } catch (err: any) {
    console.error("Błąd duplikowania grupy:", err);
    alert(
      "Błąd podczas duplikowania grupy: " + (err.response?.data?.message || err.message)
    );
  } finally {
    saving.value = false;
  }
};

// ─── ŚCIEŻKA B — Stepper wariantu ────────────────────────────────────────────

const step = ref(1);
const variantFormRef = ref<any>(null);

const defaultVariantForm = () => ({
  relation: "sibling" as "sibling" | "child",
  copy_quotation: true,
  copy_materials: true,
  type: "SERIAL",
  name: "",
  quantity: 1,
  description: "",
});

const variantForm = ref(defaultVariantForm());

// ─── Computed — numeracja wariantów ──────────────────────────────────────────

const nextSiblingNumber = computed<string>(() => {
  if (!props.sourceVariant) return "B";

  const parentId = props.sourceVariant.parent_variant_id;

  if (!parentId) {
    // Top-level: następna wolna litera
    const letters = props.existingVariants
      .filter((v) => !v.parent_variant_id && v.variant_number?.length === 1)
      .map((v) => v.variant_number as string);

    let letter = "A";
    while (letters.includes(letter)) {
      letter = String.fromCharCode(letter.charCodeAt(0) + 1);
    }
    return letter;
  }

  // Dziecko: następny numer wśród rodzeństwa
  const parent = props.existingVariants.find((v) => v.id === parentId);
  if (!parent) return props.sourceVariant.variant_number + "?";
  return computeNextChild(parent, props.existingVariants);
});

const nextChildNumber = computed<string>(() => {
  if (!props.sourceVariant) return "";
  return computeNextChild(props.sourceVariant, props.existingVariants);
});

/**
 * Oblicz następny numer dziecka dla danego rodzica.
 * Identyczna logika co backend:
 *   Rodzic bez cyfry (A, B) → A1, A2  (bez separatora)
 *   Rodzic z cyfrą (A1, B2) → A1_1, A1_2  (separator _)
 */
function computeNextChild(parent: any, allVariants: any[]): string {
  const parentNumber: string = parent.variant_number;
  const isDeepParent = /\d/.test(parentNumber);
  const separator = isDeepParent ? "_" : "";
  const prefix = parentNumber + separator;

  const children = allVariants.filter((v) => v.parent_variant_id === parent.id);
  if (children.length === 0) return prefix + "1";

  const maxNum = children.reduce((max, child) => {
    if (child.variant_number?.startsWith(prefix)) {
      const suffix = child.variant_number.slice(prefix.length);
      if (/^\d+$/.test(suffix)) return Math.max(max, parseInt(suffix));
    }
    return max;
  }, 0);

  return prefix + (maxNum + 1);
}

// ─── Computed — dane źródłowe wariantu ───────────────────────────────────────

const sourceHasApprovedQuotation = computed(
  () => props.sourceVariant?.approved_quotation != null
);

const sourceHasAnyQuotation = computed(
  () =>
    props.sourceVariant?.approved_quotation != null ||
    (props.sourceVariant?.quotations?.length ?? 0) > 0
);

const sourceLatestQuotationVersion = computed(() => {
  const q = props.sourceVariant?.quotations;
  if (!q?.length) return 0;
  return Math.max(...q.map((v: any) => v.version_number ?? 0));
});

const sourceMaterialsCount = computed(() => props.sourceVariant?.materials?.length ?? 0);

// ─── Submit wariantu ──────────────────────────────────────────────────────────

const handleVariantSubmit = async () => {
  const { valid } = await variantFormRef.value?.validate();
  if (!valid) return;

  saving.value = true;
  try {
    const response = await api.post(`/variants/${props.sourceVariant.id}/duplicate`, {
      relation: variantForm.value.relation,
      name: variantForm.value.name,
      quantity: variantForm.value.quantity,
      type: variantForm.value.type,
      copy_quotation: variantForm.value.copy_quotation,
      copy_materials: variantForm.value.copy_materials,
      description: variantForm.value.description || null,
    });

    emit("saved", response.data.variant);
    emit("update:modelValue", false);
  } catch (err: any) {
    console.error("Błąd duplikowania wariantu:", err);
    alert("Błąd podczas duplikowania: " + (err.response?.data?.message || err.message));
  } finally {
    saving.value = false;
  }
};

// ─── Reset przy otwarciu dialogu ─────────────────────────────────────────────

watch(
  () => props.modelValue,
  (open) => {
    if (!open) return;

    // Reset stanu kroków
    step.value = 1;

    if (props.sourceVariant?.is_group === true) {
      // Reset formularza grupy
      groupForm.value = defaultGroupForm();
      groupForm.value.name = props.sourceVariant.name + " (kopia)";
      groupForm.value.description = props.sourceVariant.description ?? "";
    } else {
      // Reset formularza wariantu
      variantForm.value = defaultVariantForm();
      variantForm.value.name = props.sourceVariant?.name + " (kopia)";
      variantForm.value.quantity = props.sourceVariant?.quantity ?? 1;
      variantForm.value.type = props.sourceVariant?.type ?? "SERIAL";
      variantForm.value.description = props.sourceVariant?.description ?? "";
    }
  }
);
</script>

<style scoped>
.relation-card {
  transition: all 0.2s ease;
  border-radius: 12px !important;
  height: 200px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.relation-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.border-primary {
  border: 2px solid rgb(var(--v-theme-primary)) !important;
}

.border-thick {
  border-width: 2px !important;
}

.border-dashed {
  border-style: dashed !important;
}

.bg-primary-lighten {
  background-color: rgba(var(--v-theme-primary), 0.06) !important;
}

.copy-option-card {
  border-radius: 10px !important;
  border: 2px solid rgba(var(--v-theme-on-surface), 0.12) !important;
  transition: border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
}

.copy-option-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.border-success {
  border-color: rgb(var(--v-theme-success)) !important;
}

.bg-success-lighten {
  background-color: rgba(var(--v-theme-success), 0.06) !important;
}

.border-blue {
  border-color: rgb(var(--v-theme-info)) !important;
}

.bg-blue-lighten {
  background-color: rgba(var(--v-theme-info), 0.06) !important;
}

.border-indigo {
  border-color: rgb(var(--v-theme-indigo, 63, 81, 181)) !important;
  border-color: #3f51b5 !important;
}

.bg-indigo-lighten {
  background-color: rgba(63, 81, 181, 0.06) !important;
}

.gap-2 {
  gap: 8px;
}
</style>


=================================================================================
FILE: src/components/orders/VariantFormDialog.vue
LOCATION: .//src/components/orders/VariantFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="660"
    persistent
  >
    <v-card>
      <!-- ── Nagłówek ── -->
      <v-card-title :class="headerBgClass" class="text-white d-flex align-center pa-4">
        <v-icon start color="white">{{ headerIcon }}</v-icon>
        {{ dialogTitle }}
        <v-spacer />
        <v-btn
          icon="mdi-close"
          variant="text"
          color="white"
          size="small"
          @click="handleCancel"
        />
      </v-card-title>

      <v-card-text class="pt-5">
        <v-form ref="formRef" @submit.prevent="handleSubmit">
          <!-- ═══════════════════════════════════════════════════════════════
               TRYB: NOWA GRUPA (mode='group')
               Tworzony przez POST /orders/{id}/variants
               Backend nadaje kolejną literę (A, B, C...)
          ════════════════════════════════════════════════════════════════ -->
          <template v-if="isGroupMode">
            <v-alert
              type="info"
              variant="tonal"
              density="compact"
              class="mb-4"
              icon="mdi-folder-plus"
            >
              Grupa zostanie oznaczona kolejną literą (np.
              <strong>{{ nextGroupLetter }}</strong
              >). Możesz potem dodać do niej dowolne warianty.
            </v-alert>

            <v-text-field
              v-model="form.name"
              label="Nazwa grupy *"
              variant="outlined"
              prepend-inner-icon="mdi-folder"
              :rules="[rules.required]"
              class="mb-3"
            />

            <v-textarea
              v-model="form.description"
              label="Opis grupy (opcjonalnie)"
              variant="outlined"
              rows="2"
              prepend-inner-icon="mdi-text"
              placeholder="Krótki opis linii produktowej..."
            />
          </template>

          <!-- ═══════════════════════════════════════════════════════════════
               TRYB: NOWY WARIANT (mode='variant')
               Tworzony przez POST /orders/{id}/variants/{parentId}/children
               Kontekst: pod jakim rodzicem powstaje
          ════════════════════════════════════════════════════════════════ -->
          <template v-else-if="isVariantMode">
            <!-- Info o rodzicu -->
            <v-alert
              variant="tonal"
              :color="parent?.is_group ? 'indigo' : 'teal'"
              density="compact"
              class="mb-4"
              :icon="parent?.is_group ? 'mdi-folder' : 'mdi-source-branch'"
            >
              Wariant zostanie dodany do
              <strong
                >{{ parent?.is_group ? "grupy" : "wariantu" }}
                {{ parent?.variant_number }} – {{ parent?.name }}</strong
              >
              jako
              <strong>{{ nextVariantNumber }}</strong
              >.
            </v-alert>

            <!-- Typ wariantu -->
            <div class="mb-4">
              <div
                class="text-caption text-medium-emphasis mb-2 font-weight-bold text-uppercase"
              >
                Typ wariantu
              </div>
              <v-btn-toggle
                v-model="form.type"
                mandatory
                divided
                variant="outlined"
                color="primary"
                class="w-100"
                :disabled="isEdit"
              >
                <v-btn value="SERIAL" class="flex-grow-1 w-50">
                  <v-icon start>mdi-factory</v-icon>
                  Produkcja seryjna
                </v-btn>
                <v-btn value="PROTOTYPE" class="flex-grow-1 w-50">
                  <v-icon start>mdi-flask-outline</v-icon>
                  Prototyp
                </v-btn>
              </v-btn-toggle>
            </div>

            <v-row>
              <!-- Nazwa wariantu -->
              <v-col cols="12" md="8">
                <v-text-field
                  v-model="form.name"
                  label="Nazwa wariantu *"
                  variant="outlined"
                  prepend-inner-icon="mdi-tag"
                  :rules="[rules.required]"
                />
              </v-col>

              <!-- Ilość -->
              <v-col cols="12" md="4">
                <v-text-field
                  v-model.number="form.quantity"
                  label="Ilość *"
                  type="number"
                  min="1"
                  variant="outlined"
                  prepend-inner-icon="mdi-counter"
                  suffix="szt"
                  :rules="[rules.minQty]"
                />
              </v-col>

              <!-- Opis -->
              <v-col cols="12">
                <v-textarea
                  v-model="form.description"
                  label="Opis / Specyfikacja (opcjonalnie)"
                  variant="outlined"
                  rows="2"
                  prepend-inner-icon="mdi-text"
                  placeholder="Wymiary, kolor, uwagi techniczne..."
                />
              </v-col>
            </v-row>
          </template>

          <!-- ═══════════════════════════════════════════════════════════════
               TRYB: EDYCJA GRUPY (mode='edit-group')
          ════════════════════════════════════════════════════════════════ -->
          <template v-else-if="isEditGroupMode">
            <v-text-field
              v-model="form.name"
              label="Nazwa grupy *"
              variant="outlined"
              prepend-inner-icon="mdi-folder"
              :rules="[rules.required]"
              class="mb-3"
            />
            <v-textarea
              v-model="form.description"
              label="Opis grupy (opcjonalnie)"
              variant="outlined"
              rows="2"
              prepend-inner-icon="mdi-text"
            />
          </template>

          <!-- ═══════════════════════════════════════════════════════════════
               TRYB: EDYCJA WARIANTU (mode='edit-variant')
          ════════════════════════════════════════════════════════════════ -->
          <template v-else-if="isEditVariantMode">
            <!-- Typ (tylko do odczytu — nie można konwertować) -->
            <v-chip
              :color="form.type === 'PROTOTYPE' ? 'orange' : 'blue'"
              variant="tonal"
              size="small"
              class="mb-4"
            >
              <v-icon start size="small">
                {{ form.type === "PROTOTYPE" ? "mdi-flask-outline" : "mdi-factory" }}
              </v-icon>
              {{ form.type === "PROTOTYPE" ? "Prototyp" : "Produkcja seryjna" }}
              <span class="ml-1 text-caption">(nie można zmieniać typu)</span>
            </v-chip>

            <v-row>
              <v-col cols="12" md="8">
                <v-text-field
                  v-model="form.name"
                  label="Nazwa wariantu *"
                  variant="outlined"
                  prepend-inner-icon="mdi-tag"
                  :rules="[rules.required]"
                />
              </v-col>
              <v-col cols="12" md="4">
                <v-text-field
                  v-model.number="form.quantity"
                  label="Ilość *"
                  type="number"
                  min="1"
                  variant="outlined"
                  prepend-inner-icon="mdi-counter"
                  suffix="szt"
                  :rules="[rules.minQty]"
                />
              </v-col>
              <v-col cols="12">
                <v-textarea
                  v-model="form.description"
                  label="Opis / Specyfikacja (opcjonalnie)"
                  variant="outlined"
                  rows="2"
                  prepend-inner-icon="mdi-text"
                />
              </v-col>
              <!-- Status edycji -->
              <v-col cols="12" md="6">
                <v-select
                  v-model="form.status"
                  :items="metadataStore.variantStatuses"
                  item-title="label"
                  item-value="value"
                  label="Status"
                  variant="outlined"
                  prepend-inner-icon="mdi-list-status"
                />
              </v-col>
            </v-row>
          </template>
        </v-form>
      </v-card-text>

      <!-- ── Akcje ── -->
      <v-card-actions class="pa-4 bg-grey-lighten-5">
        <v-spacer />
        <v-btn
          variant="text"
          color="grey-darken-1"
          :disabled="loading"
          @click="handleCancel"
        >
          Anuluj
        </v-btn>
        <v-btn
          :color="submitColor"
          variant="elevated"
          :loading="loading"
          @click="handleSubmit"
        >
          <v-icon start>mdi-check</v-icon>
          {{ submitLabel }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useVariantsStore } from "@/stores/variants";
import { useMetadataStore } from "@/stores/metadata";

// ─── Props / Emits ────────────────────────────────────────────────────────────

const props = defineProps<{
  modelValue: boolean;

  /**
   * Tryb dialogu:
   *   'group'        — tworzenie nowej grupy top-level
   *   'variant'      — tworzenie wariantu jako dziecko `parent`
   *   'edit-group'   — edycja istniejącej grupy
   *   'edit-variant' — edycja istniejącego wariantu
   */
  mode: "group" | "variant" | "edit-group" | "edit-variant";

  /** ID zamówienia (wymagane przy tworzeniu) */
  orderId?: number;

  /**
   * Rodzic, do którego dodajemy wariant (wymagane gdy mode='variant').
   * Może być grupą (is_group=true) lub wariantem.
   */
  parent?: any;

  /**
   * Obiekt do edycji (wymagane gdy mode='edit-group' lub 'edit-variant').
   */
  item?: any;

  /**
   * Wszystkie warianty zamówienia — do obliczenia następnego numeru.
   */
  existingVariants?: any[];
}>();

const emit = defineEmits<{
  "update:modelValue": [value: boolean];
  saved: [];
}>();

// ─── Instancje ────────────────────────────────────────────────────────────────

const variantsStore = useVariantsStore();
const metadataStore = useMetadataStore();

// ─── Stan ─────────────────────────────────────────────────────────────────────

const formRef = ref<any>(null);
const loading = ref(false);

const defaultForm = () => ({
  name: "",
  description: "",
  quantity: 1,
  type: "SERIAL" as "SERIAL" | "PROTOTYPE",
  status: "PENDING",
});

const form = ref(defaultForm());

// ─── Walidacja ────────────────────────────────────────────────────────────────

const rules = {
  required: (v: string) => !!v || "Pole jest wymagane",
  minQty: (v: number) => v >= 1 || "Ilość musi wynosić co najmniej 1",
};

// ─── Computed — tryb ─────────────────────────────────────────────────────────

const isGroupMode = computed(() => props.mode === "group");
const isVariantMode = computed(() => props.mode === "variant");
const isEditGroupMode = computed(() => props.mode === "edit-group");
const isEditVariantMode = computed(() => props.mode === "edit-variant");
const isEdit = computed(
  () => props.mode === "edit-group" || props.mode === "edit-variant"
);

// ─── Computed — UI ───────────────────────────────────────────────────────────

const headerBgClass = computed(() => {
  if (isGroupMode.value) return "bg-indigo";
  if (isVariantMode.value) return "bg-teal";
  if (isEditGroupMode.value) return "bg-indigo-darken-2";
  return "bg-primary";
});

const headerIcon = computed(() => {
  if (isGroupMode.value) return "mdi-folder-plus";
  if (isVariantMode.value) return "mdi-plus";
  if (isEditGroupMode.value) return "mdi-folder-edit";
  return "mdi-pencil";
});

const dialogTitle = computed(() => {
  if (isGroupMode.value) return "Nowa grupa wariantów";
  if (isVariantMode.value)
    return `Nowy wariant w grupie ${props.parent?.variant_number ?? ""}`;
  if (isEditGroupMode.value) return `Edytuj grupę ${props.item?.variant_number ?? ""}`;
  return `Edytuj wariant ${props.item?.variant_number ?? ""}`;
});

const submitColor = computed(() => {
  if (isGroupMode.value || isEditGroupMode.value) return "indigo";
  if (isVariantMode.value) return "teal";
  return "primary";
});

const submitLabel = computed(() => {
  if (isEdit.value) return "Zapisz zmiany";
  if (isGroupMode.value) return "Utwórz grupę";
  return "Dodaj wariant";
});

// ─── Computed — numeracja ─────────────────────────────────────────────────────

/**
 * Następna wolna litera dla grupy top-level (A, B, C...).
 * Pomija litery już zajęte przez istniejące grupy.
 */
const nextGroupLetter = computed(() => {
  const existing = (props.existingVariants ?? [])
    .filter((v) => !v.parent_variant_id && (v.is_group || v.quantity === 0))
    .map((v) => v.variant_number);
  let letter = "A";
  while (existing.includes(letter)) {
    letter = String.fromCharCode(letter.charCodeAt(0) + 1);
  }
  return letter;
});

/**
 * Następny numer wariantu wśród dzieci rodzica.
 * Reguła: A → A1, A2; A1 → A1_1, A1_2.
 */
const nextVariantNumber = computed(() => {
  if (!props.parent) return "?";
  const parentNum: string = props.parent.variant_number;
  const isDeepParent = /\d/.test(parentNum);
  const separator = isDeepParent ? "_" : "";
  const prefix = parentNum + separator;

  const siblings = (props.existingVariants ?? []).filter(
    (v) => v.parent_variant_id === props.parent.id
  );

  if (siblings.length === 0) return prefix + "1";

  const maxNum = siblings.reduce((max, s) => {
    if (s.variant_number?.startsWith(prefix)) {
      const suffix = s.variant_number.slice(prefix.length);
      if (/^\d+$/.test(suffix)) return Math.max(max, parseInt(suffix));
    }
    return max;
  }, 0);

  return prefix + (maxNum + 1);
});

// ─── Inicjalizacja formularza ─────────────────────────────────────────────────

watch(
  () => props.modelValue,
  (isOpen) => {
    if (!isOpen) return;

    if (isEdit.value && props.item) {
      // Edycja — załaduj dane edytowanego elementu
      form.value = {
        name: props.item.name ?? "",
        description: props.item.description ?? "",
        quantity: props.item.quantity ?? 1,
        type: props.item.type ?? "SERIAL",
        status: props.item.status ?? "PENDING",
      };
    } else {
      // Tworzenie — pusty formularz
      form.value = defaultForm();
    }
  }
);

// ─── Submit ───────────────────────────────────────────────────────────────────

const handleSubmit = async () => {
  const { valid } = await formRef.value?.validate();
  if (!valid) return;

  loading.value = true;
  try {
    if (isGroupMode.value) {
      // Tworzenie grupy
      await variantsStore.createGroup(props.orderId!, {
        name: form.value.name,
        description: form.value.description || undefined,
      });
    } else if (isVariantMode.value) {
      // Tworzenie wariantu jako dziecko
      await variantsStore.createChildVariant(props.orderId!, props.parent!.id, {
        name: form.value.name,
        quantity: form.value.quantity,
        type: form.value.type,
        description: form.value.description || undefined,
      });
    } else if (isEditGroupMode.value || isEditVariantMode.value) {
      // Edycja — payload różni się dla grup i wariantów
      const payload: Record<string, any> = {
        name: form.value.name,
        description: form.value.description || null,
      };
      if (isEditVariantMode.value) {
        // Warianty mogą mieć ilość i status
        payload.quantity = form.value.quantity;
        payload.status = form.value.status;
      }
      await variantsStore.updateVariant(props.item!.id, payload);
    }

    emit("saved");
    handleCancel();
  } catch (error: any) {
    console.error("Save error:", error);
    alert("Błąd zapisu: " + (error.response?.data?.message || error.message));
  } finally {
    loading.value = false;
  }
};

const handleCancel = () => {
  formRef.value?.resetValidation();
  emit("update:modelValue", false);
};
</script>

<style scoped>
.w-100 {
  width: 100%;
}
</style>


=================================================================================
FILE: src/components/orders/VariantItem.vue
LOCATION: .//src/components/orders/VariantItem.vue
=================================================================================

<template>
  <v-card class="mb-3" variant="outlined">
    <v-card-text>
      <div class="d-flex align-center">
        <v-avatar
          :color="formatVariantStatus(line.status).color"
          size="40"
          class="mr-3"
        >
          <span class="text-h6 font-weight-bold text-white">{{
            line.variant_number
          }}</span>
        </v-avatar>
        <div class="flex-grow-1">
          <div class="text-h6 font-weight-bold">{{ line.name }}</div>
          <div class="text-caption text-medium-emphasis">
            <v-chip size="x-small" class="mr-2">
              <v-icon start size="x-small">mdi-package</v-icon>
              {{ line.quantity }} szt
            </v-chip>
            <v-chip size="x-small" :color="formatVariantStatus(line.status).color">
              {{ formatVariantStatus(line.status).label }}
            </v-chip>
          </div>
        </div>

        <div class="text-right">
          <v-btn-group variant="outlined" density="compact">
            <v-btn icon="mdi-eye" size="small" @click="$emit('view')" />
            <v-btn icon="mdi-pencil" size="small" @click="$emit('edit')" />
            <v-btn
              icon="mdi-delete"
              size="small"
              color="error"
              @click="$emit('delete')"
            />
          </v-btn-group>
        </div>
      </div>
    </v-card-text>
  </v-card>
</template>
<script setup lang="ts">
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const { formatVariantStatus } = useStatusFormatter();

const props = defineProps({
  line: {
    type: Object,
    required: true,
  },
});

defineEmits(["view", "edit", "delete"]);
</script>


=================================================================================
FILE: src/components/production/TaskEditDialog.vue
LOCATION: .//src/components/production/TaskEditDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="600"
    persistent
  >
    <v-card>
      <v-card-title class="bg-primary text-white d-flex align-center">
        <v-icon start>mdi-pencil</v-icon>
        Edycja Zadania
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" @click="close" />
      </v-card-title>

      <v-card-text class="pt-6">
        <v-form ref="formRef" @submit.prevent="save">
          <div class="mb-4">
            <div class="text-caption text-medium-emphasis">Zadanie</div>
            <div class="text-h6">{{ task?.service_name }}</div>
          </div>

          <v-row>
            <v-col cols="12" md="6">
              <v-select
                v-model="form.status"
                label="Status *"
                :items="statusList"
                item-title="label"
                item-value="value"
                variant="outlined"
                prepend-inner-icon="mdi-list-status"
              />
            </v-col>

            <v-col cols="12" md="6">
              <v-autocomplete
                v-model="form.assigned_to_user_id"
                label="Pracownik"
                :items="workers"
                item-title="name"
                item-value="id"
                variant="outlined"
                prepend-inner-icon="mdi-account"
                clearable
              />
            </v-col>

            <!-- Data Startu -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.actual_start_date"
                label="Data Startu"
                type="datetime-local"
                variant="outlined"
                prepend-inner-icon="mdi-calendar-start"
                @change="recalculateDuration"
              />
            </v-col>

            <!-- Data Końca -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.actual_end_date"
                label="Data Zakończenia"
                type="datetime-local"
                variant="outlined"
                prepend-inner-icon="mdi-calendar-end"
                :disabled="form.status === 'IN_PROGRESS'"
                @change="recalculateDuration"
              />
            </v-col>

            <!-- Czas Rzeczywisty (automatycznie przeliczany) -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model.number="form.actual_time_hours"
                label="Czas Rzeczywisty (h)"
                type="number"
                step="0.01"
                min="0"
                variant="outlined"
                prepend-inner-icon="mdi-clock-outline"
                suffix="h"
                hint="Obliczany z dat lub edycja ręczna"
                persistent-hint
              />
            </v-col>

            <v-col cols="12" md="6">
              <v-text-field
                v-model.number="form.actual_quantity"
                label="Ilość wykonana"
                type="number"
                min="0"
                variant="outlined"
                prepend-inner-icon="mdi-counter"
              />
            </v-col>

            <v-col cols="12">
              <v-textarea
                v-model="form.worker_notes"
                label="Notatki"
                variant="outlined"
                rows="3"
                prepend-inner-icon="mdi-note-text"
              />
            </v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-card-actions class="pa-4">
        <v-spacer />
        <v-btn variant="text" @click="close">Anuluj</v-btn>
        <v-btn color="primary" variant="elevated" :loading="saving" @click="save">
          <v-icon start>mdi-content-save</v-icon>
          Zapisz
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";
import { parseISO, differenceInSeconds, isValid } from "date-fns";
import { rcpAdminService } from "@/services/rcpAdminService";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps({
  modelValue: Boolean,
  task: Object,
  workers: Array,
});

const emit = defineEmits(["update:modelValue", "saved"]);

const formRef = ref(null);
const saving = ref(false);

// ZMIANA: importujemy toInputDate z useFormatters
// PRZED: lokalna implementacja (identyczna kopia była też w TimeLogsDialog.vue):
//   const toInputDate = (isoString) => {
//     if (!isoString) return ''
//     const date = new Date(isoString)
//     const tzOffset = date.getTimezoneOffset() * 60000
//     return new Date(date.getTime() - tzOffset).toISOString().slice(0, 16)
//   }
const { toInputDate } = useFormatters();

const form = ref({
  status: "",
  assigned_to_user_id: null as number | null,
  actual_start_date: "",
  actual_end_date: "",
  actual_time_hours: 0,
  actual_quantity: 0,
  worker_notes: "",
});

// ZMIANA: zamiast hardcoded tablicy — można podłączyć metadataStore
// Zostawione jako stała bo statusy edycji są ograniczone (nie wszystkie stany są dostępne)
const statusList = [
  { label: "W toku", value: "IN_PROGRESS" },
  { label: "Zakończone", value: "COMPLETED" },
  { label: "Anulowane", value: "CANCELLED" },
];

// ZMIANA: recalculateDuration używa date-fns differenceInSeconds zamiast ręcznych obliczeń
// PRZED:
//   const diffMs = end.getTime() - start.getTime()
//   const hours = diffMs / (1000 * 60 * 60)
const recalculateDuration = (): void => {
  if (!form.value.actual_start_date || !form.value.actual_end_date) return;

  const start = parseISO(form.value.actual_start_date);
  const end = parseISO(form.value.actual_end_date);

  if (!isValid(start) || !isValid(end) || end <= start) return;

  const totalSeconds = differenceInSeconds(end, start);
  form.value.actual_time_hours = parseFloat((totalSeconds / 3600).toFixed(2));
};

watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen && props.task) {
      form.value = {
        status: props.task.status,
        assigned_to_user_id: props.task.assigned_to_user_id,
        // ZMIANA: toInputDate z useFormatters zamiast lokalnej funkcji
        actual_start_date: toInputDate(props.task.actual_start_date),
        actual_end_date: toInputDate(props.task.actual_end_date),
        actual_time_hours: props.task.actual_time_hours,
        actual_quantity: props.task.actual_quantity,
        worker_notes: props.task.worker_notes,
      };
    }
  }
);

const save = async (): Promise<void> => {
  saving.value = true;
  try {
    const payload = { ...form.value };

    // Jeśli status "W toku", czyścimy datę końca
    if (payload.status === "IN_PROGRESS") {
      payload.actual_end_date = "";
    }

    await rcpAdminService.updateTask(props.task.id, payload);
    emit("saved");
    close();
  } catch (error: any) {
    console.error("Save error:", error);
    alert("Błąd zapisu: " + (error.response?.data?.message || "Nieznany błąd"));
  } finally {
    saving.value = false;
  }
};

const close = (): void => {
  emit("update:modelValue", false);
};
</script>


=================================================================================
FILE: src/components/production/TimeLogsDialog.vue
LOCATION: .//src/components/production/TimeLogsDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="800"
    scrollable
  >
    <v-card>
      <v-card-title class="bg-orange text-white d-flex align-center">
        <v-icon start>mdi-history</v-icon>
        Logi Czasu Pracy (Korekta)
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" @click="close" />
      </v-card-title>

      <div class="pa-4 bg-grey-lighten-4 border-b">
        <div class="text-subtitle-1 font-weight-bold">
          {{ task?.service_name }}
        </div>
        <div class="text-caption">
          Pracownik: <strong>{{ task?.assigned_worker?.name || "Brak" }}</strong>
        </div>
        <div class="mt-2">
          <v-btn
            size="small"
            prepend-icon="mdi-plus"
            color="primary"
            variant="flat"
            @click="openAddLog"
          >
            Dodaj wpis ręcznie
          </v-btn>
        </div>
      </div>

      <v-card-text class="pa-0">
        <v-data-table
          :headers="headers"
          :items="logs"
          :loading="loading"
          density="compact"
          class="logs-table"
          hide-default-footer
          items-per-page="-1"
        >
          <!-- Typ zdarzenia -->
          <template v-slot:item.event_type="{ item }">
            <v-chip
              size="small"
              :color="getEventColor(item)"
              label
              class="font-weight-bold"
            >
              {{ getEventLabel(item) }}
            </v-chip>
          </template>

          <!-- Czas zdarzenia -->
          <template v-slot:item.event_timestamp="{ item }">
            {{ formatDateTime(item.event_timestamp) }}
          </template>

          <!-- Czas trwania (tylko dla STOP/PAUSE) -->
          <template v-slot:item.elapsed_seconds="{ item }">
            <span
              v-if="
                item.event_type === 'STOP' &&
                item.elapsed_seconds === 0 &&
                task?.status === 'CANCELLED'
              "
            >
              -
            </span>
            <span
              v-else-if="
                ['STOP', 'PAUSE'].includes(item.event_type) || item.elapsed_seconds > 0
              "
            >
              {{ formatDuration(item.elapsed_seconds) }}
            </span>
            <span v-else class="text-grey">-</span>
          </template>

          <!-- Akcje -->
          <template v-slot:item.actions="{ item }">
            <v-btn
              icon="mdi-pencil"
              size="x-small"
              variant="text"
              color="blue"
              @click="editLog(item)"
            />
            <v-btn
              icon="mdi-delete"
              size="x-small"
              variant="text"
              color="red"
              @click="deleteLog(item)"
            />
          </template>
        </v-data-table>
      </v-card-text>
    </v-card>

    <!-- Dialog edycji pojedynczego logu -->
    <v-dialog v-model="logFormDialog" max-width="500">
      <v-card>
        <v-card-title class="text-h6">
          {{ isEditMode ? "Edytuj wpis" : "Dodaj wpis" }}
        </v-card-title>
        <v-card-text class="pt-4">
          <v-form ref="formRef" @submit.prevent="saveLog">
            <v-select
              v-model="form.event_type"
              label="Typ zdarzenia *"
              :items="eventTypes"
              variant="outlined"
              prepend-inner-icon="mdi-flag"
            />

            <v-text-field
              v-model="form.event_timestamp"
              label="Data i czas *"
              type="datetime-local"
              variant="outlined"
              prepend-inner-icon="mdi-calendar-clock"
            />

            <v-text-field
              v-if="form.event_type !== 'CANCELLED_VIRTUAL'"
              v-model.number="form.elapsed_seconds"
              label="Czas trwania (sekundy)"
              type="number"
              variant="outlined"
              prepend-inner-icon="mdi-timer-sand"
              hint="Tylko dla Zakończenia lub Pauzy"
              persistent-hint
            />
            <v-alert v-else type="info" density="compact" variant="tonal" class="mt-2">
              Czas trwania dla anulowania zostanie ustawiony na 0.
            </v-alert>
          </v-form>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn @click="logFormDialog = false">Anuluj</v-btn>
          <v-btn color="primary" variant="elevated" @click="saveLog" :loading="saving">
            Zapisz
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch, computed } from "vue";
import { rcpAdminService } from "@/services/rcpAdminService";

const props = defineProps({
  modelValue: Boolean,
  task: Object,
});

const emit = defineEmits(["update:modelValue", "updated"]);

const logs = ref([]);
const loading = ref(false);
const saving = ref(false);
const logFormDialog = ref(false);
const editingLogId = ref(null);

const isEditMode = computed(() => !!editingLogId.value);

const form = ref({
  event_type: "START",
  event_timestamp: "",
  elapsed_seconds: 0,
  user_id: null,
});

const headers = [
  { title: "Zdarzenie", key: "event_type" },
  { title: "Data/Czas", key: "event_timestamp" },
  { title: "Naliczony czas", key: "elapsed_seconds", align: "end" },
  { title: "Akcje", key: "actions", align: "end", sortable: false },
];

// Dodano wirtualny typ "Anulowanie"
const eventTypes = [
  { title: "Start", value: "START" },
  { title: "Pauza", value: "PAUSE" },
  { title: "Wznowienie", value: "RESUME" },
  { title: "Stop", value: "STOP" },
  { title: "Anulowanie", value: "CANCELLED_VIRTUAL" },
];

watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen && props.task) {
      loadLogs();
    }
  }
);

const loadLogs = async () => {
  loading.value = true;
  try {
    logs.value = await rcpAdminService.getTimeLogs(props.task.id);
  } catch (e) {
    console.error(e);
  } finally {
    loading.value = false;
  }
};

const openAddLog = () => {
  editingLogId.value = null;
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

  form.value = {
    event_type: "START",
    event_timestamp: now.toISOString().slice(0, 16),
    elapsed_seconds: 0,
    user_id: props.task.assigned_to_user_id,
  };
  logFormDialog.value = true;
};

const editLog = (log) => {
  editingLogId.value = log.id;
  const date = new Date(log.event_timestamp);
  date.setMinutes(date.getMinutes() - date.getTimezoneOffset());

  // Wykrywanie czy to "Anulowanie" (STOP + 0s + Status Zadania CANCELLED)
  let type = log.event_type;
  if (
    props.task?.status === "CANCELLED" &&
    log.event_type === "STOP" &&
    log.elapsed_seconds === 0
  ) {
    type = "CANCELLED_VIRTUAL";
  }

  form.value = {
    event_type: type,
    event_timestamp: date.toISOString().slice(0, 16),
    elapsed_seconds: log.elapsed_seconds || 0,
    user_id: log.user_id,
  };
  logFormDialog.value = true;
};

const saveLog = async () => {
  saving.value = true;
  try {
    const payload = { ...form.value };

    // Obsługa wirtualnego typu "Anulowanie"
    if (payload.event_type === "CANCELLED_VIRTUAL") {
      payload.event_type = "STOP";
      payload.elapsed_seconds = 0;
    }

    if (isEditMode.value) {
      await rcpAdminService.updateTimeLog(editingLogId.value, payload);
    } else {
      await rcpAdminService.addTimeLog(props.task.id, payload);
    }

    await loadLogs();
    emit("updated");
    logFormDialog.value = false;
  } catch (e) {
    alert("Błąd zapisu logu");
  } finally {
    saving.value = false;
  }
};

const deleteLog = async (log) => {
  if (!confirm("Czy na pewno usunąć ten wpis?")) return;
  try {
    await rcpAdminService.deleteTimeLog(log.id);
    await loadLogs();
    emit("updated");
  } catch (e) {
    alert("Błąd usuwania");
  }
};

const close = () => {
  emit("update:modelValue", false);
};

// Helpers
const getEventLabel = (log) => {
  if (
    props.task?.status === "CANCELLED" &&
    log.event_type === "STOP" &&
    log.elapsed_seconds === 0
  ) {
    return "Anulowanie";
  }
  const map = { START: "Start", PAUSE: "Pauza", RESUME: "Wznowienie", STOP: "Stop" };
  return map[log.event_type] || log.event_type;
};

const getEventColor = (log) => {
  if (
    props.task?.status === "CANCELLED" &&
    log.event_type === "STOP" &&
    log.elapsed_seconds === 0
  ) {
    return "grey";
  }
  const map = { START: "green", PAUSE: "orange", RESUME: "blue", STOP: "red" };
  return map[log.event_type] || "grey";
};

const formatDateTime = (dateStr) => {
  return new Date(dateStr).toLocaleString("pl-PL");
};

const formatDuration = (seconds) => {
  if (!seconds && seconds !== 0) return "0s";
  const isNegative = seconds < 0;
  const absSeconds = Math.abs(seconds);

  const h = Math.floor(absSeconds / 3600);
  const m = Math.floor((absSeconds % 3600) / 60);
  const s = absSeconds % 60;

  return `${isNegative ? "-" : ""}${h}h ${m}m ${s}s`;
};
</script>

<style scoped>
.logs-table :deep(th) {
  font-weight: bold !important;
}
</style>


=================================================================================
FILE: src/components/production/TimerWidget.vue
LOCATION: .//src/components/production/TimerWidget.vue
=================================================================================

<template>
  <v-card elevation="8" class="timer-card">
    <v-card-text class="pa-8">
      <!-- Nazwa zadania -->
      <div class="text-center mb-6">
        <h2 class="text-h4 font-weight-bold mb-2">{{ taskName }}</h2>
        <v-chip color="primary" variant="outlined">
          <v-icon start>mdi-wrench</v-icon>
          {{ workstation }}
        </v-chip>
      </div>

      <!-- Timer Display -->
      <div class="timer-display text-center mb-6">
        <div class="timer-time">{{ formattedTime }}</div>
        <div class="timer-estimated mt-2">
          Szacowany czas: {{ formattedEstimatedTime }}
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="mb-6">
        <v-progress-linear
          :model-value="progressPercent"
          :color="progressColor"
          height="30"
          rounded
        >
          <template v-slot:default="{ value }">
            <strong class="text-white">{{ Math.ceil(value) }}%</strong>
          </template>
        </v-progress-linear>
        <div class="text-center text-caption mt-2 text-medium-emphasis">
          {{ elapsedSeconds }} / {{ estimatedSeconds }} sekund
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="d-flex justify-center gap-4 mb-4">
        <!-- START -->
        <v-btn
          v-if="!isRunning"
          color="success"
          size="x-large"
          @click="handleStart"
          :loading="loading"
        >
          <v-icon start>mdi-play</v-icon>
          START
        </v-btn>

        <!-- PAUSE/RESUME + STOP -->
        <template v-else>
          <v-btn
            v-if="!isPaused"
            color="warning"
            size="x-large"
            @click="handlePause"
            :loading="loading"
          >
            <v-icon start>mdi-pause</v-icon>
            PAUZA
          </v-btn>

          <v-btn
            v-else
            color="info"
            size="x-large"
            @click="handleResume"
            :loading="loading"
          >
            <v-icon start>mdi-play-circle</v-icon>
            WZNÓW
          </v-btn>

          <v-btn
            color="error"
            size="x-large"
            @click="handleStop"
            :loading="loading"
          >
            <v-icon start>mdi-stop</v-icon>
            ZAKOŃCZ
          </v-btn>
        </template>
      </div>

      <!-- Status -->
      <v-alert
        v-if="isPaused"
        type="warning"
        variant="tonal"
        prominent
        class="mb-4"
      >
        <v-alert-title>Timer wstrzymany</v-alert-title>
        Kliknij WZNÓW aby kontynuować pracę
      </v-alert>

      <v-alert
        v-else-if="isRunning"
        type="info"
        variant="tonal"
        prominent
        class="mb-4"
      >
        <v-alert-title>Timer aktywny</v-alert-title>
        Zadanie w trakcie realizacji
      </v-alert>

      <!-- Task Details -->
      <v-expansion-panels variant="accordion">
        <v-expansion-panel>
          <v-expansion-panel-title>
            <v-icon start>mdi-information</v-icon>
            Szczegóły zadania
          </v-expansion-panel-title>
          <v-expansion-panel-text>
            <v-list density="compact">
              <v-list-item>
                <template v-slot:prepend>
                  <v-icon>mdi-clock-outline</v-icon>
                </template>
                <v-list-item-title>Szacowany czas</v-list-item-title>
                <v-list-item-subtitle>{{ estimatedHours }} godzin</v-list-item-subtitle>
              </v-list-item>
              <v-list-item>
                <template v-slot:prepend>
                  <v-icon>mdi-counter</v-icon>
                </template>
                <v-list-item-title>Ilość</v-list-item-title>
                <v-list-item-subtitle>{{ quantity }} szt</v-list-item-subtitle>
              </v-list-item>
              <v-list-item>
                <template v-slot:prepend>
                  <v-icon>mdi-cash</v-icon>
                </template>
                <v-list-item-title>Koszt szacowany</v-list-item-title>
                <v-list-item-subtitle>{{ estimatedCost }} PLN</v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-expansion-panel-text>
        </v-expansion-panel>
      </v-expansion-panels>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useTimer } from '@/composables/useTimer'

const props = defineProps({
  taskId: {
    type: Number,
    required: true
  },
  taskName: {
    type: String,
    required: true
  },
  workstation: {
    type: String,
    required: true
  },
  estimatedHours: {
    type: Number,
    required: true
  },
  quantity: {
    type: Number,
    default: 1
  },
  estimatedCost: {
    type: Number,
    default: 0
  }
})

const emit = defineEmits(['completed'])

const {
  isRunning,
  isPaused,
  elapsedSeconds,
  estimatedSeconds,
  formattedTime,
  formattedEstimatedTime,
  progressPercent,
  progressColor,
  start,
  pause,
  resume,
  stop
} = useTimer(props.taskId)

const loading = ref(false)

// Set estimated seconds from hours
estimatedSeconds.value = Math.floor(props.estimatedHours * 3600)

const handleStart = async () => {
  loading.value = true
  try {
    await start({
      estimated_time_hours: props.estimatedHours
    })
  } catch (error) {
    console.error('Start error:', error)
  } finally {
    loading.value = false
  }
}

const handlePause = async () => {
  loading.value = true
  try {
    await pause()
  } catch (error) {
    console.error('Pause error:', error)
  } finally {
    loading.value = false
  }
}

const handleResume = async () => {
  loading.value = true
  try {
    await resume()
  } catch (error) {
    console.error('Resume error:', error)
  } finally {
    loading.value = false
  }
}

const handleStop = async () => {
  loading.value = true
  try {
    const result = await stop()
    emit('completed', result)
  } catch (error) {
    console.error('Stop error:', error)
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.timer-card {
  max-width: 800px;
  margin: 0 auto;
}

.timer-display {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 2rem;
  color: white;
}

.timer-time {
  font-size: 5rem;
  font-weight: 900;
  font-family: 'Roboto Mono', monospace;
  line-height: 1;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.timer-estimated {
  font-size: 1.2rem;
  opacity: 0.9;
}

.gap-4 {
  gap: 1rem;
}
</style>


=================================================================================
FILE: src/components/prototypes/PrototypeDetailDialog.vue
LOCATION: .//src/components/prototypes/PrototypeDetailDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="1100"
    scrollable
  >
    <v-card v-if="prototype">
      <!-- Header -->
      <v-card-title class="bg-purple text-white d-flex align-center pa-4">
        <v-avatar color="purple-lighten-2" size="48" class="mr-3">
          <span class="text-h5 font-weight-bold text-white"
            >v{{ prototype.version_number }}</span
          >
        </v-avatar>
        <div>
          <div class="text-h6">
            Prototyp v{{ prototype.version_number }}
            <v-chip
              v-if="prototype.is_approved"
              color="success"
              size="small"
              class="ml-2"
            >
              <v-icon start size="x-small">mdi-check</v-icon>
              Zatwierdzony
            </v-chip>
            <v-chip v-if="prototype.is_rejected" color="error" size="small" class="ml-2">
              <v-icon start size="x-small">mdi-close</v-icon>
              Odrzucony
            </v-chip>
          </div>
          <div class="text-caption opacity-80">
            {{ prototype.description || "Brak opisu" }}
          </div>
        </div>
        <v-spacer />

        <!-- Actions -->
        <v-btn
          v-if="!prototype.is_approved && !prototype.is_rejected"
          color="white"
          variant="text"
          size="small"
          @click="$emit('approve', prototype)"
        >
          <v-icon start>mdi-check</v-icon>
          Zatwierdź
        </v-btn>
        <v-btn
          v-if="!prototype.is_approved && !prototype.is_rejected"
          color="white"
          variant="text"
          size="small"
          @click="$emit('reject', prototype)"
        >
          <v-icon start>mdi-close</v-icon>
          Odrzuć
        </v-btn>
        <v-btn icon="mdi-close" color="white" variant="text" @click="close" />
      </v-card-title>

      <!-- Tabs -->
      <v-tabs v-model="activeTab" bg-color="purple-lighten-5" color="purple">
        <v-tab value="materials">
          <v-icon start>mdi-package-variant-closed</v-icon>
          Materiały
          <v-badge
            v-if="materials.length > 0"
            :content="materials.length"
            color="purple"
            class="ml-2"
            inline
          />
        </v-tab>
        <v-tab value="services">
          <v-icon start>mdi-cog</v-icon>
          RCP / Zadania
          <v-badge
            v-if="services.length > 0"
            :content="services.length"
            color="purple"
            class="ml-2"
            inline
          />
        </v-tab>
        <v-tab value="info">
          <v-icon start>mdi-information</v-icon>
          Info
        </v-tab>
      </v-tabs>

      <v-card-text
        class="pa-0"
        style="min-height: 400px; max-height: 70vh; overflow-y: auto"
      >
        <v-tabs-window v-model="activeTab">
          <!-- ============================================================ -->
          <!-- TAB: MATERIAŁY -->
          <!-- ============================================================ -->
          <v-tabs-window-item value="materials">
            <div class="pa-4">
              <materials-panel
                :materials="materials"
                :summary="materialsSummary"
                :total-cost="materialsTotalCost"
                :loading="loadingMaterials"
                :readonly="prototype.is_approved || prototype.is_rejected"
                @add="
                  materialFormDialog = true;
                  editingMaterial = null;
                "
                @edit="editMaterial"
                @delete="confirmDeleteMaterial"
                @status-change="handleMaterialStatusChange"
                @mark-all-ordered="markAllMaterialsOrdered"
              />
            </div>
          </v-tabs-window-item>

          <!-- ============================================================ -->
          <!-- TAB: USŁUGI / RCP -->
          <!-- ============================================================ -->
          <v-tabs-window-item value="services">
            <div class="pa-4">
              <v-card elevation="2" class="mb-4">
                <v-card-title class="bg-deep-purple text-white d-flex align-center">
                  <v-icon start color="white">mdi-cog</v-icon>
                  Zadania RCP ({{ services.length }})
                  <v-spacer />
                  <v-btn
                    v-if="!prototype.is_approved && !prototype.is_rejected"
                    color="white"
                    variant="text"
                    size="small"
                    @click="
                      serviceFormDialog = true;
                      editingService = null;
                    "
                  >
                    <v-icon start>mdi-plus</v-icon>
                    Dodaj zadanie
                  </v-btn>
                </v-card-title>

                <v-card-text class="pa-0">
                  <div v-if="loadingServices" class="text-center py-6">
                    <v-progress-circular indeterminate color="deep-purple" />
                  </div>

                  <div v-else-if="services.length === 0" class="text-center py-6">
                    <v-icon size="64" color="grey-lighten-2">mdi-cog</v-icon>
                    <p class="text-body-2 text-medium-emphasis mt-2">Brak zadań RCP</p>
                    <v-btn
                      v-if="!prototype.is_approved && !prototype.is_rejected"
                      variant="outlined"
                      color="deep-purple"
                      size="small"
                      class="mt-2"
                      @click="
                        serviceFormDialog = true;
                        editingService = null;
                      "
                    >
                      <v-icon start>mdi-plus</v-icon>
                      Dodaj pierwsze zadanie
                    </v-btn>
                  </div>

                  <v-table v-else density="compact" hover>
                    <thead>
                      <tr class="bg-grey-lighten-4">
                        <th style="width: 50px">#</th>
                        <th>Zadanie</th>
                        <th>Stanowisko</th>
                        <th>Pracownik</th>
                        <th class="text-center">Status</th>
                        <th class="text-right">Czas (h)</th>
                        <th class="text-right">Koszt</th>
                        <th
                          v-if="!prototype.is_approved && !prototype.is_rejected"
                          class="text-center"
                          style="width: 100px"
                        >
                          Akcje
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="service in sortedServices" :key="service.id">
                        <td class="text-center font-weight-medium text-grey">
                          {{ service.step_number }}
                        </td>
                        <td>
                          <div class="font-weight-medium">{{ service.service_name }}</div>
                          <div
                            v-if="service.worker_notes"
                            class="text-caption text-medium-emphasis"
                          >
                            {{ service.worker_notes }}
                          </div>
                        </td>
                        <td>
                          <span v-if="service.workstation">{{
                            service.workstation.name
                          }}</span>
                          <span v-else class="text-medium-emphasis">—</span>
                        </td>
                        <td>
                          <div v-if="service.assigned_worker" class="d-flex align-center">
                            <v-avatar size="24" color="grey-lighten-3" class="mr-2">
                              <span class="text-caption font-weight-bold">
                                {{ service.assigned_worker.name?.charAt(0) || "?" }}
                              </span>
                            </v-avatar>
                            {{ service.assigned_worker.name }}
                          </div>
                          <span v-else class="text-medium-emphasis">—</span>
                        </td>
                        <td class="text-center">
                          <v-chip
                            :color="getServiceStatusColor(service.status)"
                            size="small"
                          >
                            {{ getServiceStatusLabel(service.status) }}
                          </v-chip>
                        </td>
                        <td class="text-right">
                          <div>
                            <span class="text-medium-emphasis">Plan: </span>
                            {{ service.estimated_time_hours || "—" }}
                          </div>
                          <div v-if="service.actual_time_hours">
                            <span class="text-medium-emphasis">Fakt: </span>
                            <span class="font-weight-medium">{{
                              service.actual_time_hours
                            }}</span>
                          </div>
                        </td>
                        <td class="text-right">
                          <div>
                            {{ formatCurrency(service.estimated_cost) }}
                          </div>
                          <div v-if="service.actual_cost" class="font-weight-medium">
                            {{ formatCurrency(service.actual_cost) }}
                          </div>
                        </td>
                        <td
                          v-if="!prototype.is_approved && !prototype.is_rejected"
                          class="text-center"
                        >
                          <v-btn
                            icon="mdi-pencil"
                            variant="text"
                            size="x-small"
                            color="primary"
                            @click="editService(service)"
                          />
                          <v-btn
                            icon="mdi-delete"
                            variant="text"
                            size="x-small"
                            color="error"
                            @click="confirmDeleteService(service)"
                          />
                        </td>
                      </tr>
                    </tbody>

                    <tfoot v-if="services.length > 0">
                      <tr class="bg-grey-lighten-4">
                        <td colspan="5" class="text-right font-weight-bold">Suma:</td>
                        <td class="text-right font-weight-medium">
                          {{ totalEstimatedHours.toFixed(1) }} h
                        </td>
                        <td class="text-right font-weight-bold text-deep-purple">
                          {{ formatCurrency(totalEstimatedCost) }}
                        </td>
                        <td v-if="!prototype.is_approved && !prototype.is_rejected"></td>
                      </tr>
                    </tfoot>
                  </v-table>
                </v-card-text>
              </v-card>
            </div>
          </v-tabs-window-item>

          <!-- ============================================================ -->
          <!-- TAB: INFO -->
          <!-- ============================================================ -->
          <v-tabs-window-item value="info">
            <div class="pa-6">
              <v-row>
                <v-col cols="6">
                  <div class="mb-4">
                    <div class="text-caption text-medium-emphasis">Wersja</div>
                    <div class="text-h6">v{{ prototype.version_number }}</div>
                  </div>
                  <div class="mb-4">
                    <div class="text-caption text-medium-emphasis">Opis</div>
                    <div>{{ prototype.description || "—" }}</div>
                  </div>
                  <div class="mb-4">
                    <div class="text-caption text-medium-emphasis">Utworzony</div>
                    <div>{{ formatDateTime(prototype.created_at) }}</div>
                  </div>
                </v-col>
                <v-col cols="6">
                  <v-card variant="outlined" class="pa-4">
                    <div class="text-subtitle-2 font-weight-bold mb-3">
                      <v-icon start size="small">mdi-chart-box</v-icon>
                      Podsumowanie kosztów
                    </div>
                    <div class="d-flex justify-space-between mb-2">
                      <span class="text-medium-emphasis">Materiały:</span>
                      <span class="font-weight-medium">{{
                        formatCurrency(materialsTotalCost)
                      }}</span>
                    </div>
                    <div class="d-flex justify-space-between mb-2">
                      <span class="text-medium-emphasis">Usługi (plan):</span>
                      <span class="font-weight-medium">{{
                        formatCurrency(totalEstimatedCost)
                      }}</span>
                    </div>
                    <v-divider class="my-2" />
                    <div class="d-flex justify-space-between">
                      <span class="font-weight-bold">Razem:</span>
                      <span class="font-weight-bold text-purple">
                        {{ formatCurrency(materialsTotalCost + totalEstimatedCost) }}
                      </span>
                    </div>
                  </v-card>
                </v-col>
              </v-row>
            </div>
          </v-tabs-window-item>
        </v-tabs-window>
      </v-card-text>
    </v-card>

    <!-- Material Form Dialog -->
    <material-form-dialog
      v-model="materialFormDialog"
      :material="editingMaterial"
      @saved="handleMaterialSaved"
    />

    <!-- Prototype Service Form Dialog -->
    <prototype-service-form-dialog
      v-model="serviceFormDialog"
      :service="editingService"
      :next-step-number="nextStepNumber"
      @saved="handleServiceSaved"
    />

    <!-- Delete Material Confirm -->
    <v-dialog v-model="deleteMaterialDialog" max-width="400">
      <v-card>
        <v-card-title class="bg-error text-white">
          <v-icon start color="white">mdi-alert</v-icon>
          Usuń materiał
        </v-card-title>
        <v-card-text class="pt-4">
          Czy na pewno chcesz usunąć
          <strong>{{ deletingMaterial?.assortment?.name || "ten materiał" }}</strong
          >?
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn @click="deleteMaterialDialog = false">Anuluj</v-btn>
          <v-btn color="error" variant="elevated" @click="handleDeleteMaterial"
            >Usuń</v-btn
          >
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- Delete Service Confirm -->
    <v-dialog v-model="deleteServiceDialog" max-width="400">
      <v-card>
        <v-card-title class="bg-error text-white">
          <v-icon start color="white">mdi-alert</v-icon>
          Usuń zadanie
        </v-card-title>
        <v-card-text class="pt-4">
          Czy na pewno chcesz usunąć zadanie
          <strong>{{ deletingService?.service_name }}</strong
          >?
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn @click="deleteServiceDialog = false">Anuluj</v-btn>
          <v-btn color="error" variant="elevated" @click="handleDeleteService"
            >Usuń</v-btn
          >
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { prototypeMaterialService } from "@/services/prototypeMaterialService";
import { prototypeServiceService } from "@/services/prototypeServiceService";
import MaterialsPanel from "@/components/materials/MaterialsPanel.vue";
import MaterialFormDialog from "@/components/materials/MaterialFormDialog.vue";
import PrototypeServiceFormDialog from "@/components/prototypes/PrototypeServiceFormDialog.vue";

const props = defineProps({
  modelValue: Boolean,
  prototype: {
    type: Object as () => any,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "approve", "reject", "updated"]);

// State
const activeTab = ref("materials");
const loadingMaterials = ref(false);
const loadingServices = ref(false);
const materials = ref<any[]>([]);
const services = ref<any[]>([]);
const materialsSummary = ref<any>(null);
const materialsTotalCost = ref(0);

// Material dialogs
const materialFormDialog = ref(false);
const editingMaterial = ref<any>(null);
const deleteMaterialDialog = ref(false);
const deletingMaterial = ref<any>(null);

// Service dialogs
const serviceFormDialog = ref(false);
const editingService = ref<any>(null);
const deleteServiceDialog = ref(false);
const deletingService = ref<any>(null);

// Computed
const sortedServices = computed(() =>
  [...services.value].sort((a, b) => (a.step_number || 0) - (b.step_number || 0))
);

const nextStepNumber = computed(() => {
  if (services.value.length === 0) return 1;
  return Math.max(...services.value.map((s: any) => s.step_number || 0)) + 1;
});

const totalEstimatedHours = computed(() =>
  services.value.reduce(
    (sum: number, s: any) => sum + (Number(s.estimated_time_hours) || 0),
    0
  )
);

const totalEstimatedCost = computed(() =>
  services.value.reduce((sum: number, s: any) => sum + (Number(s.estimated_cost) || 0), 0)
);

// Watch for open
watch(
  () => props.modelValue,
  async (open) => {
    if (open && props.prototype) {
      activeTab.value = "materials";
      await Promise.all([loadMaterials(), loadServices()]);
    }
  }
);

// =========================================================================
// MATERIALS
// =========================================================================
const loadMaterials = async () => {
  if (!props.prototype?.id) return;
  loadingMaterials.value = true;
  try {
    const data = await prototypeMaterialService.getAll(props.prototype.id);
    materials.value = data.materials || data || [];
    materialsSummary.value = data.summary || null;
    materialsTotalCost.value = Number(data.total_cost) || 0;
  } catch (err) {
    console.error("Błąd ładowania materiałów prototypu:", err);
    materials.value = [];
  } finally {
    loadingMaterials.value = false;
  }
};

const editMaterial = (material: any) => {
  editingMaterial.value = material;
  materialFormDialog.value = true;
};

const confirmDeleteMaterial = (material: any) => {
  deletingMaterial.value = material;
  deleteMaterialDialog.value = true;
};

const handleMaterialSaved = async (payload: any) => {
  try {
    if (editingMaterial.value?.id) {
      await prototypeMaterialService.update(editingMaterial.value.id, payload);
    } else {
      await prototypeMaterialService.create(props.prototype.id, payload);
    }
    materialFormDialog.value = false;
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd zapisu materiału:", err);
    alert("Błąd zapisu materiału");
  }
};

const handleDeleteMaterial = async () => {
  try {
    await prototypeMaterialService.delete(deletingMaterial.value.id);
    deleteMaterialDialog.value = false;
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd usuwania materiału:", err);
  }
};

const handleMaterialStatusChange = async (material: any, newStatus: string) => {
  try {
    await prototypeMaterialService.updateStatus(material.id, newStatus);
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd zmiany statusu:", err);
  }
};

const markAllMaterialsOrdered = async () => {
  // Mark each NOT_ORDERED as ORDERED
  try {
    const promises = materials.value
      .filter((m: any) => m.status === "NOT_ORDERED")
      .map((m: any) => prototypeMaterialService.updateStatus(m.id, "ORDERED"));
    await Promise.all(promises);
    await loadMaterials();
    emit("updated");
  } catch (err) {
    console.error("Błąd masowego zamawiania:", err);
  }
};

// =========================================================================
// SERVICES (RCP)
// =========================================================================
const loadServices = async () => {
  if (!props.prototype?.id) return;
  loadingServices.value = true;
  try {
    services.value = await prototypeServiceService.getAll(props.prototype.id);
  } catch (err) {
    console.error("Błąd ładowania usług prototypu:", err);
    services.value = [];
  } finally {
    loadingServices.value = false;
  }
};

const editService = (service: any) => {
  editingService.value = service;
  serviceFormDialog.value = true;
};

const confirmDeleteService = (service: any) => {
  deletingService.value = service;
  deleteServiceDialog.value = true;
};

const handleServiceSaved = async (payload: any) => {
  try {
    if (editingService.value?.id) {
      await prototypeServiceService.update(editingService.value.id, payload);
    } else {
      await prototypeServiceService.create(props.prototype.id, payload);
    }
    serviceFormDialog.value = false;
    await loadServices();
    emit("updated");
  } catch (err) {
    console.error("Błąd zapisu zadania RCP:", err);
    alert("Błąd zapisu zadania");
  }
};

const handleDeleteService = async () => {
  try {
    await prototypeServiceService.delete(deletingService.value.id);
    deleteServiceDialog.value = false;
    await loadServices();
    emit("updated");
  } catch (err) {
    console.error("Błąd usuwania zadania:", err);
  }
};

// =========================================================================
// HELPERS
// =========================================================================
const getServiceStatusColor = (status: string) => {
  const map: Record<string, string> = {
    PLANNED: "grey",
    IN_PROGRESS: "orange",
    PAUSED: "yellow",
    COMPLETED: "green",
    CANCELLED: "red",
  };
  return map[status] || "grey";
};

const getServiceStatusLabel = (status: string) => {
  const map: Record<string, string> = {
    PLANNED: "Zaplanowane",
    IN_PROGRESS: "W trakcie",
    PAUSED: "Wstrzymane",
    COMPLETED: "Zakończone",
    CANCELLED: "Anulowane",
  };
  return map[status] || status;
};

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);

const formatDateTime = (date: string) =>
  date ? new Date(date).toLocaleString("pl-PL") : "—";

const close = () => {
  emit("update:modelValue", false);
};
</script>


=================================================================================
FILE: src/components/prototypes/PrototypeServiceFormDialog.vue
LOCATION: .//src/components/prototypes/PrototypeServiceFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="600"
    persistent
  >
    <v-card>
      <v-card-title class="bg-deep-purple text-white d-flex align-center">
        <v-icon start color="white">{{ isEdit ? "mdi-pencil" : "mdi-plus" }}</v-icon>
        {{ isEdit ? "Edytuj zadanie RCP" : "Dodaj zadanie RCP" }}
      </v-card-title>

      <v-card-text class="pt-6">
        <v-form ref="formRef" v-model="formValid">
          <v-row>
            <v-col cols="8">
              <v-text-field
                v-model="form.service_name"
                label="Nazwa usługi / operacji *"
                :rules="[(v) => !!v || 'Podaj nazwę']"
                variant="outlined"
                density="compact"
                placeholder="np. Cięcie laserowe, Montaż, Malowanie"
              />
            </v-col>
            <v-col cols="4">
              <v-text-field
                v-model.number="form.step_number"
                label="Krok #"
                type="number"
                min="1"
                variant="outlined"
                density="compact"
              />
            </v-col>

            <!-- Workstation -->
            <v-col cols="12">
              <v-autocomplete
                v-model="form.workstation_id"
                :items="workstations"
                item-title="name"
                item-value="id"
                label="Stanowisko robocze"
                variant="outlined"
                density="compact"
                clearable
              >
                <template v-slot:item="{ item, props: itemProps }">
                  <v-list-item v-bind="itemProps">
                    <template v-slot:prepend>
                      <v-icon color="blue" size="small">mdi-desktop-tower</v-icon>
                    </template>
                    <v-list-item-subtitle v-if="item.raw.type">
                      {{ item.raw.type }}
                      {{ item.raw.location ? "• " + item.raw.location : "" }}
                    </v-list-item-subtitle>
                  </v-list-item>
                </template>
              </v-autocomplete>
            </v-col>

            <!-- Assigned worker -->
            <v-col cols="12">
              <v-autocomplete
                v-model="form.assigned_to_user_id"
                :items="workers"
                item-title="name"
                item-value="id"
                label="Przypisany pracownik"
                variant="outlined"
                density="compact"
                clearable
              >
                <template v-slot:item="{ item, props: itemProps }">
                  <v-list-item v-bind="itemProps">
                    <template v-slot:prepend>
                      <v-avatar size="28" color="grey-lighten-3">
                        <span class="text-caption font-weight-bold">
                          {{ item.raw.name?.charAt(0) || "?" }}
                        </span>
                      </v-avatar>
                    </template>
                  </v-list-item>
                </template>
              </v-autocomplete>
            </v-col>

            <v-col cols="12">
              <v-divider class="mb-2" />
              <div class="text-subtitle-2 text-medium-emphasis mb-2">
                <v-icon size="small" class="mr-1">mdi-calculator</v-icon>
                Szacunkowe wartości
              </div>
            </v-col>

            <v-col cols="4">
              <v-text-field
                v-model.number="form.estimated_quantity"
                label="Ilość"
                type="number"
                min="0"
                step="1"
                variant="outlined"
                density="compact"
              />
            </v-col>
            <v-col cols="4">
              <v-text-field
                v-model.number="form.estimated_time_hours"
                label="Czas (h)"
                type="number"
                min="0"
                step="0.25"
                variant="outlined"
                density="compact"
              />
            </v-col>
            <v-col cols="4">
              <v-text-field
                v-model.number="form.estimated_cost"
                label="Koszt (PLN)"
                type="number"
                min="0"
                step="0.01"
                variant="outlined"
                density="compact"
              />
            </v-col>

            <!-- Status (only for edit) -->
            <v-col v-if="isEdit" cols="12">
              <v-select
                v-model="form.status"
                :items="statusOptions"
                item-title="label"
                item-value="value"
                label="Status"
                variant="outlined"
                density="compact"
              >
                <template v-slot:item="{ item, props: itemProps }">
                  <v-list-item v-bind="itemProps">
                    <template v-slot:prepend>
                      <v-icon :color="item.raw.color" size="small">{{
                        item.raw.icon
                      }}</v-icon>
                    </template>
                  </v-list-item>
                </template>
              </v-select>
            </v-col>

            <v-col cols="12">
              <v-textarea
                v-model="form.worker_notes"
                label="Notatki"
                variant="outlined"
                density="compact"
                rows="2"
                auto-grow
              />
            </v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn @click="close">Anuluj</v-btn>
        <v-btn
          color="deep-purple"
          variant="elevated"
          :loading="saving"
          :disabled="!formValid"
          @click="save"
        >
          {{ isEdit ? "Zapisz" : "Dodaj" }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { workstationService } from "@/services/workstationService";

const props = defineProps({
  modelValue: Boolean,
  service: {
    type: Object as () => any,
    default: null,
  },
  nextStepNumber: {
    type: Number,
    default: 1,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

const formRef = ref();
const formValid = ref(false);
const saving = ref(false);
const workstations = ref<any[]>([]);
const workers = ref<any[]>([]);

const isEdit = computed(() => !!props.service?.id);

const statusOptions = [
  { value: "PLANNED", label: "Zaplanowane", color: "grey", icon: "mdi-clock-outline" },
  { value: "IN_PROGRESS", label: "W trakcie", color: "orange", icon: "mdi-cog" },
  { value: "PAUSED", label: "Wstrzymane", color: "yellow", icon: "mdi-pause" },
  { value: "COMPLETED", label: "Zakończone", color: "green", icon: "mdi-check-circle" },
  { value: "CANCELLED", label: "Anulowane", color: "red", icon: "mdi-cancel" },
];

const defaultForm = () => ({
  service_name: "",
  step_number: props.nextStepNumber,
  workstation_id: null as number | null,
  assigned_to_user_id: null as number | null,
  estimated_quantity: 1,
  estimated_time_hours: 1,
  estimated_cost: 0,
  status: "PLANNED",
  worker_notes: "",
});

const form = ref(defaultForm());

watch(
  () => props.modelValue,
  async (open) => {
    if (open) {
      await loadData();
      if (props.service) {
        form.value = {
          service_name: props.service.service_name,
          step_number: props.service.step_number,
          workstation_id: props.service.workstation_id,
          assigned_to_user_id: props.service.assigned_to_user_id,
          estimated_quantity: Number(props.service.estimated_quantity || 1),
          estimated_time_hours: Number(props.service.estimated_time_hours || 1),
          estimated_cost: Number(props.service.estimated_cost || 0),
          status: props.service.status || "PLANNED",
          worker_notes: props.service.worker_notes || "",
        };
      } else {
        form.value = defaultForm();
      }
    }
  }
);

const loadData = async () => {
  try {
    const [ws, wk] = await Promise.all([
      workstationService.getAll(),
      workstationService.getWorkers(),
    ]);
    workstations.value = ws;
    workers.value = wk;
  } catch (err) {
    console.error("Błąd ładowania danych:", err);
  }
};

const save = () => {
  saving.value = true;
  emit("saved", { ...form.value });
};

watch(
  () => props.modelValue,
  (open) => {
    if (!open) saving.value = false;
  }
);

const close = () => {
  emit("update:modelValue", false);
};
</script>


=================================================================================
FILE: src/components/quotations/BatchServiceAddDialog.vue
LOCATION: .//src/components/quotations/BatchServiceAddDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="900"
    persistent
  >
    <v-card>
      <v-card-title class="bg-orange-darken-1 text-white d-flex align-center">
        <v-icon start color="white">mdi-table-arrow-down</v-icon>
        Import usług
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" @click="close" />
      </v-card-title>

      <v-card-text class="pt-6">
        <v-row>
          <!-- LEWA STRONA: Wklejanie -->
          <v-col cols="12" md="5">
            <div class="text-subtitle-2 mb-2">Skopiuj kolumny (bez nagłówków):</div>
            <div class="text-caption text-medium-emphasis mb-2 font-italic">
              Kolejność: <strong>[Nazwa usługi]</strong> [TAB]
              <strong>[Ilość godzin]</strong> [TAB] <strong>[Stawka/h]</strong>
            </div>

            <v-textarea
              v-model="rawInput"
              placeholder="Wklej tutaj dane...

Przykładowe dane:
Drukowanie UV   20   100
Laser CNC       1    140
Obróbka ręczna  3    70"
              variant="outlined"
              rows="14"
              no-resize
              class="font-monospace"
              @update:model-value="parseInput"
            ></v-textarea>
          </v-col>

          <!-- ŚRODEK -->
          <v-col cols="12" md="1" class="d-flex align-center justify-center">
            <v-icon size="32" color="grey-lighten-1">mdi-arrow-right-bold</v-icon>
          </v-col>

          <!-- PRAWA STRONA: Podgląd -->
          <v-col cols="12" md="6">
            <div class="text-subtitle-2 mb-2 d-flex justify-space-between">
              <span>2. Podgląd danych:</span>
              <span v-if="parsedItems.length > 0" class="text-orange font-weight-bold">
                {{ parsedItems.length }} pozycji
              </span>
            </div>

            <v-table density="compact" class="border rounded" fixed-header height="414px">
              <thead>
                <tr class="bg-grey-lighten-4">
                  <th>Nazwa usługi</th>
                  <th class="text-right">Godziny (h)</th>
                  <th class="text-right">Stawka</th>
                  <th class="text-center" style="width: 50px"></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in parsedItems" :key="index">
                  <td class="text-truncate" style="max-width: 150px" :title="item.name">
                    {{ item.name }}
                  </td>
                  <td class="text-right font-weight-bold">{{ item.quantity }} h</td>
                  <td class="text-right">{{ formatCurrency(item.unit_price) }}</td>
                  <td class="text-center">
                    <v-btn
                      icon="mdi-close"
                      size="x-small"
                      variant="text"
                      color="error"
                      @click="removeItem(index)"
                    />
                  </td>
                </tr>
                <tr v-if="parsedItems.length === 0">
                  <td colspan="4" class="text-center text-medium-emphasis py-12">
                    <v-icon class="mb-2">mdi-clipboard-text-off-outline</v-icon><br />
                    Wklej dane po lewej stronie.
                  </td>
                </tr>
              </tbody>
            </v-table>

            <v-alert
              v-if="validationError"
              type="warning"
              variant="tonal"
              density="compact"
              class="mt-2"
              icon="mdi-alert"
            >
              {{ validationError }}
            </v-alert>
          </v-col>
        </v-row>
      </v-card-text>

      <v-divider />

      <v-card-actions class="pa-4 bg-grey-lighten-5">
        <v-btn variant="text" color="grey-darken-1" @click="clear">Wyczyść</v-btn>
        <v-spacer />
        <v-btn variant="text" @click="close">Anuluj</v-btn>
        <v-btn
          color="orange"
          variant="elevated"
          :disabled="parsedItems.length === 0 || !!validationError"
          :loading="loading"
          @click="save"
          prepend-icon="mdi-check"
        >
          Importuj ({{ parsedItems.length }})
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";

const props = defineProps({
  modelValue: Boolean,
  loading: Boolean,
});

const emit = defineEmits(["update:modelValue", "save"]);

const rawInput = ref("");
const parsedItems = ref<any[]>([]);
const validationError = ref<string | null>(null);

watch(
  () => props.modelValue,
  (val) => {
    if (val) clear();
  }
);

const clear = () => {
  rawInput.value = "";
  parsedItems.value = [];
  validationError.value = null;
};

const parseInput = () => {
  if (!rawInput.value) {
    parsedItems.value = [];
    validationError.value = null;
    return;
  }

  const rows = rawInput.value.trim().split(/\r?\n/);
  const items: any[] = [];
  let error: string | null = null;

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i].trim();
    if (!row) continue;

    // Rozdzielanie po tabulatorze lub wielu spacjach
    const parts = row.split(/\t|\s{2,}/);

    // Oczekujemy: [0] Nazwa, [1] Godziny, [2] Stawka
    const name = parts[0]?.trim();
    if (!name) continue;

    // Parsowanie Godzin
    let quantityStr = parts[1]?.trim();
    quantityStr = quantityStr ? quantityStr.replace(/\s/g, "").replace(",", ".") : "0";
    const quantity = parseFloat(quantityStr);

    if (isNaN(quantity)) {
      error = `Wiersz ${i + 1}: "${name}" - nieprawidłowa ilość godzin.`;
      break;
    }

    // Parsowanie Stawki (Unit Price)
    let priceStr = parts[2]?.trim();
    let unitPrice = 0;

    if (priceStr) {
      priceStr = priceStr.replace(/[^\d.,]/g, "").replace(",", ".");
      const parsedPrice = parseFloat(priceStr);
      if (!isNaN(parsedPrice)) unitPrice = parsedPrice;
    }

    items.push({
      name,
      quantity, // To będą estimated_time_hours
      unit: "h", // Domyślna jednostka dla usług z tego formularza
      unit_price: unitPrice,
    });
  }

  parsedItems.value = items;
  validationError.value = error;
};

const removeItem = (index: number) => {
  parsedItems.value.splice(index, 1);
};

const save = () => {
  // Wysyłamy dane do rodzica
  emit("save", parsedItems.value);
};

const close = () => {
  emit("update:modelValue", false);
};

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);
</script>

<style scoped>
.font-monospace {
  font-family: "Roboto Mono", monospace !important;
  font-size: 0.85rem;
}
</style>


=================================================================================
FILE: src/components/quotations/QuotationCard.vue
LOCATION: .//src/components/quotations/QuotationCard.vue
=================================================================================

<template>
  <v-card elevation="2" :class="{ 'border-success': quotation.is_approved }">
    <v-card-title class="d-flex align-center">
      <v-chip
        :color="quotation.is_approved ? 'success' : 'grey'"
        size="small"
        class="mr-3"
      >
        v{{ quotation.version_number }}
      </v-chip>

      <span class="flex-grow-1"> Wycena #{{ quotation.version_number }} </span>

      <v-chip v-if="quotation.is_approved" color="success" variant="flat">
        <v-icon start>mdi-check-circle</v-icon>
        ZATWIERDZONA
      </v-chip>
    </v-card-title>

    <v-card-text>
      <v-row dense>
        <v-col cols="6">
          <div class="text-caption text-medium-emphasis">Materiały</div>
          <div class="text-h6 font-weight-bold">
            {{ formatCurrency(quotation.total_materials_cost) }}
          </div>
        </v-col>
        <v-col cols="6">
          <div class="text-caption text-medium-emphasis">Usługi</div>
          <div class="text-h6 font-weight-bold">
            {{ formatCurrency(quotation.total_services_cost) }}
          </div>
        </v-col>
      </v-row>

      <v-divider class="my-3" />

      <v-row dense>
        <v-col cols="6">
          <div class="text-caption text-medium-emphasis">Netto</div>
          <div class="text-h5 font-weight-bold text-primary">
            {{ formatCurrency(quotation.total_net) }}
          </div>
        </v-col>
        <v-col cols="6">
          <div class="text-caption text-medium-emphasis">Brutto (VAT 23%)</div>
          <div class="text-h5 font-weight-bold">
            {{ formatCurrency(quotation.total_gross) }}
          </div>
        </v-col>
      </v-row>

      <v-divider class="my-3" />

      <div class="d-flex align-center">
        <v-icon size="small" class="mr-2">mdi-percent</v-icon>
        <span class="text-caption">Marża: {{ quotation.margin_percent }}%</span>
        <v-spacer />
        <v-icon size="small" class="mr-2">mdi-calendar</v-icon>
        <span class="text-caption">{{ formatDate(quotation.created_at) }}</span>
      </div>

      <div v-if="quotation.notes" class="mt-3">
        <v-chip size="small" variant="outlined">
          <v-icon start size="small">mdi-note-text</v-icon>
          {{ quotation.notes }}
        </v-chip>
      </div>
    </v-card-text>

    <v-card-actions>
      <v-btn size="small" variant="text" color="primary" @click="$emit('view')">
        <v-icon start>mdi-eye</v-icon>
        Podgląd
      </v-btn>

      <v-btn
        v-if="!quotation.is_approved"
        size="small"
        variant="text"
        color="success"
        @click="$emit('approve')"
      >
        <v-icon start>mdi-check</v-icon>
        Zatwierdź
      </v-btn>

      <v-spacer />

      <v-btn
        size="small"
        icon="mdi-file-pdf"
        variant="text"
        color="error"
        @click="$emit('pdf')"
      />
    </v-card-actions>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from "vue";

const props = defineProps({
  quotation: {
    type: Object,
    required: true,
  },
});

defineEmits(["view", "approve", "pdf"]);

const formatCurrency = (value) => {
  if (!value) return "0,00 PLN";
  return new Intl.NumberFormat("pl-PL", {
    style: "currency",
    currency: "PLN",
  }).format(value);
};

const formatDate = (date) => {
  if (!date) return "-";
  return new Date(date).toLocaleDateString("pl-PL");
};
</script>

<style scoped>
.border-success {
  border: 2px solid #4caf50 !important;
}
</style>


=================================================================================
FILE: src/components/quotations/QuotationDetailsDialog.vue
LOCATION: .//src/components/quotations/QuotationDetailsDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="1200"
    scrollable
  >
    <v-card v-if="quotation">
      <!-- Header -->
      <v-card-title class="bg-primary text-white pa-4">
        <div class="d-flex align-center justify-space-between w-100">
          <div class="d-flex align-center">
            <v-icon start color="white" size="large">mdi-file-document-outline</v-icon>
            <div>
              <div class="text-h5 font-weight-bold">
                Wycena - Wersja {{ quotation.version_number }}
              </div>
              <div class="text-caption opacity-90 mt-1">
                Utworzono: {{ formatDate(quotation.created_at) }}
              </div>
            </div>
          </div>
          <v-chip
            v-if="quotation.is_approved"
            color="success"
            size="large"
            class="font-weight-bold"
            variant="flat"
          >
            <v-icon start size="small">mdi-check-decagram</v-icon>
            Zatwierdzona
          </v-chip>
          <v-chip v-else size="large" class="font-weight-bold">
            <v-icon start size="small">mdi-clock-outline</v-icon>
            Oczekująca
          </v-chip>
        </div>
      </v-card-title>
      <div class="px-6 pt-4">
        <!-- Informacje o zatwierdzeniu - jeden Wariant -->
        <v-alert
          v-if="quotation.is_approved"
          type="success"
          variant="tonal"
          prominent
          border="start"
          class="mb-4"
          icon="mdi-check-decagram"
        >
          <div class="text-body-1">
            <strong
              >Wycena zatwierdzona dnia
              {{ formatApprovalDate(quotation.approved_at) }} przez
              {{ quotation.approved_by?.name || "System" }}</strong
            >
          </div>
        </v-alert>
      </div>

      <v-card-text class="px-6 pt-0">
        <!-- Podsumowanie finansowe - 4 kolumny w jednym rzędzie -->
        <div class="summary-grid mb-6">
          <!-- Materiały -->
          <v-card variant="flat" color="grey-lighten-3" class="pa-4">
            <div class="text-caption text-medium-emphasis mb-2">Materiały</div>
            <div class="text-h5 font-weight-bold text-grey-darken-3">
              {{ formatCurrency(quotation.total_materials_cost) }}
            </div>
          </v-card>

          <!-- Usługi -->
          <v-card variant="flat" color="grey-lighten-3" class="pa-4">
            <div class="text-caption text-medium-emphasis mb-2">Usługi</div>
            <div class="text-h5 font-weight-bold text-grey-darken-3">
              {{ formatCurrency(quotation.total_services_cost) }}
            </div>
          </v-card>

          <!-- Netto -->
          <v-card variant="flat" color="blue-lighten-4" class="pa-4">
            <div class="text-caption text-grey-darken-2 mb-2">Netto</div>
            <div class="text-h5 font-weight-bold text-blue-darken-3">
              {{ formatCurrency(quotation.total_net) }}
            </div>
            <div class="text-caption text-grey-darken-1 mt-1">
              Marża: {{ quotation.margin_percent }}%
            </div>
          </v-card>

          <!-- Brutto -->
          <v-card variant="flat" color="green-lighten-4" class="pa-4">
            <div class="text-caption text-grey-darken-2 mb-2">Brutto</div>
            <div class="text-h4 font-weight-bold text-green-darken-3">
              {{ formatCurrency(quotation.total_gross) }}
            </div>
            <div class="text-caption text-grey-darken-1 mt-1">23% VAT</div>
          </v-card>
        </div>

        <!-- Materiały -->
        <v-card class="mb-6 overflow-hidden" elevation="0" outlined>
          <v-card-title class="bg-grey-lighten-3 d-flex align-center pa-4">
            <v-icon start color="grey-darken-3" size="28">mdi-package-variant</v-icon>
            <span class="text-h6 font-weight-bold">Materiały</span>
            <v-chip size="small" color="grey-darken-1" class="ml-2">
              {{ totalMaterialsCount }} poz.
            </v-chip>
            <v-spacer />
            <span class="text-h6 font-weight-bold">
              {{ formatCurrency(quotation.total_materials_cost) }}
            </span>
          </v-card-title>

          <table class="quotation-table">
            <thead>
              <tr>
                <th style="width: 60px; text-align: center">LP</th>
                <th style="width: 35%; text-align: left">NAZWA MATERIAŁU</th>
                <th style="width: 20%; text-align: left">KATEGORIA</th>
                <th style="width: 10%; text-align: right">ILOŚĆ</th>
                <th style="width: 8%; text-align: center">JEDN.</th>
                <th style="width: 12%; text-align: right">CENA JEDN.</th>
                <th style="width: 15%; text-align: right">WARTOŚĆ</th>
              </tr>
            </thead>
            <tbody>
              <template v-for="item in quotation.items" :key="`mat-item-${item.id}`">
                <tr
                  v-for="(material, idx) in item.materials"
                  :key="`mat-${material.id}`"
                  :class="{ 'row-even': idx % 2 === 0 }"
                >
                  <td style="text-align: center">{{ idx + 1 }}</td>
                  <td style="text-align: left">
                    <strong>{{ material.assortment_item?.name || "Brak nazwy" }}</strong>
                  </td>
                  <td style="text-align: left">
                    {{ material.assortment_item?.category || "-" }}
                  </td>
                  <td style="text-align: right">
                    <strong>{{ formatNumber(material.quantity) }}</strong>
                  </td>
                  <td style="text-align: center">
                    <v-chip size="x-small" variant="tonal" color="grey">
                      {{ material.unit }}
                    </v-chip>
                  </td>
                  <td style="text-align: right">
                    {{ formatCurrency(material.unit_price) }}
                  </td>
                  <td style="text-align: right">
                    <strong>{{ formatCurrency(material.total_cost) }}</strong>
                  </td>
                </tr>
              </template>
              <tr v-if="totalMaterialsCount === 0">
                <td colspan="7" style="text-align: center; padding: 24px">
                  Brak materiałów
                </td>
              </tr>
            </tbody>
          </table>
        </v-card>

        <!-- Usługi -->
        <v-card class="mb-6 overflow-hidden" elevation="0" outlined>
          <v-card-title class="bg-blue-lighten-5 d-flex align-center pa-4">
            <v-icon start color="blue-darken-2" size="28">mdi-wrench</v-icon>
            <span class="text-h6 font-weight-bold">Usługi</span>
            <v-chip size="small" color="blue-darken-1" class="ml-2">
              {{ totalServicesCount }} poz.
            </v-chip>
            <v-spacer />
            <span class="text-h6 font-weight-bold">
              {{ formatCurrency(quotation.total_services_cost) }}
            </span>
          </v-card-title>

          <table class="quotation-table">
            <thead>
              <tr>
                <th style="width: 60px; text-align: center">LP</th>
                <th style="width: 30%; text-align: left">NAZWA USŁUGI</th>
                <th style="width: 20%; text-align: left">KATEGORIA</th>
                <th style="width: 10%; text-align: right">ILOŚĆ</th>
                <th style="width: 10%; text-align: right">CZAS (H)</th>
                <th style="width: 12%; text-align: right">STAWKA /H</th>
                <th style="width: 15%; text-align: right">WARTOŚĆ</th>
              </tr>
            </thead>
            <tbody>
              <template v-for="item in quotation.items" :key="`srv-item-${item.id}`">
                <tr
                  v-for="(service, idx) in item.services"
                  :key="`srv-${service.id}`"
                  :class="{ 'row-even': idx % 2 === 0 }"
                >
                  <td style="text-align: center">{{ idx + 1 }}</td>
                  <td style="text-align: left">
                    <strong>{{ service.assortment_item?.name || "Brak nazwy" }}</strong>
                  </td>
                  <td style="text-align: left">
                    {{ service.assortment_item?.category || "-" }}
                  </td>
                  <td style="text-align: right">
                    <strong>{{ formatNumber(service.estimated_quantity) }}</strong>
                  </td>
                  <td style="text-align: right">
                    <v-chip size="x-small" color="blue" variant="tonal">
                      {{ formatNumber(service.estimated_time_hours) }} h
                    </v-chip>
                  </td>
                  <td style="text-align: right">
                    {{ formatCurrency(service.unit_price) }}
                  </td>
                  <td style="text-align: right">
                    <strong>{{ formatCurrency(service.total_cost) }}</strong>
                  </td>
                </tr>
              </template>
              <tr v-if="totalServicesCount === 0">
                <td colspan="7" style="text-align: center; padding: 24px">Brak usług</td>
              </tr>
            </tbody>
          </table>
        </v-card>

        <!-- Notatki -->
        <v-card v-if="quotation.notes" variant="outlined" class="mb-4">
          <v-card-title class="text-subtitle-1 bg-grey-lighten-4">
            <v-icon start size="small">mdi-note-text</v-icon>
            Notatki
          </v-card-title>
          <v-card-text class="pa-4">
            {{ quotation.notes }}
          </v-card-text>
        </v-card>
      </v-card-text>

      <!-- Footer -->
      <v-divider />
      <v-card-actions class="px-6 py-4 bg-grey-lighten-4">
        <v-btn
          variant="outlined"
          prepend-icon="mdi-download"
          :loading="loadingPdf"
          size="large"
          @click="downloadPdf"
        >
          POBIERZ PDF
        </v-btn>
        <v-spacer />
        <v-btn variant="elevated" color="primary" size="large" @click="$emit('close')">
          ZAMKNIJ
        </v-btn>
      </v-card-actions>
    </v-card>

    <!-- Loading state -->
    <v-card v-else>
      <v-card-text class="text-center py-12">
        <v-progress-circular indeterminate color="primary" size="64" />
        <p class="mt-4 text-h6">Ładowanie wyceny...</p>
      </v-card-text>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed } from "vue";
import { useQuotationsStore } from "@/stores/quotations";
import { format } from "date-fns";

const props = defineProps({
  modelValue: {
    type: Boolean,
    required: true,
  },
  quotation: {
    type: Object,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "close"]);

const quotationsStore = useQuotationsStore();
const loadingPdf = ref(false);

// Obliczanie łącznej liczby materiałów
const totalMaterialsCount = computed(() => {
  if (!props.quotation?.items) return 0;
  return props.quotation.items.reduce((sum, item) => {
    return sum + (item.materials?.length || 0);
  }, 0);
});

// Obliczanie łącznej liczby usług
const totalServicesCount = computed(() => {
  if (!props.quotation?.items) return 0;
  return props.quotation.items.reduce((sum, item) => {
    return sum + (item.services?.length || 0);
  }, 0);
});

// Formatowanie walut - ZAWSZE konwertuj na number!
const formatCurrency = (value) => {
  // Upewnij się że value jest liczbą
  let numValue = value;
  if (typeof value === "string") {
    numValue = parseFloat(value.replace(/[^\d.-]/g, ""));
  }
  numValue = Number(numValue) || 0;

  return new Intl.NumberFormat("pl-PL", {
    style: "currency",
    currency: "PLN",
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(numValue);
};

// Formatowanie liczb
const formatNumber = (value) => {
  let numValue = value;
  if (typeof value === "string") {
    numValue = parseFloat(value.replace(/[^\d.-]/g, ""));
  }
  numValue = Number(numValue) || 0;

  return new Intl.NumberFormat("pl-PL", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(numValue);
};

// Formatowanie daty utworzenia (z sekundami)
const formatDate = (date) => {
  if (!date) return "-";
  return new Date(date).toLocaleString("pl-PL", {
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

// Formatowanie daty zatwierdzenia (bez "Utworzono:")
const formatApprovalDate = (date) => {
  if (!date) return "-";
  return new Date(date).toLocaleString("pl-PL", {
    day: "numeric",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

const downloadPdf = async () => {
  if (!props.quotation?.id) return;

  loadingPdf.value = true;
  try {
    // 1. Pobierz plik (Blob) ze Store'a
    const blobData = await quotationsStore.downloadPdf(props.quotation.id);

    // 2. Utwórz obiekt Blob z odpowiednim typem MIME
    const blob = new Blob([blobData], { type: "application/pdf" });

    // 3. Utwórz tymczasowy URL dla tego pliku
    const url = window.URL.createObjectURL(blob);

    // 4. Stwórz niewidoczny element <a>, ustaw URL i wymuś kliknięcie
    const link = document.createElement("a");
    link.href = url;

    const formattedDate = format(new Date(props.quotation.updated_at), "yyyy-MM-dd");

    link.setAttribute(
      "download",
      `Wycena_v${props.quotation.version_number}_${formattedDate}.pdf`
    );
    document.body.appendChild(link);
    link.click();

    // 5. Posprzątaj (usuń element i zwolnij pamięć)
    link.parentNode.removeChild(link);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error("Download PDF error:", error);
    alert("Błąd podczas pobierania PDF");
  } finally {
    loadingPdf.value = false;
  }
};
</script>

<style scoped>
/* Grid 1x4 dla podsumowania (4 kolumny w jednym rzędzie) */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
}

/* Responsive - na małych ekranach 2x2 */
@media (max-width: 960px) {
  .summary-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Responsive - na bardzo małych ekranach 1 kolumna */
@media (max-width: 600px) {
  .summary-grid {
    grid-template-columns: 1fr;
  }
}

/* Tabela custom - pełna kontrola nad wyrównaniem */
.quotation-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

.quotation-table thead {
  background-color: rgb(250, 250, 250);
  border-bottom: 2px solid rgba(0, 0, 0, 0.12);
}

.quotation-table thead th {
  font-weight: 700;
  font-size: 0.75rem;
  color: rgba(0, 0, 0, 0.87);
  padding: 14px 16px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  border-bottom: 2px solid rgba(0, 0, 0, 0.12);
}

.quotation-table tbody td {
  padding: 12px 16px;
  font-size: 0.875rem;
  color: rgba(0, 0, 0, 0.87);
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
}

.quotation-table tbody tr:hover {
  background-color: rgba(33, 150, 243, 0.08);
  transition: background-color 0.2s;
}

.quotation-table tbody tr.row-even {
  background-color: rgb(252, 252, 252);
}

.quotation-table tbody tr.row-even:hover {
  background-color: rgba(33, 150, 243, 0.08);
}
</style>


=================================================================================
FILE: src/components/quotations/QuotationExportMaterialsDialog.vue
LOCATION: .//src/components/quotations/QuotationExportMaterialsDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="handleClose"
    max-width="480"
    persistent
  >
    <v-card>
      <!-- Nagłówek -->
      <v-card-title class="bg-teal text-white d-flex align-center">
        <v-icon start color="white">mdi-export</v-icon>
        Eksportuj materiały do wariantu
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" color="white" @click="handleClose" />
      </v-card-title>

      <!-- ================================================================ -->
      <!-- WIDOK 1: WYBÓR TRYBU (przed eksportem)                          -->
      <!-- ================================================================ -->
      <template v-if="!exportResult">
        <v-card-text class="pt-5">
          <!-- Info o wycenie -->
          <v-alert type="info" variant="tonal" density="compact" class="mb-5">
            Wycena <strong>v{{ quotation?.version_number }}</strong> zawiera
            <strong>{{ materialsCount }}</strong> materiałów o łącznej wartości
            <strong>{{ formatCurrency(quotation?.total_materials_cost) }}</strong
            >.
          </v-alert>

          <!-- Wybór trybu -->
          <div class="text-subtitle-2 font-weight-bold mb-3">
            Jak obsłużyć materiały już istniejące w wariancie?
          </div>

          <v-radio-group v-model="selectedMode" hide-details>
            <v-radio value="skip" color="teal" class="mb-2">
              <template #label>
                <div>
                  <div class="font-weight-medium">Pomiń istniejące</div>
                  <div class="text-caption text-medium-emphasis">
                    Dodaj tylko nowe materiały. Istniejące pozostają bez zmian.
                  </div>
                </div>
              </template>
            </v-radio>

            <v-radio value="merge" color="teal" class="mb-2">
              <template #label>
                <div>
                  <div class="font-weight-medium">Scal ilości</div>
                  <div class="text-caption text-medium-emphasis">
                    Dodaj ilość z wyceny do już istniejącej. Cena pozostaje bez zmian.
                  </div>
                </div>
              </template>
            </v-radio>

            <v-radio value="replace" color="teal">
              <template #label>
                <div>
                  <div class="font-weight-medium">Zastąp całą listę</div>
                  <div class="text-caption text-medium-emphasis">
                    Usuń wszystkie aktualne materiały wariantu i wstaw tylko te z wyceny.
                  </div>
                </div>
              </template>
            </v-radio>
          </v-radio-group>
        </v-card-text>

        <v-card-actions class="pa-4 bg-grey-lighten-5">
          <v-spacer />
          <v-btn variant="text" color="grey-darken-1" @click="handleClose">
            Anuluj
          </v-btn>
          <v-btn
            color="teal"
            variant="elevated"
            :loading="loading"
            prepend-icon="mdi-check"
            @click="doExport"
          >
            Eksportuj
          </v-btn>
        </v-card-actions>
      </template>

      <!-- ================================================================ -->
      <!-- WIDOK 2: PODSUMOWANIE (po eksporcie)                            -->
      <!-- ================================================================ -->
      <template v-else>
        <v-card-text class="pt-5">
          <!-- Ikona sukcesu -->
          <div class="text-center mb-5">
            <v-icon size="56" color="teal">mdi-check-circle</v-icon>
            <div class="text-h6 font-weight-bold mt-2">Eksport zakończony</div>
            <div class="text-caption text-medium-emphasis mt-1">
              Tryb: <strong>{{ modeLabel }}</strong>
            </div>
          </div>

          <!-- Lista statystyk -->
          <v-list density="compact" class="pa-0 border rounded">
            <v-list-item v-if="exportResult.stats.exported > 0" class="py-3">
              <template #prepend>
                <v-icon color="success" class="mr-3">mdi-plus-circle</v-icon>
              </template>
              <v-list-item-title>Dodano nowych</v-list-item-title>
              <template #append>
                <v-chip color="success" size="small" label>
                  {{ exportResult.stats.exported }}
                </v-chip>
              </template>
            </v-list-item>

            <v-divider v-if="exportResult.stats.exported > 0 && hasMoreStats" />

            <v-list-item v-if="exportResult.stats.replaced > 0" class="py-3">
              <template #prepend>
                <v-icon color="blue" class="mr-3">mdi-refresh</v-icon>
              </template>
              <v-list-item-title>Zastąpionych (nadpisanych)</v-list-item-title>
              <template #append>
                <v-chip color="blue" size="small" label>
                  {{ exportResult.stats.replaced }}
                </v-chip>
              </template>
            </v-list-item>

            <v-divider
              v-if="
                exportResult.stats.replaced > 0 &&
                (exportResult.stats.merged > 0 || exportResult.stats.skipped > 0)
              "
            />

            <v-list-item v-if="exportResult.stats.merged > 0" class="py-3">
              <template #prepend>
                <v-icon color="orange" class="mr-3">mdi-merge</v-icon>
              </template>
              <v-list-item-title>Scalonych (ilości zsumowane)</v-list-item-title>
              <template #append>
                <v-chip color="orange" size="small" label>
                  {{ exportResult.stats.merged }}
                </v-chip>
              </template>
            </v-list-item>

            <v-divider
              v-if="exportResult.stats.merged > 0 && exportResult.stats.skipped > 0"
            />

            <v-list-item v-if="exportResult.stats.skipped > 0" class="py-3">
              <template #prepend>
                <v-icon color="grey" class="mr-3">mdi-minus-circle</v-icon>
              </template>
              <v-list-item-title class="text-medium-emphasis">
                Pominiętych (już istniały)
              </v-list-item-title>
              <template #append>
                <v-chip color="grey" size="small" label>
                  {{ exportResult.stats.skipped }}
                </v-chip>
              </template>
            </v-list-item>

            <!-- Brak zmian -->
            <v-list-item v-if="totalProcessed === 0" class="py-3">
              <template #prepend>
                <v-icon color="grey" class="mr-3">mdi-information</v-icon>
              </template>
              <v-list-item-title class="text-medium-emphasis">
                Brak materiałów do przetworzenia
              </v-list-item-title>
            </v-list-item>
          </v-list>
        </v-card-text>

        <v-card-actions class="pa-4 bg-grey-lighten-5">
          <v-spacer />
          <v-btn
            color="teal"
            variant="elevated"
            prepend-icon="mdi-close"
            @click="handleClose"
          >
            Zamknij
          </v-btn>
        </v-card-actions>
      </template>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useQuotationsStore } from "@/stores/quotations";

// =========================================================================
// PROPS & EMITS
// =========================================================================

const props = defineProps({
  modelValue: { type: Boolean, required: true },
  quotation: { type: Object, default: null },
});

const emit = defineEmits<{
  "update:modelValue": [value: boolean];
  exported: [];
}>();

// =========================================================================
// STATE
// =========================================================================

const quotationsStore = useQuotationsStore();

type ExportMode = "skip" | "merge" | "replace";

const selectedMode = ref<ExportMode>("replace");
const loading = ref(false);

// Po eksporcie — null = pokazuj formularz, obiekt = pokazuj podsumowanie
const exportResult = ref<{ stats: Record<string, number>; message: string } | null>(null);

// Zapamiętaj tryb dla widoku podsumowania (selectedMode może się zmienić przy kolejnym otwarciu)
const usedMode = ref<ExportMode>("replace");

// =========================================================================
// COMPUTED
// =========================================================================

const materialsCount = computed(() => {
  if (!props.quotation?.items) return 0;
  return props.quotation.items.reduce(
    (sum: number, item: any) => sum + (item.materials?.length || 0),
    0
  );
});

const modeLabel = computed(() => {
  const labels: Record<ExportMode, string> = {
    skip: "Pomiń istniejące",
    merge: "Scal ilości",
    replace: "Zastąp istniejące",
  };
  return labels[usedMode.value];
});

const hasMoreStats = computed(() => {
  if (!exportResult.value) return false;
  const s = exportResult.value.stats;
  return (s.replaced || 0) + (s.merged || 0) + (s.skipped || 0) > 0;
});

const totalProcessed = computed(() => {
  if (!exportResult.value) return 0;
  const s = exportResult.value.stats;
  return (s.exported || 0) + (s.replaced || 0) + (s.merged || 0) + (s.skipped || 0);
});

// =========================================================================
// WATCHERS
// =========================================================================

// Reset przy każdym otwarciu dialogu
watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen) {
      exportResult.value = null;
      selectedMode.value = "replace";
      usedMode.value = "replace";
      loading.value = false;
    }
  }
);

// =========================================================================
// METODY
// =========================================================================

const doExport = async () => {
  if (!props.quotation?.id) return;

  loading.value = true;
  usedMode.value = selectedMode.value; // Zapamiętaj przed eksportem

  try {
    const result = await quotationsStore.exportMaterials(
      props.quotation.id,
      selectedMode.value
    );

    // Przełącz na widok podsumowania
    exportResult.value = result;

    // Powiadom rodzica żeby odświeżył zakładkę materiałów
    emit("exported");
  } catch (error: any) {
    console.error("Export materials error:", error);
    alert("Błąd eksportu: " + (error.response?.data?.message || error.message));
  } finally {
    loading.value = false;
  }
};

const handleClose = () => {
  emit("update:modelValue", false);
  // Krótkie opóźnienie żeby animacja zamknięcia nie migała
  setTimeout(() => {
    exportResult.value = null;
    selectedMode.value = "replace";
    usedMode.value = "replace";
  }, 300);
};

// =========================================================================
// POMOCNICZE
// =========================================================================

const formatCurrency = (val: any) =>
  new Intl.NumberFormat("pl-PL", { style: "currency", currency: "PLN" }).format(val || 0);
</script>


=================================================================================
FILE: src/components/quotations/QuotationFormDialog.vue
LOCATION: .//src/components/quotations/QuotationFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    fullscreen
    transition="dialog-bottom-transition"
  >
    <v-card>
      <!-- Toolbar -->
      <v-toolbar color="primary">
        <v-btn icon="mdi-close" @click="closeDialog" />
        <v-toolbar-title>
          {{ isEdit ? `Edycja Wyceny v${quotation.version_number}` : "Nowa Wycena" }}
        </v-toolbar-title>
        <v-spacer />
        <v-toolbar-items>
          <v-btn variant="text" :loading="saving" @click="saveQuotation">
            <v-icon start>mdi-content-save</v-icon>
            Zapisz
          </v-btn>
        </v-toolbar-items>
      </v-toolbar>

      <v-card-text class="bg-grey-lighten-4 pa-4">
        <v-row>
          <!-- LEWA KOLUMNA: Edytor -->
          <v-col cols="12" md="8">
            <!-- Sekcja Materiałów -->
            <v-card class="mb-4" elevation="1">
              <v-card-title class="d-flex align-center py-3 bg-white">
                <v-icon start color="teal">mdi-cube-outline</v-icon>
                Materiały
                <v-spacer />
                <v-btn
                  size="small"
                  color="teal"
                  variant="tonal"
                  prepend-icon="mdi-table-arrow-down"
                  class="mr-2"
                  @click="batchDialog = true"
                >
                  Importuj
                </v-btn>
                <v-btn
                  size="small"
                  color="teal"
                  variant="tonal"
                  prepend-icon="mdi-plus"
                  @click="addMaterial"
                >
                  Dodaj materiał
                </v-btn>
              </v-card-title>

              <v-divider />

              <v-card-text class="pa-0">
                <v-table density="compact">
                  <thead>
                    <tr>
                      <th style="width: 40%">Nazwa</th>
                      <th style="width: 15%">Ilość</th>
                      <th style="width: 10%">J.m.</th>
                      <th style="width: 15%">Cena jedn.</th>
                      <th style="width: 15%">Wartość</th>
                      <th style="width: 5%"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(item, index) in form.materials" :key="index">
                      <td class="py-2">
                        <v-autocomplete
                          v-model="item.assortment_item_id"
                          :items="quotationsStore.materials"
                          item-title="name"
                          item-value="id"
                          density="compact"
                          variant="outlined"
                          hide-details
                          placeholder="Wybierz materiał"
                          auto-select-first
                          @update:model-value="(val) => onMaterialSelect(item, val)"
                        >
                          <template #item="{ props: itemProps, item: material }">
                            <v-list-item
                              v-bind="itemProps"
                              :subtitle="`${material.raw.default_price} PLN / ${material.raw.unit}`"
                            />
                          </template>
                        </v-autocomplete>
                      </td>
                      <td>
                        <v-text-field
                          v-model.number="item.quantity"
                          type="number"
                          min="0"
                          step="0.01"
                          density="compact"
                          variant="outlined"
                          hide-details
                        />
                      </td>
                      <td class="text-caption text-medium-emphasis">
                        {{ item.unit || "-" }}
                      </td>
                      <td>
                        <v-text-field
                          v-model.number="item.unit_price"
                          type="number"
                          min="0"
                          step="0.01"
                          density="compact"
                          variant="outlined"
                          hide-details
                          suffix="zł"
                        />
                      </td>
                      <td class="text-right font-weight-bold">
                        {{ formatCurrency(item.quantity * item.unit_price) }}
                      </td>
                      <td>
                        <v-btn
                          icon="mdi-delete"
                          size="x-small"
                          color="grey"
                          variant="text"
                          @click="removeMaterial(index)"
                        />
                      </td>
                    </tr>
                    <tr v-if="form.materials.length === 0">
                      <td
                        colspan="6"
                        class="text-center text-caption pa-4 text-medium-emphasis"
                      >
                        Brak materiałów. Kliknij "Dodaj materiał" lub "Importuj".
                      </td>
                    </tr>
                  </tbody>
                </v-table>
              </v-card-text>
            </v-card>

            <!-- Sekcja Usług -->
            <v-card elevation="1">
              <v-card-title class="d-flex align-center py-3 bg-white">
                <v-icon start color="orange">mdi-wrench-outline</v-icon>
                Usługi / Robocizna
                <v-spacer />
                <v-btn
                  size="small"
                  color="orange-darken-2"
                  variant="tonal"
                  prepend-icon="mdi-table-arrow-down"
                  class="mr-2"
                  @click="batchServiceDialog = true"
                >
                  Importuj
                </v-btn>
                <v-btn
                  size="small"
                  color="orange-darken-2"
                  variant="tonal"
                  prepend-icon="mdi-plus"
                  @click="addService"
                >
                  Dodaj usługę
                </v-btn>
              </v-card-title>

              <v-divider />

              <v-card-text class="pa-0">
                <v-table density="compact">
                  <thead>
                    <tr>
                      <th style="width: 40%">Nazwa usługi</th>
                      <th style="width: 15%">Godziny (h)</th>
                      <th style="width: 10%"></th>
                      <th style="width: 15%">Stawka/h</th>
                      <th style="width: 15%">Wartość</th>
                      <th style="width: 5%"></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(item, index) in form.services" :key="index">
                      <td class="py-2">
                        <v-autocomplete
                          v-model="item.assortment_item_id"
                          :items="quotationsStore.services"
                          item-title="name"
                          item-value="id"
                          density="compact"
                          variant="outlined"
                          hide-details
                          placeholder="Wybierz usługę"
                          @update:model-value="(val) => onServiceSelect(item, val)"
                        />
                      </td>
                      <td>
                        <v-text-field
                          v-model.number="item.estimated_time_hours"
                          type="number"
                          min="0"
                          step="0.5"
                          density="compact"
                          variant="outlined"
                          hide-details
                        />
                      </td>
                      <td></td>
                      <td>
                        <v-text-field
                          v-model.number="item.unit_price"
                          type="number"
                          min="0"
                          step="1"
                          density="compact"
                          variant="outlined"
                          hide-details
                          suffix="zł"
                        />
                      </td>
                      <td class="text-right font-weight-bold">
                        {{ formatCurrency(item.estimated_time_hours * item.unit_price) }}
                      </td>
                      <td>
                        <v-btn
                          icon="mdi-delete"
                          size="x-small"
                          color="grey"
                          variant="text"
                          @click="removeService(index)"
                        />
                      </td>
                    </tr>
                    <tr v-if="form.services.length === 0">
                      <td
                        colspan="6"
                        class="text-center text-caption pa-4 text-medium-emphasis"
                      >
                        Brak usług. Kliknij "Dodaj usługę" lub "Importuj".
                      </td>
                    </tr>
                  </tbody>
                </v-table>
              </v-card-text>
            </v-card>
          </v-col>

          <!-- PRAWA KOLUMNA: Podsumowanie -->
          <v-col cols="12" md="4">
            <v-card class="position-sticky" style="top: 20px">
              <v-card-title class="bg-grey-lighten-3">Podsumowanie</v-card-title>
              <v-card-text class="pa-4">
                <div class="d-flex justify-space-between mb-2">
                  <span class="text-medium-emphasis">Materiały:</span>
                  <span class="font-weight-bold">{{
                    formatCurrency(totals.materials)
                  }}</span>
                </div>
                <div class="d-flex justify-space-between mb-2">
                  <span class="text-medium-emphasis">Usługi:</span>
                  <span class="font-weight-bold">{{
                    formatCurrency(totals.services)
                  }}</span>
                </div>
                <div class="d-flex justify-space-between mb-4">
                  <span class="text-medium-emphasis">Koszty łącznie:</span>
                  <span class="font-weight-bold">{{ formatCurrency(totals.cost) }}</span>
                </div>

                <v-divider class="mb-4" />

                <div class="mb-4">
                  <div class="text-caption mb-1">Marża (%)</div>
                  <v-slider
                    v-model="form.margin_percent"
                    :min="0"
                    :max="100"
                    step="1"
                    thumb-label
                    color="primary"
                    hide-details
                  >
                    <template #append>
                      <v-text-field
                        v-model.number="form.margin_percent"
                        type="number"
                        style="width: 80px"
                        density="compact"
                        variant="outlined"
                        hide-details
                        suffix="%"
                      />
                    </template>
                  </v-slider>
                </div>

                <v-divider class="mb-4" />

                <div class="d-flex justify-space-between align-center mb-2">
                  <span class="text-subtitle-1">Netto:</span>
                  <span class="text-h6 text-primary font-weight-bold">
                    {{ formatCurrency(totals.net) }}
                  </span>
                </div>
                <div class="d-flex justify-space-between align-center">
                  <span class="text-subtitle-1">Brutto (23%):</span>
                  <span class="text-h5 font-weight-black">
                    {{ formatCurrency(totals.gross) }}
                  </span>
                </div>

                <v-divider class="my-4" />

                <v-textarea
                  v-model="form.notes"
                  label="Notatki do wyceny"
                  variant="outlined"
                  rows="3"
                  hide-details
                  class="mb-2"
                />
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </v-card-text>
    </v-card>

    <!-- Dialog Importu Materiałów -->
    <batch-material-add-dialog
      v-model="batchDialog"
      :loading="batchLoading"
      @save="handleBatchImport"
    />

    <!-- Dialog Importu Usług -->
    <batch-service-add-dialog
      v-model="batchServiceDialog"
      :loading="batchServiceLoading"
      @save="handleBatchServiceImport"
    />
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useQuotationsStore } from "@/stores/quotations";
import { useFormatters } from "@/composables/useFormatters";
import { assortmentService } from "@/services/assortmentService"; // DODANE
import BatchMaterialAddDialog from "@/components/materials/BatchMaterialAddDialog.vue";
import BatchServiceAddDialog from "@/components/quotations/BatchServiceAddDialog.vue";

// TYPY
interface MaterialItem {
  assortment_item_id: number | null;
  quantity: number;
  unit: string;
  unit_price: number;
}

interface ServiceItem {
  assortment_item_id: number | null;
  estimated_time_hours: number;
  unit_price: number;
}

const props = defineProps({
  modelValue: Boolean,
  variant: {
    type: Object,
    required: true,
  },
  quotation: {
    type: Object,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

const quotationsStore = useQuotationsStore();
const { formatCurrency } = useFormatters();

const saving = ref(false);
const batchDialog = ref(false);
const batchLoading = ref(false);
const batchServiceDialog = ref(false);
const batchServiceLoading = ref(false);

const isEdit = computed(() => !!props.quotation);

const form = ref({
  materials: [] as MaterialItem[],
  services: [] as ServiceItem[],
  margin_percent: 30,
  notes: "",
});

// Obliczenia sumaryczne dla podsumowania
const totals = computed(() => {
  const materialsCost = form.value.materials.reduce(
    (sum, item) => sum + (item.quantity * item.unit_price || 0),
    0
  );
  const servicesCost = form.value.services.reduce(
    (sum, item) => sum + (item.estimated_time_hours * item.unit_price || 0),
    0
  );

  const cost = materialsCost + servicesCost;
  const marginValue = cost * (form.value.margin_percent / 100);
  const net = cost + marginValue;
  const gross = net * 1.23;

  return {
    materials: materialsCost,
    services: servicesCost,
    cost,
    marginValue,
    net,
    gross,
  };
});

// Inicjalizacja formularza przy otwarciu dialogu
watch(
  () => props.modelValue,
  async (isOpen) => {
    if (!isOpen) return;

    await Promise.all([
      quotationsStore.fetchMaterials(),
      quotationsStore.fetchServices(),
    ]);

    if (props.quotation) {
      // Tryb edycji — mapujemy istniejące pozycje wyceny
      const q = props.quotation;
      const materials: MaterialItem[] = [];
      const services: ServiceItem[] = [];

      q.items?.forEach((item: any) => {
        item.materials?.forEach((m: any) => {
          materials.push({
            assortment_item_id: m.assortment_item_id,
            quantity: m.quantity,
            unit: m.unit || "",
            unit_price: m.unit_price,
          });
        });
        item.services?.forEach((s: any) => {
          services.push({
            assortment_item_id: s.assortment_item_id,
            estimated_time_hours: s.estimated_time_hours,
            unit_price: s.unit_price,
          });
        });
      });

      form.value = {
        materials,
        services,
        margin_percent: q.margin_percent ?? 30,
        notes: q.notes ?? "",
      };
    } else {
      // Tryb tworzenia — pusty formularz
      form.value = { materials: [], services: [], margin_percent: 30, notes: "" };
    }
  }
);

// --- Operacje na materiałach ---

const addMaterial = (): void => {
  form.value.materials.push({
    assortment_item_id: null,
    quantity: 1,
    unit: "",
    unit_price: 0,
  });
};

const removeMaterial = (index: number): void => {
  form.value.materials.splice(index, 1);
};

// ID jest przekazywane jako value, szukamy obiektu w store
const onMaterialSelect = (item: MaterialItem, id: number): void => {
  if (!id) return;
  const selected = quotationsStore.materials.find((m: any) => m.id === id);
  if (selected) {
    item.unit_price = selected.default_price ?? 0;
    item.unit = selected.unit ?? "";
  }
};

// --- Operacje na usługach ---

const addService = (): void => {
  form.value.services.push({
    assortment_item_id: null,
    estimated_time_hours: 1,
    unit_price: 0,
  });
};

const removeService = (index: number): void => {
  form.value.services.splice(index, 1);
};

// ID jest przekazywane jako value, szukamy obiektu w store
const onServiceSelect = (item: ServiceItem, id: number): void => {
  if (!id) return;
  const selected = quotationsStore.services.find((s: any) => s.id === id);
  if (selected) {
    item.unit_price = selected.default_price ?? 0;
  }
};

// --- Import wsadowy (ZMODYFIKOWANE) ---

const handleBatchImport = async (items: any[]): Promise<void> => {
  batchLoading.value = true;
  try {
    // 1. Wyślij do backendu celem stworzenia/sprawdzenia asortymentu
    const resolvedItems = await assortmentService.batchCheckOrCreate(items, "MATERIAL");

    // 2. Odśwież lokalny sklep materiałów, aby v-autocomplete widział nowe ID
    await quotationsStore.fetchMaterials();

    // 3. Dodaj przetworzone pozycje do formularza
    resolvedItems.forEach((item) => {
      form.value.materials.push({
        assortment_item_id: item.assortment_item_id,
        quantity: item.quantity,
        unit: item.unit || "SZT",
        unit_price: item.unit_price,
      });
    });

    batchDialog.value = false;
  } catch (error: any) {
    console.error("Błąd importu:", error);
    alert("Błąd podczas importu: " + (error.response?.data?.message || error.message));
  } finally {
    batchLoading.value = false;
  }
};

const handleBatchServiceImport = async (items: any[]): Promise<void> => {
  batchServiceLoading.value = true;
  try {
    // 1. Wyślij do backendu
    const resolvedItems = await assortmentService.batchCheckOrCreate(items, "SERVICE");

    // 2. Odśwież listę usług
    await quotationsStore.fetchServices();

    // 3. Dodaj pozycje (mapując ilość na godziny)
    resolvedItems.forEach((item) => {
      form.value.services.push({
        assortment_item_id: item.assortment_item_id,
        estimated_time_hours: item.quantity,
        unit_price: item.unit_price,
      });
    });

    batchServiceDialog.value = false;
  } catch (error: any) {
    console.error("Błąd importu usług:", error);
    alert(
      "Błąd podczas importu usług: " + (error.response?.data?.message || error.message)
    );
  } finally {
    batchServiceLoading.value = false;
  }
};

// --- Zapis ---

const saveQuotation = async (): Promise<void> => {
  saving.value = true;
  try {
    const payload = {
      materials: form.value.materials,
      services: form.value.services,
      margin_percent: form.value.margin_percent,
      notes: form.value.notes,
    };

    if (isEdit.value) {
      await quotationsStore.updateQuotation(props.quotation.id, payload);
    } else {
      await quotationsStore.createQuotation(props.variant.id, payload);
    }

    emit("saved");
    closeDialog();
  } catch (error: any) {
    console.error("Błąd zapisu wyceny:", error);
    alert("Błąd zapisu: " + (error.response?.data?.message || "Nieznany błąd"));
  } finally {
    saving.value = false;
  }
};

const closeDialog = (): void => {
  emit("update:modelValue", false);
};
</script>


=================================================================================
FILE: src/components/users/UserFormDialog.vue
LOCATION: .//src/components/users/UserFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="closeDialog"
    max-width="600"
    persistent
  >
    <v-card>
      <v-toolbar color="primary" density="comfortable">
        <v-icon class="ml-4">{{
          isEdit ? "mdi-account-edit" : "mdi-account-plus"
        }}</v-icon>
        <v-toolbar-title>
          {{ isEdit ? "Edytuj Użytkownika" : "Nowy Użytkownik" }}
        </v-toolbar-title>
        <v-spacer></v-spacer>
        <v-btn icon="mdi-close" variant="text" @click="closeDialog"></v-btn>
      </v-toolbar>

      <v-card-text class="pa-4">
        <!-- Globalny Alert Błędu -->
        <v-alert
          v-if="errorMessage"
          type="error"
          variant="tonal"
          closable
          class="mb-4"
          @click:close="errorMessage = null"
        >
          {{ errorMessage }}
        </v-alert>

        <v-form ref="formRef" v-model="valid" @submit.prevent="handleSubmit">
          <v-row dense>
            <!-- Imię i Nazwisko -->
            <v-col cols="12">
              <v-text-field
                v-model="form.name"
                label="Imię i Nazwisko *"
                variant="outlined"
                prepend-inner-icon="mdi-account"
                :rules="[rules.required]"
                :error-messages="errors.name"
              ></v-text-field>
            </v-col>

            <!-- Email -->
            <v-col cols="12">
              <v-text-field
                v-model="form.email"
                label="Adres Email *"
                variant="outlined"
                prepend-inner-icon="mdi-email"
                type="email"
                :rules="[rules.required, rules.email]"
                :error-messages="errors.email"
              ></v-text-field>
            </v-col>

            <!-- Rola -->
            <v-col cols="12" md="6">
              <v-select
                v-model="form.role"
                :items="metadataStore.userRoles"
                item-title="label"
                item-value="value"
                label="Rola w systemie *"
                variant="outlined"
                prepend-inner-icon="mdi-badge-account"
                :rules="[rules.required]"
                :error-messages="errors.role"
              ></v-select>
            </v-col>

            <!-- Status -->
            <v-col cols="12" md="6" class="d-flex align-center">
              <v-switch
                v-model="form.is_active"
                label="Konto aktywne"
                color="success"
                hide-details
                class="ml-2"
              ></v-switch>
            </v-col>

            <v-divider class="my-3 w-100"></v-divider>
            <div class="text-subtitle-2 text-medium-emphasis mb-2 w-100">
              Bezpieczeństwo
            </div>

            <!-- Hasło -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.password"
                label="Hasło"
                variant="outlined"
                prepend-inner-icon="mdi-lock"
                :type="showPassword ? 'text' : 'password'"
                :append-inner-icon="showPassword ? 'mdi-eye' : 'mdi-eye-off'"
                @click:append-inner="showPassword = !showPassword"
                :rules="isEdit ? [] : [rules.required, rules.min8]"
                :hint="isEdit ? 'Pozostaw puste, aby nie zmieniać' : 'Min. 8 znaków'"
                persistent-hint
                :error-messages="errors.password"
              ></v-text-field>
            </v-col>

            <!-- PIN -->
            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.pin_code"
                label="Kod PIN (RCP)"
                variant="outlined"
                prepend-inner-icon="mdi-dialpad"
                type="password"
                maxlength="4"
                :rules="[rules.pin]"
                hint="4 cyfry (opcjonalne, dla produkcji)"
                persistent-hint
                :error-messages="errors.pin_code"
              ></v-text-field>
            </v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-divider></v-divider>

      <v-card-actions class="pa-4 bg-grey-lighten-5">
        <v-spacer></v-spacer>
        <v-btn
          variant="text"
          color="grey-darken-1"
          @click="closeDialog"
          :disabled="loading"
        >
          Anuluj
        </v-btn>
        <v-btn
          color="primary"
          variant="elevated"
          @click="handleSubmit"
          :loading="loading"
          :disabled="!valid"
          class="px-6"
        >
          {{ isEdit ? "Zapisz zmiany" : "Utwórz" }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted } from "vue";
import { useUsersStore } from "@/stores/users";
import { useMetadataStore } from "@/stores/metadata";

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false,
  },
  user: {
    type: Object,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

const usersStore = useUsersStore();
const metadataStore = useMetadataStore();

const formRef = ref(null);
const valid = ref(false);
const loading = ref(false);
const showPassword = ref(false);

// Stan błędów z serwera
const errors = ref<Record<string, string[]>>({});
const errorMessage = ref<string | null>(null);

const defaultForm = {
  name: "",
  email: "",
  password: "",
  role: null,
  pin_code: "",
  is_active: true,
};

const form = ref({ ...defaultForm });

const isEdit = computed(() => !!props.user);

const rules = {
  required: (v: any) => !!v || "Pole jest wymagane",
  email: (v: string) => /.+@.+\..+/.test(v) || "Nieprawidłowy format email",
  min8: (v: string) => !v || v.length >= 8 || "Min. 8 znaków",
  pin: (v: string) => !v || /^\d{4}$/.test(v) || "PIN musi składać się z 4 cyfr",
};

// Obserwuj otwarcie dialogu
watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen) {
      // Reset błędów
      errors.value = {};
      errorMessage.value = null;

      if (props.user) {
        // Edycja
        form.value = {
          name: props.user.name,
          email: props.user.email,
          password: "",
          role: props.user.role,
          pin_code: "",
          is_active: props.user.is_active,
        };
      } else {
        // Nowy
        form.value = { ...defaultForm };
      }
      // Reset walidacji
      if (formRef.value) (formRef.value as any).resetValidation();
    }
  }
);

const closeDialog = () => {
  emit("update:modelValue", false);
};

const handleSubmit = async () => {
  // Walidacja frontendowa
  const { valid } = await (formRef.value as any).validate();
  if (!valid) return;

  loading.value = true;
  errors.value = {}; // Wyczyść stare błędy
  errorMessage.value = null;

  try {
    const payload: any = {
      name: form.value.name,
      email: form.value.email,
      role: form.value.role,
      is_active: form.value.is_active,
    };

    if (form.value.password) {
      payload.password = form.value.password;
    }

    // Wyślij PIN tylko jeśli został wpisany (pusty = brak zmian lub usunięcie w zależności od logiki API, tutaj zakładamy wpisanie nowego)
    if (form.value.pin_code) {
      payload.pin_code = form.value.pin_code;
    }

    if (isEdit.value) {
      await usersStore.updateUser(props.user.id, payload);
    } else {
      await usersStore.createUser(payload);
    }

    emit("saved");
    closeDialog();
  } catch (error: any) {
    console.error("Błąd zapisu:", error);

    // Obsługa błędów walidacji z Laravela (status 422)
    if (error.response && error.response.status === 422) {
      // Przypisz błędy do pól (np. pin_code: ["Ten kod PIN jest już zajęty"])
      errors.value = error.response.data.errors;
      errorMessage.value = "Formularz zawiera błędy. Sprawdź poniższe pola.";
    } else {
      // Inne błędy
      errorMessage.value =
        error.response?.data?.message || "Wystąpił nieoczekiwany błąd podczas zapisu.";
    }
  } finally {
    loading.value = false;
  }
};

onMounted(() => {
  if (!metadataStore.loaded) {
    metadataStore.fetchMetadata();
  }
});
</script>


=================================================================================
FILE: src/components/users/UserList.vue
LOCATION: .//src/components/users/UserList.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="$emit('update:modelValue', $event)"
    max-width="600"
    persistent
  >
    <v-card>
      <v-card-title class="bg-primary text-white">
        <v-icon start>{{ isEdit ? "mdi-account-edit" : "mdi-account-plus" }}</v-icon>
        {{ isEdit ? "Edytuj Użytkownika" : "Nowy Użytkownik" }}
      </v-card-title>

      <v-form ref="formRef" @submit.prevent="handleSubmit">
        <v-card-text class="pt-6">
          <v-row>
            <v-col cols="12">
              <v-text-field
                v-model="form.name"
                label="Imię i Nazwisko *"
                variant="outlined"
                prepend-inner-icon="mdi-account"
                :rules="[(v) => !!v || 'Wymagane']"
              />
            </v-col>

            <v-col cols="12">
              <v-text-field
                v-model="form.email"
                label="Adres Email *"
                type="email"
                variant="outlined"
                prepend-inner-icon="mdi-email"
                :rules="[
                  (v) => !!v || 'Wymagane',
                  (v) => /.+@.+\..+/.test(v) || 'Nieprawidłowy email',
                ]"
              />
            </v-col>

            <v-col cols="12">
              <v-select
                v-model="form.role"
                :items="metadataStore.userRoles"
                item-title="label"
                item-value="value"
                label="Rola w systemie *"
                variant="outlined"
                prepend-inner-icon="mdi-badge-account"
                :rules="[(v) => !!v || 'Wymagane']"
              />
            </v-col>

            <v-divider class="my-2"></v-divider>
            <v-col cols="12">
              <div class="text-subtitle-2 text-medium-emphasis mb-2">Bezpieczeństwo</div>
            </v-col>

            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.password"
                :label="isEdit ? 'Nowe Hasło (opcjonalnie)' : 'Hasło *'"
                :type="showPassword ? 'text' : 'password'"
                variant="outlined"
                prepend-inner-icon="mdi-lock"
                :append-inner-icon="showPassword ? 'mdi-eye' : 'mdi-eye-off'"
                @click:append-inner="showPassword = !showPassword"
                :rules="passwordRules"
                hint="Min. 8 znaków"
              />
            </v-col>

            <v-col cols="12" md="6">
              <v-text-field
                v-model="form.pin_code"
                label="Kod PIN (do RCP)"
                type="text"
                maxlength="4"
                variant="outlined"
                prepend-inner-icon="mdi-dialpad"
                :rules="[(v) => !v || /^\d{4}$/.test(v) || 'PIN musi mieć 4 cyfry']"
                hint="Tylko 4 cyfry"
              />
            </v-col>

            <v-col cols="12" v-if="isEdit">
              <v-switch
                v-model="form.is_active"
                color="success"
                label="Konto aktywne"
                hide-details
              />
            </v-col>
          </v-row>
        </v-card-text>

        <v-card-actions class="pa-4 bg-grey-lighten-5">
          <v-spacer />
          <v-btn variant="text" @click="close">Anuluj</v-btn>
          <v-btn color="primary" variant="elevated" type="submit" :loading="loading">
            Zapisz
          </v-btn>
        </v-card-actions>
      </v-form>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useUsersStore } from "@/stores/users";
import { useMetadataStore } from "@/stores/metadata";

const props = defineProps({
  modelValue: Boolean,
  user: Object,
});

const emit = defineEmits(["update:modelValue", "saved"]);

const usersStore = useUsersStore();
const metadataStore = useMetadataStore();

const formRef = ref(null);
const loading = ref(false);
const showPassword = ref(false);

const isEdit = computed(() => !!props.user);

const defaultForm = {
  name: "",
  email: "",
  role: null,
  password: "",
  pin_code: "",
  is_active: true,
};

const form = ref({ ...defaultForm });

const passwordRules = computed(() => {
  const rules = [];
  if (!isEdit.value) {
    rules.push((v) => !!v || "Hasło jest wymagane");
  }
  rules.push((v) => !v || v.length >= 8 || "Min. 8 znaków");
  return rules;
});

watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen) {
      if (props.user) {
        form.value = {
          ...props.user,
          password: "", // Nie wypełniamy hasła przy edycji
          pin_code: "", // Nie wypełniamy PINu (jest hashowany) - ewentualnie placeholder
        };
      } else {
        form.value = { ...defaultForm };
      }
    }
  }
);

const handleSubmit = async () => {
  const { valid } = await formRef.value.validate();
  if (!valid) return;

  loading.value = true;
  try {
    const payload = { ...form.value };

    // Usuń puste hasło/pin przy edycji, żeby nie nadpisać nullem/pustym stringiem
    if (isEdit.value) {
      if (!payload.password) delete payload.password;
      if (!payload.pin_code && payload.pin_code !== "") delete payload.pin_code; // delete only if undefined
      // Backend handles nullable/empty logic usually
    }

    if (isEdit.value) {
      await usersStore.updateUser(props.user.id, payload);
    } else {
      await usersStore.createUser(payload);
    }
    emit("saved");
    close();
  } catch (e: any) {
    alert(e.response?.data?.message || "Błąd zapisu");
    if (e.response?.data?.errors) {
      console.log(e.response.data.errors);
    }
  } finally {
    loading.value = false;
  }
};

const close = () => {
  emit("update:modelValue", false);
  formRef.value?.resetValidation();
};
</script>


=================================================================================
FILE: src/components/variants/VariantCostControl.vue
LOCATION: .//src/components/variants/VariantCostControl.vue
=================================================================================

<template>
  <v-card class="mb-6" elevation="2">
    <v-card-title class="bg-blue-grey text-white d-flex align-center">
      <v-icon start color="white">mdi-chart-areaspline</v-icon>
      Kontrola Kosztów Produkcji
    </v-card-title>

    <v-card-text class="pt-6">
      <!-- Główne podsumowanie -->
      <v-row class="mb-4">
        <v-col cols="6">
          <div class="text-caption text-uppercase font-weight-bold text-medium-emphasis">
            Budżet Całkowity (Z Wyceny)
          </div>
          <div class="text-h4 font-weight-black text-blue-grey-darken-2">
            {{ formatCurrency(budgetTotal) }}
          </div>
        </v-col>
        <v-col cols="6" class="text-right">
          <div class="text-caption text-uppercase font-weight-bold text-medium-emphasis">
            Wykorzystanie budżetu
          </div>
          <div
            class="text-h4 font-weight-black"
            :class="totalCostActual > budgetTotal ? 'text-error' : 'text-success'"
          >
            {{ formatCurrency(totalCostActual) }}
          </div>
          <div class="text-caption">
            {{ calculatePercentage(totalCostActual, budgetTotal) }}%
          </div>
        </v-col>
      </v-row>

      <v-divider class="mb-6" />

      <!-- Podział: Materiały vs Usługi -->
      <v-row>
        <!-- MATERIAŁY -->
        <v-col cols="12" md="6">
          <v-card variant="outlined" class="pa-3">
            <div class="d-flex align-center mb-2">
              <v-icon color="blue" class="mr-2">mdi-cube-outline</v-icon>
              <span class="text-subtitle-1 font-weight-bold">Materiały</span>
            </div>
            <div class="d-flex justify-space-between text-body-2 mb-1">
              <span class="text-medium-emphasis">Budżet:</span>
              <strong>{{ formatCurrency(budgetMaterials) }}</strong>
            </div>
            <div class="d-flex justify-space-between text-body-2 mb-2">
              <span class="text-medium-emphasis">Rzeczywiste:</span>
              <strong
                :class="
                  actualMaterialsCost > budgetMaterials
                    ? 'text-error'
                    : 'text-grey-darken-3'
                "
              >
                {{ formatCurrency(actualMaterialsCost) }}
              </strong>
            </div>
            <v-progress-linear
              :model-value="calculatePercentage(actualMaterialsCost, budgetMaterials)"
              :color="actualMaterialsCost > budgetMaterials ? 'error' : 'blue'"
              height="8"
              rounded
            />
          </v-card>
        </v-col>

        <!-- USŁUGI -->
        <v-col cols="12" md="6">
          <v-card variant="outlined" class="pa-3">
            <div class="d-flex align-center mb-2">
              <v-icon color="orange" class="mr-2">mdi-wrench-outline</v-icon>
              <span class="text-subtitle-1 font-weight-bold">Usługi</span>
            </div>
            <div class="d-flex justify-space-between text-body-2 mb-1">
              <span class="text-medium-emphasis">Budżet:</span>
              <strong>{{ formatCurrency(budgetServices) }}</strong>
            </div>
            <div class="d-flex justify-space-between text-body-2 mb-2">
              <span class="text-medium-emphasis">Rzeczywiste:</span>
              <strong
                :class="
                  actualServicesCost > budgetServices
                    ? 'text-error'
                    : 'text-grey-darken-3'
                "
              >
                {{ formatCurrency(actualServicesCost) }}
              </strong>
            </div>
            <v-progress-linear
              :model-value="calculatePercentage(actualServicesCost, budgetServices)"
              :color="actualServicesCost > budgetServices ? 'error' : 'orange'"
              height="8"
              rounded
            />
          </v-card>
        </v-col>
      </v-row>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps<{
  budgetMaterials: number;
  budgetServices: number;
  actualMaterialsCost: number;
  actualServicesCost: number;
}>();

const { formatCurrency } = useFormatters();

const budgetTotal = computed(() => props.budgetMaterials + props.budgetServices);
const totalCostActual = computed(
  () => props.actualMaterialsCost + props.actualServicesCost
);

const calculatePercentage = (actual: number, total: number): number => {
  if (!total || total === 0) return 0;
  return Math.min(Math.round((actual / total) * 100), 100);
};
</script>


=================================================================================
FILE: src/components/variants/VariantDeleteQuotationDialog.vue
LOCATION: .//src/components/variants/VariantDeleteQuotationDialog.vue
=================================================================================

<template>
  <v-dialog :model-value="modelValue" @update:model-value="close" max-width="500">
    <v-card>
      <v-card-title class="bg-error text-white">Usuń wycenę</v-card-title>
      <v-card-text class="pt-4">
        Czy na pewno chcesz usunąć wycenę
        <strong>v{{ versionNumber }}</strong
        >? Operacja jest nieodwracalna.
      </v-card-text>
      <v-card-actions>
        <v-spacer />
        <v-btn @click="close">Anuluj</v-btn>
        <v-btn
          color="error"
          variant="elevated"
          :loading="loading"
          @click="$emit('confirm')"
        >
          Usuń
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
defineProps<{
  modelValue: boolean;
  versionNumber?: number;
  loading: boolean;
}>();

const emit = defineEmits(["update:modelValue", "confirm"]);

const close = () => emit("update:modelValue", false);
</script>


=================================================================================
FILE: src/components/variants/VariantDescription.vue
LOCATION: .//src/components/variants/VariantDescription.vue
=================================================================================

<template>
  <v-card class="mb-6" elevation="2">
    <v-card-title class="bg-indigo text-white d-flex align-center">
      <v-icon start color="white">mdi-text-box-outline</v-icon>
      Opis / Specyfikacja
      <v-spacer />
      <v-btn
        v-if="!isEditing"
        icon="mdi-pencil"
        variant="text"
        color="white"
        density="comfortable"
        v-tooltip="'Edytuj opis'"
        @click="startEdit"
      />
    </v-card-title>

    <v-card-text class="pt-4">
      <!-- Tryb wyświetlania -->
      <div
        v-if="!isEditing"
        class="text-body-1"
        style="white-space: pre-wrap; min-height: 60px"
        :class="!variant?.description ? 'text-medium-emphasis font-italic' : ''"
      >
        {{
          variant?.description || "Brak opisu. Kliknij ołówek, aby dodać specyfikację."
        }}
      </div>

      <!-- Tryb edycji -->
      <div v-else>
        <v-textarea
          v-model="buffer"
          variant="outlined"
          rows="5"
          autofocus
          placeholder="Szczegóły techniczne, wymiary, materiały, uwagi..."
          hide-details
          class="mb-3"
        />
        <div class="d-flex gap-2">
          <v-btn color="primary" size="small" :loading="loading" @click="save">
            Zapisz
          </v-btn>
          <v-btn size="small" variant="text" @click="cancel">Anuluj</v-btn>
        </div>
      </div>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref } from "vue";

const props = defineProps<{
  variant: any;
  loading: boolean;
}>();

const emit = defineEmits(["update-desc"]);

const isEditing = ref(false);
const buffer = ref("");

const startEdit = () => {
  buffer.value = props.variant?.description || "";
  isEditing.value = true;
};

const cancel = () => {
  isEditing.value = false;
  buffer.value = "";
};

const save = async () => {
  emit("update-desc", buffer.value);
  // Zmiana isEditing na false odbywa się z poziomu rodzica (lub tutaj, jeśli preferujesz optymistyczny update)
  isEditing.value = false;
};
</script>

<style scoped>
.gap-2 {
  gap: 8px;
}
</style>


=================================================================================
FILE: src/components/variants/VariantHeader.vue
LOCATION: .//src/components/variants/VariantHeader.vue
=================================================================================

<template>
  <page-header
    :title="variant ? variant.name : 'Ładowanie...'"
    :subtitle="variant?.order?.full_order_number || ''"
    icon="mdi-package-variant"
    :icon-color="variantStatusColor"
    :breadcrumbs="breadcrumbItems"
  >
    <!-- Edycja nazwy wariantu inline -->
    <template #title>
      <div class="d-flex align-center w-100">
        <inline-edit-field
          v-if="variant"
          :model-value="variant.name"
          text-class="text-h4 font-weight-bold text-high-emphasis"
          placeholder="Wpisz nazwę wariantu..."
          :loading="loading"
          class="variant-name-input flex-grow-1"
          @save="handleNameSave"
        />
        <span v-else>Ładowanie...</span>
      </div>
    </template>

    <template #subtitle>
      Wariant {{ variant?.variant_number || "#" }} •
      {{ variant?.order?.full_order_number }}
    </template>

    <template #actions>
      <v-btn
        variant="outlined"
        prepend-icon="mdi-arrow-left"
        class="mr-2"
        @click="$emit('go-back')"
      >
        Wróć
      </v-btn>
      <v-btn
        variant="flat"
        color="primary"
        prepend-icon="mdi-pencil"
        :disabled="!variant"
        @click="$emit('edit-full')"
      >
        Pełna Edycja
      </v-btn>
    </template>
  </page-header>
</template>

<script setup lang="ts">
import { computed } from "vue";
import PageHeader from "@/components/layout/PageHeader.vue";
import InlineEditField from "@/components/common/InlineEditField.vue";
import { useStatusFormatter } from "@/composables/useStatusFormatter";

const props = defineProps<{
  variant: any;
  loading: boolean;
}>();

const emit = defineEmits(["update-name", "go-back", "edit-full"]);

const { formatVariantStatus } = useStatusFormatter();

const variantStatusColor = computed(() => {
  return props.variant ? formatVariantStatus(props.variant.status).color : "grey";
});

const breadcrumbItems = computed(() => [
  { title: "Zamówienia", to: "/orders", disabled: false },
  {
    title: props.variant?.order?.full_order_number || "...",
    to: `/orders/${props.variant?.order_id}`,
    disabled: false,
  },
  { title: `Wariant ${props.variant?.variant_number || ""}`, disabled: true },
]);

const handleNameSave = (val: string) => {
  emit("update-name", val);
};
</script>

<style scoped>
.variant-name-input {
  width: 100%;
}
.variant-name-input :deep(.v-field) {
  padding: 0 !important;
  min-height: auto !important;
  background-color: transparent !important;
  box-shadow: none !important;
}
</style>


=================================================================================
FILE: src/components/variants/VariantQuotations.vue
LOCATION: .//src/components/variants/VariantQuotations.vue
=================================================================================

<template>
  <v-card class="mb-6" elevation="2">
    <v-card-title class="bg-blue text-white d-flex align-center">
      <v-icon start color="white">mdi-calculator</v-icon>
      Wyceny ({{ quotations.length }})
      <v-spacer />
      <v-btn color="white" variant="text" size="small" @click="$emit('create')">
        <v-icon start>mdi-plus</v-icon>
        Nowa wycena
      </v-btn>
    </v-card-title>

    <v-card-text class="pt-4">
      <div v-if="loading" class="text-center py-6">
        <v-progress-circular indeterminate color="primary" />
      </div>

      <div v-else-if="quotations.length > 0">
        <v-list>
          <v-list-item
            v-for="quotation in quotations"
            :key="quotation.id"
            class="mb-2 pa-3 border rounded"
            :class="{ 'bg-green-lighten-5': quotation.is_approved }"
          >
            <template #prepend>
              <v-avatar
                :color="quotation.is_approved ? 'success' : 'grey'"
                size="36"
                class="mr-2"
              >
                <span class="text-h6 text-white">v{{ quotation.version_number }}</span>
              </v-avatar>
            </template>

            <v-list-item-title>
              <span class="text-h6 font-weight-bold">
                {{ formatCurrency(quotation.total_gross) }}
              </span>
              <v-chip
                v-if="quotation.is_approved"
                size="x-small"
                color="success"
                class="ml-2"
              >
                <v-icon start size="x-small">mdi-check</v-icon>
                Zatwierdzona
              </v-chip>
            </v-list-item-title>

            <v-list-item-subtitle class="mt-1">
              Materiały:
              <strong>{{ formatCurrency(quotation.total_materials_cost) }}</strong> •
              Usługi:
              <strong>{{ formatCurrency(quotation.total_services_cost) }}</strong> •
              Marża: <strong>{{ quotation.margin_percent }}%</strong>
            </v-list-item-subtitle>

            <template #append>
              <!-- Podgląd -->
              <v-btn
                icon="mdi-eye"
                variant="text"
                size="small"
                v-tooltip="'Podgląd wyceny'"
                @click="$emit('view', quotation)"
              />
              <!-- Edycja -->
              <v-btn
                v-if="!quotation.is_approved"
                icon="mdi-pencil"
                variant="text"
                size="small"
                color="blue"
                v-tooltip="'Edytuj wycenę'"
                @click="$emit('edit', quotation)"
              />
              <!-- Duplikowanie -->
              <v-btn
                icon="mdi-content-copy"
                variant="text"
                size="small"
                color="purple"
                :loading="duplicatingId === quotation.id"
                v-tooltip="'Duplikuj jako nową wersję'"
                @click="$emit('duplicate', quotation)"
              />
              <!-- Eksport materiałów -->
              <v-btn
                v-if="quotation.is_approved"
                icon="mdi-export"
                variant="text"
                size="small"
                color="teal"
                v-tooltip="'Eksportuj materiały do wariantu'"
                @click="$emit('export', quotation)"
              />
              <!-- Zatwierdzenie -->
              <v-btn
                v-if="!quotation.is_approved"
                icon="mdi-check"
                variant="text"
                size="small"
                color="success"
                v-tooltip="'Zatwierdź wycenę'"
                @click="$emit('approve', quotation)"
              />
              <!-- Usunięcie -->
              <v-btn
                v-if="!quotation.is_approved"
                icon="mdi-delete"
                variant="text"
                size="small"
                color="error"
                v-tooltip="'Usuń wycenę'"
                @click="$emit('delete', quotation)"
              />
            </template>
          </v-list-item>
        </v-list>
      </div>

      <v-alert v-else type="info" variant="tonal" class="text-body-2">
        Brak wycen. Utwórz pierwszą wycenę klikając „Nowa wycena".
      </v-alert>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { useFormatters } from "@/composables/useFormatters";

defineProps<{
  quotations: any[];
  loading: boolean;
  duplicatingId: number | null;
}>();

defineEmits(["create", "view", "edit", "duplicate", "export", "approve", "delete"]);

const { formatCurrency } = useFormatters();
</script>

<style scoped>
.v-list-item.border {
  transition: background-color 0.2s;
}
</style>


=================================================================================
FILE: src/components/variants/VariantRcpServices.vue
LOCATION: .//src/components/variants/VariantRcpServices.vue
=================================================================================

<template>
  <v-card class="mb-6" elevation="2">
    <v-card-title class="bg-orange text-white d-flex align-center">
      <v-icon start>mdi-clipboard-check-outline</v-icon>
      Usługi wykonane
      <v-spacer />
      <v-chip size="small" variant="tonal" color="white">
        Koszt: {{ formatCurrency(totalCost) }}
      </v-chip>
    </v-card-title>

    <v-card-text class="pa-0">
      <v-data-table
        :headers="headers"
        :items="tasks"
        density="compact"
        hide-default-footer
        items-per-page="-1"
        class="elevation-0"
      >
        <template #item="{ item }">
          <tr style="cursor: default">
            <!-- Ikona statusu -->
            <td class="text-center px-0">
              <div class="d-flex justify-center align-center">
                <v-icon
                  v-if="item.status === 'COMPLETED'"
                  size="small"
                  color="success"
                  icon="mdi-check-circle"
                />
                <div v-else-if="item.status === 'IN_PROGRESS'" class="pulsing-dot" />
                <v-icon
                  v-else
                  size="small"
                  color="grey-lighten-1"
                  icon="mdi-circle-outline"
                />
              </div>
            </td>

            <!-- Nazwa zadania i stanowisko -->
            <td>
              <div
                class="font-weight-medium"
                :class="{ 'text-primary': item.status === 'IN_PROGRESS' }"
              >
                {{ item.service_name }}
              </div>
              <div v-if="item.workstation" class="text-caption text-medium-emphasis">
                {{ item.workstation.name }}
              </div>
            </td>

            <td>{{ item.assigned_worker?.name || "-" }}</td>

            <!-- Stawka/h -->
            <td class="text-right">{{ formatCurrency(item.unit_price) }}</td>

            <!-- Czas (na żywo dla IN_PROGRESS, h+min dla zakończonych) -->
            <td class="text-right font-mono">
              <template v-if="item.status === 'IN_PROGRESS'">
                <span class="text-primary font-weight-bold">
                  {{ formatDuration(Math.floor(getTaskElapsedSeconds(item))) }}
                </span>
              </template>
              <template v-else>
                {{ formatHoursToHm(getTaskHours(item)) }}
              </template>
            </td>

            <!-- Koszt -->
            <td class="text-right font-weight-medium">
              {{ formatCurrency(getTaskCost(item)) }}
            </td>
          </tr>
        </template>

        <template #no-data>
          <div class="text-center py-4 text-medium-emphasis">
            Brak zarejestrowanych usług
          </div>
        </template>
      </v-data-table>
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from "vue";
import { parseISO, differenceInSeconds, isValid } from "date-fns";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps<{
  tasks: any[];
  totalCost: number;
}>();

const { formatCurrency, formatDuration } = useFormatters();

const headers: any[] = [
  { title: "", key: "status", width: "40px", align: "center", sortable: false },
  { title: "Zadanie", key: "service_name" },
  { title: "Pracownik", key: "assigned_worker" },
  { title: "Stawka /h", key: "unit_price", align: "end" },
  { title: "Czas", key: "actual_time_hours", align: "end" },
  { title: "Koszt", key: "actual_cost", align: "end" },
];

const now = ref(new Date());
let timerInterval: ReturnType<typeof setInterval> | null = null;

onMounted(() => {
  timerInterval = setInterval(() => {
    now.value = new Date();
  }, 1000);
});

onUnmounted(() => {
  if (timerInterval) clearInterval(timerInterval);
});

const getTaskElapsedSeconds = (item: any): number => {
  if (item.status === "COMPLETED") {
    return (Number(item.actual_time_hours) || 0) * 3600;
  }
  if (item.status === "IN_PROGRESS" && item.actual_start_date) {
    const start = parseISO(item.actual_start_date);
    if (!isValid(start)) return 0;
    return Math.max(0, differenceInSeconds(now.value, start));
  }
  return (Number(item.actual_time_hours) || 0) * 3600;
};

const getTaskHours = (item: any): number => {
  return Number(item.actual_time_hours) || 0;
};

const formatHoursToHm = (decimalHours: number): string => {
  if (!decimalHours || decimalHours <= 0) return "-";
  const totalMin = Math.round(decimalHours * 60);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return h > 0 ? `${h} h ${m} min` : `${m} min`;
};

const getTaskCost = (item: any): number => {
  if (item.status === "COMPLETED") return Number(item.actual_cost) || 0;
  if (item.status === "IN_PROGRESS") {
    const hours = getTaskElapsedSeconds(item) / 3600;
    return hours * (Number(item.unit_price) || 0);
  }
  return Number(item.actual_cost) || 0;
};
</script>

<style scoped>
.pulsing-dot {
  width: 8px;
  height: 8px;
  background-color: rgb(var(--v-theme-primary));
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.3);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.font-mono {
  font-family: "Roboto Mono", monospace;
}
</style>


=================================================================================
FILE: src/components/variants/VariantReviewDialog.vue
LOCATION: .//src/components/variants/VariantReviewDialog.vue
=================================================================================

<template>
  <v-dialog :model-value="modelValue" @update:model-value="close" max-width="500">
    <v-card>
      <v-card-title
        :class="action === 'approve' ? 'bg-success text-white' : 'bg-error text-white'"
      >
        {{ action === "approve" ? "Zatwierdź Prototyp" : "Odrzuć Prototyp" }}
      </v-card-title>
      <v-card-text class="pt-4">
        <p class="mb-4">
          {{
            action === "approve"
              ? "Potwierdzasz, że prototyp spełnia wymagania klienta?"
              : "Czy na pewno chcesz odrzucić ten prototyp?"
          }}
        </p>
        <v-textarea
          v-model="feedback"
          label="Notatki / Feedback klienta"
          variant="outlined"
          rows="3"
        />
      </v-card-text>
      <v-card-actions>
        <v-spacer />
        <v-btn @click="close">Anuluj</v-btn>
        <v-btn
          :color="action === 'approve' ? 'success' : 'error'"
          variant="elevated"
          :loading="loading"
          @click="submit"
        >
          {{ action === "approve" ? "Zatwierdź" : "Odrzuć" }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, watch } from "vue";

const props = defineProps<{
  modelValue: boolean;
  action: "approve" | "reject";
  loading: boolean;
}>();

const emit = defineEmits(["update:modelValue", "submit"]);

const feedback = ref("");

watch(
  () => props.modelValue,
  (isOpen) => {
    if (isOpen) {
      feedback.value = "";
    }
  }
);

const close = () => emit("update:modelValue", false);
const submit = () => emit("submit", feedback.value);
</script>


=================================================================================
FILE: src/components/variants/VariantSidebar.vue
LOCATION: .//src/components/variants/VariantSidebar.vue
=================================================================================

<template>
  <div class="sticky-sidebar">
    <!-- Szczegóły wariantu -->
    <v-card class="mb-4 bg-white border" elevation="1">
      <v-card-title class="d-flex align-center pb-2">
        <v-icon start size="small" color="primary">mdi-information-outline</v-icon>
        Szczegóły
      </v-card-title>
      <v-divider class="mb-2 mx-4" />

      <v-card-text class="pa-4 pt-0">
        <!-- Zamówienie -->
        <div class="detail-row">
          <div class="label">Zamówienie</div>
          <div class="value">
            <router-link
              :to="`/orders/${variant?.order_id}`"
              class="text-decoration-none text-primary font-weight-bold"
            >
              {{ variant?.order?.full_order_number }}
            </router-link>
          </div>
        </div>

        <!-- Klient -->
        <div class="detail-row">
          <div class="label">Klient</div>
          <div class="value text-truncate">
            <router-link
              v-if="variant?.order?.customer?.id"
              :to="`/customers/${variant.order.customer.id}`"
              class="text-decoration-none text-primary font-weight-medium"
            >
              {{ variant?.order?.customer?.name }}
            </router-link>
            <span v-else>-</span>
          </div>
        </div>

        <!-- Status wariantu -->
        <div class="detail-row">
          <div class="label">Status</div>
          <div class="value">
            <v-select
              :model-value="variant?.status"
              :items="metadataStore.variantStatuses"
              item-title="label"
              item-value="value"
              density="compact"
              variant="outlined"
              hide-details
              :loading="statusLoading"
              :disabled="
                variant?.status === 'CANCELLED' || variant?.status === 'COMPLETED'
              "
              class="status-select"
              @update:model-value="(val) => $emit('update-status', val)"
            >
              <template v-slot:selection="{ item }">
                <div class="d-flex align-center" :class="`text-${item.raw.color}`">
                  <v-icon size="small" class="mr-2">{{ item.raw.icon }}</v-icon>
                  <span class="font-weight-bold" style="font-size: 0.85rem">
                    {{ item.raw.label }}
                  </span>
                </div>
              </template>
              <template v-slot:item="{ props, item }">
                <v-list-item v-bind="props" density="compact">
                  <template v-slot:title>
                    <div class="d-flex align-center">
                      <v-icon :color="item.raw.color" size="small" class="mr-2">
                        {{ item.raw.icon }}
                      </v-icon>
                      <span style="font-size: 0.95rem; color: rgba(0, 0, 0, 0.87)">
                        {{ item.raw.label }}
                      </span>
                    </div>
                  </template>
                </v-list-item>
              </template>
            </v-select>
          </div>
        </div>

        <!-- Priorytet -->
        <div v-if="variant?.order?.priority" class="detail-row">
          <div class="label">Priorytet zamówienia</div>
          <div class="value">
            <v-chip
              size="small"
              :color="formatPriority(variant.order.priority).color"
              variant="flat"
              class="font-weight-bold"
            >
              <v-icon start size="x-small">{{
                formatPriority(variant.order.priority).icon
              }}</v-icon>
              {{ formatPriority(variant.order.priority).label }}
            </v-chip>
          </div>
        </div>

        <!-- Termin realizacji -->
        <div class="detail-row">
          <div class="label">Termin realizacji zamówienia</div>
          <div class="value font-weight-bold text-error">
            {{ formatDateOnly(variant?.order?.planned_delivery_date) }}
          </div>
        </div>

        <!-- Typ -->
        <div class="detail-row">
          <div class="label">Typ</div>
          <div class="value">
            <v-chip size="small" :color="variantTypeColor" variant="tonal">
              <v-icon start size="x-small">{{ variantTypeIcon }}</v-icon>
              {{ variantTypeLabel }}
            </v-chip>
          </div>
        </div>

        <!-- Ilość -->
        <div class="detail-row">
          <div class="label">Ilość</div>
          <div class="value">
            <inline-edit-field
              :model-value="String(variant?.quantity || 0)"
              type="number"
              icon-position="left"
              text-class="font-weight-bold text-body-1"
              :loading="inlineLoading === 'quantity'"
              @save="(val) => $emit('update-inline', 'quantity', val)"
            />
            <span class="text-caption text-medium-emphasis ml-1">szt.</span>
          </div>
        </div>
      </v-card-text>
    </v-card>

    <!-- ========================================== -->
    <!-- Sekcja Prototypu                           -->
    <!-- ========================================== -->
    <v-card
      v-if="variant?.type === 'PROTOTYPE'"
      variant="outlined"
      class="mb-4 border"
      :class="variant.is_approved ? 'border-success' : 'border-warning'"
    >
      <v-card-text class="pa-4">
        <div
          class="text-subtitle-2 text-medium-emphasis mb-3 text-uppercase font-weight-bold"
        >
          Decyzja Klienta
        </div>

        <div class="mb-3">
          <div
            v-if="variant.is_approved"
            class="d-flex align-center text-success bg-green-lighten-5 pa-2 rounded"
          >
            <v-icon start color="success" size="large">mdi-check-decagram</v-icon>
            <div>
              <div class="font-weight-bold text-body-1">Prototyp zatwierdzony</div>
              <div class="text-caption">Można rozpocząć produkcję seryjną</div>
            </div>
          </div>
          <div
            v-else
            class="d-flex align-center text-orange-darken-2 bg-orange-lighten-5 pa-2 rounded"
          >
            <v-icon start size="large">mdi-clock-alert-outline</v-icon>
            <div>
              <div class="font-weight-bold text-body-1">Oczekuje na decyzję</div>
              <div class="text-caption">Wymaga akceptacji prototypu</div>
            </div>
          </div>
        </div>

        <!-- Edytowalne pole z uwagami -->
        <div class="mb-3 pa-2 bg-grey-lighten-5 rounded border d-flex flex-column">
          <div
            class="text-caption font-weight-bold text-medium-emphasis mb-1 d-flex align-center"
          >
            <v-icon size="x-small" class="mr-1">mdi-message-text-outline</v-icon>
            Notatki / Feedback
          </div>
          <inline-edit-field
            :model-value="variant?.feedback_notes || ''"
            type="textarea"
            icon-position="left"
            placeholder="Kliknij, aby dodać notatkę..."
            text-class="text-body-2 text-medium-emphasis"
            :loading="inlineLoading === 'feedback_notes'"
            @save="(val) => $emit('update-inline', 'feedback_notes', val)"
          />
        </div>

        <div
          v-if="!variant.is_approved && variant.status !== 'CANCELLED'"
          class="d-flex flex-wrap gap-2 mb-2"
        >
          <v-btn
            color="success"
            variant="elevated"
            size="small"
            prepend-icon="mdi-check"
            class="flex-grow-1"
            @click="$emit('open-review', 'approve')"
          >
            Zatwierdź
          </v-btn>
          <v-btn
            color="error"
            variant="outlined"
            size="small"
            prepend-icon="mdi-close"
            class="flex-grow-1"
            @click="$emit('open-review', 'reject')"
          >
            Odrzuć
          </v-btn>
        </div>
      </v-card-text>
    </v-card>
  </div>
</template>

<script setup lang="ts">
import { computed } from "vue";
import InlineEditField from "@/components/common/InlineEditField.vue";
import { useMetadataStore } from "@/stores/metadata";
import { useStatusFormatter } from "@/composables/useStatusFormatter";
import { useFormatters } from "@/composables/useFormatters";

const props = defineProps<{
  variant: any;
  statusLoading: boolean;
  inlineLoading: string | null;
}>();

defineEmits(["update-inline", "update-status", "open-review", "open-cancel"]);

const metadataStore = useMetadataStore();

// Import formatters
const { formatVariantType, formatPriority } = useStatusFormatter();
const { formatDateOnly } = useFormatters();

const variantTypeLabel = computed(
  () => formatVariantType(props.variant?.type || "").label
);
const variantTypeColor = computed(
  () => formatVariantType(props.variant?.type || "").color
);
const variantTypeIcon = computed(() => formatVariantType(props.variant?.type || "").icon);
</script>

<style scoped>
.sticky-sidebar {
  position: sticky;
  top: 80px;
  z-index: 1;
}

/* Zwężony select statusu */
.status-select {
  max-width: 170px;
  width: 100%;
}
.status-select :deep(.v-field__input) {
  min-height: 32px;
  padding-top: 4px;
  padding-bottom: 4px;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #f5f5f5;
  min-height: 32px;
}

/* Usuwamy border bottom z ostatniego elementu i dodajemy wrap w razie czego */
.detail-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.detail-row .label {
  font-size: 0.85rem;
  color: rgba(0, 0, 0, 0.6);
  font-weight: 500;
  min-width: 110px;
  flex-shrink: 0;
}

.detail-row .value {
  font-size: 0.95rem;
  font-weight: 500;
  text-align: right;
  flex-grow: 1;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  word-break: break-word; /* Zapewnia złamanie długich słów, np. długich maili */
}

/* Zapobieganie uciekaniu tekstu poza rodzica w flexboxie */
.text-truncate {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  max-width: 100%;
}

.border-success {
  border: 2px solid rgb(var(--v-theme-success)) !important;
}
.border-warning {
  border: 2px solid rgb(var(--v-theme-warning)) !important;
}

.gap-2 {
  gap: 8px;
}
</style>


=================================================================================
FILE: src/components/variants/zxc copy.vue
LOCATION: .//src/components/variants/zxc copy.vue
=================================================================================



=================================================================================
FILE: src/components/variants/zxc.vue
LOCATION: .//src/components/variants/zxc.vue
=================================================================================



=================================================================================
FILE: src/components/workstations/WorkstationFormDialog.vue
LOCATION: .//src/components/workstations/WorkstationFormDialog.vue
=================================================================================

<template>
  <v-dialog
    :model-value="modelValue"
    @update:model-value="closeDialog"
    max-width="800"
    persistent
    scrollable
  >
    <v-card class="rounded-lg d-flex flex-column">
      <!-- Header -->
      <v-toolbar color="primary" density="comfortable" flat>
        <v-icon class="ml-4">{{ isEdit ? "mdi-pencil" : "mdi-plus" }}</v-icon>
        <v-toolbar-title class="text-subtitle-1 font-weight-bold">
          {{ isEdit ? "Edycja Stanowiska" : "Nowe Stanowisko" }}
        </v-toolbar-title>
        <v-spacer />
        <v-btn icon="mdi-close" variant="text" @click="closeDialog" />
      </v-toolbar>

      <!-- Tabs Navigation -->
      <div class="bg-grey-lighten-4">
        <v-tabs v-model="activeTab" color="primary" align-tabs="start" density="compact">
          <v-tab value="basic" class="text-capitalize">
            <v-icon start>mdi-information-outline</v-icon>
            Dane podstawowe
          </v-tab>
          <v-tab value="operators" :disabled="!isEdit" class="text-capitalize">
            <v-icon start>mdi-account-group-outline</v-icon>
            Operatorzy
          </v-tab>
          <v-tab value="services" :disabled="!isEdit" class="text-capitalize">
            <v-icon start>mdi-wrench-outline</v-icon>
            Przypisane usługi
          </v-tab>
        </v-tabs>
      </div>

      <v-divider />

      <!-- Content Area -->
      <v-card-text class="pa-0 flex-grow-1" style="min-height: 400px">
        <v-window v-model="activeTab" class="h-100">
          <!-- TAB: Dane podstawowe -->
          <v-window-item value="basic" class="pa-6">
            <v-form ref="formRef" @submit.prevent="handleSubmit">
              <v-row dense>
                <v-col cols="12" md="8">
                  <v-text-field
                    v-model="form.name"
                    label="Nazwa stanowiska *"
                    placeholder="np. Laser-01"
                    variant="outlined"
                    density="comfortable"
                    prepend-inner-icon="mdi-label"
                    :rules="rules.required"
                  />
                </v-col>

                <v-col cols="12" md="4">
                  <v-select
                    v-model="form.type"
                    :items="metadataStore.workstationTypes"
                    item-title="label"
                    item-value="value"
                    label="Typ stanowiska *"
                    variant="outlined"
                    density="comfortable"
                    prepend-inner-icon="mdi-shape"
                    :rules="rules.required"
                  />
                </v-col>

                <v-col cols="12">
                  <v-text-field
                    v-model="form.location"
                    label="Lokalizacja"
                    placeholder="np. Hala A - Sekcja 1"
                    variant="outlined"
                    density="comfortable"
                    prepend-inner-icon="mdi-map-marker"
                  />
                </v-col>

                <v-col cols="12" md="6">
                  <v-select
                    v-model="form.status"
                    :items="statusOptions"
                    item-title="title"
                    item-value="value"
                    label="Status techniczny"
                    variant="outlined"
                    density="comfortable"
                    prepend-inner-icon="mdi-traffic-light"
                  >
                    <template v-slot:selection="{ item }">
                      <v-chip
                        :color="item.raw.color"
                        size="small"
                        label
                        class="font-weight-medium"
                      >
                        {{ item.title }}
                      </v-chip>
                    </template>
                    <template v-slot:item="{ props, item }">
                      <v-list-item v-bind="props" density="compact">
                        <template v-slot:prepend>
                          <v-icon :color="item.raw.color" size="small">mdi-circle</v-icon>
                        </template>
                      </v-list-item>
                    </template>
                  </v-select>
                </v-col>
              </v-row>
            </v-form>
          </v-window-item>

          <!-- TAB: Operatorzy (Zmieniona struktura) -->
          <v-window-item value="operators" class="pa-0">
            <!-- Sekcja dodawania (szare tło) -->
            <div class="bg-grey-lighten-5 pa-6 border-b">
              <div class="d-flex align-center gap-4">
                <v-autocomplete
                  v-model="operatorsToAdd"
                  :items="availableOperators"
                  item-title="name"
                  item-value="id"
                  label="Wybierz operatorów"
                  placeholder="Wyszukaj pracownika..."
                  variant="outlined"
                  density="comfortable"
                  bg-color="white"
                  hide-details
                  class="flex-grow-1 mr-2"
                  prepend-inner-icon="mdi-account-search"
                  multiple
                  chips
                  closable-chips
                  no-data-text="Brak dostępnych operatorów"
                >
                  <!-- Naprawa przyciętego awatara w chipie -->
                  <template v-slot:chip="{ props, item }">
                    <v-chip
                      v-bind="props"
                      color="primary"
                      variant="tonal"
                      pill
                      label
                      class="pr-2"
                    >
                      <v-avatar start size="24" color="primary" class="text-white ml-0">
                        {{ item.raw.name?.charAt(0) }}
                      </v-avatar>
                      <span class="text-truncate">{{ item.raw.name }}</span>
                    </v-chip>
                  </template>

                  <template v-slot:item="{ props, item }">
                    <v-list-item v-bind="props" :subtitle="item.raw.email">
                      <template v-slot:prepend>
                        <v-avatar color="grey-lighten-3" size="32" variant="flat">
                          {{ item.raw.name?.charAt(0) }}
                        </v-avatar>
                      </template>
                    </v-list-item>
                  </template>
                </v-autocomplete>

                <v-btn
                  color="secondary"
                  height="48"
                  :disabled="operatorsToAdd.length === 0"
                  @click="handleAddOperators"
                  class="px-6"
                >
                  <v-icon start>mdi-account-plus</v-icon>
                  Dodaj
                </v-btn>
              </div>
            </div>

            <!-- Lista przypisanych (Tabela) -->
            <div class="pa-0">
              <v-table v-if="assignedOperators.length > 0" hover density="comfortable">
                <thead>
                  <tr>
                    <th class="text-left font-weight-bold">Pracownik</th>
                    <th class="text-left font-weight-bold">Email/ID</th>
                    <th class="text-right font-weight-bold" style="width: 100px">
                      Akcje
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="op in assignedOperators" :key="op.id">
                    <td>
                      <div class="d-flex align-center py-2">
                        <v-avatar color="secondary" size="36" variant="flat" class="mr-3">
                          <span class="text-white font-weight-bold">{{
                            op.name?.charAt(0)
                          }}</span>
                        </v-avatar>
                        <span class="font-weight-medium">{{ op.name }}</span>
                      </div>
                    </td>
                    <td class="text-medium-emphasis">{{ op.email }}</td>
                    <td class="text-right">
                      <v-btn
                        icon="mdi-delete"
                        size="small"
                        color="error"
                        variant="text"
                        title="Usuń przypisanie"
                        @click="handleRemoveOperator(op.id)"
                      />
                    </td>
                  </tr>
                </tbody>
              </v-table>

              <div v-else class="text-center py-12 text-medium-emphasis">
                <v-icon size="64" class="mb-4 opacity-20">mdi-account-off-outline</v-icon>
                <div class="text-body-1">Brak przypisanych operatorów</div>
                <div class="text-caption">Wybierz pracowników z listy powyżej</div>
              </div>
            </div>
          </v-window-item>

          <!-- TAB: Usługi -->
          <v-window-item value="services" class="pa-0">
            <!-- Sekcja dodawania -->
            <div class="bg-grey-lighten-5 pa-6 border-b">
              <div class="d-flex align-center gap-4">
                <v-autocomplete
                  v-model="serviceToAdd"
                  :items="availableServices"
                  item-title="name"
                  item-value="id"
                  label="Dodaj usługę do stanowiska"
                  placeholder="Wpisz nazwę usługi..."
                  variant="outlined"
                  density="comfortable"
                  bg-color="white"
                  hide-details
                  :loading="loadingServices"
                  class="flex-grow-1 mr-2"
                  no-data-text="Brak dostępnych usług do przypisania"
                >
                  <template v-slot:item="{ props, item }">
                    <v-list-item v-bind="props" :subtitle="item.raw.category">
                    </v-list-item>
                  </template>
                </v-autocomplete>

                <v-btn
                  color="secondary"
                  height="48"
                  :disabled="!serviceToAdd"
                  :loading="attaching"
                  @click="handleAttachService"
                  class="px-6"
                >
                  <v-icon start>mdi-link-plus</v-icon>
                  Dodaj
                </v-btn>
              </div>
            </div>

            <!-- Lista przypisanych -->
            <div class="pa-0">
              <div v-if="loadingAssigned" class="d-flex justify-center align-center py-8">
                <v-progress-circular indeterminate color="primary" />
              </div>

              <v-table
                v-else-if="workstationStore.currentWorkstationServices.length > 0"
                density="comfortable"
                hover
              >
                <thead>
                  <tr>
                    <th class="text-left font-weight-bold">Nazwa Usługi</th>
                    <th class="text-left font-weight-bold">Kategoria</th>
                    <th class="text-right font-weight-bold">Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="item in workstationStore.currentWorkstationServices"
                    :key="item.id"
                  >
                    <td class="font-weight-medium">{{ item.name }}</td>
                    <td>
                      <v-chip size="small" label>{{ item.category }}</v-chip>
                    </td>
                    <td class="text-right">
                      <v-btn
                        icon="mdi-link-variant-off"
                        size="small"
                        color="error"
                        variant="text"
                        title="Odłącz usługę"
                        @click="handleDetachService(item.id)"
                        :loading="detachingId === item.id"
                      />
                    </td>
                  </tr>
                </tbody>
              </v-table>

              <div v-else class="text-center py-12 text-medium-emphasis">
                <v-icon size="64" class="mb-4 opacity-20">mdi-wrench-outline</v-icon>
                <div class="text-body-1">Brak przypisanych usług</div>
                <div class="text-caption">
                  Dodaj usługi korzystając z formularza powyżej
                </div>
              </div>
            </div>
          </v-window-item>
        </v-window>
      </v-card-text>

      <v-divider />

      <!-- Footer Actions -->
      <v-card-actions class="pa-4 bg-white">
        <v-btn
          variant="text"
          color="grey-darken-1"
          @click="closeDialog"
          :disabled="saving"
        >
          Anuluj
        </v-btn>
        <v-spacer />
        <v-btn
          color="primary"
          variant="elevated"
          @click="handleSubmit"
          :loading="saving"
          class="px-6"
        >
          {{ isEdit ? "Zapisz zmiany" : "Utwórz stanowisko" }}
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from "vue";
import { useWorkstationStore } from "@/stores/workstations";
import { useAssortmentStore } from "@/stores/assortment";
import { useMetadataStore } from "@/stores/metadata";

// Props & Emits
const props = defineProps({
  modelValue: Boolean,
  workstation: {
    type: Object,
    default: null,
  },
});

const emit = defineEmits(["update:modelValue", "saved"]);

// Stores
const workstationStore = useWorkstationStore();
const assortmentStore = useAssortmentStore();
const metadataStore = useMetadataStore();

// State
const activeTab = ref("basic");
const formRef = ref(null);
const saving = ref(false);
const loadingServices = ref(false);
const loadingAssigned = ref(false);
const attaching = ref(false);
const detachingId = ref(null);

// Form Data & Buffers
const defaultForm = {
  name: "",
  type: null,
  location: "",
  status: "IDLE",
  operator_ids: [],
};
const form = ref({ ...defaultForm });

const serviceToAdd = ref(null);
const operatorsToAdd = ref([]); // Bufor dla selecta operatorów

// Constants & Helpers
const rules = {
  required: [(v) => !!v || "To pole jest wymagane"],
};

const statusOptions = [
  { title: "Dostępne (Idle)", value: "IDLE", color: "success" },
  { title: "W użyciu (Active)", value: "ACTIVE", color: "primary" },
  { title: "Przerwa (Paused)", value: "PAUSED", color: "warning" },
  { title: "Konserwacja (Maintenance)", value: "MAINTENANCE", color: "error" },
];

const isEdit = computed(() => !!props.workstation);

// --- Computed dla Operatorów ---

// 1. Zwraca obiekty operatorów, którzy są już przypisani (bazując na form.operator_ids)
const assignedOperators = computed(() => {
  if (!workstationStore.workers) return [];
  return workstationStore.workers.filter((w) => form.value.operator_ids.includes(w.id));
});

// 2. Zwraca listę dostępnych operatorów (wyklucza już przypisanych)
const availableOperators = computed(() => {
  if (!workstationStore.workers) return [];
  return workstationStore.workers.filter((w) => !form.value.operator_ids.includes(w.id));
});

// --- Computed dla Usług ---

const availableServices = computed(() => {
  const assignedIds = new Set(
    workstationStore.currentWorkstationServices.map((s) => s.id)
  );
  return assortmentStore.items.filter(
    (item) => item.type?.toUpperCase() === "SERVICE" && !assignedIds.has(item.id)
  );
});

// Watchers
watch(
  () => props.modelValue,
  async (isOpen) => {
    if (isOpen) {
      activeTab.value = "basic";
      serviceToAdd.value = null;
      operatorsToAdd.value = [];

      // Reset lub wczytanie danych
      if (props.workstation) {
        form.value = {
          name: props.workstation.name,
          type: props.workstation.type,
          location: props.workstation.location,
          status: props.workstation.status,
          operator_ids: props.workstation.operators?.map((u) => u.id) || [],
        };

        await Promise.all([workstationStore.fetchWorkers(), loadServicesData()]);
      } else {
        form.value = { ...defaultForm };
        workstationStore.currentWorkstationServices = [];
        workstationStore.fetchWorkers();
      }
    }
  }
);

// Methods
const loadServicesData = async () => {
  loadingAssigned.value = true;
  loadingServices.value = true;
  try {
    await assortmentStore.fetchItems({ type: "service" });
    if (props.workstation?.id) {
      await workstationStore.fetchWorkstationServices(props.workstation.id);
    }
  } catch (e) {
    console.error("Błąd pobierania danych usług", e);
  } finally {
    loadingAssigned.value = false;
    loadingServices.value = false;
  }
};

// Logika dodawania/usuwania operatorów w GUI (przed zapisem)
const handleAddOperators = () => {
  if (operatorsToAdd.value.length === 0) return;

  // Dodaj wybrane ID do formularza
  form.value.operator_ids = [...form.value.operator_ids, ...operatorsToAdd.value];

  // Wyczyść selekcję
  operatorsToAdd.value = [];
};

const handleRemoveOperator = (id) => {
  form.value.operator_ids = form.value.operator_ids.filter((opId) => opId !== id);
};

const handleSubmit = async () => {
  const { valid } = await formRef.value.validate();
  if (!valid) return;

  saving.value = true;
  try {
    if (isEdit.value) {
      await workstationStore.updateWorkstation(props.workstation.id, form.value);
    } else {
      await workstationStore.createWorkstation(form.value);
    }
    emit("saved");
    if (!isEdit.value) closeDialog();
  } catch (error) {
    console.error(error);
    alert(
      "Wystąpił błąd podczas zapisu: " +
        (error.response?.data?.message || "Nieznany błąd")
    );
  } finally {
    saving.value = false;
  }
};

const handleAttachService = async () => {
  if (!serviceToAdd.value || !props.workstation?.id) return;

  attaching.value = true;
  try {
    await workstationStore.attachService(props.workstation.id, serviceToAdd.value);
    serviceToAdd.value = null;
    await workstationStore.fetchWorkstationServices(props.workstation.id);
  } catch (e) {
    alert("Nie udało się przypisać usługi.");
  } finally {
    attaching.value = false;
  }
};

const handleDetachService = async (serviceId) => {
  if (!confirm("Czy na pewno chcesz odłączyć tę usługę?")) return;

  detachingId.value = serviceId;
  try {
    await workstationStore.detachService(props.workstation.id, serviceId);
    await workstationStore.fetchWorkstationServices(props.workstation.id);
  } catch (e) {
    alert("Nie udało się odłączyć usługi.");
  } finally {
    detachingId.value = null;
  }
};

const closeDialog = () => {
  emit("update:modelValue", false);
};
</script>


=================================================================================
FILE: src/layouts/MainLayout.vue
LOCATION: .//src/layouts/MainLayout.vue
=================================================================================

<template>
  <v-app>
    <!-- Header dynamiczny na podstawie roli -->
    <!-- Dla pracowników produkcyjnych (PRODUCTION_EMPLOYEE) pokazujemy RcpHeader -->
    <rcp-header
      v-if="authStore.isWorker"
      :show-back="showBackButton"
      @back="handleBack"
    />

    <!-- Dla pozostałych ról (Admin, Manager, Trader, etc.) pokazujemy pełny AppHeader -->
    <app-header v-else @toggle-drawer="mobileDrawer = !mobileDrawer" />

    <!-- Mobile Drawer - tylko dla użytkowników z pełnym dostępem -->
    <v-navigation-drawer
      v-if="!authStore.isWorker"
      v-model="mobileDrawer"
      temporary
      location="left"
      class="d-md-none"
    >
      <v-list>
        <v-list-item
          prepend-icon="mdi-factory"
          title="CSERP"
          subtitle="Custom Solutions ERP"
          class="mb-2"
        />
        <v-divider />
        <v-list-item
          v-for="item in mobileNavItems"
          :key="item.to"
          :to="item.to"
          :prepend-icon="item.icon"
          :title="item.title"
        />
      </v-list>
    </v-navigation-drawer>

    <!-- Główna zawartość -->
    <v-main class="flex-grow-1">
      <slot />
    </v-main>

    <!-- Footer - ukryty dla pracowników produkcyjnych (opcjonalnie) -->
    <app-footer />
  </v-app>
</template>

<script setup lang="ts">
import { ref, computed } from "vue";
import { useRouter, useRoute } from "vue-router";
import { useAuthStore } from "@/stores/auth";
import AppHeader from "@/components/layout/AppHeader.vue";
import AppFooter from "@/components/layout/AppFooter.vue";
import RcpHeader from "@/components/layout/RcpHeader.vue";

const router = useRouter();
const route = useRoute();
const authStore = useAuthStore();
const mobileDrawer = ref(false);

// Określanie czy pokazać przycisk wstecz w RcpHeader
// Pokazujemy go gdy jesteśmy na stronie Timer (nie na głównej stronie wyboru stanowiska)
const showBackButton = computed(() => {
  // Lista ścieżek gdzie NIE pokazujemy przycisku wstecz
  const noBackRoutes = ["/rcp/workstation", "/dashboard"];
  return !noBackRoutes.includes(route.path);
});

// Obsługa przycisku wstecz
const handleBack = () => {
  // Jeśli jesteśmy na timerze, wracamy do wyboru stanowiska
  if (route.path.startsWith("/rcp/timer")) {
    router.push("/rcp/workstation");
  } else {
    router.back();
  }
};

// Menu mobilne dla pełnego dostępu
const mobileNavItems = computed(() => {
  const items = [{ title: "Dashboard", icon: "mdi-view-dashboard", to: "/dashboard" }];

  if (authStore.canManageSystem) {
    items.push(
      { title: "Zamówienia", icon: "mdi-clipboard-text", to: "/orders" },
      { title: "Klienci", icon: "mdi-account-group", to: "/customers" },
      { title: "Asortyment", icon: "mdi-package-variant-closed", to: "/assortment" },
      { title: "Stanowiska", icon: "mdi-factory", to: "/workstations" }
    );
  }

  items.push({ title: "Panel Pracownika", icon: "mdi-timer", to: "/rcp/workstation" });
  return items;
});
</script>



################################################################################
#                                                                              #
#                            END OF FRONTEND CODE                              #
#                                                                              #
#  Export completed: 2026-02-28 08:00:08                                     #
#                                                                              #
################################################################################
